<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>10_Bean映射框架 | snote</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/snote/img/logo.png">
    <meta name="description" content="study note">
    
    <link rel="preload" href="/snote/assets/css/0.styles.733b32e4.css" as="style"><link rel="preload" href="/snote/assets/js/app.3cc04e36.js" as="script"><link rel="preload" href="/snote/assets/js/5.22329d81.js" as="script"><link rel="preload" href="/snote/assets/js/1.5e23c49c.js" as="script"><link rel="preload" href="/snote/assets/js/6.f56a3b14.js" as="script"><link rel="preload" href="/snote/assets/js/77.11cc1a2c.js" as="script"><link rel="prefetch" href="/snote/assets/js/10.1e6036a4.js"><link rel="prefetch" href="/snote/assets/js/100.e53901ab.js"><link rel="prefetch" href="/snote/assets/js/101.7ff3bf92.js"><link rel="prefetch" href="/snote/assets/js/102.72df3fb1.js"><link rel="prefetch" href="/snote/assets/js/103.39232b43.js"><link rel="prefetch" href="/snote/assets/js/104.19b1fd3c.js"><link rel="prefetch" href="/snote/assets/js/105.a9e362b5.js"><link rel="prefetch" href="/snote/assets/js/106.77930f24.js"><link rel="prefetch" href="/snote/assets/js/107.ea9f01d0.js"><link rel="prefetch" href="/snote/assets/js/108.7ff74d7c.js"><link rel="prefetch" href="/snote/assets/js/109.e55033b4.js"><link rel="prefetch" href="/snote/assets/js/11.9b2b7f36.js"><link rel="prefetch" href="/snote/assets/js/110.d399212c.js"><link rel="prefetch" href="/snote/assets/js/111.9ca56f5e.js"><link rel="prefetch" href="/snote/assets/js/112.97d8e09c.js"><link rel="prefetch" href="/snote/assets/js/113.b00a35d2.js"><link rel="prefetch" href="/snote/assets/js/114.7071cc16.js"><link rel="prefetch" href="/snote/assets/js/115.71bfbee0.js"><link rel="prefetch" href="/snote/assets/js/116.d3cc8989.js"><link rel="prefetch" href="/snote/assets/js/117.52c30bbd.js"><link rel="prefetch" href="/snote/assets/js/118.d17bd671.js"><link rel="prefetch" href="/snote/assets/js/119.17200614.js"><link rel="prefetch" href="/snote/assets/js/12.8e64e191.js"><link rel="prefetch" href="/snote/assets/js/120.c4c779cd.js"><link rel="prefetch" href="/snote/assets/js/121.6e65fbc1.js"><link rel="prefetch" href="/snote/assets/js/122.304ccf9d.js"><link rel="prefetch" href="/snote/assets/js/123.b744823c.js"><link rel="prefetch" href="/snote/assets/js/124.f5ab81c9.js"><link rel="prefetch" href="/snote/assets/js/125.aaa33725.js"><link rel="prefetch" href="/snote/assets/js/126.10649710.js"><link rel="prefetch" href="/snote/assets/js/127.f35b2900.js"><link rel="prefetch" href="/snote/assets/js/128.833a1e82.js"><link rel="prefetch" href="/snote/assets/js/129.83493639.js"><link rel="prefetch" href="/snote/assets/js/13.d156e68f.js"><link rel="prefetch" href="/snote/assets/js/130.3c356544.js"><link rel="prefetch" href="/snote/assets/js/131.77654b97.js"><link rel="prefetch" href="/snote/assets/js/132.3e636caa.js"><link rel="prefetch" href="/snote/assets/js/133.b8a7f38a.js"><link rel="prefetch" href="/snote/assets/js/134.35ccee41.js"><link rel="prefetch" href="/snote/assets/js/135.13f63617.js"><link rel="prefetch" href="/snote/assets/js/136.2cd53605.js"><link rel="prefetch" href="/snote/assets/js/137.8331c390.js"><link rel="prefetch" href="/snote/assets/js/138.0c433171.js"><link rel="prefetch" href="/snote/assets/js/139.a6287a10.js"><link rel="prefetch" href="/snote/assets/js/14.41b00a6a.js"><link rel="prefetch" href="/snote/assets/js/140.53857f35.js"><link rel="prefetch" href="/snote/assets/js/141.173a51f6.js"><link rel="prefetch" href="/snote/assets/js/142.ea2a40cd.js"><link rel="prefetch" href="/snote/assets/js/143.bf22752b.js"><link rel="prefetch" href="/snote/assets/js/144.ee4de6bb.js"><link rel="prefetch" href="/snote/assets/js/145.c3171214.js"><link rel="prefetch" href="/snote/assets/js/146.3784d416.js"><link rel="prefetch" href="/snote/assets/js/147.724d5523.js"><link rel="prefetch" href="/snote/assets/js/148.887b57b8.js"><link rel="prefetch" href="/snote/assets/js/149.365a3713.js"><link rel="prefetch" href="/snote/assets/js/15.d7973cb5.js"><link rel="prefetch" href="/snote/assets/js/150.5a119004.js"><link rel="prefetch" href="/snote/assets/js/151.35989bab.js"><link rel="prefetch" href="/snote/assets/js/152.a53a5bcf.js"><link rel="prefetch" href="/snote/assets/js/153.c49175be.js"><link rel="prefetch" href="/snote/assets/js/154.132d5c92.js"><link rel="prefetch" href="/snote/assets/js/155.4d2859d7.js"><link rel="prefetch" href="/snote/assets/js/156.24fa7e30.js"><link rel="prefetch" href="/snote/assets/js/157.d00b5ab7.js"><link rel="prefetch" href="/snote/assets/js/158.58345bf0.js"><link rel="prefetch" href="/snote/assets/js/159.30fd6c79.js"><link rel="prefetch" href="/snote/assets/js/16.2a0f8a1e.js"><link rel="prefetch" href="/snote/assets/js/160.0415e6c5.js"><link rel="prefetch" href="/snote/assets/js/161.af36ab6d.js"><link rel="prefetch" href="/snote/assets/js/162.3f15c754.js"><link rel="prefetch" href="/snote/assets/js/163.b29fc431.js"><link rel="prefetch" href="/snote/assets/js/164.9bcd2f56.js"><link rel="prefetch" href="/snote/assets/js/165.3b91ca92.js"><link rel="prefetch" href="/snote/assets/js/166.749c6ca6.js"><link rel="prefetch" href="/snote/assets/js/167.d48009c9.js"><link rel="prefetch" href="/snote/assets/js/168.c36d8d5d.js"><link rel="prefetch" href="/snote/assets/js/169.ae085a84.js"><link rel="prefetch" href="/snote/assets/js/17.4ffd4119.js"><link rel="prefetch" href="/snote/assets/js/170.fca3db2e.js"><link rel="prefetch" href="/snote/assets/js/171.7696e010.js"><link rel="prefetch" href="/snote/assets/js/172.1c40e807.js"><link rel="prefetch" href="/snote/assets/js/173.9b50a23b.js"><link rel="prefetch" href="/snote/assets/js/174.58befaba.js"><link rel="prefetch" href="/snote/assets/js/175.e1b9ba0f.js"><link rel="prefetch" href="/snote/assets/js/176.ec0983d0.js"><link rel="prefetch" href="/snote/assets/js/177.36734ab4.js"><link rel="prefetch" href="/snote/assets/js/178.fe90bfd6.js"><link rel="prefetch" href="/snote/assets/js/179.76053104.js"><link rel="prefetch" href="/snote/assets/js/18.f6fa6b40.js"><link rel="prefetch" href="/snote/assets/js/180.b015d622.js"><link rel="prefetch" href="/snote/assets/js/181.9b717ca0.js"><link rel="prefetch" href="/snote/assets/js/182.7f4cf041.js"><link rel="prefetch" href="/snote/assets/js/183.bb178fad.js"><link rel="prefetch" href="/snote/assets/js/184.7bcfa00d.js"><link rel="prefetch" href="/snote/assets/js/185.bca06eaf.js"><link rel="prefetch" href="/snote/assets/js/186.b5a2ae31.js"><link rel="prefetch" href="/snote/assets/js/187.54d67a16.js"><link rel="prefetch" href="/snote/assets/js/188.4c672878.js"><link rel="prefetch" href="/snote/assets/js/189.c4ff0da3.js"><link rel="prefetch" href="/snote/assets/js/19.4e10afcb.js"><link rel="prefetch" href="/snote/assets/js/190.c04cba39.js"><link rel="prefetch" href="/snote/assets/js/191.47277121.js"><link rel="prefetch" href="/snote/assets/js/192.2df35df1.js"><link rel="prefetch" href="/snote/assets/js/193.6522b845.js"><link rel="prefetch" href="/snote/assets/js/194.b0ab5764.js"><link rel="prefetch" href="/snote/assets/js/195.28c85e74.js"><link rel="prefetch" href="/snote/assets/js/196.6b6c7db3.js"><link rel="prefetch" href="/snote/assets/js/197.11fe146e.js"><link rel="prefetch" href="/snote/assets/js/198.d68ebf1f.js"><link rel="prefetch" href="/snote/assets/js/199.b813b835.js"><link rel="prefetch" href="/snote/assets/js/20.3b3c1d36.js"><link rel="prefetch" href="/snote/assets/js/200.b3956510.js"><link rel="prefetch" href="/snote/assets/js/201.9ae9098a.js"><link rel="prefetch" href="/snote/assets/js/202.a2a5abba.js"><link rel="prefetch" href="/snote/assets/js/203.6c78ac54.js"><link rel="prefetch" href="/snote/assets/js/204.07229555.js"><link rel="prefetch" href="/snote/assets/js/205.007d975e.js"><link rel="prefetch" href="/snote/assets/js/206.053c9ad1.js"><link rel="prefetch" href="/snote/assets/js/207.9dc2d2a1.js"><link rel="prefetch" href="/snote/assets/js/208.3ebf2372.js"><link rel="prefetch" href="/snote/assets/js/209.1bef9845.js"><link rel="prefetch" href="/snote/assets/js/21.54f98d7e.js"><link rel="prefetch" href="/snote/assets/js/210.d0a49b1e.js"><link rel="prefetch" href="/snote/assets/js/211.9867a469.js"><link rel="prefetch" href="/snote/assets/js/212.69fd5be2.js"><link rel="prefetch" href="/snote/assets/js/213.8f82a998.js"><link rel="prefetch" href="/snote/assets/js/214.823be3c5.js"><link rel="prefetch" href="/snote/assets/js/215.678426f8.js"><link rel="prefetch" href="/snote/assets/js/216.0564d748.js"><link rel="prefetch" href="/snote/assets/js/217.ea5120a3.js"><link rel="prefetch" href="/snote/assets/js/218.b259e9f5.js"><link rel="prefetch" href="/snote/assets/js/219.7103afc4.js"><link rel="prefetch" href="/snote/assets/js/22.2aac9b21.js"><link rel="prefetch" href="/snote/assets/js/220.294118e9.js"><link rel="prefetch" href="/snote/assets/js/221.fc705f9e.js"><link rel="prefetch" href="/snote/assets/js/222.82415480.js"><link rel="prefetch" href="/snote/assets/js/223.34d2d18a.js"><link rel="prefetch" href="/snote/assets/js/224.0dae4c03.js"><link rel="prefetch" href="/snote/assets/js/225.1200b289.js"><link rel="prefetch" href="/snote/assets/js/226.3f3df43d.js"><link rel="prefetch" href="/snote/assets/js/227.c7ecd98d.js"><link rel="prefetch" href="/snote/assets/js/228.1c820734.js"><link rel="prefetch" href="/snote/assets/js/229.42a94887.js"><link rel="prefetch" href="/snote/assets/js/23.4d176be4.js"><link rel="prefetch" href="/snote/assets/js/230.2fad6960.js"><link rel="prefetch" href="/snote/assets/js/231.ce9d1a71.js"><link rel="prefetch" href="/snote/assets/js/232.c63516ab.js"><link rel="prefetch" href="/snote/assets/js/233.49851721.js"><link rel="prefetch" href="/snote/assets/js/234.e8b507d2.js"><link rel="prefetch" href="/snote/assets/js/235.d33e513e.js"><link rel="prefetch" href="/snote/assets/js/236.87e4e820.js"><link rel="prefetch" href="/snote/assets/js/237.d58c3ffb.js"><link rel="prefetch" href="/snote/assets/js/238.5082bd37.js"><link rel="prefetch" href="/snote/assets/js/239.5802e4fa.js"><link rel="prefetch" href="/snote/assets/js/24.80d247cf.js"><link rel="prefetch" href="/snote/assets/js/240.bd7f4259.js"><link rel="prefetch" href="/snote/assets/js/241.d135df38.js"><link rel="prefetch" href="/snote/assets/js/242.67bd6281.js"><link rel="prefetch" href="/snote/assets/js/243.dda77da4.js"><link rel="prefetch" href="/snote/assets/js/244.5ced0265.js"><link rel="prefetch" href="/snote/assets/js/245.76aa7524.js"><link rel="prefetch" href="/snote/assets/js/246.690093e7.js"><link rel="prefetch" href="/snote/assets/js/247.3127d466.js"><link rel="prefetch" href="/snote/assets/js/248.dbe63ed3.js"><link rel="prefetch" href="/snote/assets/js/249.fe2ef438.js"><link rel="prefetch" href="/snote/assets/js/25.63eaaf87.js"><link rel="prefetch" href="/snote/assets/js/250.1549a447.js"><link rel="prefetch" href="/snote/assets/js/251.db65678e.js"><link rel="prefetch" href="/snote/assets/js/252.e6b08a3c.js"><link rel="prefetch" href="/snote/assets/js/253.c60596c3.js"><link rel="prefetch" href="/snote/assets/js/254.cc49031e.js"><link rel="prefetch" href="/snote/assets/js/255.815e4537.js"><link rel="prefetch" href="/snote/assets/js/256.497750f6.js"><link rel="prefetch" href="/snote/assets/js/257.fd4a510f.js"><link rel="prefetch" href="/snote/assets/js/258.e1d62930.js"><link rel="prefetch" href="/snote/assets/js/259.42dad2e9.js"><link rel="prefetch" href="/snote/assets/js/26.70fb8da2.js"><link rel="prefetch" href="/snote/assets/js/260.a826fe7a.js"><link rel="prefetch" href="/snote/assets/js/261.220b0562.js"><link rel="prefetch" href="/snote/assets/js/262.df8af257.js"><link rel="prefetch" href="/snote/assets/js/263.e8218053.js"><link rel="prefetch" href="/snote/assets/js/264.88e08802.js"><link rel="prefetch" href="/snote/assets/js/265.f936d179.js"><link rel="prefetch" href="/snote/assets/js/266.a05c3940.js"><link rel="prefetch" href="/snote/assets/js/267.a7a75213.js"><link rel="prefetch" href="/snote/assets/js/268.33bfc335.js"><link rel="prefetch" href="/snote/assets/js/269.6e869285.js"><link rel="prefetch" href="/snote/assets/js/27.1f5790a0.js"><link rel="prefetch" href="/snote/assets/js/270.6ffca78a.js"><link rel="prefetch" href="/snote/assets/js/271.ac1fb068.js"><link rel="prefetch" href="/snote/assets/js/272.13e569b2.js"><link rel="prefetch" href="/snote/assets/js/273.2ce712d9.js"><link rel="prefetch" href="/snote/assets/js/274.d66f80d4.js"><link rel="prefetch" href="/snote/assets/js/275.de571766.js"><link rel="prefetch" href="/snote/assets/js/276.f3b29147.js"><link rel="prefetch" href="/snote/assets/js/277.b76178a1.js"><link rel="prefetch" href="/snote/assets/js/278.56362141.js"><link rel="prefetch" href="/snote/assets/js/279.25b22240.js"><link rel="prefetch" href="/snote/assets/js/28.5ef486f6.js"><link rel="prefetch" href="/snote/assets/js/280.0028cb8e.js"><link rel="prefetch" href="/snote/assets/js/281.19110b74.js"><link rel="prefetch" href="/snote/assets/js/282.92106866.js"><link rel="prefetch" href="/snote/assets/js/283.986ffec9.js"><link rel="prefetch" href="/snote/assets/js/284.c24532a5.js"><link rel="prefetch" href="/snote/assets/js/285.f53857b8.js"><link rel="prefetch" href="/snote/assets/js/286.b1f41b19.js"><link rel="prefetch" href="/snote/assets/js/287.b8c0d28b.js"><link rel="prefetch" href="/snote/assets/js/288.77b2860b.js"><link rel="prefetch" href="/snote/assets/js/289.d0a5c87b.js"><link rel="prefetch" href="/snote/assets/js/29.c1aa7b05.js"><link rel="prefetch" href="/snote/assets/js/290.a2b5aa3a.js"><link rel="prefetch" href="/snote/assets/js/291.8d3fa552.js"><link rel="prefetch" href="/snote/assets/js/292.ec03d81e.js"><link rel="prefetch" href="/snote/assets/js/293.98696bcb.js"><link rel="prefetch" href="/snote/assets/js/294.fe6857c9.js"><link rel="prefetch" href="/snote/assets/js/295.618179f3.js"><link rel="prefetch" href="/snote/assets/js/296.9ef57bc6.js"><link rel="prefetch" href="/snote/assets/js/297.f252aac1.js"><link rel="prefetch" href="/snote/assets/js/298.5e1c84a5.js"><link rel="prefetch" href="/snote/assets/js/299.309fb772.js"><link rel="prefetch" href="/snote/assets/js/3.c1ff7317.js"><link rel="prefetch" href="/snote/assets/js/30.4bb90738.js"><link rel="prefetch" href="/snote/assets/js/300.4e4d323e.js"><link rel="prefetch" href="/snote/assets/js/301.3a31e029.js"><link rel="prefetch" href="/snote/assets/js/302.d5214ae9.js"><link rel="prefetch" href="/snote/assets/js/303.df064523.js"><link rel="prefetch" href="/snote/assets/js/304.f9eb1bf7.js"><link rel="prefetch" href="/snote/assets/js/305.4d6612e0.js"><link rel="prefetch" href="/snote/assets/js/306.8acfffc4.js"><link rel="prefetch" href="/snote/assets/js/307.ba54d579.js"><link rel="prefetch" href="/snote/assets/js/308.d4473266.js"><link rel="prefetch" href="/snote/assets/js/309.a76d6b29.js"><link rel="prefetch" href="/snote/assets/js/31.b1ee51e2.js"><link rel="prefetch" href="/snote/assets/js/310.291ca423.js"><link rel="prefetch" href="/snote/assets/js/311.39a60e61.js"><link rel="prefetch" href="/snote/assets/js/312.36aa70af.js"><link rel="prefetch" href="/snote/assets/js/313.68c1ba97.js"><link rel="prefetch" href="/snote/assets/js/314.65cd2f18.js"><link rel="prefetch" href="/snote/assets/js/315.36d2f5b8.js"><link rel="prefetch" href="/snote/assets/js/316.7fc1ad1f.js"><link rel="prefetch" href="/snote/assets/js/317.aef9d07a.js"><link rel="prefetch" href="/snote/assets/js/318.783cd3bc.js"><link rel="prefetch" href="/snote/assets/js/319.e7f7bb74.js"><link rel="prefetch" href="/snote/assets/js/32.415bb67d.js"><link rel="prefetch" href="/snote/assets/js/320.4858112b.js"><link rel="prefetch" href="/snote/assets/js/321.5c2d406d.js"><link rel="prefetch" href="/snote/assets/js/322.0ca7c95d.js"><link rel="prefetch" href="/snote/assets/js/323.2d6fbc1c.js"><link rel="prefetch" href="/snote/assets/js/324.982fef51.js"><link rel="prefetch" href="/snote/assets/js/325.c244b4d2.js"><link rel="prefetch" href="/snote/assets/js/326.dbf8ace0.js"><link rel="prefetch" href="/snote/assets/js/327.8f2c1ebe.js"><link rel="prefetch" href="/snote/assets/js/328.e8eb5fa6.js"><link rel="prefetch" href="/snote/assets/js/329.162c0bd5.js"><link rel="prefetch" href="/snote/assets/js/33.35a98693.js"><link rel="prefetch" href="/snote/assets/js/330.5c6cafc3.js"><link rel="prefetch" href="/snote/assets/js/331.27832ebd.js"><link rel="prefetch" href="/snote/assets/js/332.d924873c.js"><link rel="prefetch" href="/snote/assets/js/333.2a25fce8.js"><link rel="prefetch" href="/snote/assets/js/334.fc1972ba.js"><link rel="prefetch" href="/snote/assets/js/335.35bf5bc7.js"><link rel="prefetch" href="/snote/assets/js/336.14b855aa.js"><link rel="prefetch" href="/snote/assets/js/337.462cd198.js"><link rel="prefetch" href="/snote/assets/js/338.a4ada162.js"><link rel="prefetch" href="/snote/assets/js/339.cdccddf6.js"><link rel="prefetch" href="/snote/assets/js/34.a375d18a.js"><link rel="prefetch" href="/snote/assets/js/340.4ef3435a.js"><link rel="prefetch" href="/snote/assets/js/341.14e6591a.js"><link rel="prefetch" href="/snote/assets/js/342.d944b8a6.js"><link rel="prefetch" href="/snote/assets/js/343.5e6e1814.js"><link rel="prefetch" href="/snote/assets/js/344.60707e61.js"><link rel="prefetch" href="/snote/assets/js/345.25b2d6d9.js"><link rel="prefetch" href="/snote/assets/js/346.fe7a8f22.js"><link rel="prefetch" href="/snote/assets/js/347.8dc03771.js"><link rel="prefetch" href="/snote/assets/js/348.92e83ff5.js"><link rel="prefetch" href="/snote/assets/js/349.2f717ea8.js"><link rel="prefetch" href="/snote/assets/js/35.175c5eb9.js"><link rel="prefetch" href="/snote/assets/js/350.5d843d49.js"><link rel="prefetch" href="/snote/assets/js/351.07f15a6d.js"><link rel="prefetch" href="/snote/assets/js/352.a931cc83.js"><link rel="prefetch" href="/snote/assets/js/353.04a30c0b.js"><link rel="prefetch" href="/snote/assets/js/354.a7adb748.js"><link rel="prefetch" href="/snote/assets/js/355.ed562ee8.js"><link rel="prefetch" href="/snote/assets/js/356.c42cbb30.js"><link rel="prefetch" href="/snote/assets/js/357.30d3bca7.js"><link rel="prefetch" href="/snote/assets/js/358.8e4e9d5d.js"><link rel="prefetch" href="/snote/assets/js/359.b907912b.js"><link rel="prefetch" href="/snote/assets/js/36.a16c85c6.js"><link rel="prefetch" href="/snote/assets/js/360.5901ac19.js"><link rel="prefetch" href="/snote/assets/js/361.480746e5.js"><link rel="prefetch" href="/snote/assets/js/362.ae2e8c50.js"><link rel="prefetch" href="/snote/assets/js/363.f4fd2d93.js"><link rel="prefetch" href="/snote/assets/js/364.71efc99c.js"><link rel="prefetch" href="/snote/assets/js/365.01f1bbac.js"><link rel="prefetch" href="/snote/assets/js/366.ce846e06.js"><link rel="prefetch" href="/snote/assets/js/367.d4be3b41.js"><link rel="prefetch" href="/snote/assets/js/368.5dfde021.js"><link rel="prefetch" href="/snote/assets/js/369.4fc6a3c2.js"><link rel="prefetch" href="/snote/assets/js/37.9518c0e3.js"><link rel="prefetch" href="/snote/assets/js/370.0beee867.js"><link rel="prefetch" href="/snote/assets/js/371.93f76ea7.js"><link rel="prefetch" href="/snote/assets/js/372.3516675d.js"><link rel="prefetch" href="/snote/assets/js/373.77a2d6fe.js"><link rel="prefetch" href="/snote/assets/js/374.4df21af3.js"><link rel="prefetch" href="/snote/assets/js/375.2b0bfaf9.js"><link rel="prefetch" href="/snote/assets/js/376.1ede8405.js"><link rel="prefetch" href="/snote/assets/js/377.6ebc80ca.js"><link rel="prefetch" href="/snote/assets/js/378.10b8ed94.js"><link rel="prefetch" href="/snote/assets/js/379.bf89586c.js"><link rel="prefetch" href="/snote/assets/js/38.87f9adbc.js"><link rel="prefetch" href="/snote/assets/js/380.0858af5c.js"><link rel="prefetch" href="/snote/assets/js/381.f5f831bc.js"><link rel="prefetch" href="/snote/assets/js/382.6f2a95ff.js"><link rel="prefetch" href="/snote/assets/js/383.0f3a65fc.js"><link rel="prefetch" href="/snote/assets/js/384.a5c6d41a.js"><link rel="prefetch" href="/snote/assets/js/385.3a233d1e.js"><link rel="prefetch" href="/snote/assets/js/39.596a81f1.js"><link rel="prefetch" href="/snote/assets/js/4.19456bac.js"><link rel="prefetch" href="/snote/assets/js/40.0bebee27.js"><link rel="prefetch" href="/snote/assets/js/41.119caf45.js"><link rel="prefetch" href="/snote/assets/js/42.07dbe829.js"><link rel="prefetch" href="/snote/assets/js/43.534b6876.js"><link rel="prefetch" href="/snote/assets/js/44.109672d9.js"><link rel="prefetch" href="/snote/assets/js/45.3293f327.js"><link rel="prefetch" href="/snote/assets/js/46.71975505.js"><link rel="prefetch" href="/snote/assets/js/47.403a111f.js"><link rel="prefetch" href="/snote/assets/js/48.31adab5a.js"><link rel="prefetch" href="/snote/assets/js/49.d7cdd50e.js"><link rel="prefetch" href="/snote/assets/js/50.473b8594.js"><link rel="prefetch" href="/snote/assets/js/51.f397ad1e.js"><link rel="prefetch" href="/snote/assets/js/52.d5c73839.js"><link rel="prefetch" href="/snote/assets/js/53.7ff84687.js"><link rel="prefetch" href="/snote/assets/js/54.dfe7baf8.js"><link rel="prefetch" href="/snote/assets/js/55.45ce9dfe.js"><link rel="prefetch" href="/snote/assets/js/56.99f83db0.js"><link rel="prefetch" href="/snote/assets/js/57.041b34e7.js"><link rel="prefetch" href="/snote/assets/js/58.eb1dc55f.js"><link rel="prefetch" href="/snote/assets/js/59.07e58102.js"><link rel="prefetch" href="/snote/assets/js/60.401104f8.js"><link rel="prefetch" href="/snote/assets/js/61.1f344f74.js"><link rel="prefetch" href="/snote/assets/js/62.2458973b.js"><link rel="prefetch" href="/snote/assets/js/63.3935dddc.js"><link rel="prefetch" href="/snote/assets/js/64.7ba454e7.js"><link rel="prefetch" href="/snote/assets/js/65.78e00c42.js"><link rel="prefetch" href="/snote/assets/js/66.a5035491.js"><link rel="prefetch" href="/snote/assets/js/67.d4a88243.js"><link rel="prefetch" href="/snote/assets/js/68.e5ea69d1.js"><link rel="prefetch" href="/snote/assets/js/69.0d61549e.js"><link rel="prefetch" href="/snote/assets/js/7.fef180a0.js"><link rel="prefetch" href="/snote/assets/js/70.7ebe43d7.js"><link rel="prefetch" href="/snote/assets/js/71.e9b48c2a.js"><link rel="prefetch" href="/snote/assets/js/72.fea6f5d4.js"><link rel="prefetch" href="/snote/assets/js/73.2eb66693.js"><link rel="prefetch" href="/snote/assets/js/74.bb5a4f82.js"><link rel="prefetch" href="/snote/assets/js/75.f281d576.js"><link rel="prefetch" href="/snote/assets/js/76.8d8d7aee.js"><link rel="prefetch" href="/snote/assets/js/78.65f8cc94.js"><link rel="prefetch" href="/snote/assets/js/79.bcc870ee.js"><link rel="prefetch" href="/snote/assets/js/8.c4d1827a.js"><link rel="prefetch" href="/snote/assets/js/80.7f9e4555.js"><link rel="prefetch" href="/snote/assets/js/81.96ec0bed.js"><link rel="prefetch" href="/snote/assets/js/82.070dd41d.js"><link rel="prefetch" href="/snote/assets/js/83.ebe27694.js"><link rel="prefetch" href="/snote/assets/js/84.75491c26.js"><link rel="prefetch" href="/snote/assets/js/85.714e47e1.js"><link rel="prefetch" href="/snote/assets/js/86.9d78fc9e.js"><link rel="prefetch" href="/snote/assets/js/87.08bb0110.js"><link rel="prefetch" href="/snote/assets/js/88.c6532cef.js"><link rel="prefetch" href="/snote/assets/js/89.92eaf325.js"><link rel="prefetch" href="/snote/assets/js/9.05800a53.js"><link rel="prefetch" href="/snote/assets/js/90.77ebb53b.js"><link rel="prefetch" href="/snote/assets/js/91.6c2753e5.js"><link rel="prefetch" href="/snote/assets/js/92.8ffec3d5.js"><link rel="prefetch" href="/snote/assets/js/93.f2a2ebcd.js"><link rel="prefetch" href="/snote/assets/js/94.ce688d63.js"><link rel="prefetch" href="/snote/assets/js/95.6f20e8a9.js"><link rel="prefetch" href="/snote/assets/js/96.da6970c0.js"><link rel="prefetch" href="/snote/assets/js/97.0ee9c63a.js"><link rel="prefetch" href="/snote/assets/js/98.0cd42ce4.js"><link rel="prefetch" href="/snote/assets/js/99.748348db.js">
    <link rel="stylesheet" href="/snote/assets/css/0.styles.733b32e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>snote</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>study note</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><!---->
            
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/snote/" class="home-link router-link-active"><!----> <span class="site-name">snote</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/snote/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/snote/categories/maven/" class="nav-link"><i class="undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/dev-tools/" class="nav-link"><i class="undefined"></i>
  dev-tools
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/idea/" class="nav-link"><i class="undefined"></i>
  idea
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/java-basic/" class="nav-link"><i class="undefined"></i>
  java-basic
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/java-concurrency/" class="nav-link"><i class="undefined"></i>
  java-concurrency
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/jvm/" class="nav-link"><i class="undefined"></i>
  jvm
</a></li></ul></div></div><div class="nav-item"><a href="/snote/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/snote/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><!----> <!----> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>138</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>6</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6><li class="social-item" data-v-828910c6><i class="iconfont reco-github" style="color:#f47e60;" data-v-828910c6></i></li></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/snote/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/snote/categories/maven/" class="nav-link"><i class="undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/dev-tools/" class="nav-link"><i class="undefined"></i>
  dev-tools
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/idea/" class="nav-link"><i class="undefined"></i>
  idea
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/java-basic/" class="nav-link"><i class="undefined"></i>
  java-basic
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/java-concurrency/" class="nav-link"><i class="undefined"></i>
  java-concurrency
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/jvm/" class="nav-link"><i class="undefined"></i>
  jvm
</a></li></ul></div></div><div class="nav-item"><a href="/snote/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/snote/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java Basic</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/snote/cs/backend/java/java-basic/" aria-current="page" class="sidebar-link">概览</a></li><li><a href="/snote/cs/backend/java/java-basic/00_zi-yuan-tie.html" class="sidebar-link">00_资源帖</a></li><li><a href="/snote/cs/backend/java/java-basic/01_jdkan-zhuang-ji-huan-jing-bian-liang-pei-zhi.html" class="sidebar-link">01_Jdk安装及环境变量配置</a></li><li><a href="/snote/cs/backend/java/java-basic/02_fan-she.html" class="sidebar-link">02_反射</a></li><li><a href="/snote/cs/backend/java/java-basic/03_io.html" class="sidebar-link">03_io</a></li><li><a href="/snote/cs/backend/java/java-basic/04_copyonwrite.html" class="sidebar-link">04_CopyOnWrite</a></li><li><a href="/snote/cs/backend/java/java-basic/05_dong-tai-dai-li.html" class="sidebar-link">05_动态代理</a></li><li><a href="/snote/cs/backend/java/java-basic/06_re-bu-shu-yuan-li.html" class="sidebar-link">06_热部署原理</a></li><li><a href="/snote/cs/backend/java/java-basic/07_java8.html" class="sidebar-link">07_java8</a></li><li><a href="/snote/cs/backend/java/java-basic/08_zheng-ze-biao-da-shi.html" class="sidebar-link">08_正则表达式</a></li><li><a href="/snote/cs/backend/java/java-basic/09_ye-wu-quan-qiu-hua-duo-shi-qu-de-jie-jue-si-lu.html" class="sidebar-link">09_业务全球化多时区的解决思路</a></li><li><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html" aria-current="page" class="active sidebar-link">10_Bean映射框架</a></li><li><a href="/snote/cs/backend/java/java-basic/11_zhu-jie.html" class="sidebar-link">11_注解</a></li><li><a href="/snote/cs/backend/java/java-basic/12_jsr269cha-jian-hua-zhu-jie.html" class="sidebar-link">JSR269插件化注解</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>10_Bean映射框架</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><!---->
            
          <!---->
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">10_Bean映射框架</h1> <div data-v-1ff7123e><!----> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>4/29/2021</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>java-basic</span></i></div></div> <div class="theme-reco-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#推荐阅读">推荐阅读</a></li><li><a href="#一、环境说明">一、环境说明</a></li><li><a href="#二、常见的-bean-映射框架">二、常见的 Bean 映射框架</a></li><li><a href="#三、mapstruct-使用入门">三、MapStruct 使用入门</a><ul><li><a href="#_1-引入依赖">1. 引入依赖</a></li><li><a href="#_2-类型转换规则">2. 类型转换规则</a></li><li><a href="#_3-用法示例">3. 用法示例</a></li></ul></li><li><a href="#四、jsr-269-入门示例">四、JSR 269 入门示例</a></li><li><a href="#五、javac-编译过程详解">五、Javac 编译过程详解</a><ul><li><a href="#_1-概述">1.概述</a></li><li><a href="#_2-编译的入口">2.编译的入口</a></li><li><a href="#_3-编译期-debug">3.编译期 Debug</a></li><li><a href="#_4-编译流程分析">4.编译流程分析</a></li><li><a href="#_5-相应的数据结构">5.相应的数据结构</a></li></ul></li><li><a href="#六、mapstruct-源码解析">六、MapStruct 源码解析</a><ul><li><a href="#_1-如何-debug">1.如何 Debug</a></li><li><a href="#_2-注解处理的流程">2.注解处理的流程</a></li></ul></li></ul></div><p></p> <p>[toc]</p> <h2 id="推荐阅读"><a href="#推荐阅读" class="header-anchor">#</a> 推荐阅读</h2> <p>常见的 Bean 映射框架：</p> <blockquote><ul><li><a href="https://www.cnblogs.com/harrychinese/p/SpringBoot_DTO_Orika.html" target="_blank" rel="noopener noreferrer">DTO/DO 等 POJO 对象的使用场景和 orika-mapper 框架的使用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.baeldung.com/java-performance-mapping-frameworks" target="_blank" rel="noopener noreferrer">https://www.baeldung.com/java-performance-mapping-frameworks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/135270403" target="_blank" rel="noopener noreferrer">面试官：你知道几种对象属性拷贝方式，说来看看？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.cnblogs.com/fuzongle/p/12609063.html" target="_blank" rel="noopener noreferrer">Orika 对象复制教程（完美笔记）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.cnkirito.moe/orika/" target="_blank" rel="noopener noreferrer">打开 orika 的正确方式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <p>MapStruct:</p> <blockquote><ul><li><a href="https://github.com/mapstruct/mapstruct" target="_blank" rel="noopener noreferrer">mapstruct/mapstruct<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>https://mapstruct.org/documentation/reference-guide/</li> <li><a href="http://www.kailing.pub/MapStruct1.3/index.html#Preface" target="_blank" rel="noopener noreferrer">MapStruct 1.3.0.Final 参考指南<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <p>JSR 269 与 MapStruct：</p> <blockquote><ul><li><a href="http://www.cyblogs.com/2020/05/13/2020/05/JSR269%E6%8F%92%E4%BB%B6%E5%8C%96%E6%B3%A8%E8%A7%A3API/" target="_blank" rel="noopener noreferrer">JSR269 插件化注解 API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/weixin_43983762/article/details/105867398" target="_blank" rel="noopener noreferrer">由 lombok 说起，浅析 JSR-269 原理及应用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/6844904199755415559" target="_blank" rel="noopener noreferrer">Mapstruct 源码解析- 框架实现原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <h2 id="一、环境说明"><a href="#一、环境说明" class="header-anchor">#</a> 一、环境说明</h2> <blockquote><ul><li>jdk: open-jdk-16</li></ul></blockquote> <p>最开始是用 JDK1.8，但是 Debug 的时候只能看到反编译后的代码，太痛苦了，而在 jdk9 模块化之后，tools.jar 包被放进了 java 的源码包下，所以为了方便看源码 Debug，后来又将 jdk 改成了 open-jdk-16。</p> <h2 id="二、常见的-bean-映射框架"><a href="#二、常见的-bean-映射框架" class="header-anchor">#</a> 二、常见的 Bean 映射框架</h2> <h2 id="三、mapstruct-使用入门"><a href="#三、mapstruct-使用入门" class="header-anchor">#</a> 三、MapStruct 使用入门</h2> <h3 id="_1-引入依赖"><a href="#_1-引入依赖" class="header-anchor">#</a> 1. 引入依赖</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapstruct.version</span><span class="token punctuation">&gt;</span></span>1.4.1.Final<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapstruct.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mapstruct<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mapstruct<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mapstruct.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mapstruct<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mapstruct-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mapstruct.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_2-类型转换规则"><a href="#_2-类型转换规则" class="header-anchor">#</a> 2. 类型转换规则</h3> <blockquote><ul><li>对于类型相同且是基本类型的同名属性，可以自动转换</li> <li>对于类型不同且是基本类型的同名属性，可以隐式地自动转换</li> <li>对于类型相同且是基本类型的不同名属性，可以在借助 <code>@Mapping</code> 注解进行转换</li> <li>对于类型不同的同名属性，可以使用 <code>@Mapper#use</code>来自定义类型转换器去进行转换</li> <li>对于类型不同且属性名也不相同的属性，可以结合 <code>@Mapper#use</code> 和 <code>@Mapping</code> 注解来实现类型转换</li></ul></blockquote> <h3 id="_3-用法示例"><a href="#_3-用法示例" class="header-anchor">#</a> 3. 用法示例</h3> <h4 id="_3-1-基本类型转换"><a href="#_3-1-基本类型转换" class="header-anchor">#</a> 3.1 基本类型转换</h4> <p>（1）先定义两个实体类</p> <p>对于 Bean 映射的场景，我们可以假设有个 Dto 用来映射前端请求参数，然后转成业务实体，然后进行业务逻辑的处理。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 数据传输对象,用来接收前端请求参数</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceDTO</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> resourceStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 业务实体,用于系统内部业务逻辑处理</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Resource</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> resourceCode<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> resourceStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后我们需要对这两个类进行相互转换。</p> <p>（2）定义一个 Mapper 用于这两个类型的相互转换。</p> <p>此时只需要定义如下接口，即可实现这两个类型的相互转换。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ResourceConverter</span> <span class="token punctuation">{</span>

    <span class="token class-name">ResourceConverter</span> INSTANCE <span class="token operator">=</span> <span class="token class-name">Mappers</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">ResourceConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Mapping</span><span class="token punctuation">(</span>source <span class="token operator">=</span> <span class="token string">&quot;resourceCode&quot;</span><span class="token punctuation">,</span> target <span class="token operator">=</span> <span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">ResourceDTO</span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Mapping</span><span class="token punctuation">(</span>source <span class="token operator">=</span> <span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> target <span class="token operator">=</span> <span class="token string">&quot;resourceCode&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Resource</span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token class-name">ResourceDTO</span> dto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>（3）测试用例</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceConverterTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token function">mockResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResourceDTO</span> resourceDTO <span class="token operator">=</span> <span class="token class-name">ResourceConverter</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">toD</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resourceDTO<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ResourceDTO(id=1, code=/api/user/list, resourceStatus=true)</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>resourceDTO<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token function">mockResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResourceDTO</span> resourceDTO <span class="token operator">=</span> <span class="token class-name">ResourceConverter</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">toD</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>

        resource <span class="token operator">=</span> <span class="token class-name">ResourceConverter</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">toE</span><span class="token punctuation">(</span>resourceDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Resource(id=1, resourceCode=/api/user/list, resourceStatus=true)</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getResourceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Resource</span> <span class="token function">mockResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resource<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resource<span class="token punctuation">.</span><span class="token function">setResourceCode</span><span class="token punctuation">(</span><span class="token string">&quot;/api/user/list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resource<span class="token punctuation">.</span><span class="token function">setResourceStatus</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> resource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>（4）分析</p> <blockquote><ul><li><code>resourceStatus</code> ：类型相同且是基本类型，属性名相同，可以自动转换</li> <li><code>id</code>：类型不同且是基本类型，属性名相同，可以自动隐式转换</li> <li><code>resourceCode</code>：类型相同且是基本类型，但是属性名不相同，可以借助 <code>@Mapping</code> 注解进行转换</li></ul></blockquote> <h4 id="_3-2-不同类型转换"><a href="#_3-2-不同类型转换" class="header-anchor">#</a> 3.2 不同类型转换</h4> <p>（1）先来看一个简单的同名属性且是基本类型的例子</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleDTO</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> roleId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> roleCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Role</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> roleId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> roleCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>先通过 BaseConverter 接口来定义两个类型之间的相互转换：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BaseConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">,</span> <span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">D</span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">E</span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token class-name">D</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然后通过 <code>RoleConverter</code> 即可实现 RoleDto 和 Role 的相互转换</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Mapper</span><span class="token punctuation">(</span><span class="token keyword">uses</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> unmappedTargetPolicy <span class="token operator">=</span> <span class="token class-name">ReportingPolicy</span><span class="token punctuation">.</span>IGNORE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RoleConverter</span> <span class="token keyword">extends</span> <span class="token class-name">BaseConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleDTO</span><span class="token punctuation">,</span> <span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">RoleConverter</span> INSTANCE <span class="token operator">=</span> <span class="token class-name">Mappers</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">RoleConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>编译时，会生成接口 RoleConverter 的实现类，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Generated</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token string">&quot;org.mapstruct.ap.MappingProcessor&quot;</span><span class="token punctuation">,</span>
    date <span class="token operator">=</span> <span class="token string">&quot;2021-05-26T17:24:27+0800&quot;</span><span class="token punctuation">,</span>
    comments <span class="token operator">=</span> <span class="token string">&quot;version: 1.4.1.Final, compiler: javac, environment: Java 1.8.0_181 (Oracle Corporation)&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleConverterImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RoleConverter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Role</span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token class-name">RoleDTO</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> e <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Role</span> role <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Role</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        role<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">getRoleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        role<span class="token punctuation">.</span><span class="token function">setRoleCode</span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">getRoleCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> role<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RoleDTO</span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token class-name">Role</span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> d <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">RoleDTO</span> roleDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoleDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        roleDTO<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">getRoleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        roleDTO<span class="token punctuation">.</span><span class="token function">setRoleCode</span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">getRoleCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> roleDTO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleDTO</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> e <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">RoleDTO</span> roleDTO <span class="token operator">:</span> e <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> <span class="token function">toD</span><span class="token punctuation">(</span> roleDTO <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> d <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleDTO</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleDTO</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">Role</span> role <span class="token operator">:</span> d <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> <span class="token function">toE</span><span class="token punctuation">(</span> role <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>测试用例如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleConverterTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Role</span> role <span class="token operator">=</span> <span class="token function">mockRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RoleDTO</span> roleDTO <span class="token operator">=</span> <span class="token class-name">RoleConverter</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">toE</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>roleDTO<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// RoleDTO(roleId=1, roleCode=ADMIN)</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>roleDTO<span class="token punctuation">.</span><span class="token function">getRoleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testToD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> <span class="token function">mockRoleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleDTO</span><span class="token punctuation">&gt;</span></span> roleDTOS <span class="token operator">=</span> <span class="token class-name">RoleConverter</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">toE</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>roleDTOS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [RoleDTO(roleId=1, roleCode=ADMIN)]</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> roleDTOS<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testToE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> <span class="token function">mockRoleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        roles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">mockRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> roles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Role</span> <span class="token function">mockRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Role</span> role <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Role</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        role<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        role<span class="token punctuation">.</span><span class="token function">setRoleCode</span><span class="token punctuation">(</span><span class="token string">&quot;ADMIN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> role<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>（2）然后对于复杂类型和不同类型的转换示例如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDTO</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> userStatus<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> createTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleDTO</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> userStatus<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>然后定义一个 Date 和 Long 的类型转换器来帮助 createTime 进行类型转换</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DateMapper</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">asLong</span><span class="token punctuation">(</span><span class="token class-name">Date</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> date <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">asDate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> date <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然后对于 RoleDTO 和 Role ，可以借助前面定义的 <code>RoleConverter</code> 去进行转换，因此我们得到 UserDTO 和 User 的转换器：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Mapper</span><span class="token punctuation">(</span><span class="token keyword">uses</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">DateMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">RoleConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> unmappedTargetPolicy <span class="token operator">=</span> <span class="token class-name">ReportingPolicy</span><span class="token punctuation">.</span>IGNORE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserConverter</span> <span class="token keyword">extends</span> <span class="token class-name">BaseConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">UserConverter</span> INSTANCE <span class="token operator">=</span> <span class="token class-name">Mappers</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到编译会生成如下实现类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Generated</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token string">&quot;org.mapstruct.ap.MappingProcessor&quot;</span><span class="token punctuation">,</span>
    date <span class="token operator">=</span> <span class="token string">&quot;2021-05-26T17:24:27+0800&quot;</span><span class="token punctuation">,</span>
    comments <span class="token operator">=</span> <span class="token string">&quot;version: 1.4.1.Final, compiler: javac, environment: Java 1.8.0_181 (Oracle Corporation)&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserConverterImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserConverter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DateMapper</span> dateMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RoleConverter</span> roleConverter <span class="token operator">=</span> <span class="token class-name">Mappers</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span> <span class="token class-name">RoleConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token class-name">UserDTO</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> e <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUserStatus</span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">getUserStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span> dateMapper<span class="token punctuation">.</span><span class="token function">asDate</span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setRoles</span><span class="token punctuation">(</span> roleConverter<span class="token punctuation">.</span><span class="token function">toD</span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDTO</span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token class-name">User</span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> d <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        userDTO<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        userDTO<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        userDTO<span class="token punctuation">.</span><span class="token function">setUserStatus</span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">getUserStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        userDTO<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span> dateMapper<span class="token punctuation">.</span><span class="token function">asLong</span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        userDTO<span class="token punctuation">.</span><span class="token function">setRoles</span><span class="token punctuation">(</span> roleConverter<span class="token punctuation">.</span><span class="token function">toE</span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> userDTO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> e <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span> e<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">UserDTO</span> userDTO <span class="token operator">:</span> e <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> <span class="token function">toD</span><span class="token punctuation">(</span> userDTO <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> d <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span> d<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">User</span> user <span class="token operator">:</span> d <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> <span class="token function">toE</span><span class="token punctuation">(</span> user <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>测试用例如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserConverterTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">mockUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">UserConverter</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">toE</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UserDTO(id=1, userName=tom, userStatus=true, createTime=1622030464158, roles=[RoleDTO(roleId=1, roleCode=ADMIN)])</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testToD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testToE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">User</span> <span class="token function">mockUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        roles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">mockRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">&quot;tom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUserStatus</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setRoles</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Role</span> <span class="token function">mockRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Role</span> role <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Role</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        role<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        role<span class="token punctuation">.</span><span class="token function">setRoleCode</span><span class="token punctuation">(</span><span class="token string">&quot;ADMIN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> role<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>分析：</p> <blockquote><ul><li><code>createTime</code>：类型不同的同名属性，可以使用 <code>@Mapper#use</code>来自定义类型转换器去进行转换</li> <li><code>roles</code>：类型不同的同名属性，可以使用 <code>@Mapper#use</code>来自定义类型转换器去进行转换</li></ul></blockquote> <h2 id="四、jsr-269-入门示例"><a href="#四、jsr-269-入门示例" class="header-anchor">#</a> 四、JSR 269 入门示例</h2> <p>推荐阅读：</p> <blockquote><ul><li><a href="https://lilu.org.cn/2020/12/19/javaee/lombok/impl-simple-lombok/" target="_blank" rel="noopener noreferrer">动手实现 Lombok<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://liuyehcf.github.io/2018/02/02/Java-JSR-269-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8/" target="_blank" rel="noopener noreferrer">Java-JSR-269-插入式注解处理器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://nicky-chin.cn/2019/05/03/apt_lombok_implement/" target="_blank" rel="noopener noreferrer">基于 APT(注解处理器)实现 Lombok 的@getter @setter @toString 功能<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://mouse0w0.github.io/2018/11/28/Introduce-to-Pluggable-Annotation-Processing-API/" target="_blank" rel="noopener noreferrer">插入式注解处理 API（JSR269）介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>https://jcp.org/en/jsr/detail?id=269</li> <li><a href="https://blog.csdn.net/justry_deng/article/details/106176181" target="_blank" rel="noopener noreferrer">【JSR269 实战】之编译时操作 AST，修改字节码文件，以实现和 lombok 类似的功能<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://pfmiles.github.io/blog/dynamic-java/" target="_blank" rel="noopener noreferrer">动态的 Java - 无废话 JavaCompilerAPI 中文指南<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.cnblogs.com/wade-luffy/p/6050331.html" target="_blank" rel="noopener noreferrer">Javac 早期(编译期)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <h2 id="五、javac-编译过程详解"><a href="#五、javac-编译过程详解" class="header-anchor">#</a> 五、Javac 编译过程详解</h2> <p>推荐阅读：</p> <blockquote><ul><li><a href="http://65.49.135.49/geek/geek/144-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AE%9E%E6%88%98%E8%AF%BE/10%E4%B8%A8Java%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%8E%EF%BC%8C%E8%BF%98%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88%EF%BC%9F.html" target="_blank" rel="noopener noreferrer">10 | Java 编译器（二）：语法分析之后，还要做些什么？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="dsd">《深入理解 JVM 虚拟机》</a></li> <li><a href="dsdsd">《深入解析 Java 编译器》</a></li></ul></blockquote> <h3 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1.概述</h3> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="560px" preserveAspectRatio="none" version="1.1" viewBox="0 0 549 560" width="549px" zoomAndPan="magnify" style="width:549px;height:560px;"><defs><filter height="300%" id="fk27y0btfff4i" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FFFFFF" filter="url(#fk27y0btfff4i)" height="222" width="299" x="30" y="101" style="stroke:#000000;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="75" x="142" y="117.5332">前端编译器</text><rect fill="#FEFECE" filter="url(#fk27y0btfff4i)" height="37.6094" width="132" x="54" y="145" style="stroke:#000000;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="64" y="169.5332">解析与填充符号表</text><rect fill="#FEFECE" filter="url(#fk27y0btfff4i)" height="37.6094" width="76" x="54" y="261" style="stroke:#000000;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="64" y="285.5332">注解处理</text><rect fill="#FEFECE" filter="url(#fk27y0btfff4i)" height="37.6094" width="132" x="165" y="261" style="stroke:#000000;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="175" y="285.5332">分析与字节码生产</text><polygon fill="#FEFECE" filter="url(#fk27y0btfff4i)" points="403,8,403,45.6094,453,45.6094,453,18,443,8,403,8" style="stroke:#000000;stroke-width:1.5;"></polygon><path d="M443,8 L443,18 L453,18 " fill="#FEFECE" style="stroke:#000000;stroke-width:1.5;"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="413" y="32.5332">.java</text><polygon fill="#FEFECE" filter="url(#fk27y0btfff4i)" points="353,261,353,298.6094,409,298.6094,409,271,399,261,353,261" style="stroke:#000000;stroke-width:1.5;"></polygon><path d="M399,261 L399,271 L409,271 " fill="#FEFECE" style="stroke:#000000;stroke-width:1.5;"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="36" x="363" y="285.5332">.class</text><polygon fill="#FEFECE" filter="url(#fk27y0btfff4i)" points="351,511,351,548.6094,455,548.6094,455,521,445,511,351,511" style="stroke:#000000;stroke-width:1.5;"></polygon><path d="M445,511 L445,521 L455,521 " fill="#FEFECE" style="stroke:#000000;stroke-width:1.5;"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="84" x="361" y="535.5332">二进制机器码</text><rect fill="#FEFECE" filter="url(#fk27y0btfff4i)" height="37.6094" width="90" x="225" y="395" style="stroke:#000000;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="235" y="419.5332">即时编译器</text><rect fill="#FEFECE" filter="url(#fk27y0btfff4i)" height="37.6094" width="91" x="447.5" y="395" style="stroke:#000000;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="457.5" y="419.5332">AOT编译器</text><rect fill="#FEFECE" filter="url(#fk27y0btfff4i)" height="37.6094" width="62" x="350" y="395" style="stroke:#000000;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="360" y="419.5332">解释器</text><path d="M115.563,183.064 C110.738,202.709 103.0095,234.176 97.7287,255.676 " fill="none" id="ParseAndEnter-&gt;AnnotationProcessing" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="96.5086,260.643,102.5403,252.8572,97.7015,255.7874,94.7713,250.9486,96.5086,260.643" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M130.008,280 C139.862,280 149.716,280 159.571,280 " fill="none" id="AnnotationProcessing-&gt;AnalyseAndGenerate" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="164.724,280,155.724,276,159.724,280,155.724,284,164.724,280" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M413.57,46.207 C399.1945,64.3435 376.545,92.9198 357.2486,117.2656 C347.6004,129.4386 338.7905,140.5539 332.2723,148.7779 C331.4575,149.8059 330.6785,150.7887 329.9382,151.7228 C329.7531,151.9563 329.5705,152.1868 329.3903,152.4141 C329.3002,152.5278 329.2107,152.6407 329.1218,152.7528 " fill="none" id="javaFile-&gt;JavacCompiler" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="329.1218,152.7528,337.8469,148.1842,332.2275,148.8344,331.5773,143.215,329.1218,152.7528" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M329.0947,180.3801 C329.1526,180.4901 329.2107,180.6006 329.2691,180.7115 C330.2031,182.486 331.1978,184.3758 332.2431,186.362 C334.3339,190.3343 336.6276,194.6923 339.0451,199.2855 C348.7152,217.6585 360.3665,239.796 368.934,256.075 " fill="none" id="JavacCompiler-&gt;classFile" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="371.368,260.7,370.716,250.8728,369.0393,256.2754,363.6366,254.5987,371.368,260.7" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="356" y="227.4951">编译</text><path d="M365.799,299.077 C345.734,322.937 310.425,364.927 288.734,390.722 " fill="none" id="classFile-&gt;JITCompiler" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="285.374,394.717,294.2288,390.4052,288.5929,390.8909,288.1071,385.255,285.374,394.717" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M291.074,433.064 C314.574,453.2067 352.572,485.7763 377.671,507.2892 " fill="none" id="JITCompiler-&gt;MachineCodeFile" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="381.584,510.6434,377.3543,501.749,377.7879,507.3893,372.1477,507.8228,381.584,510.6434" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="346" y="477.4951">编译</text><path d="M431.048,46.053 C441.689,109.08 477.185,319.325 489.078,389.77 " fill="none" id="javaFile-&gt;AOTCompiler" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="489.959,394.986,492.4066,385.4461,489.1275,390.0556,484.518,386.7765,489.959,394.986" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M478.739,433.064 C463.033,452.958 437.757,484.974 420.773,506.4874 " fill="none" id="AOTCompiler-&gt;MachineCodeFile" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="417.492,510.6434,426.2083,506.0581,420.5902,506.719,419.9293,501.1009,417.492,510.6434" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M381,299.077 C381,322.545 381,363.55 381,389.435 " fill="none" id="classFile-&gt;Interpreter" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="381,394.717,385,385.717,381,389.717,377,385.717,381,394.717" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="382" y="361.4951">解释执行</text></g></svg><p>Java 语言的“编译期”其实是一段“不确定”的操作过程，因为它可能是指一个前端编译器（其实叫“编译器的前端”更准确一些）把*.java 文件转变成*.class 文件的过程；也可能是指虚拟机的后端运行期编译器（JIT 编译器，Just In Time Compiler）把字节码转变成机器码的过程；还可能是指使用静态提前编译器（AOT 编译器，Ahead Of Time Compiler）直接把*.java 文件编译成本地机器代码的过程。</p> <p>下面列举了这 3 类编译过程中一些比较有代表性的编译器。</p> <blockquote><ul><li>前端编译器：Sun 的 Javac、Eclipse JDT 中的增量式编译器（ECJ）。</li> <li>JIT 编译器：HotSpot VM 的 C1、C2 编译器。</li> <li>AOT 编译器：GNU Compiler for the Java（GCJ）、Excelsior JET。</li></ul></blockquote> <p>Javac 编译器的编译过程大致如下：</p> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="811px" preserveAspectRatio="none" version="1.1" viewBox="0 0 193 811" width="193px" zoomAndPan="magnify" style="width:193px;height:811px;"><defs><filter height="300%" id="f1c0ug356lmj6u" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><ellipse cx="96" cy="20" fill="#000000" filter="url(#f1c0ug356lmj6u)" rx="10" ry="10" style="stroke:none;stroke-width:1.0;"></ellipse><rect fill="#FFFFFF" filter="url(#f1c0ug356lmj6u)" height="294.4902" width="132" x="34" y="40.5762" style="stroke:#000000;stroke-width:2.0;"></rect><path d="M156,41.5762 L156,51.1855 L146,61.1855 L34,61.1855 " fill="none" style="stroke:#000000;stroke-width:2.0;"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="37" y="56.1094">解析与填充符号表</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="68" x="62" y="78.1855" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="48" x="72" y="100.6426">程序源码</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="56" x="68" y="155.5322" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="36" x="78" y="177.9893">单词流</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="80" x="56" y="232.8789" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="60" x="66" y="255.3359">抽象语法树</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="80" x="56" y="287.9727" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="60" x="66" y="310.4297">填充符号表</text><rect fill="#FFFFFF" filter="url(#f1c0ug356lmj6u)" height="194.8906" width="172" x="10" y="345.0664" style="stroke:#000000;stroke-width:2.0;"></rect><path d="M76,346.0664 L76,355.6758 L66,365.6758 L10,365.6758 " fill="none" style="stroke:#000000;stroke-width:2.0;"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="13" y="360.5996">注解处理</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="152" x="20" y="382.6758" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="132" x="30" y="405.1328">初始化插入式注解处理器</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="68" x="62" y="437.7695" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="48" x="72" y="460.2266">获取注解</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="152" x="20" y="492.8633" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="132" x="30" y="515.3203">调用注解处理器处理注解</text><rect fill="#FFFFFF" filter="url(#f1c0ug356lmj6u)" height="249.9844" width="160" x="16" y="550.5332" style="stroke:#000000;stroke-width:2.0;"></rect><path d="M166,551.5332 L166,561.1426 L156,571.1426 L16,571.1426 " fill="none" style="stroke:#000000;stroke-width:2.0;"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="140" x="19" y="566.0664">语义分析与字节码生成</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="68" x="62" y="588.1426" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="48" x="72" y="610.5996">标注检查</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="128" x="32" y="643.2363" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="108" x="42" y="665.6934">数据与流程控制分析</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="68" x="62" y="698.3301" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="48" x="72" y="720.7871">解语法糖</text><rect fill="#FEFECE" filter="url(#f1c0ug356lmj6u)" height="35.0938" rx="12.5" ry="12.5" width="80" x="56" y="753.4238" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="60" x="66" y="775.8809">字节码生成</text><line x1="96" x2="96" y1="113.2793" y2="155.5322" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,145.5322,96,155.5322,100,145.5322,96,149.5322" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="100" y="135.6152">词法分析</text><line x1="96" x2="96" y1="190.626" y2="232.8789" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,222.8789,96,232.8789,100,222.8789,96,226.8789" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="100" y="212.9619">语法分析</text><line x1="96" x2="96" y1="267.9727" y2="287.9727" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,277.9727,96,287.9727,100,277.9727,96,281.9727" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="96" x2="96" y1="30" y2="78.1855" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,68.1855,96,78.1855,100,68.1855,96,72.1855" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="96" x2="96" y1="417.7695" y2="437.7695" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,427.7695,96,437.7695,100,427.7695,96,431.7695" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="96" x2="96" y1="472.8633" y2="492.8633" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,482.8633,96,492.8633,100,482.8633,96,486.8633" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="96" x2="96" y1="323.0664" y2="382.6758" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,372.6758,96,382.6758,100,372.6758,96,376.6758" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="96" x2="96" y1="623.2363" y2="643.2363" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,633.2363,96,643.2363,100,633.2363,96,637.2363" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="96" x2="96" y1="678.3301" y2="698.3301" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,688.3301,96,698.3301,100,688.3301,96,692.3301" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="96" x2="96" y1="733.4238" y2="753.4238" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,743.4238,96,753.4238,100,743.4238,96,747.4238" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="96" x2="96" y1="527.957" y2="588.1426" style="stroke:#A80036;stroke-width:1.5;"></line><polygon fill="#A80036" points="92,578.1426,96,588.1426,100,578.1426,96,582.1426" style="stroke:#A80036;stroke-width:1.0;"></polygon></g></svg><p>整个流程对应这个<code>com.sun.tools.javac.comp.CompileStates</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
 <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">CompileState</span> <span class="token punctuation">{</span>
        <span class="token function">INIT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">//初始化</span>
        <span class="token function">PARSE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">//词法和语法分析</span>
        <span class="token function">ENTER</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">//建立符号表</span>
        <span class="token function">PROCESS</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//处理注解</span>
        <span class="token function">ATTR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">//属性计算</span>
        <span class="token function">FLOW</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">//数据流分析</span>
        <span class="token function">TRANSTYPES</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">//去除语法糖：泛型处理</span>
        <span class="token function">TRANSPATTERNS</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//去除语法糖：模式匹配处理</span>
        <span class="token function">UNLAMBDA</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">//去除语法糖：Lambda表达式处理(转换成方法)</span>
        <span class="token function">LOWER</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">//去除语法糖：内部类、foreach循环、断言等</span>
        <span class="token function">GENERATE</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//生成字节码</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_2-编译的入口"><a href="#_2-编译的入口" class="header-anchor">#</a> 2.编译的入口</h3> <p>（1）通过 <code>com.sun.tools.javac.Main</code> 来编译 java 文件</p> <blockquote><ul><li>参考： <a href="https://www.cnblogs.com/huaweiyun/p/13071560.html" target="_blank" rel="noopener noreferrer">程序员实用 JDK 小工具归纳，工作用得到<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <p>javac 命令是收录于 JDK 中的 Java 语言编译器，可以将后缀名为.java 的源文件编译为后缀名为.class 的可以运行于 Java 虚拟机的字节码文件。比如有如下 java 源文件：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//Hello.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;invoke test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以通过 javac 命令来编译.java 源文件文件得到.class 字节码文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>javac Hello.java
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>而当我们在命令行使用 javac 命令来编译 Java 文件时，实际上内部是调用的 <code>%JAVA_HOME%/lib/tools.jar</code>（在 Java9 之后，直接被包含在 Java 的 src，而不是以扩展 jar 包的形式引用）的<code>com.sun.tools.javac.Main#main</code>方法来启动编译过程，所以我们也可以通过如下方法来编译源文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>java -cp tools.jar com.sun.tools.javac.Main Hello.java
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>两者等效，都可以编译源文件</p> <p>（2）编译的入口为 JavaCompiler</p> <p>这里以 Javac 命令为例，程序首先会进入到 <code>com.sun.tools.javac.Main#main</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// com.sun.tools.javac.Main</span>
<span class="token annotation punctuation">@Exported</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这就是一个正常的main方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var0<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token function">compile</span><span class="token punctuation">(</span>var0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>javac<span class="token punctuation">.</span>main<span class="token punctuation">.</span></span>Main</span> var1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>javac<span class="token punctuation">.</span>main<span class="token punctuation">.</span></span>Main</span><span class="token punctuation">(</span><span class="token string">&quot;javac&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>var0<span class="token punctuation">)</span><span class="token punctuation">.</span>exitCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var0<span class="token punctuation">,</span> <span class="token class-name">PrintWriter</span> var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>javac<span class="token punctuation">.</span>main<span class="token punctuation">.</span></span>Main</span> var2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>javac<span class="token punctuation">.</span>main<span class="token punctuation">.</span></span>Main</span><span class="token punctuation">(</span><span class="token string">&quot;javac&quot;</span><span class="token punctuation">,</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> var2<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>var0<span class="token punctuation">)</span><span class="token punctuation">.</span>exitCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>然后会经过 <code>com.sun.tools.javac.main.Main#compile</code>方法，在此方法中会调用 <code>com.sun.tools.javac.main.JavaCompiler#compile</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * Main method: compile a list of files, return all compiled classes
     *
     * @param sourceFileObjects file objects to be compiled
     * @param classnames class names to process for annotations
     * @param processors user provided annotation processors to bypass
     * discovery, {@code null} means that no processors were provided
     * @param addModules additional root modules to be used during
     * module resolution.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JavaFileObject</span><span class="token punctuation">&gt;</span></span> sourceFileObjects<span class="token punctuation">,</span>
                        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> classnames<span class="token punctuation">,</span>
                        <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Processor</span><span class="token punctuation">&gt;</span></span> processors<span class="token punctuation">,</span>
                        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> addModules<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 准备过程：初始化插入式注解处理器，最终是通过ServiceLoader获取所有Processor.class的实现类</span>
        <span class="token function">initProcessAnnotations</span><span class="token punctuation">(</span>processors<span class="token punctuation">,</span> sourceFileObjects<span class="token punctuation">,</span> classnames<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// These method calls must be chained to avoid memory leaks</span>
        <span class="token comment">// 2. 执行注解处理</span>
        <span class="token function">processAnnotations</span><span class="token punctuation">(</span>
            <span class="token comment">// 1.2 填充符号表</span>
            <span class="token function">enterTrees</span><span class="token punctuation">(</span>
                    <span class="token function">stopIfError</span><span class="token punctuation">(</span><span class="token class-name">CompileState</span><span class="token punctuation">.</span>ENTER<span class="token punctuation">,</span>
                            <span class="token function">initModules</span><span class="token punctuation">(</span><span class="token function">stopIfError</span><span class="token punctuation">(</span><span class="token class-name">CompileState</span><span class="token punctuation">.</span>ENTER<span class="token punctuation">,</span>
                                <span class="token comment">// 1.1 词法分析、语法分析，从而构建出一棵AST抽象语法树，sourceFileObjects即为Java源文件在内存中的表示</span>
                                <span class="token function">parseFiles</span><span class="token punctuation">(</span>sourceFileObjects<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            classnames
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CompileState</span><span class="token punctuation">.</span>ATTR<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>shouldStopPolicyIfNoError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>compilePolicy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">case</span> BY_TODO<span class="token operator">:</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>todo<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment">// 3.语义分析及字节码生成</span>
                    <span class="token function">generate</span><span class="token punctuation">(</span><span class="token function">desugar</span><span class="token punctuation">(</span><span class="token function">flow</span><span class="token punctuation">(</span><span class="token function">attribute</span><span class="token punctuation">(</span>todo<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>若是在其他情况下，如 Maven、Idea、Eclipse 等的编译，可能会通过调用<code>com.sun.tools.javac.api.JavacTaskImpl</code>而最终进入到<code>com.sun.tools.javac.main.JavaCompiler#compile</code>，也就是说，JavaCompiler 就是编译的入口。</p> <h3 id="_3-编译期-debug"><a href="#_3-编译期-debug" class="header-anchor">#</a> 3.编译期 Debug</h3> <p>运行期的 Debug 我们都会，那么如何进行编译期的 Debug？可以借助 Maven 实现，如下所示：</p> <p>（1）在指定项目下，执行 <code>mvnDebug clean compile</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ mvnDebug clean compile
Preparing to execute Maven <span class="token keyword">in</span> debug mode
Listening <span class="token keyword">for</span> transport dt_socket at address: <span class="token number">8000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>(2) 然后在 Idea 中, 创建一个 <code>Remote JVM Debug</code>, 并指定端口为前面的 <code>8000</code></p> <p><img src="/snote/assets/img/image-20210528152918591.6c3afeed.png" alt="image-20210528152918591"></p> <p>然后以 Debug 方式运行</p> <h3 id="_4-编译流程分析"><a href="#_4-编译流程分析" class="header-anchor">#</a> 4.编译流程分析</h3> <h4 id="_4-1-解析与填充符号表"><a href="#_4-1-解析与填充符号表" class="header-anchor">#</a> 4.1 解析与填充符号表</h4> <h5 id="_4-1-1-词法分析"><a href="#_4-1-1-词法分析" class="header-anchor">#</a> 4.1.1 词法分析</h5> <p>词法分析是将源代码的字符流转变为 Token 集合，单个字符是程序编写过程的最小元素，而 Token 则是编译过程的最小元素，关键字、变量名、字面量、运算符都可以成为 Token。</p> <p>词法、语法分析的入口为 parseFiles：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCCompilationUnit</span><span class="token punctuation">&gt;</span></span> <span class="token function">parseFiles</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JavaFileObject</span><span class="token punctuation">&gt;</span></span> fileObjects<span class="token punctuation">,</span> <span class="token keyword">boolean</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force <span class="token operator">&amp;&amp;</span> <span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token class-name">CompileState</span><span class="token punctuation">.</span>PARSE<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 解析所有java源文件，然后转换成AST先后向语法树, JCCompilationUnit继承自JCTree，即为抽象语法树</span>
        <span class="token comment">//parse all files</span>
        <span class="token class-name">ListBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCCompilationUnit</span><span class="token punctuation">&gt;</span></span> trees <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JavaFileObject</span><span class="token punctuation">&gt;</span></span> filesSoFar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JavaFileObject</span> fileObject <span class="token operator">:</span> fileObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filesSoFar<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>fileObject<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                filesSoFar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fileObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 解析源文件</span>
                trees<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span>fileObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> trees<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JCTree<span class="token punctuation">.</span>JCCompilationUnit</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">JavaFileObject</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JavaFileObject</span> prev <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">useSource</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 此处 readSource 会获取源文件的源码内容</span>
            <span class="token class-name">JCTree<span class="token punctuation">.</span>JCCompilationUnit</span> t <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token function">readSource</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>endPositions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                log<span class="token punctuation">.</span><span class="token function">setEndPosTable</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> t<span class="token punctuation">.</span>endPositions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">useSource</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">JCCompilationUnit</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">JavaFileObject</span> filename<span class="token punctuation">,</span> <span class="token class-name">CharSequence</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> msec <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JCCompilationUnit</span> tree <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">make<span class="token punctuation">.</span></span>TopLevel</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>content <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>verbose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">printVerbose</span><span class="token punctuation">(</span><span class="token string">&quot;parsing.started&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>taskListener<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">TaskEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskEvent</span><span class="token punctuation">(</span><span class="token class-name">TaskEvent<span class="token punctuation">.</span>Kind</span><span class="token punctuation">.</span>PARSE<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
                taskListener<span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                keepComments <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                genEndPos <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 在构造 JavacParser 的时候会通过 com.sun.tools.javac.parser.Scanner 进行词法分析</span>
            <span class="token class-name">Parser</span> parser <span class="token operator">=</span> parserFactory<span class="token punctuation">.</span><span class="token function">newParser</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token function">keepComments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> genEndPos<span class="token punctuation">,</span>
                                lineDebugInfo<span class="token punctuation">,</span> filename<span class="token punctuation">.</span><span class="token function">isNameCompatible</span><span class="token punctuation">(</span><span class="token string">&quot;module-info&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Kind</span><span class="token punctuation">.</span>SOURCE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 语法分析：通过JavacParser进行语法分析，得到AST抽象语法树</span>
            tree <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseCompilationUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>verbose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">printVerbose</span><span class="token punctuation">(</span><span class="token string">&quot;parsing.done&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">elapsed</span><span class="token punctuation">(</span>msec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        tree<span class="token punctuation">.</span>sourcefile <span class="token operator">=</span> filename<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>content <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>taskListener<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TaskEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskEvent</span><span class="token punctuation">(</span><span class="token class-name">TaskEvent<span class="token punctuation">.</span>Kind</span><span class="token punctuation">.</span>PARSE<span class="token punctuation">,</span> tree<span class="token punctuation">)</span><span class="token punctuation">;</span>
            taskListener<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> tree<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>在构造 Parser 的时候会进行词法分析：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParserFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">JavacParser</span> <span class="token function">newParser</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> input<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepDocComments<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepEndPos<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepLineMap<span class="token punctuation">,</span> <span class="token keyword">boolean</span> parseModuleInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 构造一个词法分析器Lexer，其实现类为`com.sun.tools.javac.parser.Scanner`</span>
        <span class="token class-name">Lexer</span> lexer <span class="token operator">=</span> scannerFactory<span class="token punctuation">.</span><span class="token function">newScanner</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> keepDocComments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 在 JavacParser 的构造方法中会进行词法分析</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JavacParser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> lexer<span class="token punctuation">,</span> keepDocComments<span class="token punctuation">,</span> keepLineMap<span class="token punctuation">,</span> keepEndPos<span class="token punctuation">,</span> parseModuleInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>先构造一个词法分析器 Lexer，其实现类为<code>com.sun.tools.javac.parser.Scanner</code>，其结构如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Scanner</span> <span class="token keyword">implements</span> <span class="token class-name">Lexer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Tokens</span> tokens<span class="token punctuation">;</span>

    <span class="token comment">/** The token, set by nextToken().
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Token</span> token<span class="token punctuation">;</span>

    <span class="token comment">/** The previous token, set by nextToken().
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Token</span> prevToken<span class="token punctuation">;</span>

    <span class="token comment">/** Buffer of saved tokens (used during lookahead)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Token</span><span class="token punctuation">&gt;</span></span> savedTokens <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">JavaTokenizer</span> tokenizer<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prevToken <span class="token operator">=</span> token<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>savedTokens<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            token <span class="token operator">=</span> savedTokens<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            token <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span><span class="token function">readToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Token</span> <span class="token punctuation">{</span>

    <span class="token comment">/** tags constants **/</span>
    <span class="token keyword">enum</span> <span class="token class-name">Tag</span> <span class="token punctuation">{</span>
        DEFAULT<span class="token punctuation">,</span>
        NAMED<span class="token punctuation">,</span>
        STRING<span class="token punctuation">,</span>
        NUMERIC<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** The token kind */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">TokenKind</span> kind<span class="token punctuation">;</span>

    <span class="token comment">/** The start position of this token */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> pos<span class="token punctuation">;</span>

    <span class="token comment">/** The end position of this token */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> endPos<span class="token punctuation">;</span>

    <span class="token comment">/** Comment reader associated with this token */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> comments<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tokens</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Names</span> names<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Keyword array. Maps name indices to Token.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TokenKind</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">;</span>

    <span class="token comment">/**  The number of the last entered keyword.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxKey <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/** The names of all tokens.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Name</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokenName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Name</span><span class="token punctuation">[</span><span class="token class-name">TokenKind</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p>在 JavacParser 的构造方法中，会使用 JavaTokenizer 进行词法分析，从而得到 Token 集合</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavacParser</span> <span class="token keyword">implements</span> <span class="token class-name">Parser</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">JavacParser</span><span class="token punctuation">(</span><span class="token class-name">ParserFactory</span> fac<span class="token punctuation">,</span>
                     <span class="token class-name">Lexer</span> <span class="token class-name">S</span><span class="token punctuation">,</span>
                     <span class="token keyword">boolean</span> keepDocComments<span class="token punctuation">,</span>
                     <span class="token keyword">boolean</span> keepLineMap<span class="token punctuation">,</span>
                     <span class="token keyword">boolean</span> keepEndPositions<span class="token punctuation">,</span>
                     <span class="token keyword">boolean</span> parseModuleInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>S</span> <span class="token operator">=</span> <span class="token class-name">S</span><span class="token punctuation">;</span>
        <span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prime the pump</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">S</span><span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        token <span class="token operator">=</span> <span class="token class-name">S</span><span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Scanner</span> <span class="token keyword">implements</span> <span class="token class-name">Lexer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Tokens</span> tokens<span class="token punctuation">;</span>

    <span class="token comment">/** The token, set by nextToken().
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Token</span> token<span class="token punctuation">;</span>

    <span class="token comment">/** The previous token, set by nextToken().
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Token</span> prevToken<span class="token punctuation">;</span>

    <span class="token comment">/** Buffer of saved tokens (used during lookahead)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Token</span><span class="token punctuation">&gt;</span></span> savedTokens <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">JavaTokenizer</span> tokenizer<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prevToken <span class="token operator">=</span> token<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>savedTokens<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            token <span class="token operator">=</span> savedTokens<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 词法分析，获取token集合</span>
            token <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span><span class="token function">readToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>JavaTokenizer 中存储了源码的字符流，会挨个读取字符，判断其属于哪种 Token，在枚举类 TokenKind 中可以看到所有 Token 种类</p> <p><img src="/snote/assets/img/image-20210604145859441.51ad0182.png" alt="image-20210604145859441"></p> <p>词法分析的具体细节可见 <code>JavaTokenizer#readToken()</code></p> <p><img src="/snote/assets/img/image-20210604193840324.dfe0786c.png" alt="image-20210604193840324"></p> <h5 id="_4-1-2-javac-抽象语法树"><a href="#_4-1-2-javac-抽象语法树" class="header-anchor">#</a> 4.1.2 Javac 抽象语法树</h5> <p>（1） 抽象语法树的结构</p> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="543px" preserveAspectRatio="none" version="1.1" viewBox="0 0 781 543" width="781px" zoomAndPan="magnify" style="width:781px;height:543px;"><defs><filter height="300%" id="f1nnuy6auja3l1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="StatementTree" width="113" x="51" y="116" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="66" cy="132" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M66.9531,128.6406 L66.9531,135.2969 L68.6719,135.2969 Q69.2813,135.2969 69.5469,135.5313 Q69.8125,135.7656 69.8125,136.1563 Q69.8125,136.5313 69.5469,136.7656 Q69.2813,137 68.6719,137 L63.5313,137 Q62.9219,137 62.6563,136.7656 Q62.3906,136.5313 62.3906,136.1406 Q62.3906,135.7656 62.6563,135.5313 Q62.9219,135.2969 63.5313,135.2969 L65.25,135.2969 L65.25,128.6406 L63.5313,128.6406 Q62.9219,128.6406 62.6563,128.4063 Q62.3906,128.1719 62.3906,127.7813 Q62.3906,127.4063 62.6563,127.1719 Q62.9219,126.9375 63.5313,126.9375 L68.6719,126.9375 Q69.2813,126.9375 69.5469,127.1719 Q69.8125,127.4063 69.8125,127.7813 Q69.8125,128.1719 69.5469,128.4063 Q69.2813,128.6406 68.6719,128.6406 L66.9531,128.6406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="81" x="80" y="136.9102">StatementTree</text><line x1="52" x2="163" y1="148" y2="148" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="52" x2="163" y1="156" y2="156" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="Tree" width="57" x="95" y="8" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="110" cy="24" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M110.9531,20.6406 L110.9531,27.2969 L112.6719,27.2969 Q113.2813,27.2969 113.5469,27.5313 Q113.8125,27.7656 113.8125,28.1563 Q113.8125,28.5313 113.5469,28.7656 Q113.2813,29 112.6719,29 L107.5313,29 Q106.9219,29 106.6563,28.7656 Q106.3906,28.5313 106.3906,28.1406 Q106.3906,27.7656 106.6563,27.5313 Q106.9219,27.2969 107.5313,27.2969 L109.25,27.2969 L109.25,20.6406 L107.5313,20.6406 Q106.9219,20.6406 106.6563,20.4063 Q106.3906,20.1719 106.3906,19.7813 Q106.3906,19.4063 106.6563,19.1719 Q106.9219,18.9375 107.5313,18.9375 L112.6719,18.9375 Q113.2813,18.9375 113.5469,19.1719 Q113.8125,19.4063 113.8125,19.7813 Q113.8125,20.1719 113.5469,20.4063 Q113.2813,20.6406 112.6719,20.6406 L110.9531,20.6406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="25" x="124" y="28.9102">Tree</text><line x1="96" x2="151" y1="40" y2="40" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="96" x2="151" y1="48" y2="48" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="JCTree" width="72" x="282.5" y="116" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="297.5" cy="132" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M299.6875,133.7656 L295.5469,133.7656 L295.125,134.7969 L295.5469,134.7969 Q296.1563,134.7969 296.4219,135.0313 Q296.6875,135.2656 296.6875,135.6563 Q296.6875,136.0313 296.4219,136.2656 Q296.1563,136.5 295.5469,136.5 L293.25,136.5 Q292.6406,136.5 292.3828,136.2656 Q292.125,136.0313 292.125,135.6406 Q292.125,135.2656 292.3984,135.0234 Q292.6719,134.7813 293.2969,134.7969 L295.9688,128.1406 L294.8594,128.1406 Q294.25,128.1406 293.9844,127.9063 Q293.7188,127.6719 293.7188,127.2813 Q293.7188,126.9063 293.9844,126.6719 Q294.25,126.4375 294.8594,126.4375 L298.5313,126.4375 L301.9219,134.7969 Q302.5156,134.7969 302.7031,134.9375 Q303.0938,135.2031 303.0938,135.6563 Q303.0938,136.0313 302.8359,136.2656 Q302.5781,136.5 301.9688,136.5 L299.6719,136.5 Q299.0625,136.5 298.7969,136.2656 Q298.5313,136.0313 298.5313,135.6406 Q298.5313,135.2656 298.7969,135.0313 Q299.0625,134.7969 299.6719,134.7969 L300.0938,134.7969 L299.6875,133.7656 Z M298.9688,132.0625 L297.6094,128.6875 L296.2344,132.0625 L298.9688,132.0625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="40" x="311.5" y="136.9102">JCTree</text><line x1="283.5" x2="353.5" y1="148" y2="148" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="283.5" x2="353.5" y1="156" y2="156" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="Cloneable" width="90" x="195.5" y="8" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="210.5" cy="24" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M211.4531,20.6406 L211.4531,27.2969 L213.1719,27.2969 Q213.7813,27.2969 214.0469,27.5313 Q214.3125,27.7656 214.3125,28.1563 Q214.3125,28.5313 214.0469,28.7656 Q213.7813,29 213.1719,29 L208.0313,29 Q207.4219,29 207.1563,28.7656 Q206.8906,28.5313 206.8906,28.1406 Q206.8906,27.7656 207.1563,27.5313 Q207.4219,27.2969 208.0313,27.2969 L209.75,27.2969 L209.75,20.6406 L208.0313,20.6406 Q207.4219,20.6406 207.1563,20.4063 Q206.8906,20.1719 206.8906,19.7813 Q206.8906,19.4063 207.1563,19.1719 Q207.4219,18.9375 208.0313,18.9375 L213.1719,18.9375 Q213.7813,18.9375 214.0469,19.1719 Q214.3125,19.4063 214.3125,19.7813 Q214.3125,20.1719 214.0469,20.4063 Q213.7813,20.6406 213.1719,20.6406 L211.4531,20.6406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="58" x="224.5" y="28.9102">Cloneable</text><line x1="196.5" x2="284.5" y1="40" y2="40" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="196.5" x2="284.5" y1="48" y2="48" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="DiagnosticPosition" width="134" x="320.5" y="8" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="335.5" cy="24" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M336.4531,20.6406 L336.4531,27.2969 L338.1719,27.2969 Q338.7813,27.2969 339.0469,27.5313 Q339.3125,27.7656 339.3125,28.1563 Q339.3125,28.5313 339.0469,28.7656 Q338.7813,29 338.1719,29 L333.0313,29 Q332.4219,29 332.1563,28.7656 Q331.8906,28.5313 331.8906,28.1406 Q331.8906,27.7656 332.1563,27.5313 Q332.4219,27.2969 333.0313,27.2969 L334.75,27.2969 L334.75,20.6406 L333.0313,20.6406 Q332.4219,20.6406 332.1563,20.4063 Q331.8906,20.1719 331.8906,19.7813 Q331.8906,19.4063 332.1563,19.1719 Q332.4219,18.9375 333.0313,18.9375 L338.1719,18.9375 Q338.7813,18.9375 339.0469,19.1719 Q339.3125,19.4063 339.3125,19.7813 Q339.3125,20.1719 339.0469,20.4063 Q338.7813,20.6406 338.1719,20.6406 L336.4531,20.6406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="102" x="349.5" y="28.9102">DiagnosticPosition</text><line x1="321.5" x2="453.5" y1="40" y2="40" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="321.5" x2="453.5" y1="48" y2="48" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="JCStatement" width="103" x="43" y="245" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="58" cy="261" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M60.1875,262.7656 L56.0469,262.7656 L55.625,263.7969 L56.0469,263.7969 Q56.6563,263.7969 56.9219,264.0313 Q57.1875,264.2656 57.1875,264.6563 Q57.1875,265.0313 56.9219,265.2656 Q56.6563,265.5 56.0469,265.5 L53.75,265.5 Q53.1406,265.5 52.8828,265.2656 Q52.625,265.0313 52.625,264.6406 Q52.625,264.2656 52.8984,264.0234 Q53.1719,263.7813 53.7969,263.7969 L56.4688,257.1406 L55.3594,257.1406 Q54.75,257.1406 54.4844,256.9063 Q54.2188,256.6719 54.2188,256.2813 Q54.2188,255.9063 54.4844,255.6719 Q54.75,255.4375 55.3594,255.4375 L59.0313,255.4375 L62.4219,263.7969 Q63.0156,263.7969 63.2031,263.9375 Q63.5938,264.2031 63.5938,264.6563 Q63.5938,265.0313 63.3359,265.2656 Q63.0781,265.5 62.4688,265.5 L60.1719,265.5 Q59.5625,265.5 59.2969,265.2656 Q59.0313,265.0313 59.0313,264.6406 Q59.0313,264.2656 59.2969,264.0313 Q59.5625,263.7969 60.1719,263.7969 L60.5938,263.7969 L60.1875,262.7656 Z M59.4688,261.0625 L58.1094,257.6875 L56.7344,261.0625 L59.4688,261.0625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="71" x="72" y="265.9102">JCStatement</text><line x1="44" x2="145" y1="277" y2="277" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="44" x2="145" y1="285" y2="285" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="JCCompilationUnit" width="136" x="181.5" y="245" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="196.5" cy="261" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M199.2656,256.875 Q199.4219,256.6563 199.6094,256.5469 Q199.7969,256.4375 200.0156,256.4375 Q200.3906,256.4375 200.625,256.6953 Q200.8594,256.9531 200.8594,257.5625 L200.8594,259.0156 Q200.8594,259.625 200.625,259.8906 Q200.3906,260.1563 200.0156,260.1563 Q199.6719,260.1563 199.4688,259.9531 Q199.2656,259.7656 199.1563,259.25 Q199.1094,258.8906 198.9219,258.7031 Q198.5938,258.3281 197.9844,258.1094 Q197.375,257.8906 196.75,257.8906 Q195.9844,257.8906 195.3516,258.2188 Q194.7188,258.5469 194.2266,259.2969 Q193.7344,260.0469 193.7344,261.0781 L193.7344,262.1719 Q193.7344,263.4063 194.625,264.2266 Q195.5156,265.0469 197.1094,265.0469 Q198.0469,265.0469 198.7031,264.7969 Q199.0938,264.6406 199.5156,264.2031 Q199.7813,263.9375 199.9297,263.8594 Q200.0781,263.7813 200.2813,263.7813 Q200.6094,263.7813 200.8672,264.0391 Q201.125,264.2969 201.125,264.6406 Q201.125,264.9844 200.7813,265.3906 Q200.2813,265.9688 199.4844,266.2969 Q198.4063,266.75 197.1094,266.75 Q195.5938,266.75 194.3906,266.125 Q193.4063,265.625 192.7188,264.5547 Q192.0313,263.4844 192.0313,262.2031 L192.0313,261.0469 Q192.0313,259.7188 192.6484,258.5703 Q193.2656,257.4219 194.3594,256.8047 Q195.4531,256.1875 196.6875,256.1875 Q197.4219,256.1875 198.0703,256.3516 Q198.7188,256.5156 199.2656,256.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="104" x="210.5" y="265.9102">JCCompilationUnit</text><line x1="182.5" x2="316.5" y1="277" y2="277" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="182.5" x2="316.5" y1="285" y2="285" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="89.5078" id="JCPackageDecl" width="167" x="353" y="224" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="389.15" cy="240" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M391.9156,235.875 Q392.0719,235.6563 392.2594,235.5469 Q392.4469,235.4375 392.6656,235.4375 Q393.0406,235.4375 393.275,235.6953 Q393.5094,235.9531 393.5094,236.5625 L393.5094,238.0156 Q393.5094,238.625 393.275,238.8906 Q393.0406,239.1563 392.6656,239.1563 Q392.3219,239.1563 392.1188,238.9531 Q391.9156,238.7656 391.8063,238.25 Q391.7594,237.8906 391.5719,237.7031 Q391.2438,237.3281 390.6344,237.1094 Q390.025,236.8906 389.4,236.8906 Q388.6344,236.8906 388.0016,237.2188 Q387.3688,237.5469 386.8766,238.2969 Q386.3844,239.0469 386.3844,240.0781 L386.3844,241.1719 Q386.3844,242.4063 387.275,243.2266 Q388.1656,244.0469 389.7594,244.0469 Q390.6969,244.0469 391.3531,243.7969 Q391.7438,243.6406 392.1656,243.2031 Q392.4313,242.9375 392.5797,242.8594 Q392.7281,242.7813 392.9313,242.7813 Q393.2594,242.7813 393.5172,243.0391 Q393.775,243.2969 393.775,243.6406 Q393.775,243.9844 393.4313,244.3906 Q392.9313,244.9688 392.1344,245.2969 Q391.0563,245.75 389.7594,245.75 Q388.2438,245.75 387.0406,245.125 Q386.0563,244.625 385.3688,243.5547 Q384.6813,242.4844 384.6813,241.2031 L384.6813,240.0469 Q384.6813,238.7188 385.2984,237.5703 Q385.9156,236.4219 387.0094,235.8047 Q388.1031,235.1875 389.3375,235.1875 Q390.0719,235.1875 390.7203,235.3516 Q391.3688,235.5156 391.9156,235.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="88" x="407.85" y="244.9102">JCPackageDecl</text><line x1="354" x2="519" y1="256" y2="256" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="155" x="359" y="271.4189">List&lt;JCAnnotation&gt; annotations;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="86" x="359" y="285.2549">JCExpression pid;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="117" x="359" y="299.0908">PackageSymbol packge;</text><line x1="354" x2="519" y1="305.5078" y2="305.5078" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="JCImport" width="82" x="555.5" y="245" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="570.5" cy="261" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M573.2656,256.875 Q573.4219,256.6563 573.6094,256.5469 Q573.7969,256.4375 574.0156,256.4375 Q574.3906,256.4375 574.625,256.6953 Q574.8594,256.9531 574.8594,257.5625 L574.8594,259.0156 Q574.8594,259.625 574.625,259.8906 Q574.3906,260.1563 574.0156,260.1563 Q573.6719,260.1563 573.4688,259.9531 Q573.2656,259.7656 573.1563,259.25 Q573.1094,258.8906 572.9219,258.7031 Q572.5938,258.3281 571.9844,258.1094 Q571.375,257.8906 570.75,257.8906 Q569.9844,257.8906 569.3516,258.2188 Q568.7188,258.5469 568.2266,259.2969 Q567.7344,260.0469 567.7344,261.0781 L567.7344,262.1719 Q567.7344,263.4063 568.625,264.2266 Q569.5156,265.0469 571.1094,265.0469 Q572.0469,265.0469 572.7031,264.7969 Q573.0938,264.6406 573.5156,264.2031 Q573.7813,263.9375 573.9297,263.8594 Q574.0781,263.7813 574.2813,263.7813 Q574.6094,263.7813 574.8672,264.0391 Q575.125,264.2969 575.125,264.6406 Q575.125,264.9844 574.7813,265.3906 Q574.2813,265.9688 573.4844,266.2969 Q572.4063,266.75 571.1094,266.75 Q569.5938,266.75 568.3906,266.125 Q567.4063,265.625 566.7188,264.5547 Q566.0313,263.4844 566.0313,262.2031 L566.0313,261.0469 Q566.0313,259.7188 566.6484,258.5703 Q567.2656,257.4219 568.3594,256.8047 Q569.4531,256.1875 570.6875,256.1875 Q571.4219,256.1875 572.0703,256.3516 Q572.7188,256.5156 573.2656,256.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="50" x="584.5" y="265.9102">JCImport</text><line x1="556.5" x2="636.5" y1="277" y2="277" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="556.5" x2="636.5" y1="285" y2="285" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="48" id="JCModifiers" width="97" x="673" y="245" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="688" cy="261" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M690.7656,256.875 Q690.9219,256.6563 691.1094,256.5469 Q691.2969,256.4375 691.5156,256.4375 Q691.8906,256.4375 692.125,256.6953 Q692.3594,256.9531 692.3594,257.5625 L692.3594,259.0156 Q692.3594,259.625 692.125,259.8906 Q691.8906,260.1563 691.5156,260.1563 Q691.1719,260.1563 690.9688,259.9531 Q690.7656,259.7656 690.6563,259.25 Q690.6094,258.8906 690.4219,258.7031 Q690.0938,258.3281 689.4844,258.1094 Q688.875,257.8906 688.25,257.8906 Q687.4844,257.8906 686.8516,258.2188 Q686.2188,258.5469 685.7266,259.2969 Q685.2344,260.0469 685.2344,261.0781 L685.2344,262.1719 Q685.2344,263.4063 686.125,264.2266 Q687.0156,265.0469 688.6094,265.0469 Q689.5469,265.0469 690.2031,264.7969 Q690.5938,264.6406 691.0156,264.2031 Q691.2813,263.9375 691.4297,263.8594 Q691.5781,263.7813 691.7813,263.7813 Q692.1094,263.7813 692.3672,264.0391 Q692.625,264.2969 692.625,264.6406 Q692.625,264.9844 692.2813,265.3906 Q691.7813,265.9688 690.9844,266.2969 Q689.9063,266.75 688.6094,266.75 Q687.0938,266.75 685.8906,266.125 Q684.9063,265.625 684.2188,264.5547 Q683.5313,263.4844 683.5313,262.2031 L683.5313,261.0469 Q683.5313,259.7188 684.1484,258.5703 Q684.7656,257.4219 685.8594,256.8047 Q686.9531,256.1875 688.1875,256.1875 Q688.9219,256.1875 689.5703,256.3516 Q690.2188,256.5156 690.7656,256.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="65" x="702" y="265.9102">JCModifiers</text><line x1="674" x2="769" y1="277" y2="277" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="674" x2="769" y1="285" y2="285" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#f1nnuy6auja3l1)" height="158.6875" id="JCClassDecl" width="177" x="6" y="374" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="53.75" cy="390" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M56.5156,385.875 Q56.6719,385.6563 56.8594,385.5469 Q57.0469,385.4375 57.2656,385.4375 Q57.6406,385.4375 57.875,385.6953 Q58.1094,385.9531 58.1094,386.5625 L58.1094,388.0156 Q58.1094,388.625 57.875,388.8906 Q57.6406,389.1563 57.2656,389.1563 Q56.9219,389.1563 56.7188,388.9531 Q56.5156,388.7656 56.4063,388.25 Q56.3594,387.8906 56.1719,387.7031 Q55.8438,387.3281 55.2344,387.1094 Q54.625,386.8906 54,386.8906 Q53.2344,386.8906 52.6016,387.2188 Q51.9688,387.5469 51.4766,388.2969 Q50.9844,389.0469 50.9844,390.0781 L50.9844,391.1719 Q50.9844,392.4063 51.875,393.2266 Q52.7656,394.0469 54.3594,394.0469 Q55.2969,394.0469 55.9531,393.7969 Q56.3438,393.6406 56.7656,393.2031 Q57.0313,392.9375 57.1797,392.8594 Q57.3281,392.7813 57.5313,392.7813 Q57.8594,392.7813 58.1172,393.0391 Q58.375,393.2969 58.375,393.6406 Q58.375,393.9844 58.0313,394.3906 Q57.5313,394.9688 56.7344,395.2969 Q55.6563,395.75 54.3594,395.75 Q52.8438,395.75 51.6406,395.125 Q50.6563,394.625 49.9688,393.5547 Q49.2813,392.4844 49.2813,391.2031 L49.2813,390.0469 Q49.2813,388.7188 49.8984,387.5703 Q50.5156,386.4219 51.6094,385.8047 Q52.7031,385.1875 53.9375,385.1875 Q54.6719,385.1875 55.3203,385.3516 Q55.9688,385.5156 56.5156,385.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="73" x="74.25" y="394.9102">JCClassDecl</text><line x1="7" x2="182" y1="406" y2="406" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="133" x="12" y="421.4189">JCModifiers mods; // 修饰符</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="59" x="12" y="435.2549">Name name;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="165" x="12" y="449.0908">List&lt;JCTypeParameter&gt; typarams;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="119" x="12" y="462.9268">JCExpression extending;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="162" x="12" y="476.7627">List&lt;JCExpression&gt; implementing;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="147" x="12" y="490.5986">List&lt;JCExpression&gt; permitting;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="158" x="12" y="504.4346">List&lt;JCTree&gt; defs; // 方法和变量</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="88" x="12" y="518.2705">ClassSymbol sym;</text><line x1="7" x2="182" y1="524.6875" y2="524.6875" style="stroke:#A80036;stroke-width:1.5;"></line><path d="M117.006,76.024 C114.96,89.579 112.777,104.038 111.02,115.678 " fill="none" id="Tree&lt;-StatementTree" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="110.122,74.732,120.028,56,123.965,76.821,110.122,74.732" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M170.01,58.282 C204.42,76.987 250.623,102.103 282.3,119.322 " fill="none" id="Tree&lt;-JCTree" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="166.501,64.343,152.273,48.641,173.188,52.042,166.501,64.343" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M269.329,72.178 C280.088,86.8 291.958,102.929 301.339,115.678 " fill="none" id="Cloneable&lt;-JCTree" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="263.64,76.258,257.425,56,274.917,67.96,263.64,76.258" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M361.375,73.134 C352.024,87.499 341.799,103.207 333.681,115.678 " fill="none" id="DiagnosticPosition&lt;-JCTree" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="355.751,68.943,372.528,56,367.484,76.581,355.751,68.943" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M264.346,168.709 C234.325,184.391 196.502,204.679 163.5,224 C152.343,230.532 140.399,237.98 129.637,244.867 " fill="none" id="JCTree&lt;-JCStatement" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="261.39,162.357,282.366,159.359,267.838,174.783,261.39,162.357" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M103.068,184.298 C100.9899,204.598 98.5971,227.974 96.8693,244.854 " fill="none" id="StatementTree&lt;-JCStatement" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="96.1153,183.477,105.1156,164.294,110.043,184.903,96.1153,183.477" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M296.194,182.055 C284.892,202.858 271.586,227.349 262.075,244.854 " fill="none" id="JCTree&lt;-JCCompilationUnit" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="290.146,178.526,305.844,164.294,302.447,185.209,290.146,178.526" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M353.933,179.136 C366.994,193.192 381.898,209.233 395.416,223.782 " fill="none" id="JCTree&lt;-JCPackageDecl" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="348.628,183.71,340.143,164.294,358.885,174.181,348.628,183.71" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M374.105,157.321 C419.529,171.758 484.631,195.013 537.5,224 C548.256,229.897 559.242,237.559 568.773,244.833 " fill="none" id="JCTree&lt;-JCImport" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="371.767,163.925,354.734,151.319,375.91,150.552,371.767,163.925" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M374.475,148.702 C442.95,159.48 561.372,182.557 655.5,224 C667.978,229.494 680.675,237.319 691.556,244.85 " fill="none" id="JCTree&lt;-JCModifiers" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="373.231,155.594,354.5,145.686,375.321,141.751,373.231,155.594" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M94.5,313.186 C94.5,331.328 94.5,353.018 94.5,373.819 " fill="none" id="JCStatement&lt;-JCClassDecl" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="87.5001,313.114,94.5,293.114,101.5001,313.114,87.5001,313.114" style="stroke:#A80036;stroke-width:1.0;"></polygon></g></svg><p>Java 源码在编译的时候，会被解析成一个语法树，这棵语法树就是 JCCompilationUnit，也就是一个编译单元。<br>
其中这棵语法树根节点的子节点为包声明结点、Import 声明结点、类声明结点都是树的一级结点，例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ray<span class="token punctuation">.</span>study<span class="token punctuation">.</span>smaple<span class="token punctuation">.</span>beanmap<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span> <span class="token comment">// 对应包声明结点 JCPackageDecl</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>  <span class="token comment">// 对应Import声明结点 JCImport</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span> <span class="token comment">// 对应Import声明结点 JCImport</span>

<span class="token comment">/**
 * description
 *
 * @author r.shi 2021/5/26 15:37
 */</span>

<span class="token comment">// 下面的所有代码对应JCClassDecl结点</span>
<span class="token annotation punctuation">@Data</span>  <span class="token comment">// 注解 和 public 对应 修饰符结点 JCModifiers</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDTO</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>             <span class="token comment">// 对应变量声明结点 JCVariableDecl</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>     <span class="token comment">// 对应变量声明结点 JCVariableDecl</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> userStatus<span class="token punctuation">;</span>  <span class="token comment">// 对应变量声明结点 JCVariableDecl</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> createTime<span class="token punctuation">;</span>     <span class="token comment">// 对应变量声明结点 JCVariableDecl</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleDTO</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span> <span class="token comment">// 对应变量声明结点 JCVariableDecl</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><img src="/snote/assets/img/image-20210604193311967.31303b1a.png" alt="image-20210604193311967"></p> <p>（2）抽象语法树是如何生成的？</p> <p>可以通过 <code>JCTree</code> 的工厂类 <code>com.sun.tools.javac.tree.TreeMaker</code> 生成</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TreeMaker</span> <span class="token keyword">implements</span> <span class="token class-name">JCTree<span class="token punctuation">.</span>Factory</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">JCClassDecl</span> <span class="token class-name">ClassDef</span><span class="token punctuation">(</span><span class="token class-name">JCModifiers</span> mods<span class="token punctuation">,</span>
                                <span class="token class-name">Name</span> name<span class="token punctuation">,</span>
                                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCTypeParameter</span><span class="token punctuation">&gt;</span></span> typarams<span class="token punctuation">,</span>
                                <span class="token class-name">JCExpression</span> extending<span class="token punctuation">,</span>
                                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCExpression</span><span class="token punctuation">&gt;</span></span> implementing<span class="token punctuation">,</span>
                                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCExpression</span><span class="token punctuation">&gt;</span></span> permitting<span class="token punctuation">,</span>
                                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCTree</span><span class="token punctuation">&gt;</span></span> defs<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">JCClassDecl</span> tree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JCClassDecl</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span>
                                     name<span class="token punctuation">,</span>
                                     typarams<span class="token punctuation">,</span>
                                     extending<span class="token punctuation">,</span>
                                     implementing<span class="token punctuation">,</span>
                                     permitting<span class="token punctuation">,</span>
                                     defs<span class="token punctuation">,</span>
                                     <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tree<span class="token punctuation">.</span>pos <span class="token operator">=</span> pos<span class="token punctuation">;</span>
        <span class="token keyword">return</span> tree<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JCMethodDecl</span> <span class="token class-name">MethodDef</span><span class="token punctuation">(</span><span class="token class-name">JCModifiers</span> mods<span class="token punctuation">,</span>
                               <span class="token class-name">Name</span> name<span class="token punctuation">,</span>
                               <span class="token class-name">JCExpression</span> restype<span class="token punctuation">,</span>
                               <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCTypeParameter</span><span class="token punctuation">&gt;</span></span> typarams<span class="token punctuation">,</span>
                               <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCVariableDecl</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">,</span>
                               <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCExpression</span><span class="token punctuation">&gt;</span></span> thrown<span class="token punctuation">,</span>
                               <span class="token class-name">JCBlock</span> body<span class="token punctuation">,</span>
                               <span class="token class-name">JCExpression</span> defaultValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">MethodDef</span><span class="token punctuation">(</span>
                mods<span class="token punctuation">,</span> name<span class="token punctuation">,</span> restype<span class="token punctuation">,</span> typarams<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span>
                thrown<span class="token punctuation">,</span> body<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h5 id="_4-1-3-语法分析"><a href="#_4-1-3-语法分析" class="header-anchor">#</a> 4.1.3 语法分析</h5> <p>然后根据 Token 序列构造抽象语法树</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token comment">// JavacParser</span>
<span class="token keyword">public</span> <span class="token class-name">JCTree<span class="token punctuation">.</span>JCCompilationUnit</span> <span class="token function">parseCompilationUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">Token</span> firstToken <span class="token operator">=</span> token<span class="token punctuation">;</span>
    <span class="token class-name">JCModifiers</span> mods <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> consumedToplevelDoc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> seenImport <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> seenPackage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">ListBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCTree</span><span class="token punctuation">&gt;</span></span> defs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> MONKEYS_AT<span class="token punctuation">)</span>
        mods <span class="token operator">=</span> <span class="token function">modifiersOpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.包声明语法分析</span>
    <span class="token comment">// PackageDeclaration = PACKAGE Ident { DOT [Annotations] Ident } ;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> PACKAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 若遇到的 token 是 PACKAGE类型，</span>
        <span class="token keyword">int</span> packagePos <span class="token operator">=</span> token<span class="token punctuation">.</span>pos<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCAnnotation</span><span class="token punctuation">&gt;</span></span> annotations <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seenPackage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mods <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkNoMods</span><span class="token punctuation">(</span>mods<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token class-name">Flags</span><span class="token punctuation">.</span>DEPRECATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            annotations <span class="token operator">=</span> mods<span class="token punctuation">.</span>annotations<span class="token punctuation">;</span>
            mods <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到具体包名</span>
        <span class="token class-name">JCExpression</span> pid <span class="token operator">=</span> <span class="token function">qualident</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断是否以 `;` 结尾，accept通过说明是正确的包声明语句</span>
        <span class="token function">accept</span><span class="token punctuation">(</span>SEMI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造包声明</span>
        <span class="token class-name">JCPackageDecl</span> pd <span class="token operator">=</span> <span class="token function">toP</span><span class="token punctuation">(</span><span class="token class-name">F</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>packagePos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PackageDecl</span><span class="token punctuation">(</span>annotations<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">attach</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> firstToken<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token class-name">CommentStyle</span><span class="token punctuation">.</span>JAVADOC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumedToplevelDoc <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        defs<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> checkForImports <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> firstTypeDecl <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">!=</span> EOF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>pos <span class="token operator">&lt;=</span> endPosTable<span class="token punctuation">.</span>errorEndPos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// error recovery</span>
            <span class="token function">skip</span><span class="token punctuation">(</span>checkForImports<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> EOF<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>checkForImports <span class="token operator">&amp;&amp;</span> mods <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span>kind <span class="token operator">==</span> IMPORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.import 声明语法分析</span>
            <span class="token comment">// ImportDeclaration = IMPORT [ STATIC ] Ident { &quot;.&quot; Ident } [ &quot;.&quot; &quot;*&quot; ] &quot;;&quot;</span>
            seenImport <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            defs<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">importDeclaration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Comment</span> docComment <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token class-name">CommentStyle</span><span class="token punctuation">.</span>JAVADOC<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTypeDecl <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>seenImport <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>seenPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                docComment <span class="token operator">=</span> firstToken<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token class-name">CommentStyle</span><span class="token punctuation">.</span>JAVADOC<span class="token punctuation">)</span><span class="token punctuation">;</span>
                consumedToplevelDoc <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mods <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> token<span class="token punctuation">.</span>kind <span class="token operator">!=</span> SEMI<span class="token punctuation">)</span>
                <span class="token comment">// 3.修饰符</span>
                mods <span class="token operator">=</span> <span class="token function">modifiersOpt</span><span class="token punctuation">(</span>mods<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTypeDecl <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span>kind <span class="token operator">==</span> IDENTIFIER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ModuleKind</span> kind <span class="token operator">=</span> <span class="token class-name">ModuleKind</span><span class="token punctuation">.</span>STRONG<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> names<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    kind <span class="token operator">=</span> <span class="token class-name">ModuleKind</span><span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> IDENTIFIER <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> names<span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mods <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">checkNoMods</span><span class="token punctuation">(</span>mods<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token class-name">Flags</span><span class="token punctuation">.</span>DEPRECATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    defs<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">moduleDecl</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> docComment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    consumedToplevelDoc <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">!=</span> <span class="token class-name">ModuleKind</span><span class="token punctuation">.</span>STRONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reportSyntaxError</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token class-name">Errors<span class="token punctuation">.</span>ExpectedModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 4.类型声明语法分析</span>
            <span class="token class-name">JCTree</span> def <span class="token operator">=</span> <span class="token function">typeDeclaration</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span> docComment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>def <span class="token keyword">instanceof</span> <span class="token class-name">JCExpressionStatement</span><span class="token punctuation">)</span>
                def <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JCExpressionStatement</span><span class="token punctuation">)</span>def<span class="token punctuation">)</span><span class="token punctuation">.</span>expr<span class="token punctuation">;</span>
            defs<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>def<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>def <span class="token keyword">instanceof</span> <span class="token class-name">JCClassDecl</span><span class="token punctuation">)</span>
                checkForImports <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mods <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            firstTypeDecl <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 构建toplevel根结点，并将包声明结点、Import声明结点、类型声明结点作为其子结点</span>
    <span class="token class-name">JCTree<span class="token punctuation">.</span>JCCompilationUnit</span> toplevel <span class="token operator">=</span> <span class="token class-name">F</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>firstToken<span class="token punctuation">.</span>pos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TopLevel</span><span class="token punctuation">(</span>defs<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumedToplevelDoc<span class="token punctuation">)</span>
        <span class="token function">attach</span><span class="token punctuation">(</span>toplevel<span class="token punctuation">,</span> firstToken<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token class-name">CommentStyle</span><span class="token punctuation">.</span>JAVADOC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>defs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">storeEnd</span><span class="token punctuation">(</span>toplevel<span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">.</span><span class="token function">prevToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepDocComments<span class="token punctuation">)</span>
        toplevel<span class="token punctuation">.</span>docComments <span class="token operator">=</span> docComments<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepLineMap<span class="token punctuation">)</span>
        toplevel<span class="token punctuation">.</span>lineMap <span class="token operator">=</span> <span class="token class-name">S</span><span class="token punctuation">.</span><span class="token function">getLineMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>endPosTable<span class="token punctuation">.</span><span class="token function">setParser</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// remove reference to parser</span>
    toplevel<span class="token punctuation">.</span>endPositions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endPosTable<span class="token punctuation">;</span>
    <span class="token keyword">return</span> toplevel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** ClassOrInterfaceOrEnumDeclaration = ModifiersOpt
    *           (ClassDeclaration | InterfaceDeclaration | EnumDeclaration)
    *  @param mods     Any modifiers starting the class or interface declaration
    *  @param dc       The documentation comment for the class, or null.
    */</span>
<span class="token keyword">protected</span> <span class="token class-name">JCStatement</span> <span class="token function">classOrRecordOrInterfaceOrEnumDeclaration</span><span class="token punctuation">(</span><span class="token class-name">JCModifiers</span> mods<span class="token punctuation">,</span> <span class="token class-name">Comment</span> dc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> CLASS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 类声明语法分析</span>
        <span class="token keyword">return</span> <span class="token function">classDeclaration</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span> dc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRecordStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">recordDeclaration</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span> dc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> INTERFACE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 接口声明语法分析</span>
        <span class="token keyword">return</span> <span class="token function">interfaceDeclaration</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span> dc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> ENUM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 枚举声明语法分析</span>
        <span class="token keyword">return</span> <span class="token function">enumDeclaration</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span> dc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> token<span class="token punctuation">.</span>pos<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCTree</span><span class="token punctuation">&gt;</span></span> errs<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> IDENTIFIER <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> names<span class="token punctuation">.</span><span class="token keyword">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkSourceLevel</span><span class="token punctuation">(</span><span class="token class-name">Feature</span><span class="token punctuation">.</span>RECORDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JCErroneous</span> erroneousTree <span class="token operator">=</span> <span class="token function">syntaxError</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>mods<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Errors<span class="token punctuation">.</span>RecordHeaderExpected</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">toP</span><span class="token punctuation">(</span><span class="token class-name">F<span class="token punctuation">.</span>Exec</span><span class="token punctuation">(</span>erroneousTree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LAX_IDENTIFIER<span class="token punctuation">.</span><span class="token function">accepts</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errs <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span> <span class="token function">toP</span><span class="token punctuation">(</span><span class="token class-name">F</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Ident</span><span class="token punctuation">(</span><span class="token function">ident</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setErrorEndPos</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                errs <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>mods<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token class-name">JCErroneous</span> erroneousTree<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parseModuleInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                erroneousTree <span class="token operator">=</span> <span class="token function">syntaxError</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> errs<span class="token punctuation">,</span> <span class="token class-name">Errors<span class="token punctuation">.</span>ExpectedModuleOrOpen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>allowRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    erroneousTree <span class="token operator">=</span> <span class="token function">syntaxError</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> errs<span class="token punctuation">,</span> <span class="token class-name">Errors<span class="token punctuation">.</span>Expected4</span><span class="token punctuation">(</span>CLASS<span class="token punctuation">,</span> INTERFACE<span class="token punctuation">,</span> ENUM<span class="token punctuation">,</span> <span class="token string">&quot;record&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    erroneousTree <span class="token operator">=</span> <span class="token function">syntaxError</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> errs<span class="token punctuation">,</span> <span class="token class-name">Errors<span class="token punctuation">.</span>Expected3</span><span class="token punctuation">(</span>CLASS<span class="token punctuation">,</span> INTERFACE<span class="token punctuation">,</span> ENUM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">toP</span><span class="token punctuation">(</span><span class="token class-name">F<span class="token punctuation">.</span>Exec</span><span class="token punctuation">(</span>erroneousTree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/** ClassDeclaration = CLASS Ident TypeParametersOpt [EXTENDS Type]
    *                     [IMPLEMENTS TypeList] ClassBody
    *  @param mods    The modifiers starting the class declaration
    *  @param dc       The documentation comment for the class, or null.
    */</span>
<span class="token keyword">protected</span> <span class="token class-name">JCClassDecl</span> <span class="token function">classDeclaration</span><span class="token punctuation">(</span><span class="token class-name">JCModifiers</span> mods<span class="token punctuation">,</span> <span class="token class-name">Comment</span> dc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> pos <span class="token operator">=</span> token<span class="token punctuation">.</span>pos<span class="token punctuation">;</span>
    <span class="token function">accept</span><span class="token punctuation">(</span>CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Name</span> name <span class="token operator">=</span> <span class="token function">typeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCTypeParameter</span><span class="token punctuation">&gt;</span></span> typarams <span class="token operator">=</span> <span class="token function">typeParametersOpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">JCExpression</span> extending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> EXTENDS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        extending <span class="token operator">=</span> <span class="token function">parseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCExpression</span><span class="token punctuation">&gt;</span></span> implementing <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>kind <span class="token operator">==</span> IMPLEMENTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        implementing <span class="token operator">=</span> <span class="token function">typeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCExpression</span><span class="token punctuation">&gt;</span></span> permitting <span class="token operator">=</span> <span class="token function">permitsClause</span><span class="token punctuation">(</span>mods<span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCTree</span><span class="token punctuation">&gt;</span></span> defs <span class="token operator">=</span> <span class="token function">classInterfaceOrRecordBody</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JCClassDecl</span> result <span class="token operator">=</span> <span class="token function">toP</span><span class="token punctuation">(</span><span class="token class-name">F</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ClassDef</span><span class="token punctuation">(</span>
        mods<span class="token punctuation">,</span> name<span class="token punctuation">,</span> typarams<span class="token punctuation">,</span> extending<span class="token punctuation">,</span> implementing<span class="token punctuation">,</span> permitting<span class="token punctuation">,</span> defs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">attach</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> dc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br></div></div><h5 id="_4-1-4-填充符号表"><a href="#_4-1-4-填充符号表" class="header-anchor">#</a> 4.1.4 填充符号表</h5> <h6 id="_4-1-4-1-符号表的数据结构"><a href="#_4-1-4-1-符号表的数据结构" class="header-anchor">#</a> 4.1.4.1 符号表的数据结构</h6> <p>Javac 在编译过程中需要频繁查找被引用的符号，因此需要一定的结构来组织这些符号，这就是符号表。</p> <p>符号一般都是与作用域关联的，Java 的作用域是嵌套的，这样 Javac 在实现过程中，可以通过 Scope 类来实现作用域的嵌套，然后将每个作用域中定义的符号分别保存到对应作用域的相关变量中，这样就可以通过遍历作用域的方式查找唯一的符号引用了。</p> <p>作用域（Scope）大部分都以花括号分隔，同一个符号在不同的作用域中可能指向不同的实体。</p> <p>Scope 类图如下：</p> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="435px" preserveAspectRatio="none" version="1.1" viewBox="0 0 362 435" width="362px" zoomAndPan="magnify" style="width:362px;height:435px;"><defs><filter height="300%" id="fk2w0p25ir70n" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FEFECE" filter="url(#fk2w0p25ir70n)" height="61.8359" id="Scope" width="85" x="67" y="35.5" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="90.1" cy="51.5" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M92.2875,53.2656 L88.1469,53.2656 L87.725,54.2969 L88.1469,54.2969 Q88.7563,54.2969 89.0219,54.5313 Q89.2875,54.7656 89.2875,55.1563 Q89.2875,55.5313 89.0219,55.7656 Q88.7563,56 88.1469,56 L85.85,56 Q85.2406,56 84.9828,55.7656 Q84.725,55.5313 84.725,55.1406 Q84.725,54.7656 84.9984,54.5234 Q85.2719,54.2813 85.8969,54.2969 L88.5688,47.6406 L87.4594,47.6406 Q86.85,47.6406 86.5844,47.4063 Q86.3188,47.1719 86.3188,46.7813 Q86.3188,46.4063 86.5844,46.1719 Q86.85,45.9375 87.4594,45.9375 L91.1313,45.9375 L94.5219,54.2969 Q95.1156,54.2969 95.3031,54.4375 Q95.6938,54.7031 95.6938,55.1563 Q95.6938,55.5313 95.4359,55.7656 Q95.1781,56 94.5688,56 L92.2719,56 Q91.6625,56 91.3969,55.7656 Q91.1313,55.5313 91.1313,55.1406 Q91.1313,54.7656 91.3969,54.5313 Q91.6625,54.2969 92.2719,54.2969 L92.6938,54.2969 L92.2875,53.2656 Z M91.5688,51.5625 L90.2094,48.1875 L88.8344,51.5625 L91.5688,51.5625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="35" x="105.9" y="56.4102">Scope</text><line x1="68" x2="151" y1="67.5" y2="67.5" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="73" x="73" y="82.9189">Symbol owner;</text><line x1="68" x2="151" y1="89.3359" y2="89.3359" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fk2w0p25ir70n)" height="48" id="WriteableScope" width="119" x="50" y="185" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="65" cy="201" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M67.7656,196.875 Q67.9219,196.6563 68.1094,196.5469 Q68.2969,196.4375 68.5156,196.4375 Q68.8906,196.4375 69.125,196.6953 Q69.3594,196.9531 69.3594,197.5625 L69.3594,199.0156 Q69.3594,199.625 69.125,199.8906 Q68.8906,200.1563 68.5156,200.1563 Q68.1719,200.1563 67.9688,199.9531 Q67.7656,199.7656 67.6563,199.25 Q67.6094,198.8906 67.4219,198.7031 Q67.0938,198.3281 66.4844,198.1094 Q65.875,197.8906 65.25,197.8906 Q64.4844,197.8906 63.8516,198.2188 Q63.2188,198.5469 62.7266,199.2969 Q62.2344,200.0469 62.2344,201.0781 L62.2344,202.1719 Q62.2344,203.4063 63.125,204.2266 Q64.0156,205.0469 65.6094,205.0469 Q66.5469,205.0469 67.2031,204.7969 Q67.5938,204.6406 68.0156,204.2031 Q68.2813,203.9375 68.4297,203.8594 Q68.5781,203.7813 68.7813,203.7813 Q69.1094,203.7813 69.3672,204.0391 Q69.625,204.2969 69.625,204.6406 Q69.625,204.9844 69.2813,205.3906 Q68.7813,205.9688 67.9844,206.2969 Q66.9063,206.75 65.6094,206.75 Q64.0938,206.75 62.8906,206.125 Q61.9063,205.625 61.2188,204.5547 Q60.5313,203.4844 60.5313,202.2031 L60.5313,201.0469 Q60.5313,199.7188 61.1484,198.5703 Q61.7656,197.4219 62.8594,196.8047 Q63.9531,196.1875 65.1875,196.1875 Q65.9219,196.1875 66.5703,196.3516 Q67.2188,196.5156 67.7656,196.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="87" x="79" y="205.9102">WriteableScope</text><line x1="51" x2="168" y1="217" y2="217" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="51" x2="168" y1="225" y2="225" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fk2w0p25ir70n)" height="131.0156" id="ScopeImpl" width="207" x="6" y="293" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="75.75" cy="309" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M78.5156,304.875 Q78.6719,304.6563 78.8594,304.5469 Q79.0469,304.4375 79.2656,304.4375 Q79.6406,304.4375 79.875,304.6953 Q80.1094,304.9531 80.1094,305.5625 L80.1094,307.0156 Q80.1094,307.625 79.875,307.8906 Q79.6406,308.1563 79.2656,308.1563 Q78.9219,308.1563 78.7188,307.9531 Q78.5156,307.7656 78.4063,307.25 Q78.3594,306.8906 78.1719,306.7031 Q77.8438,306.3281 77.2344,306.1094 Q76.625,305.8906 76,305.8906 Q75.2344,305.8906 74.6016,306.2188 Q73.9688,306.5469 73.4766,307.2969 Q72.9844,308.0469 72.9844,309.0781 L72.9844,310.1719 Q72.9844,311.4063 73.875,312.2266 Q74.7656,313.0469 76.3594,313.0469 Q77.2969,313.0469 77.9531,312.7969 Q78.3438,312.6406 78.7656,312.2031 Q79.0313,311.9375 79.1797,311.8594 Q79.3281,311.7813 79.5313,311.7813 Q79.8594,311.7813 80.1172,312.0391 Q80.375,312.2969 80.375,312.6406 Q80.375,312.9844 80.0313,313.3906 Q79.5313,313.9688 78.7344,314.2969 Q77.6563,314.75 76.3594,314.75 Q74.8438,314.75 73.6406,314.125 Q72.6563,313.625 71.9688,312.5547 Q71.2813,311.4844 71.2813,310.2031 L71.2813,309.0469 Q71.2813,307.7188 71.8984,306.5703 Q72.5156,305.4219 73.6094,304.8047 Q74.7031,304.1875 75.9375,304.1875 Q76.6719,304.1875 77.3203,304.3516 Q77.9688,304.5156 78.5156,304.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="59" x="96.25" y="313.9102">ScopeImpl</text><line x1="7" x2="212" y1="325" y2="325" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="51" x="12" y="340.4189">int shared;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="110" x="12" y="354.2549">ScopeImpl next; // 后继</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="105" x="12" y="368.0908">Entry[] table; // 符号表</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="66" x="12" y="381.9268">int hashMask;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="195" x="12" y="395.7627">Entry elems; // 保存单链表中的首个Entry</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="103" x="12" y="409.5986">int nelems = 0; // 总数</text><line x1="7" x2="212" y1="416.0156" y2="416.0156" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fk2w0p25ir70n)" height="117.1797" id="Entry" width="164" x="187.5" y="8" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="251.75" cy="24" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M254.5156,19.875 Q254.6719,19.6563 254.8594,19.5469 Q255.0469,19.4375 255.2656,19.4375 Q255.6406,19.4375 255.875,19.6953 Q256.1094,19.9531 256.1094,20.5625 L256.1094,22.0156 Q256.1094,22.625 255.875,22.8906 Q255.6406,23.1563 255.2656,23.1563 Q254.9219,23.1563 254.7188,22.9531 Q254.5156,22.7656 254.4063,22.25 Q254.3594,21.8906 254.1719,21.7031 Q253.8438,21.3281 253.2344,21.1094 Q252.625,20.8906 252,20.8906 Q251.2344,20.8906 250.6016,21.2188 Q249.9688,21.5469 249.4766,22.2969 Q248.9844,23.0469 248.9844,24.0781 L248.9844,25.1719 Q248.9844,26.4063 249.875,27.2266 Q250.7656,28.0469 252.3594,28.0469 Q253.2969,28.0469 253.9531,27.7969 Q254.3438,27.6406 254.7656,27.2031 Q255.0313,26.9375 255.1797,26.8594 Q255.3281,26.7813 255.5313,26.7813 Q255.8594,26.7813 256.1172,27.0391 Q256.375,27.2969 256.375,27.6406 Q256.375,27.9844 256.0313,28.3906 Q255.5313,28.9688 254.7344,29.2969 Q253.6563,29.75 252.3594,29.75 Q250.8438,29.75 249.6406,29.125 Q248.6563,28.625 247.9688,27.5547 Q247.2813,26.4844 247.2813,25.2031 L247.2813,24.0469 Q247.2813,22.7188 247.8984,21.5703 Q248.5156,20.4219 249.6094,19.8047 Q250.7031,19.1875 251.9375,19.1875 Q252.6719,19.1875 253.3203,19.3516 Q253.9688,19.5156 254.5156,19.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="27" x="272.25" y="28.9102">Entry</text><line x1="188.5" x2="350.5" y1="40" y2="40" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="61" x="193.5" y="55.4189">Symbol sym;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="83" x="193.5" y="69.2549">Entry shadowed;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="83" x="193.5" y="83.0908">Entry nextSibling;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="84" x="193.5" y="96.9268">Entry prevSibling;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="152" x="193.5" y="110.7627">ScopeImpl scope; // 所属作用域</text><line x1="188.5" x2="350.5" y1="117.1797" y2="117.1797" style="stroke:#A80036;stroke-width:1.5;"></line><path d="M109.5,117.879 C109.5,140.758 109.5,166.699 109.5,184.856 " fill="none" id="Scope&lt;-WriteableScope" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="102.5001,117.641,109.5,97.641,116.5,117.641,102.5001,117.641" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M109.5,253.445 C109.5,265.817 109.5,279.568 109.5,292.912 " fill="none" id="WriteableScope&lt;-ScopeImpl" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="102.5001,253.047,109.5,233.047,116.5,253.047,102.5001,253.047" style="stroke:#A80036;stroke-width:1.0;"></polygon></g></svg><p>一个作用域内定义的多个符号存储在 table 数组中，由于 table 数组专门用来存储符号，因而也可以直接叫符号表。同一个作用域内定义的所有符号会形成单链表，elems 保存了这个单链表的首个 Entry 对象，nelems 保存了单链表中 Entry 对象的总数。</p> <p>而符号的数据结构如下：</p> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="366px" preserveAspectRatio="none" version="1.1" viewBox="0 0 496 366" width="496px" zoomAndPan="magnify" style="width:496px;height:366px;"><defs><filter height="300%" id="fxblue8od08nv" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FEFECE" filter="url(#fxblue8od08nv)" height="131.0156" id="Symbol" width="177" x="199" y="8" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="262.75" cy="24" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M265.5156,19.875 Q265.6719,19.6563 265.8594,19.5469 Q266.0469,19.4375 266.2656,19.4375 Q266.6406,19.4375 266.875,19.6953 Q267.1094,19.9531 267.1094,20.5625 L267.1094,22.0156 Q267.1094,22.625 266.875,22.8906 Q266.6406,23.1563 266.2656,23.1563 Q265.9219,23.1563 265.7188,22.9531 Q265.5156,22.7656 265.4063,22.25 Q265.3594,21.8906 265.1719,21.7031 Q264.8438,21.3281 264.2344,21.1094 Q263.625,20.8906 263,20.8906 Q262.2344,20.8906 261.6016,21.2188 Q260.9688,21.5469 260.4766,22.2969 Q259.9844,23.0469 259.9844,24.0781 L259.9844,25.1719 Q259.9844,26.4063 260.875,27.2266 Q261.7656,28.0469 263.3594,28.0469 Q264.2969,28.0469 264.9531,27.7969 Q265.3438,27.6406 265.7656,27.2031 Q266.0313,26.9375 266.1797,26.8594 Q266.3281,26.7813 266.5313,26.7813 Q266.8594,26.7813 267.1172,27.0391 Q267.375,27.2969 267.375,27.6406 Q267.375,27.9844 267.0313,28.3906 Q266.5313,28.9688 265.7344,29.2969 Q264.6563,29.75 263.3594,29.75 Q261.8438,29.75 260.6406,29.125 Q259.6563,28.625 258.9688,27.5547 Q258.2813,26.4844 258.2813,25.2031 L258.2813,24.0469 Q258.2813,22.7188 258.8984,21.5703 Q259.5156,20.4219 260.6094,19.8047 Q261.7031,19.1875 262.9375,19.1875 Q263.6719,19.1875 264.3203,19.3516 Q264.9688,19.5156 265.5156,19.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="41" x="283.25" y="28.9102">Symbol</text><line x1="200" x2="375" y1="40" y2="40" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="46" x="205" y="55.4189">Kind kind;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="59" x="205" y="69.2549">Name name;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="51" x="205" y="83.0908">Type type;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="73" x="205" y="96.9268">Symbol owner;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="165" x="205" y="110.7627">long flags_field; // 保存符号修饰符</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="101" x="205" y="124.5986">Completer completer;</text><line x1="200" x2="375" y1="131.0156" y2="131.0156" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fxblue8od08nv)" height="48" id="TypeSymbol" width="102" x="104.5" y="199" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="119.5" cy="215" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M121.6875,216.7656 L117.5469,216.7656 L117.125,217.7969 L117.5469,217.7969 Q118.1563,217.7969 118.4219,218.0313 Q118.6875,218.2656 118.6875,218.6563 Q118.6875,219.0313 118.4219,219.2656 Q118.1563,219.5 117.5469,219.5 L115.25,219.5 Q114.6406,219.5 114.3828,219.2656 Q114.125,219.0313 114.125,218.6406 Q114.125,218.2656 114.3984,218.0234 Q114.6719,217.7813 115.2969,217.7969 L117.9688,211.1406 L116.8594,211.1406 Q116.25,211.1406 115.9844,210.9063 Q115.7188,210.6719 115.7188,210.2813 Q115.7188,209.9063 115.9844,209.6719 Q116.25,209.4375 116.8594,209.4375 L120.5313,209.4375 L123.9219,217.7969 Q124.5156,217.7969 124.7031,217.9375 Q125.0938,218.2031 125.0938,218.6563 Q125.0938,219.0313 124.8359,219.2656 Q124.5781,219.5 123.9688,219.5 L121.6719,219.5 Q121.0625,219.5 120.7969,219.2656 Q120.5313,219.0313 120.5313,218.6406 Q120.5313,218.2656 120.7969,218.0313 Q121.0625,217.7969 121.6719,217.7969 L122.0938,217.7969 L121.6875,216.7656 Z M120.9688,215.0625 L119.6094,211.6875 L118.2344,215.0625 L120.9688,215.0625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="70" x="133.5" y="219.9102">TypeSymbol</text><line x1="105.5" x2="205.5" y1="231" y2="231" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="105.5" x2="205.5" y1="239" y2="239" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fxblue8od08nv)" height="48" id="PackageSymbol" width="121" x="6" y="307" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="21" cy="323" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M23.7656,318.875 Q23.9219,318.6563 24.1094,318.5469 Q24.2969,318.4375 24.5156,318.4375 Q24.8906,318.4375 25.125,318.6953 Q25.3594,318.9531 25.3594,319.5625 L25.3594,321.0156 Q25.3594,321.625 25.125,321.8906 Q24.8906,322.1563 24.5156,322.1563 Q24.1719,322.1563 23.9688,321.9531 Q23.7656,321.7656 23.6563,321.25 Q23.6094,320.8906 23.4219,320.7031 Q23.0938,320.3281 22.4844,320.1094 Q21.875,319.8906 21.25,319.8906 Q20.4844,319.8906 19.8516,320.2188 Q19.2188,320.5469 18.7266,321.2969 Q18.2344,322.0469 18.2344,323.0781 L18.2344,324.1719 Q18.2344,325.4063 19.125,326.2266 Q20.0156,327.0469 21.6094,327.0469 Q22.5469,327.0469 23.2031,326.7969 Q23.5938,326.6406 24.0156,326.2031 Q24.2813,325.9375 24.4297,325.8594 Q24.5781,325.7813 24.7813,325.7813 Q25.1094,325.7813 25.3672,326.0391 Q25.625,326.2969 25.625,326.6406 Q25.625,326.9844 25.2813,327.3906 Q24.7813,327.9688 23.9844,328.2969 Q22.9063,328.75 21.6094,328.75 Q20.0938,328.75 18.8906,328.125 Q17.9063,327.625 17.2188,326.5547 Q16.5313,325.4844 16.5313,324.2031 L16.5313,323.0469 Q16.5313,321.7188 17.1484,320.5703 Q17.7656,319.4219 18.8594,318.8047 Q19.9531,318.1875 21.1875,318.1875 Q21.9219,318.1875 22.5703,318.3516 Q23.2188,318.5156 23.7656,318.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="89" x="35" y="327.9102">PackageSymbol</text><line x1="7" x2="126" y1="339" y2="339" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="7" x2="126" y1="347" y2="347" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fxblue8od08nv)" height="48" id="ClassSymbol" width="106" x="162.5" y="307" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="177.5" cy="323" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M180.2656,318.875 Q180.4219,318.6563 180.6094,318.5469 Q180.7969,318.4375 181.0156,318.4375 Q181.3906,318.4375 181.625,318.6953 Q181.8594,318.9531 181.8594,319.5625 L181.8594,321.0156 Q181.8594,321.625 181.625,321.8906 Q181.3906,322.1563 181.0156,322.1563 Q180.6719,322.1563 180.4688,321.9531 Q180.2656,321.7656 180.1563,321.25 Q180.1094,320.8906 179.9219,320.7031 Q179.5938,320.3281 178.9844,320.1094 Q178.375,319.8906 177.75,319.8906 Q176.9844,319.8906 176.3516,320.2188 Q175.7188,320.5469 175.2266,321.2969 Q174.7344,322.0469 174.7344,323.0781 L174.7344,324.1719 Q174.7344,325.4063 175.625,326.2266 Q176.5156,327.0469 178.1094,327.0469 Q179.0469,327.0469 179.7031,326.7969 Q180.0938,326.6406 180.5156,326.2031 Q180.7813,325.9375 180.9297,325.8594 Q181.0781,325.7813 181.2813,325.7813 Q181.6094,325.7813 181.8672,326.0391 Q182.125,326.2969 182.125,326.6406 Q182.125,326.9844 181.7813,327.3906 Q181.2813,327.9688 180.4844,328.2969 Q179.4063,328.75 178.1094,328.75 Q176.5938,328.75 175.3906,328.125 Q174.4063,327.625 173.7188,326.5547 Q173.0313,325.4844 173.0313,324.2031 L173.0313,323.0469 Q173.0313,321.7188 173.6484,320.5703 Q174.2656,319.4219 175.3594,318.8047 Q176.4531,318.1875 177.6875,318.1875 Q178.4219,318.1875 179.0703,318.3516 Q179.7188,318.5156 180.2656,318.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="74" x="191.5" y="327.9102">ClassSymbol</text><line x1="163.5" x2="267.5" y1="339" y2="339" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="163.5" x2="267.5" y1="347" y2="347" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fxblue8od08nv)" height="48" id="VarSymbol" width="91" x="242" y="199" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="257" cy="215" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M259.7656,210.875 Q259.9219,210.6563 260.1094,210.5469 Q260.2969,210.4375 260.5156,210.4375 Q260.8906,210.4375 261.125,210.6953 Q261.3594,210.9531 261.3594,211.5625 L261.3594,213.0156 Q261.3594,213.625 261.125,213.8906 Q260.8906,214.1563 260.5156,214.1563 Q260.1719,214.1563 259.9688,213.9531 Q259.7656,213.7656 259.6563,213.25 Q259.6094,212.8906 259.4219,212.7031 Q259.0938,212.3281 258.4844,212.1094 Q257.875,211.8906 257.25,211.8906 Q256.4844,211.8906 255.8516,212.2188 Q255.2188,212.5469 254.7266,213.2969 Q254.2344,214.0469 254.2344,215.0781 L254.2344,216.1719 Q254.2344,217.4063 255.125,218.2266 Q256.0156,219.0469 257.6094,219.0469 Q258.5469,219.0469 259.2031,218.7969 Q259.5938,218.6406 260.0156,218.2031 Q260.2813,217.9375 260.4297,217.8594 Q260.5781,217.7813 260.7813,217.7813 Q261.1094,217.7813 261.3672,218.0391 Q261.625,218.2969 261.625,218.6406 Q261.625,218.9844 261.2813,219.3906 Q260.7813,219.9688 259.9844,220.2969 Q258.9063,220.75 257.6094,220.75 Q256.0938,220.75 254.8906,220.125 Q253.9063,219.625 253.2188,218.5547 Q252.5313,217.4844 252.5313,216.2031 L252.5313,215.0469 Q252.5313,213.7188 253.1484,212.5703 Q253.7656,211.4219 254.8594,210.8047 Q255.9531,210.1875 257.1875,210.1875 Q257.9219,210.1875 258.5703,210.3516 Q259.2188,210.5156 259.7656,210.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="59" x="271" y="219.9102">VarSymbol</text><line x1="243" x2="332" y1="231" y2="231" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="243" x2="332" y1="239" y2="239" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fxblue8od08nv)" height="48" id="MethodSymbol" width="113" x="368" y="199" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="383" cy="215" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M385.7656,210.875 Q385.9219,210.6563 386.1094,210.5469 Q386.2969,210.4375 386.5156,210.4375 Q386.8906,210.4375 387.125,210.6953 Q387.3594,210.9531 387.3594,211.5625 L387.3594,213.0156 Q387.3594,213.625 387.125,213.8906 Q386.8906,214.1563 386.5156,214.1563 Q386.1719,214.1563 385.9688,213.9531 Q385.7656,213.7656 385.6563,213.25 Q385.6094,212.8906 385.4219,212.7031 Q385.0938,212.3281 384.4844,212.1094 Q383.875,211.8906 383.25,211.8906 Q382.4844,211.8906 381.8516,212.2188 Q381.2188,212.5469 380.7266,213.2969 Q380.2344,214.0469 380.2344,215.0781 L380.2344,216.1719 Q380.2344,217.4063 381.125,218.2266 Q382.0156,219.0469 383.6094,219.0469 Q384.5469,219.0469 385.2031,218.7969 Q385.5938,218.6406 386.0156,218.2031 Q386.2813,217.9375 386.4297,217.8594 Q386.5781,217.7813 386.7813,217.7813 Q387.1094,217.7813 387.3672,218.0391 Q387.625,218.2969 387.625,218.6406 Q387.625,218.9844 387.2813,219.3906 Q386.7813,219.9688 385.9844,220.2969 Q384.9063,220.75 383.6094,220.75 Q382.0938,220.75 380.8906,220.125 Q379.9063,219.625 379.2188,218.5547 Q378.5313,217.4844 378.5313,216.2031 L378.5313,215.0469 Q378.5313,213.7188 379.1484,212.5703 Q379.7656,211.4219 380.8594,210.8047 Q381.9531,210.1875 383.1875,210.1875 Q383.9219,210.1875 384.5703,210.3516 Q385.2188,210.5156 385.7656,210.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="81" x="397" y="219.9102">MethodSymbol</text><line x1="369" x2="480" y1="231" y2="231" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="369" x2="480" y1="239" y2="239" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fxblue8od08nv)" height="48" id="OperatorSymbol" width="121" x="364" y="307" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="379" cy="323" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M381.7656,318.875 Q381.9219,318.6563 382.1094,318.5469 Q382.2969,318.4375 382.5156,318.4375 Q382.8906,318.4375 383.125,318.6953 Q383.3594,318.9531 383.3594,319.5625 L383.3594,321.0156 Q383.3594,321.625 383.125,321.8906 Q382.8906,322.1563 382.5156,322.1563 Q382.1719,322.1563 381.9688,321.9531 Q381.7656,321.7656 381.6563,321.25 Q381.6094,320.8906 381.4219,320.7031 Q381.0938,320.3281 380.4844,320.1094 Q379.875,319.8906 379.25,319.8906 Q378.4844,319.8906 377.8516,320.2188 Q377.2188,320.5469 376.7266,321.2969 Q376.2344,322.0469 376.2344,323.0781 L376.2344,324.1719 Q376.2344,325.4063 377.125,326.2266 Q378.0156,327.0469 379.6094,327.0469 Q380.5469,327.0469 381.2031,326.7969 Q381.5938,326.6406 382.0156,326.2031 Q382.2813,325.9375 382.4297,325.8594 Q382.5781,325.7813 382.7813,325.7813 Q383.1094,325.7813 383.3672,326.0391 Q383.625,326.2969 383.625,326.6406 Q383.625,326.9844 383.2813,327.3906 Q382.7813,327.9688 381.9844,328.2969 Q380.9063,328.75 379.6094,328.75 Q378.0938,328.75 376.8906,328.125 Q375.9063,327.625 375.2188,326.5547 Q374.5313,325.4844 374.5313,324.2031 L374.5313,323.0469 Q374.5313,321.7188 375.1484,320.5703 Q375.7656,319.4219 376.8594,318.8047 Q377.9531,318.1875 379.1875,318.1875 Q379.9219,318.1875 380.5703,318.3516 Q381.2188,318.5156 381.7656,318.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="89" x="393" y="327.9102">OperatorSymbol</text><line x1="365" x2="484" y1="339" y2="339" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="365" x2="484" y1="347" y2="347" style="stroke:#A80036;stroke-width:1.5;"></line><path d="M216.19,154.183 C201.602,170.484 187.362,186.396 176.346,198.706 " fill="none" id="Symbol&lt;-TypeSymbol" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="211.049,149.431,229.603,139.196,221.482,158.767,211.049,149.431" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M123.005,262.7021 C110.623,277.4485 96.902,293.7909 86.0813,306.6784 " fill="none" id="TypeSymbol&lt;-PackageSymbol" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="117.967,257.8162,136.188,247,128.689,266.8186,117.967,257.8162" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M178.489,264.6133 C186.546,278.8479 195.318,294.3452 202.299,306.6784 " fill="none" id="TypeSymbol&lt;-ClassSymbol" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="172.279,267.8538,168.519,247,184.463,260.9574,172.279,267.8538" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M287.5,159.653 C287.5,174.011 287.5,187.778 287.5,198.706 " fill="none" id="Symbol&lt;-VarSymbol" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="280.5,159.196,287.5,139.196,294.5,159.196,280.5,159.196" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M361.511,154.183 C376.651,170.484 391.431,186.396 402.864,198.706 " fill="none" id="Symbol&lt;-MethodSymbol" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="356.072,158.614,347.59,139.196,366.33,149.086,356.072,158.614" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M424.5,267.0236 C424.5,280.5792 424.5,295.0381 424.5,306.6784 " fill="none" id="MethodSymbol&lt;-OperatorSymbol" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="417.5,267.0005,424.5,247,431.5,267.0004,417.5,267.0005" style="stroke:#A80036;stroke-width:1.0;"></polygon></g></svg><p>同时符号还会在<code>Symtab</code>中缓存起来：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Symtab</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Name</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">,</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> classes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Name</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">,</span><span class="token class-name">PackageSymbol</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> packages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">/** Create a new toplevel or member class symbol with given name
     *  and owner and enter in `classes' unless already there.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ClassSymbol</span> <span class="token function">enterClass</span><span class="token punctuation">(</span><span class="token class-name">ModuleSymbol</span> msym<span class="token punctuation">,</span> <span class="token class-name">Name</span> name<span class="token punctuation">,</span> <span class="token class-name">TypeSymbol</span> owner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">checkNonNull</span><span class="token punctuation">(</span>msym<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Name</span> flatname <span class="token operator">=</span> <span class="token class-name">TypeSymbol</span><span class="token punctuation">.</span><span class="token function">formFlatName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassSymbol</span> c <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span>msym<span class="token punctuation">,</span> flatname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            c <span class="token operator">=</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doEnterClass</span><span class="token punctuation">(</span>msym<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name <span class="token operator">!=</span> name <span class="token operator">||</span> c<span class="token punctuation">.</span>owner <span class="token operator">!=</span> owner<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> owner<span class="token punctuation">.</span>kind <span class="token operator">==</span> TYP <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>owner<span class="token punctuation">.</span>kind <span class="token operator">==</span> PCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// reassign fields of classes that might have been loaded with</span>
            <span class="token comment">// their flat names.</span>
            c<span class="token punctuation">.</span>owner<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            c<span class="token punctuation">.</span>owner <span class="token operator">=</span> owner<span class="token punctuation">;</span>
            c<span class="token punctuation">.</span>fullname <span class="token operator">=</span> <span class="token class-name">ClassSymbol</span><span class="token punctuation">.</span><span class="token function">formFullName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h6 id="_4-1-4-2-符号表的填充过程"><a href="#_4-1-4-2-符号表的填充过程" class="header-anchor">#</a> 4.1.4.2 符号表的填充过程</h6> <p>语法树除了包含前面已经填充好的语法树子节点 List，还包含作用域 Scope、包符号、Type 等属性，符号表的填充也就是填充语法树中的这些还未填充的属性</p> <p><img src="/snote/assets/img/image-20210609231646204.f7370696.png" alt="image-20210609231646204"></p> <p>符号表填充的时序图如下：</p> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1303px" preserveAspectRatio="none" version="1.1" viewBox="0 0 1442 1303" width="1442px" zoomAndPan="magnify" style="width:1442px;height:1303px;"><defs><filter height="300%" id="fi3an8cbptct9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="1181.0859" width="10" x="67" y="71.9609" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="1142.7344" width="10" x="72" y="110.3125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="1107.3828" width="10" x="154.5" y="145.6641" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="1069.0313" width="10" x="159.5" y="184.0156" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="757.5703" width="10" x="164.5" y="227.3672" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="657.8672" width="10" x="169.5" y="293.0703" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="25" width="10" x="174.5" y="904.9375" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="702.2188" width="10" x="270.5" y="262.7188" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="14" width="10" x="379" y="323.4219" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="498.8125" width="10" x="379" y="367.7734" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="14" width="10" x="384" y="675.5859" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="454.4609" width="10" x="481" y="398.125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="395.1094" width="10" x="486" y="436.4766" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="339.7578" width="10" x="597.5" y="471.8281" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="280.4063" width="10" x="602.5" y="510.1797" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="210.0547" width="10" x="607.5" y="553.5313" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="139.7031" width="10" x="612.5" y="596.8828" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="69.3516" width="10" x="617.5" y="640.2344" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="230.7578" width="10" x="731.5" y="1022.2891" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="191.4063" width="10" x="833" y="1052.6406" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="147.0547" width="10" x="1010" y="1082.9922" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="102.7031" width="10" x="1131" y="1113.3438" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="58.3516" width="10" x="1252" y="1143.6953" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="14" width="10" x="1372" y="1174.0469" style="stroke:#A80036;stroke-width:1.0;"></rect><line x1="71.5" x2="71.5" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="159.5" x2="159.5" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="275.5" x2="275.5" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="383.5" x2="383.5" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="485.5" x2="485.5" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="602.5" x2="602.5" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="736" x2="736" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="838" x2="838" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1015" x2="1015" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1136" x2="1136" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1257" x2="1257" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1377" x2="1377" y1="39.6094" y2="1262.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="99" x="20.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="27.5" y="24.5332">JavaCompiler</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="99" x="20.5" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="27.5" y="1282.5801">JavaCompiler</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="48" x="133.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="140.5" y="24.5332">Enter</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="48" x="133.5" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="140.5" y="1282.5801">Enter</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="128" x="209.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="216.5" y="24.5332">JCCompilationUnit</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="128" x="209.5" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="216.5" y="1282.5801">JCCompilationUnit</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="61" x="351.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="358.5" y="24.5332">Symtab</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="61" x="351.5" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="358.5" y="1282.5801">Symtab</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="115" x="426.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="433.5" y="24.5332">PackageSymbol</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="115" x="426.5" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="433.5" y="1282.5801">PackageSymbol</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="90" x="555.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="562.5" y="24.5332">ClassFinder</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="90" x="555.5" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="562.5" y="1282.5801">ClassFinder</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="95" x="687" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="694" y="24.5332">ClassSymbol</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="95" x="687" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="694" y="1282.5801">ClassSymbol</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="80" x="796" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="803" y="24.5332">TypeEnter</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="80" x="796" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="803" y="1282.5801">TypeEnter</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="100" x="963" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="970" y="24.5332">ImportsPhase</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="100" x="963" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="970" y="1282.5801">ImportsPhase</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="114" x="1077" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="1084" y="24.5332">HierarchyPhase</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="114" x="1077" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="1084" y="1282.5801">HierarchyPhase</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="100" x="1205" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1212" y="24.5332">HeaderPhase</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="100" x="1205" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1212" y="1282.5801">HeaderPhase</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="112" x="1319" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1326" y="24.5332">MembersPhase</text><rect fill="#FEFECE" filter="url(#fi3an8cbptct9)" height="31.6094" width="112" x="1319" y="1261.0469" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1326" y="1282.5801">MembersPhase</text><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="1181.0859" width="10" x="67" y="71.9609" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="1142.7344" width="10" x="72" y="110.3125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="1107.3828" width="10" x="154.5" y="145.6641" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="1069.0313" width="10" x="159.5" y="184.0156" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="757.5703" width="10" x="164.5" y="227.3672" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="657.8672" width="10" x="169.5" y="293.0703" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="25" width="10" x="174.5" y="904.9375" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="702.2188" width="10" x="270.5" y="262.7188" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="14" width="10" x="379" y="323.4219" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="498.8125" width="10" x="379" y="367.7734" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="14" width="10" x="384" y="675.5859" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="454.4609" width="10" x="481" y="398.125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="395.1094" width="10" x="486" y="436.4766" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="339.7578" width="10" x="597.5" y="471.8281" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="280.4063" width="10" x="602.5" y="510.1797" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="210.0547" width="10" x="607.5" y="553.5313" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="139.7031" width="10" x="612.5" y="596.8828" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="69.3516" width="10" x="617.5" y="640.2344" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="230.7578" width="10" x="731.5" y="1022.2891" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="191.4063" width="10" x="833" y="1052.6406" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="147.0547" width="10" x="1010" y="1082.9922" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="102.7031" width="10" x="1131" y="1113.3438" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="58.3516" width="10" x="1252" y="1143.6953" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fi3an8cbptct9)" height="14" width="10" x="1372" y="1174.0469" style="stroke:#A80036;stroke-width:1.0;"></rect><polygon fill="#A80036" points="55,67.9609,65,71.9609,55,75.9609,59,71.9609" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="3" x2="61" y1="71.9609" y2="71.9609" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="10" y="67.1045">compile</text><line x1="77" x2="124" y1="97.3125" y2="97.3125" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="124" x2="124" y1="97.3125" y2="110.3125" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="83" x2="124" y1="110.3125" y2="110.3125" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="93,106.3125,83,110.3125,93,114.3125,89,110.3125" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="89" y="92.4561">enterTrees</text><polygon fill="#A80036" points="142.5,141.6641,152.5,145.6641,142.5,149.6641,146.5,145.6641" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="82" x2="148.5" y1="145.6641" y2="145.6641" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="89" y="140.8076">main</text><line x1="164.5" x2="211.5" y1="171.0156" y2="171.0156" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="211.5" x2="211.5" y1="171.0156" y2="184.0156" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="170.5" x2="211.5" y1="184.0156" y2="184.0156" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="180.5,180.0156,170.5,184.0156,180.5,188.0156,176.5,184.0156" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="176.5" y="166.1592">complete</text><line x1="169.5" x2="216.5" y1="214.3672" y2="214.3672" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="216.5" x2="216.5" y1="214.3672" y2="227.3672" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="175.5" x2="216.5" y1="227.3672" y2="227.3672" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="185.5,223.3672,175.5,227.3672,185.5,231.3672,181.5,227.3672" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="181.5" y="209.5107">1.classEnter</text><polygon fill="#A80036" points="258.5,258.7188,268.5,262.7188,258.5,266.7188,262.5,262.7188" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="174.5" x2="264.5" y1="262.7188" y2="262.7188" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="181.5" y="257.8623">accept</text><polygon fill="#A80036" points="190.5,289.0703,180.5,293.0703,190.5,297.0703,186.5,293.0703" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="184.5" x2="269.5" y1="293.0703" y2="293.0703" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="196.5" y="288.2139">visitTopLevel</text><polygon fill="#A80036" points="367,319.4219,377,323.4219,367,327.4219,371,323.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="179.5" x2="373" y1="323.4219" y2="323.4219" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="186.5" y="318.5654">enterPackage</text><polygon fill="#A80036" points="190.5,333.4219,180.5,337.4219,190.5,341.4219,186.5,337.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="184.5" x2="383" y1="337.4219" y2="337.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="367,363.7734,377,367.7734,367,371.7734,371,367.7734" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="179.5" x2="373" y1="367.7734" y2="367.7734" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="186.5" y="362.917">listPackageModules</text><polygon fill="#A80036" points="469,394.125,479,398.125,469,402.125,473,398.125" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="389" x2="475" y1="398.125" y2="398.125" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="396" y="393.2686">members</text><line x1="491" x2="538" y1="423.4766" y2="423.4766" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="538" x2="538" y1="423.4766" y2="436.4766" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="497" x2="538" y1="436.4766" y2="436.4766" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="507,432.4766,497,436.4766,507,440.4766,503,436.4766" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="503" y="418.6201">complete</text><polygon fill="#A80036" points="585.5,467.8281,595.5,471.8281,585.5,475.8281,589.5,471.8281" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="496" x2="591.5" y1="471.8281" y2="471.8281" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="503" y="466.9717">complete</text><line x1="607.5" x2="654.5" y1="497.1797" y2="497.1797" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="654.5" x2="654.5" y1="497.1797" y2="510.1797" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="613.5" x2="654.5" y1="510.1797" y2="510.1797" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="623.5,506.1797,613.5,510.1797,623.5,514.1797,619.5,510.1797" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="619.5" y="492.3232">fillIn</text><line x1="612.5" x2="659.5" y1="540.5313" y2="540.5313" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="659.5" x2="659.5" y1="540.5313" y2="553.5313" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="618.5" x2="659.5" y1="553.5313" y2="553.5313" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="628.5,549.5313,618.5,553.5313,628.5,557.5313,624.5,553.5313" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="624.5" y="535.6748">scanUserPaths</text><line x1="617.5" x2="664.5" y1="583.8828" y2="583.8828" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="664.5" x2="664.5" y1="583.8828" y2="596.8828" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="623.5" x2="664.5" y1="596.8828" y2="596.8828" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="633.5,592.8828,623.5,596.8828,633.5,600.8828,629.5,596.8828" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="629.5" y="579.0264">fillIn</text><line x1="622.5" x2="669.5" y1="627.2344" y2="627.2344" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="669.5" x2="669.5" y1="627.2344" y2="640.2344" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="628.5" x2="669.5" y1="640.2344" y2="640.2344" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="638.5,636.2344,628.5,640.2344,638.5,644.2344,634.5,640.2344" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="634.5" y="622.3779">includeClassFile</text><polygon fill="#A80036" points="405,671.5859,395,675.5859,405,679.5859,401,675.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="399" x2="616.5" y1="675.5859" y2="675.5859" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="411" y="670.7295">enterClass</text><polygon fill="#A80036" points="605.5,685.5859,615.5,689.5859,605.5,693.5859,609.5,689.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="389" x2="611.5" y1="689.5859" y2="689.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="627.5" x2="669.5" y1="708.5859" y2="708.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="669.5" x2="669.5" y1="708.5859" y2="721.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="622.5" x2="669.5" y1="721.5859" y2="721.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="632.5,717.5859,622.5,721.5859,632.5,725.5859,628.5,721.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="622.5" x2="664.5" y1="735.5859" y2="735.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="664.5" x2="664.5" y1="735.5859" y2="748.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="617.5" x2="664.5" y1="748.5859" y2="748.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="627.5,744.5859,617.5,748.5859,627.5,752.5859,623.5,748.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="617.5" x2="659.5" y1="762.5859" y2="762.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="659.5" x2="659.5" y1="762.5859" y2="775.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="612.5" x2="659.5" y1="775.5859" y2="775.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="622.5,771.5859,612.5,775.5859,622.5,779.5859,618.5,775.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="612.5" x2="654.5" y1="789.5859" y2="789.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="654.5" x2="654.5" y1="789.5859" y2="802.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="607.5" x2="654.5" y1="802.5859" y2="802.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="617.5,798.5859,607.5,802.5859,617.5,806.5859,613.5,802.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="507,807.5859,497,811.5859,507,815.5859,503,811.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="501" x2="601.5" y1="811.5859" y2="811.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="496" x2="538" y1="830.5859" y2="830.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="538" x2="538" y1="830.5859" y2="843.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="491" x2="538" y1="843.5859" y2="843.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="501,839.5859,491,843.5859,501,847.5859,497,843.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="400,848.5859,390,852.5859,400,856.5859,396,852.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="394" x2="485" y1="852.5859" y2="852.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="190.5,862.5859,180.5,866.5859,190.5,870.5859,186.5,866.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="184.5" x2="383" y1="866.5859" y2="866.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="179.5" x2="226.5" y1="891.9375" y2="891.9375" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="226.5" x2="226.5" y1="891.9375" y2="904.9375" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="185.5" x2="226.5" y1="904.9375" y2="904.9375" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="195.5,900.9375,185.5,904.9375,195.5,908.9375,191.5,904.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="191.5" y="887.0811">classEnter</text><line x1="184.5" x2="226.5" y1="928.9375" y2="928.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="226.5" x2="226.5" y1="928.9375" y2="941.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="179.5" x2="226.5" y1="941.9375" y2="941.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="189.5,937.9375,179.5,941.9375,189.5,945.9375,185.5,941.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="258.5,946.9375,268.5,950.9375,258.5,954.9375,262.5,950.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="174.5" x2="264.5" y1="950.9375" y2="950.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="185.5,960.9375,175.5,964.9375,185.5,968.9375,181.5,964.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="179.5" x2="274.5" y1="964.9375" y2="964.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="174.5" x2="216.5" y1="983.9375" y2="983.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="216.5" x2="216.5" y1="983.9375" y2="996.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="169.5" x2="216.5" y1="996.9375" y2="996.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="179.5,992.9375,169.5,996.9375,179.5,1000.9375,175.5,996.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="719.5,1018.2891,729.5,1022.2891,719.5,1026.2891,723.5,1022.2891" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="169.5" x2="725.5" y1="1022.2891" y2="1022.2891" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="176.5" y="1017.4326">2.complete</text><polygon fill="#A80036" points="821,1048.6406,831,1052.6406,821,1056.6406,825,1052.6406" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="741.5" x2="827" y1="1052.6406" y2="1052.6406" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="748.5" y="1047.7842">complete</text><polygon fill="#A80036" points="998,1078.9922,1008,1082.9922,998,1086.9922,1002,1082.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="843" x2="1004" y1="1082.9922" y2="1082.9922" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="850" y="1078.1357">completeEnvs-&gt;runPhase</text><polygon fill="#A80036" points="1119,1109.3438,1129,1113.3438,1119,1117.3438,1123,1113.3438" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1020" x2="1125" y1="1113.3438" y2="1113.3438" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="1027" y="1108.4873">completeEnvs</text><polygon fill="#A80036" points="1240,1139.6953,1250,1143.6953,1240,1147.6953,1244,1143.6953" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1141" x2="1246" y1="1143.6953" y2="1143.6953" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="1148" y="1138.8389">completeEnvs</text><polygon fill="#A80036" points="1360,1170.0469,1370,1174.0469,1360,1178.0469,1364,1174.0469" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1262" x2="1366" y1="1174.0469" y2="1174.0469" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="1269" y="1169.1904">completeEnvs</text><polygon fill="#A80036" points="1273,1184.0469,1263,1188.0469,1273,1192.0469,1269,1188.0469" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1267" x2="1376" y1="1188.0469" y2="1188.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="1152,1198.0469,1142,1202.0469,1152,1206.0469,1148,1202.0469" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1146" x2="1256" y1="1202.0469" y2="1202.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="1031,1212.0469,1021,1216.0469,1031,1220.0469,1027,1216.0469" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1025" x2="1135" y1="1216.0469" y2="1216.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="854,1226.0469,844,1230.0469,854,1234.0469,850,1230.0469" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="848" x2="1014" y1="1230.0469" y2="1230.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="752.5,1240.0469,742.5,1244.0469,752.5,1248.0469,748.5,1244.0469" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="746.5" x2="837" y1="1244.0469" y2="1244.0469" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line></g></svg><p>两个阶段</p> <p>符号表的填充主要分为两个过程：</p> <blockquote><ul><li>填充包符号，并创建类符号本身，对于类符号内部的方法、成员属性，会在下一个阶段填充</li> <li>填充 ImportScope、type 和父类型以及接口、成员属性、成员方法</li></ul></blockquote> <p>这两个过程主要由 <code>com.sun.tools.javac.comp.Enter</code>、<code>com.sun.tools.javac.comp.TypeEnter</code>、<code>com.sun.tools.javac.comp.MemberEnter</code>类来完成。</p> <p>程序首先会进入到 <code>Enter#complete()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
    <span class="token comment">/** Main method: enter classes from the list of toplevel trees, possibly
     *  skipping TypeEnter for all but 'c' by placing them on the uncompleted
     *  list.
     *  @param trees      The list of trees to be processed.
     *  @param c          The class symbol to be processed or null to process all.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCCompilationUnit</span><span class="token punctuation">&gt;</span></span> trees<span class="token punctuation">,</span> <span class="token class-name">ClassSymbol</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        annotate<span class="token punctuation">.</span><span class="token function">blockAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ListBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">&gt;</span></span> prevUncompleted <span class="token operator">=</span> uncompleted<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>typeEnter<span class="token punctuation">.</span>completionEnabled<span class="token punctuation">)</span> uncompleted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// enter all classes, and construct uncompleted list</span>
            <span class="token comment">// 阶段1</span>
            <span class="token function">classEnter</span><span class="token punctuation">(</span>trees<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// complete all uncompleted classes in memberEnter</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>typeEnter<span class="token punctuation">.</span>completionEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>uncompleted<span class="token punctuation">.</span><span class="token function">nonEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ClassSymbol</span> clazz <span class="token operator">=</span> uncompleted<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> c <span class="token operator">==</span> clazz <span class="token operator">||</span> prevUncompleted <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token comment">// 阶段2</span>
                        clazz<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        <span class="token comment">// defer</span>
                        prevUncompleted<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modules<span class="token punctuation">.</span><span class="token function">modulesInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JCCompilationUnit</span> cut <span class="token operator">:</span> trees<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>cut<span class="token punctuation">.</span><span class="token function">getModuleDecl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            unfinishedModules<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>cut<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            typeEnter<span class="token punctuation">.</span><span class="token function">ensureImportsChecked</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>cut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    typeEnter<span class="token punctuation">.</span><span class="token function">ensureImportsChecked</span><span class="token punctuation">(</span>unfinishedModules<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    unfinishedModules<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    typeEnter<span class="token punctuation">.</span><span class="token function">ensureImportsChecked</span><span class="token punctuation">(</span>trees<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            uncompleted <span class="token operator">=</span> prevUncompleted<span class="token punctuation">;</span>
            annotate<span class="token punctuation">.</span><span class="token function">unblockAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>进行阶段 1 前，语法树填充情况如下：</p> <p><img src="/snote/assets/img/image-20210609231646204.f7370696.png" alt="image-20210609231646204"></p> <p>进行阶段 2 前，语法树填充情况如下：</p> <p><img src="/snote/assets/img/image-20210609233156958.d4420563.png" alt="image-20210609233156958"></p> <p>完成阶段 2 后，语法树填充情况如下：</p> <p><img src="/snote/assets/img/image-20210609233506776.40deb08b.png" alt="image-20210609233506776"></p> <p>（1）阶段 1：创建包或类符号</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Enter</span> <span class="token keyword">extends</span> <span class="token class-name">JCTree<span class="token punctuation">.</span>Visitor</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitTopLevel</span><span class="token punctuation">(</span><span class="token class-name">JCCompilationUnit</span> tree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Assert.checkNonNull(tree.modle, tree.sourcefile.toString());</span>

        <span class="token class-name">JavaFileObject</span> prev <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">useSource</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>sourcefile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> addEnv <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isPkgInfo <span class="token operator">=</span> tree<span class="token punctuation">.</span>sourcefile<span class="token punctuation">.</span><span class="token function">isNameCompatible</span><span class="token punctuation">(</span><span class="token string">&quot;package-info&quot;</span><span class="token punctuation">,</span>
                                                             <span class="token class-name">JavaFileObject<span class="token punctuation">.</span>Kind</span><span class="token punctuation">.</span>SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TreeInfo</span><span class="token punctuation">.</span><span class="token function">isModuleInfo</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">JCPackageDecl</span> pd <span class="token operator">=</span> tree<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Errors<span class="token punctuation">.</span>NoPkgInModuleInfoJava</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tree<span class="token punctuation">.</span>packge <span class="token operator">=</span> syms<span class="token punctuation">.</span>rootPackage<span class="token punctuation">;</span>
            <span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> topEnv <span class="token operator">=</span> <span class="token function">topLevelEnv</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">classEnter</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>defs<span class="token punctuation">,</span> topEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tree<span class="token punctuation">.</span>modle<span class="token punctuation">.</span>usesProvidesCompleter <span class="token operator">=</span> modules<span class="token punctuation">.</span><span class="token function">getUsesProvidesCompleter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">JCPackageDecl</span> pd <span class="token operator">=</span> tree<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 1.递归创建包符号</span>
                tree<span class="token punctuation">.</span>packge <span class="token operator">=</span> pd<span class="token punctuation">.</span>packge <span class="token operator">=</span> syms<span class="token punctuation">.</span><span class="token function">enterPackage</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>modle<span class="token punctuation">,</span> <span class="token class-name">TreeInfo</span><span class="token punctuation">.</span><span class="token function">fullName</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>   pd<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span><span class="token function">nonEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> pkginfoOpt <span class="token operator">==</span> <span class="token class-name">PkgInfo</span><span class="token punctuation">.</span>ALWAYS
                    <span class="token operator">||</span> tree<span class="token punctuation">.</span>docComments <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isPkgInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        addEnv <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pd<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span><span class="token function">nonEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token class-name">Errors<span class="token punctuation">.</span>PkgAnnotationsSbInPackageInfoJava</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                tree<span class="token punctuation">.</span>packge <span class="token operator">=</span> tree<span class="token punctuation">.</span>modle<span class="token punctuation">.</span>unnamedPackage<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Name</span><span class="token punctuation">,</span> <span class="token class-name">PackageSymbol</span><span class="token punctuation">&gt;</span></span> visiblePackages <span class="token operator">=</span> tree<span class="token punctuation">.</span>modle<span class="token punctuation">.</span>visiblePackages<span class="token punctuation">;</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">&gt;</span></span> dependencyWithPackage <span class="token operator">=</span>
                <span class="token comment">// 2.扫描包下的所有Java源文件，挨个创建类符号，并形成一个类符号列表作为包符号的成员属性(members_field)</span>
                syms<span class="token punctuation">.</span><span class="token function">listPackageModules</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>packge<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m <span class="token operator">!=</span> tree<span class="token punctuation">.</span>modle<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>cand <span class="token operator">-&gt;</span> visiblePackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>packge<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span> <span class="token operator">==</span> syms<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span>cand<span class="token punctuation">,</span> tree<span class="token punctuation">.</span>packge<span class="token punctuation">.</span>fullname<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>dependencyWithPackage<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token class-name">Errors<span class="token punctuation">.</span>PackageInOtherModule</span><span class="token punctuation">(</span>dependencyWithPackage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            tree<span class="token punctuation">.</span>packge<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Find all classes in package.</span>

            <span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> topEnv <span class="token operator">=</span> <span class="token function">topLevelEnv</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> packageEnv <span class="token operator">=</span> isPkgInfo <span class="token operator">?</span> topEnv<span class="token punctuation">.</span><span class="token function">dup</span><span class="token punctuation">(</span>pd<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token comment">// Save environment of package-info.java file.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isPkgInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> env0 <span class="token operator">=</span> typeEnvs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>packge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>env0 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">JCCompilationUnit</span> tree0 <span class="token operator">=</span> env0<span class="token punctuation">.</span>toplevel<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileManager<span class="token punctuation">.</span><span class="token function">isSameFile</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>sourcefile<span class="token punctuation">,</span> tree0<span class="token punctuation">.</span>sourcefile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">warning</span><span class="token punctuation">(</span>pd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> pd<span class="token punctuation">.</span>pid<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                                    <span class="token class-name">Warnings<span class="token punctuation">.</span>PkgInfoAlreadySeen</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>packge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                typeEnvs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>packge<span class="token punctuation">,</span> packageEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Symbol</span> q <span class="token operator">=</span> tree<span class="token punctuation">.</span>packge<span class="token punctuation">;</span> q <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span>kind <span class="token operator">==</span> PCK<span class="token punctuation">;</span> q <span class="token operator">=</span> q<span class="token punctuation">.</span>owner<span class="token punctuation">)</span>
                    q<span class="token punctuation">.</span>flags_field <span class="token operator">|=</span> EXISTS<span class="token punctuation">;</span>

                <span class="token class-name">Name</span> name <span class="token operator">=</span> names<span class="token punctuation">.</span>package_info<span class="token punctuation">;</span>
                <span class="token class-name">ClassSymbol</span> c <span class="token operator">=</span> syms<span class="token punctuation">.</span><span class="token function">enterClass</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>modle<span class="token punctuation">,</span> name<span class="token punctuation">,</span> tree<span class="token punctuation">.</span>packge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>flatname <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>packge <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>sourcefile <span class="token operator">=</span> tree<span class="token punctuation">.</span>sourcefile<span class="token punctuation">;</span>
            c<span class="token punctuation">.</span>completer <span class="token operator">=</span> <span class="token class-name">Completer</span><span class="token punctuation">.</span>NULL_COMPLETER<span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>members_field <span class="token operator">=</span> <span class="token class-name">WriteableScope</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                tree<span class="token punctuation">.</span>packge<span class="token punctuation">.</span>package_info <span class="token operator">=</span> c<span class="token punctuation">;</span>
                tree<span class="token punctuation">.</span>packge<span class="token punctuation">.</span>sourcefile <span class="token operator">=</span> tree<span class="token punctuation">.</span>sourcefile<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">classEnter</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>defs<span class="token punctuation">,</span> topEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>addEnv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                todo<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>packageEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">useSource</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p>创建包符号和类符号的创建都是由<code>Symtab</code>完成的:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Symtab</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Name</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">,</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> classes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Name</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">,</span><span class="token class-name">PackageSymbol</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> packages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** Make a package, given its fully qualified name.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PackageSymbol</span> <span class="token function">enterPackage</span><span class="token punctuation">(</span><span class="token class-name">ModuleSymbol</span> currModule<span class="token punctuation">,</span> <span class="token class-name">Name</span> fullname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">checkNonNull</span><span class="token punctuation">(</span>currModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PackageSymbol</span> p <span class="token operator">=</span> <span class="token function">getPackage</span><span class="token punctuation">(</span>currModule<span class="token punctuation">,</span> fullname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 若没有创建过，则创建并放入到缓存中</span>
            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>fullname<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;rootPackage missing!; currModule: &quot;</span> <span class="token operator">+</span> currModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageSymbol</span><span class="token punctuation">(</span>
                    <span class="token comment">// shortName当前包简称， packagePart为当前包的父级包名，也就是说创建当前包符号的时候会递归创建其父包符号</span>
                    <span class="token comment">// 当此包为一级包时，其父包为 rootPackage，packagePart值为空串</span>
                    <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">shortName</span><span class="token punctuation">(</span>fullname<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">enterPackage</span><span class="token punctuation">(</span>currModule<span class="token punctuation">,</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">packagePart</span><span class="token punctuation">(</span>fullname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span>completer <span class="token operator">=</span> initialCompleter<span class="token punctuation">;</span>
            p<span class="token punctuation">.</span>modle <span class="token operator">=</span> currModule<span class="token punctuation">;</span>
            <span class="token function">doEnterPackage</span><span class="token punctuation">(</span>currModule<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doEnterPackage</span><span class="token punctuation">(</span><span class="token class-name">ModuleSymbol</span> msym<span class="token punctuation">,</span> <span class="token class-name">PackageSymbol</span> pack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        packages<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span> n <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msym<span class="token punctuation">,</span> pack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msym<span class="token punctuation">.</span>enclosedPackages <span class="token operator">=</span> msym<span class="token punctuation">.</span>enclosedPackages<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>pack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PackageSymbol</span> <span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token class-name">ModuleSymbol</span> <span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token class-name">Name</span> fullname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> packages<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>fullname<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">/** Create a new toplevel or member class symbol with given name
     *  and owner and enter in `classes' unless already there.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ClassSymbol</span> <span class="token function">enterClass</span><span class="token punctuation">(</span><span class="token class-name">ModuleSymbol</span> msym<span class="token punctuation">,</span> <span class="token class-name">Name</span> name<span class="token punctuation">,</span> <span class="token class-name">TypeSymbol</span> owner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">checkNonNull</span><span class="token punctuation">(</span>msym<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Name</span> flatname <span class="token operator">=</span> <span class="token class-name">TypeSymbol</span><span class="token punctuation">.</span><span class="token function">formFlatName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassSymbol</span> c <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span>msym<span class="token punctuation">,</span> flatname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 若没有创建过，则创建并放入到缓存中</span>
            <span class="token comment">// 创建类符号的时候，此类符号的Owner为包符号</span>
            c <span class="token operator">=</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doEnterClass</span><span class="token punctuation">(</span>msym<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name <span class="token operator">!=</span> name <span class="token operator">||</span> c<span class="token punctuation">.</span>owner <span class="token operator">!=</span> owner<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> owner<span class="token punctuation">.</span>kind <span class="token operator">==</span> TYP <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>owner<span class="token punctuation">.</span>kind <span class="token operator">==</span> PCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// reassign fields of classes that might have been loaded with</span>
            <span class="token comment">// their flat names.</span>
            c<span class="token punctuation">.</span>owner<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            c<span class="token punctuation">.</span>owner <span class="token operator">=</span> owner<span class="token punctuation">;</span>
            c<span class="token punctuation">.</span>fullname <span class="token operator">=</span> <span class="token class-name">ClassSymbol</span><span class="token punctuation">.</span><span class="token function">formFullName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doEnterClass</span><span class="token punctuation">(</span><span class="token class-name">ModuleSymbol</span> msym<span class="token punctuation">,</span> <span class="token class-name">ClassSymbol</span> cs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        classes<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>cs<span class="token punctuation">.</span>flatname<span class="token punctuation">,</span> n <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msym<span class="token punctuation">,</span> cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ClassSymbol</span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token class-name">Name</span> name<span class="token punctuation">,</span> <span class="token class-name">Symbol</span> owner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassSymbol</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassSymbol</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span>completer <span class="token operator">=</span> initialCompleter<span class="token punctuation">;</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>创建好包符号之后，会填充包符号的 <code>members_field</code> 属性，包符号的 Member 即为类符号。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Symtab</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">&gt;</span></span> <span class="token function">listPackageModules</span><span class="token punctuation">(</span><span class="token class-name">Name</span> packageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageName<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">,</span><span class="token class-name">PackageSymbol</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> packages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">,</span> <span class="token class-name">PackageSymbol</span><span class="token punctuation">&gt;</span></span> e<span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 调用PackageSymbol#members() 会填充包符号的Member</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Symbol</span> <span class="token keyword">extends</span> <span class="token class-name">AnnoConstruct</span> <span class="token keyword">implements</span> <span class="token class-name">PoolConstant</span><span class="token punctuation">,</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">WriteableScope</span> <span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> members_field<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Complete the elaboration of this symbol's definition.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CompletionFailure</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>completer <span class="token operator">!=</span> <span class="token class-name">Completer</span><span class="token punctuation">.</span>NULL_COMPLETER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Completer</span> c <span class="token operator">=</span> completer<span class="token punctuation">;</span>
            completer <span class="token operator">=</span> <span class="token class-name">Completer</span><span class="token punctuation">.</span>NULL_COMPLETER<span class="token punctuation">;</span>
            <span class="token comment">// completer 为 ClassFinder</span>
            c<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>进入到<code>ClassFinder#complete()</code>之后，由于 sym 是 PackageSymbol，因此会进入到<code>ClassFinder#fillIn(PackageSymbol p)</code>，在此方法中，会在用户目录下扫描指定包下的 Java 源文件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassFinder</span> <span class="token punctuation">{</span>
    <span class="token comment">/** Completion for classes to be loaded. Before a class is loaded
     *  we make sure its enclosing class (if any) is loaded.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">Symbol</span> sym<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CompletionFailure</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sym<span class="token punctuation">.</span>kind <span class="token operator">==</span> TYP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 填充类符号</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">ClassSymbol</span> c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">)</span> sym<span class="token punctuation">;</span>
                dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token class-name">CompletionCause</span><span class="token punctuation">.</span>CLASS_READER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                annotate<span class="token punctuation">.</span><span class="token function">blockAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>members_field <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope<span class="token punctuation">.</span>ErrorScope</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make sure it's always defined</span>
                <span class="token function">completeOwners</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">completeEnclosing</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">fillIn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                annotate<span class="token punctuation">.</span><span class="token function">unblockAnnotationsNoFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                dependencies<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sym<span class="token punctuation">.</span>kind <span class="token operator">==</span> PCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">PackageSymbol</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PackageSymbol</span><span class="token punctuation">)</span>sym<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">fillIn</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CompletionFailure</span><span class="token punctuation">(</span>
                        sym<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> diagFactory<span class="token punctuation">.</span><span class="token function">fragment</span><span class="token punctuation">(</span>
                            <span class="token class-name">Fragments<span class="token punctuation">.</span>ExceptionMessage</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        dcfh<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">initCause</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span>filling<span class="token punctuation">)</span>
            annotate<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// finish attaching annotations</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Load directory of package into members scope.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fillIn</span><span class="token punctuation">(</span><span class="token class-name">PackageSymbol</span> p<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>members_field <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            p<span class="token punctuation">.</span>members_field <span class="token operator">=</span> <span class="token class-name">WriteableScope</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ModuleSymbol</span> msym <span class="token operator">=</span> p<span class="token punctuation">.</span>modle<span class="token punctuation">;</span>

        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">checkNonNull</span><span class="token punctuation">(</span>msym<span class="token punctuation">,</span> p<span class="token operator">::</span><span class="token function">toString</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        msym<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>msym <span class="token operator">==</span> syms<span class="token punctuation">.</span>noModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            preferCurrent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userPathsFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">scanUserPaths</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                preferCurrent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">scanPlatformPath</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">scanPlatformPath</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scanUserPaths</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msym<span class="token punctuation">.</span>classLocation <span class="token operator">==</span> <span class="token class-name">StandardLocation</span><span class="token punctuation">.</span>CLASS_PATH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 在用户目录下扫描指定包下的Java源文件</span>
            <span class="token function">scanUserPaths</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> msym<span class="token punctuation">.</span>sourceLocation <span class="token operator">==</span> <span class="token class-name">StandardLocation</span><span class="token punctuation">.</span>SOURCE_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">scanModulePaths</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> msym<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

        <span class="token comment">/**
     * Scans class path and source path for files in given package.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scanUserPaths</span><span class="token punctuation">(</span><span class="token class-name">PackageSymbol</span> p<span class="token punctuation">,</span> <span class="token keyword">boolean</span> includeSourcePath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wantSourceFiles<span class="token punctuation">)</span>
            <span class="token comment">// 根据源文件创建类符号并填充至包符号</span>
            <span class="token function">fillIn</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> SOURCE_PATH<span class="token punctuation">,</span>
                    <span class="token comment">// 获取包路径下的所有Java源文件</span>
                    <span class="token function">list</span><span class="token punctuation">(</span>SOURCE_PATH<span class="token punctuation">,</span>
                        p<span class="token punctuation">,</span>
                        packageName<span class="token punctuation">,</span>
                        sourceKinds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fillIn</span><span class="token punctuation">(</span><span class="token class-name">PackageSymbol</span> p<span class="token punctuation">,</span>
                            <span class="token class-name">Location</span> location<span class="token punctuation">,</span>
                            <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JavaFileObject</span><span class="token punctuation">&gt;</span></span> files<span class="token punctuation">)</span><span class="token punctuation">{</span>
            currentLoc <span class="token operator">=</span> location<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JavaFileObject</span> fo <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>fo<span class="token punctuation">.</span><span class="token function">getKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> OTHER<span class="token operator">:</span>
                    <span class="token function">extraFileActions</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> fo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> CLASS<span class="token operator">:</span>
                <span class="token keyword">case</span> SOURCE<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment">// TODO pass binaryName to includeClassFile</span>
                    <span class="token class-name">String</span> binaryName <span class="token operator">=</span> fileManager<span class="token punctuation">.</span><span class="token function">inferBinaryName</span><span class="token punctuation">(</span>currentLoc<span class="token punctuation">,</span> fo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> simpleName <span class="token operator">=</span> binaryName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>binaryName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SourceVersion</span><span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>simpleName<span class="token punctuation">)</span> <span class="token operator">||</span>
                        simpleName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;package-info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment">// 根据源文件创建类符号并填充至包符号</span>
                        <span class="token function">includeClassFile</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> fo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token function">extraFileActions</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> fo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">includeClassFile</span><span class="token punctuation">(</span><span class="token class-name">PackageSymbol</span> p<span class="token punctuation">,</span> <span class="token class-name">JavaFileObject</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">Name</span> classname <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span>binaryName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lastDot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isPkgInfo <span class="token operator">=</span> classname <span class="token operator">==</span> names<span class="token punctuation">.</span>package_info<span class="token punctuation">;</span>
        <span class="token class-name">ClassSymbol</span> c <span class="token operator">=</span> isPkgInfo
            <span class="token operator">?</span> p<span class="token punctuation">.</span>package_info
            <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">)</span> p<span class="token punctuation">.</span>members_field<span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 创建类符号</span>
            c <span class="token operator">=</span> syms<span class="token punctuation">.</span><span class="token function">enterClass</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>modle<span class="token punctuation">,</span> classname<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>classfile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// only update the file if's it's newly created</span>
                c<span class="token punctuation">.</span>classfile <span class="token operator">=</span> file<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isPkgInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                p<span class="token punctuation">.</span>package_info <span class="token operator">=</span> c<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>owner <span class="token operator">==</span> p<span class="token punctuation">)</span>  <span class="token comment">// it might be an inner class</span>
                    <span class="token comment">// 将类符号填充进包符号的 members_field</span>
                    p<span class="token punctuation">.</span>members_field<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br></div></div><p>（2）阶段 2：填充类符号下的属性</p> <p>给语法树填充好了包符号，和类符号本身之后，还需要继续填充类符号的属性<br>
此阶段主要是由<code>TypeEnter#complete()</code>开始，并会经历一系列阶段</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 进入类型作用域</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TypeEnter</span> <span class="token keyword">implements</span> <span class="token class-name">Completer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ImportsPhase</span> completeClass <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImportsPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">Symbol</span> sym<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CompletionFailure</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Env</span><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>

        dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">)</span> sym<span class="token punctuation">,</span> <span class="token class-name">CompletionCause</span><span class="token punctuation">.</span>MEMBER_ENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 开始分阶段填充类符号的 extend/implement/typeParam/member 等属性</span>
            queue <span class="token operator">=</span> completeClass<span class="token punctuation">.</span><span class="token function">completeEnvs</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>typeEnvs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">)</span> sym<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            dependencies<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>TypeEnter 的阶段由<code>Phase</code>表示，使用单链表作为其数据结构即可将一系列阶段串联起来：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Phase</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ListBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Env</span><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Phase</span> next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CompletionCause</span> phaseName<span class="token punctuation">;</span>

    <span class="token class-name">Phase</span><span class="token punctuation">(</span><span class="token class-name">CompletionCause</span> phaseName<span class="token punctuation">,</span> <span class="token class-name">Phase</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>phaseName <span class="token operator">=</span> phaseName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Env</span><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">completeEnvs</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Env</span><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> envs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> firstToComplete <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Phase</span> prevTopLevelPhase <span class="token operator">=</span> topLevelPhase<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            topLevelPhase <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token comment">// 执行当前节点代表的阶段</span>
            <span class="token function">doCompleteEnvs</span><span class="token punctuation">(</span>envs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            topLevelPhase <span class="token operator">=</span> prevTopLevelPhase<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success <span class="token operator">&amp;&amp;</span> firstToComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//an exception was thrown, e.g. BreakAttr:</span>
                <span class="token comment">//the queue would become stale, clear it:</span>
                queue<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstToComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Env</span><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            queue<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 执行后继节点代表的阶段，也即下一个阶段</span>
            <span class="token keyword">return</span> next <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> next<span class="token punctuation">.</span><span class="token function">completeEnvs</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token operator">:</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doCompleteEnvs</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Env</span><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> envs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> env <span class="token operator">:</span> envs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">JCClassDecl</span> tree <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JCClassDecl</span><span class="token punctuation">)</span>env<span class="token punctuation">.</span>tree<span class="token punctuation">;</span>

            queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">JavaFileObject</span> prev <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">useSource</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>toplevel<span class="token punctuation">.</span>sourcefile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DiagnosticPosition</span> prevLintPos <span class="token operator">=</span> deferredLintHandler<span class="token punctuation">.</span><span class="token function">setPos</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>enclClass<span class="token punctuation">.</span>sym<span class="token punctuation">,</span> phaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 执行此阶段的具体任务</span>
                <span class="token function">runPhase</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CompletionFailure</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                chk<span class="token punctuation">.</span><span class="token function">completionError</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                dependencies<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                deferredLintHandler<span class="token punctuation">.</span><span class="token function">setPos</span><span class="token punctuation">(</span>prevLintPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">useSource</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">runPhase</span><span class="token punctuation">(</span><span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>主要的阶段有：</p> <blockquote><ul><li>ImportsPhase: 补充import信息，填充编译单元的 namedImportScope 和 starImportScope 属性，同时填充子节点 JCImport 的 importScope 属性</li> <li>HierarchyPhase: 补充类层级信息，填充JCClassDecl的extending和implementing 以及sym属性的supertype_field（父类）、interfaces_field（接口）</li> <li>HeaderPhase: 填充 JCModifiers 下的注解</li> <li>MembersPhase: 填充 JCVariableDecl下的</li></ul></blockquote> <p>ImportsPhase：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ImportsPhase</span> <span class="token keyword">extends</span> <span class="token class-name">Phase</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">runPhase</span><span class="token punctuation">(</span><span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">resolveImports</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>toplevel<span class="token punctuation">,</span> env<span class="token punctuation">.</span><span class="token function">enclosing</span><span class="token punctuation">(</span>TOPLEVEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resolveImports</span><span class="token punctuation">(</span><span class="token class-name">JCCompilationUnit</span> tree<span class="token punctuation">,</span> <span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 使用 java.Lang 包来填充编译单元的startImportScope</span>
        <span class="token function">importAll</span><span class="token punctuation">(</span>make<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Import</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">make<span class="token punctuation">.</span></span>QualIdent</span><span class="token punctuation">(</span>javaLang<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> javaLang<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JCModuleDecl</span> decl <span class="token operator">=</span> tree<span class="token punctuation">.</span><span class="token function">getModuleDecl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Process the package def and all import clauses.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> decl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">checkClassPackageClash</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JCImport</span> imp <span class="token operator">:</span> tree<span class="token punctuation">.</span><span class="token function">getImports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 使用类中的Import语句来填充编译单元的namedImport，同时也会填充其子节点JCImport的ImportScope</span>
            <span class="token function">doImport</span><span class="token punctuation">(</span>imp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doImport</span><span class="token punctuation">(</span><span class="token class-name">JCImport</span> tree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// Named type import.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">.</span>staticImport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">importNamedStatic</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> p<span class="token punctuation">,</span> name<span class="token punctuation">,</span> localEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            chk<span class="token punctuation">.</span><span class="token function">checkCanonical</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span>selected<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Type</span> importedType <span class="token operator">=</span> <span class="token function">attribImportType</span><span class="token punctuation">(</span>imp<span class="token punctuation">,</span> localEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Type</span> originalType <span class="token operator">=</span> importedType<span class="token punctuation">.</span><span class="token function">getOriginalType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TypeSymbol</span> c <span class="token operator">=</span> originalType<span class="token punctuation">.</span><span class="token function">hasTag</span><span class="token punctuation">(</span>CLASS<span class="token punctuation">)</span> <span class="token operator">?</span> originalType<span class="token punctuation">.</span>tsym <span class="token operator">:</span> importedType<span class="token punctuation">.</span>tsym<span class="token punctuation">;</span>
            chk<span class="token punctuation">.</span><span class="token function">checkCanonical</span><span class="token punctuation">(</span>imp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">importNamed</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> env<span class="token punctuation">,</span> tree<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 向语法树中填充import信息</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">importNamed</span><span class="token punctuation">(</span><span class="token class-name">DiagnosticPosition</span> pos<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Symbol</span> tsym<span class="token punctuation">,</span> <span class="token class-name">Env</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span></span> env<span class="token punctuation">,</span> <span class="token class-name">JCImport</span> imp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tsym<span class="token punctuation">.</span>kind <span class="token operator">==</span> TYP<span class="token punctuation">)</span>
            imp<span class="token punctuation">.</span>importScope <span class="token operator">=</span> env<span class="token punctuation">.</span>toplevel<span class="token punctuation">.</span>namedImportScope<span class="token punctuation">.</span><span class="token function">importType</span><span class="token punctuation">(</span>tsym<span class="token punctuation">.</span>owner<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tsym<span class="token punctuation">.</span>owner<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tsym<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>如下图：</p> <p><img src="/snote/assets/img/image-20210610155908948.1ce576c2.png" alt="image-20210610155908948"></p> <p>HierarchyPhase：</p> <p><img src="/snote/assets/img/image-20210610161852504.b2eadfdb.png" alt="image-20210610161852504"></p> <p>HeaderPhase：</p> <p><img src="/snote/assets/img/image-20210610162609219.ae6905d3.png" alt="image-20210610162609219"></p> <p>MembersPhase：填充成员属性：</p> <p><img src="/snote/assets/img/image-20210610164119822.4599ed4d.png" alt="image-20210610164119822"></p> <h4 id="_4-2-注解处理"><a href="#_4-2-注解处理" class="header-anchor">#</a> 4.2 注解处理</h4> <h5 id="_4-2-1-注解处理时序图"><a href="#_4-2-1-注解处理时序图" class="header-anchor">#</a> 4.2.1 注解处理时序图</h5> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1215px" preserveAspectRatio="none" version="1.1" viewBox="0 0 2010 1215" width="2010px" zoomAndPan="magnify" style="width:2010px;height:1215px;"><defs><filter height="300%" id="fnou8j4cajpku" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="1093.3828" width="10" x="50" y="71.9609" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="1063.0313" width="10" x="162" y="102.3125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="1032.6797" width="10" x="283" y="132.6641" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="228.4063" width="10" x="288" y="171.0156" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="720.5703" width="10" x="288" y="444.7734" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="25" width="10" x="293" y="1124.3438" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="173.0547" width="10" x="452" y="206.3672" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="113.7031" width="10" x="457" y="244.7188" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="605.8672" width="10" x="452" y="480.125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="128.7031" width="10" x="457" y="929.2891" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="69.3516" width="10" x="462" y="967.6406" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="58.3516" width="10" x="713" y="280.0703" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="14" width="10" x="927.5" y="310.4219" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="358.1094" width="10" x="1117" y="510.4766" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="298.7578" width="10" x="1122" y="548.8281" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="173.0547" width="10" x="1117" y="898.9375" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="243.4063" width="10" x="1428" y="584.1797" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="184.0547" width="10" x="1433" y="622.5313" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="128.7031" width="10" x="1670.5" y="657.8828" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="84.3516" width="10" x="1834.5" y="688.2344" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="25" width="10" x="1839.5" y="726.5859" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="14" width="10" x="1957.5" y="1002.9922" style="stroke:#A80036;stroke-width:1.0;"></rect><line x1="54.5" x2="54.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="166.5" x2="166.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="287.5" x2="287.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="456.5" x2="456.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="717.5" x2="717.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="932.5" x2="932.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1121.5" x2="1121.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1432.5" x2="1432.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1675.5" x2="1675.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1839.5" x2="1839.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1962.5" x2="1962.5" y1="39.6094" y2="1174.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="81" x="12.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="19.5" y="24.5332">javac.Main</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="81" x="12.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="19.5" y="1194.877">javac.Main</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="115" x="107.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="114.5" y="24.5332">javac.main.Main</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="115" x="107.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="114.5" y="1194.877">javac.main.Main</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="99" x="236.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="243.5" y="24.5332">JavaCompiler</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="99" x="236.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="243.5" y="1194.877">JavaCompiler</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="199" x="355.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="185" x="362.5" y="24.5332">JavacProcessingEnvironment</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="199" x="355.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="185" x="362.5" y="1194.877">JavacProcessingEnvironment</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="295" x="568.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="281" x="575.5" y="24.5332">JavacProcessingEnvironment.ServiceIterator</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="295" x="568.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="281" x="575.5" y="1194.877">JavacProcessingEnvironment.ServiceIterator</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="106" x="877.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="884.5" y="24.5332">ServiceLoader</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="106" x="877.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="884.5" y="1194.877">ServiceLoader</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="245" x="997.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="231" x="1004.5" y="24.5332">JavacProcessingEnvironment.Round</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="245" x="997.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="231" x="1004.5" y="1194.877">JavacProcessingEnvironment.Round</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="349" x="1256.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="335" x="1263.5" y="24.5332">JavacProcessingEnvironment.ComputeAnnotationSet</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="349" x="1256.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="335" x="1263.5" y="1194.877">JavacProcessingEnvironment.ComputeAnnotationSet</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="108" x="1619.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="94" x="1626.5" y="24.5332">JavacElements</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="108" x="1619.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="94" x="1626.5" y="1194.877">JavacElements</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="60" x="1807.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1814.5" y="24.5332">Symbol</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="60" x="1807.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1814.5" y="1194.877">Symbol</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="78" x="1921.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="1928.5" y="24.5332">Processor</text><rect fill="#FEFECE" filter="url(#fnou8j4cajpku)" height="31.6094" width="78" x="1921.5" y="1173.3438" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="1928.5" y="1194.877">Processor</text><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="1093.3828" width="10" x="50" y="71.9609" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="1063.0313" width="10" x="162" y="102.3125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="1032.6797" width="10" x="283" y="132.6641" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="228.4063" width="10" x="288" y="171.0156" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="720.5703" width="10" x="288" y="444.7734" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="25" width="10" x="293" y="1124.3438" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="173.0547" width="10" x="452" y="206.3672" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="113.7031" width="10" x="457" y="244.7188" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="605.8672" width="10" x="452" y="480.125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="128.7031" width="10" x="457" y="929.2891" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="69.3516" width="10" x="462" y="967.6406" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="58.3516" width="10" x="713" y="280.0703" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="14" width="10" x="927.5" y="310.4219" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="358.1094" width="10" x="1117" y="510.4766" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="298.7578" width="10" x="1122" y="548.8281" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="173.0547" width="10" x="1117" y="898.9375" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="243.4063" width="10" x="1428" y="584.1797" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="184.0547" width="10" x="1433" y="622.5313" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="128.7031" width="10" x="1670.5" y="657.8828" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="84.3516" width="10" x="1834.5" y="688.2344" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="25" width="10" x="1839.5" y="726.5859" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fnou8j4cajpku)" height="14" width="10" x="1957.5" y="1002.9922" style="stroke:#A80036;stroke-width:1.0;"></rect><polygon fill="#A80036" points="38,67.9609,48,71.9609,38,75.9609,42,71.9609" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="3" x2="44" y1="71.9609" y2="71.9609" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="10" y="67.1045">main</text><polygon fill="#A80036" points="150,98.3125,160,102.3125,150,106.3125,154,102.3125" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="60" x2="156" y1="102.3125" y2="102.3125" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="67" y="97.4561">compile</text><polygon fill="#A80036" points="271,128.6641,281,132.6641,271,136.6641,275,132.6641" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="172" x2="277" y1="132.6641" y2="132.6641" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="179" y="127.8076">compile</text><line x1="293" x2="340" y1="158.0156" y2="158.0156" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="340" x2="340" y1="158.0156" y2="171.0156" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="299" x2="340" y1="171.0156" y2="171.0156" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="309,167.0156,299,171.0156,309,175.0156,305,171.0156" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="305" y="153.1592">1.initProcessAnnotations</text><polygon fill="#A80036" points="440,202.3672,450,206.3672,440,210.3672,444,206.3672" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="298" x2="446" y1="206.3672" y2="206.3672" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="305" y="201.5107">setProcessors</text><line x1="462" x2="509" y1="231.7188" y2="231.7188" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="509" x2="509" y1="231.7188" y2="244.7188" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="468" x2="509" y1="244.7188" y2="244.7188" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="478,240.7188,468,244.7188,478,248.7188,474,244.7188" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="474" y="226.8623">initProcessorIterator</text><polygon fill="#A80036" points="701,276.0703,711,280.0703,701,284.0703,705,280.0703" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="467" x2="707" y1="280.0703" y2="280.0703" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="474" y="275.2139">constructor</text><polygon fill="#A80036" points="915.5,306.4219,925.5,310.4219,915.5,314.4219,919.5,310.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="723" x2="921.5" y1="310.4219" y2="310.4219" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="730" y="305.5654">load</text><polygon fill="#A80036" points="734,320.4219,724,324.4219,734,328.4219,730,324.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="728" x2="931.5" y1="324.4219" y2="324.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="478,334.4219,468,338.4219,478,342.4219,474,338.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="472" x2="717" y1="338.4219" y2="338.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="467" x2="509" y1="357.4219" y2="357.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="509" x2="509" y1="357.4219" y2="370.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="462" x2="509" y1="370.4219" y2="370.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="472,366.4219,462,370.4219,472,374.4219,468,370.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="309,375.4219,299,379.4219,309,383.4219,305,379.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="303" x2="456" y1="379.4219" y2="379.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="298" x2="340" y1="398.4219" y2="398.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="340" x2="340" y1="398.4219" y2="411.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="293" x2="340" y1="411.4219" y2="411.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="303,407.4219,293,411.4219,303,415.4219,299,411.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="293" x2="340" y1="431.7734" y2="431.7734" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="340" x2="340" y1="431.7734" y2="444.7734" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="299" x2="340" y1="444.7734" y2="444.7734" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="309,440.7734,299,444.7734,309,448.7734,305,444.7734" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="305" y="426.917">2.processAnnotations</text><polygon fill="#A80036" points="440,476.125,450,480.125,440,484.125,444,480.125" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="298" x2="446" y1="480.125" y2="480.125" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="305" y="475.2686">doProcessing</text><polygon fill="#A80036" points="1105,506.4766,1115,510.4766,1105,514.4766,1109,510.4766" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="462" x2="1111" y1="510.4766" y2="510.4766" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="469" y="505.6201">2.1 constructor</text><line x1="1127" x2="1174" y1="535.8281" y2="535.8281" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1174" x2="1174" y1="535.8281" y2="548.8281" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1133" x2="1174" y1="548.8281" y2="548.8281" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1143,544.8281,1133,548.8281,1143,552.8281,1139,548.8281" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1139" y="530.9717">findAnnotationsPresent</text><polygon fill="#A80036" points="1416,580.1797,1426,584.1797,1416,588.1797,1420,584.1797" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1132" x2="1422" y1="584.1797" y2="584.1797" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1139" y="579.3232">scan</text><line x1="1438" x2="1485" y1="609.5313" y2="609.5313" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1485" x2="1485" y1="609.5313" y2="622.5313" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1444" x2="1485" y1="622.5313" y2="622.5313" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1454,618.5313,1444,622.5313,1454,626.5313,1450,622.5313" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="1450" y="604.6748">addAnnotations</text><polygon fill="#A80036" points="1658.5,653.8828,1668.5,657.8828,1658.5,661.8828,1662.5,657.8828" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1443" x2="1664.5" y1="657.8828" y2="657.8828" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="1450" y="653.0264">getAllAnnotationMirrors</text><polygon fill="#A80036" points="1822.5,684.2344,1832.5,688.2344,1822.5,692.2344,1826.5,688.2344" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1680.5" x2="1828.5" y1="688.2344" y2="688.2344" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="1687.5" y="683.3779">getAllAnnotationMirrors</text><line x1="1844.5" x2="1891.5" y1="713.5859" y2="713.5859" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1891.5" x2="1891.5" y1="713.5859" y2="726.5859" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1850.5" x2="1891.5" y1="726.5859" y2="726.5859" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1860.5,722.5859,1850.5,726.5859,1860.5,730.5859,1856.5,726.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="1856.5" y="708.7295">getRawAttributes</text><line x1="1849.5" x2="1891.5" y1="750.5859" y2="750.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="1891.5" x2="1891.5" y1="750.5859" y2="763.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="1844.5" x2="1891.5" y1="763.5859" y2="763.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="1854.5,759.5859,1844.5,763.5859,1854.5,767.5859,1850.5,763.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="1691.5,768.5859,1681.5,772.5859,1691.5,776.5859,1687.5,772.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1685.5" x2="1838.5" y1="772.5859" y2="772.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="1454,782.5859,1444,786.5859,1454,790.5859,1450,786.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1448" x2="1674.5" y1="786.5859" y2="786.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="1443" x2="1485" y1="805.5859" y2="805.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="1485" x2="1485" y1="805.5859" y2="818.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="1438" x2="1485" y1="818.5859" y2="818.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="1448,814.5859,1438,818.5859,1448,822.5859,1444,818.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="1143,823.5859,1133,827.5859,1143,831.5859,1139,827.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="1137" x2="1432" y1="827.5859" y2="827.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="1132" x2="1174" y1="846.5859" y2="846.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="1174" x2="1174" y1="846.5859" y2="859.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="1127" x2="1174" y1="859.5859" y2="859.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="1137,855.5859,1127,859.5859,1137,863.5859,1133,859.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="473,864.5859,463,868.5859,473,872.5859,469,868.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="467" x2="1121" y1="868.5859" y2="868.5859" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="1105,894.9375,1115,898.9375,1105,902.9375,1109,898.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="462" x2="1111" y1="898.9375" y2="898.9375" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="469" y="894.0811">2.2 run</text><polygon fill="#A80036" points="478,925.2891,468,929.2891,478,933.2891,474,929.2891" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="472" x2="1116" y1="929.2891" y2="929.2891" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="484" y="924.4326">discoverAndRunProcs</text><line x1="467" x2="514" y1="954.6406" y2="954.6406" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="514" x2="514" y1="954.6406" y2="967.6406" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="473" x2="514" y1="967.6406" y2="967.6406" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="483,963.6406,473,967.6406,483,971.6406,479,967.6406" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="479" y="949.7842">callProcessor</text><polygon fill="#A80036" points="1945.5,998.9922,1955.5,1002.9922,1945.5,1006.9922,1949.5,1002.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="472" x2="1951.5" y1="1002.9922" y2="1002.9922" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="479" y="998.1357">process</text><polygon fill="#A80036" points="483,1012.9922,473,1016.9922,483,1020.9922,479,1016.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="477" x2="1961.5" y1="1016.9922" y2="1016.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="472" x2="514" y1="1035.9922" y2="1035.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="514" x2="514" y1="1035.9922" y2="1048.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="467" x2="514" y1="1048.9922" y2="1048.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="477,1044.9922,467,1048.9922,477,1052.9922,473,1048.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="1105,1053.9922,1115,1057.9922,1105,1061.9922,1109,1057.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="462" x2="1111" y1="1057.9922" y2="1057.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="473,1067.9922,463,1071.9922,473,1075.9922,469,1071.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="467" x2="1121" y1="1071.9922" y2="1071.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="309,1081.9922,299,1085.9922,309,1089.9922,305,1085.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="303" x2="456" y1="1085.9922" y2="1085.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="298" x2="345" y1="1111.3438" y2="1111.3438" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="345" x2="345" y1="1111.3438" y2="1124.3438" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="304" x2="345" y1="1124.3438" y2="1124.3438" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="314,1120.3438,304,1124.3438,314,1128.3438,310,1124.3438" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="310" y="1106.4873">compile2</text><line x1="303" x2="345" y1="1148.3438" y2="1148.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="345" x2="345" y1="1148.3438" y2="1161.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="298" x2="345" y1="1161.3438" y2="1161.3438" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="308,1157.3438,298,1161.3438,308,1165.3438,304,1161.3438" style="stroke:#A80036;stroke-width:1.0;"></polygon></g></svg><p>注解处理的入口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaCompiler</span> <span class="token punctuation">{</span> 
	<span class="token comment">/**
     * Main method: compile a list of files, return all compiled classes
     *
     * @param sourceFileObjects file objects to be compiled
     * @param classnames class names to process for annotations
     * @param processors user provided annotation processors to bypass
     * discovery, {@code null} means that no processors were provided
     * @param addModules additional root modules to be used during
     * module resolution.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JavaFileObject</span><span class="token punctuation">&gt;</span></span> sourceFileObjects<span class="token punctuation">,</span>
                        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> classnames<span class="token punctuation">,</span>
                        <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Processor</span><span class="token punctuation">&gt;</span></span> processors<span class="token punctuation">,</span>
                        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> addModules<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 准备过程：初始化插入式注解处理器，最终是通过ServiceLoader获取所有Processor.class的实现类</span>
        <span class="token function">initProcessAnnotations</span><span class="token punctuation">(</span>processors<span class="token punctuation">,</span> sourceFileObjects<span class="token punctuation">,</span> classnames<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// These method calls must be chained to avoid memory leaks</span>
        <span class="token comment">// 2. 执行注解处理</span>
        <span class="token function">processAnnotations</span><span class="token punctuation">(</span>
            <span class="token comment">// 1.2 填充符号表</span>
            <span class="token function">enterTrees</span><span class="token punctuation">(</span>
                    <span class="token function">stopIfError</span><span class="token punctuation">(</span><span class="token class-name">CompileState</span><span class="token punctuation">.</span>ENTER<span class="token punctuation">,</span>
                            <span class="token function">initModules</span><span class="token punctuation">(</span><span class="token function">stopIfError</span><span class="token punctuation">(</span><span class="token class-name">CompileState</span><span class="token punctuation">.</span>ENTER<span class="token punctuation">,</span>
                                <span class="token comment">// 1.1 词法分析、语法分析，从而构建出一棵AST抽象语法树，sourceFileObjects即为Java源文件在内存中的表示</span>
                                <span class="token function">parseFiles</span><span class="token punctuation">(</span>sourceFileObjects<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            classnames
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CompileState</span><span class="token punctuation">.</span>ATTR<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>shouldStopPolicyIfNoError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>compilePolicy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">case</span> BY_TODO<span class="token operator">:</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>todo<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment">// 3.语义分析及字节码生成</span>
                    <span class="token function">generate</span><span class="token punctuation">(</span><span class="token function">desugar</span><span class="token punctuation">(</span><span class="token function">flow</span><span class="token punctuation">(</span><span class="token function">attribute</span><span class="token punctuation">(</span>todo<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h5 id="_4-2-2-获取注解处理器"><a href="#_4-2-2-获取注解处理器" class="header-anchor">#</a> 4.2.2 获取注解处理器</h5> <p>（1）通过 ServiceLoader 来加载 Processor.class 的实现类</p> <p>如上述流程图所示，在<code>JavacProcessingEnvironment.ServiceIterator</code>的构造方法中，会通过 ServiceLoader 来加载 Processor.class 的实现类，这样就可以获取到所有的注解处理器。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ServiceIterator</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Processor</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Processor</span><span class="token punctuation">&gt;</span></span> iterator<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Log</span> log<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Processor</span><span class="token punctuation">&gt;</span></span> loader<span class="token punctuation">;</span>

    <span class="token class-name">ServiceIterator</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> var2<span class="token punctuation">,</span> <span class="token class-name">Log</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>log <span class="token operator">=</span> var3<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 通过 ServiceLoader 来加载 Processor.class 的实现类</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>loader <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> <span class="token class-name">JavacProcessingEnvironment</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleServiceLoaderUnavailability</span><span class="token punctuation">(</span><span class="token string">&quot;proc.no.service&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var6<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            var3<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;proc.service.problem&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Abort</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>（2）<code>ServiceLoader.load</code> 根据<code>resources/META-INF/services/</code>目录下的接口文件来反射创建具体的实现类列表</p> <h5 id="_4-2-3-获取注解与处理注解"><a href="#_4-2-3-获取注解与处理注解" class="header-anchor">#</a> 4.2.3 获取注解与处理注解</h5> <p>获取注解：</p> <blockquote><ul><li>首先会从语法树中获取所有的类符号</li> <li>然后挨个获取每个类符号里的所有的注解</li> <li>获取注解的时候是从  ClassSymbol.metadata.attributes 中获取</li></ul></blockquote> <p>处理注解：</p> <blockquote><ul><li>遍历注解处理器，对于每一个注解处理器，遍历注解列表，若有注解匹配此注解处理器，则注解处理器来处理注解</li></ul></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavacProcessingEnvironment</span> <span class="token keyword">implements</span> <span class="token class-name">ProcessingEnvironment</span><span class="token punctuation">,</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">doProcessing</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCCompilationUnit</span><span class="token punctuation">&gt;</span></span> roots<span class="token punctuation">,</span>
                                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">&gt;</span></span> classSymbols<span class="token punctuation">,</span>
                                <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">PackageSymbol</span><span class="token punctuation">&gt;</span></span> pckSymbols<span class="token punctuation">,</span>
                                <span class="token class-name">Log<span class="token punctuation">.</span>DeferredDiagnosticHandler</span> deferredDiagnosticHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.root 即为语法树列表，这里会根据JCTree 列表中的所有的类符号获取所有注解</span>
        <span class="token class-name">Round</span> round <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Round</span><span class="token punctuation">(</span>roots<span class="token punctuation">,</span> classSymbols<span class="token punctuation">,</span> treesToClean<span class="token punctuation">,</span> deferredDiagnosticHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> errorStatus<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> moreToDo<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// Run processors for round n</span>
            <span class="token comment">// 2.获取到注解之后，就可以执行注解处理器</span>
            round<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// Processors for round n have run to completion.</span>
            <span class="token comment">// Check for errors and whether there is more work to do.</span>
            errorStatus <span class="token operator">=</span> round<span class="token punctuation">.</span><span class="token function">unrecoverableError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            moreToDo <span class="token operator">=</span> <span class="token function">moreToDo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>moreToDo <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errorStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        
    <span class="token punctuation">}</span>
    
    <span class="token keyword">class</span> <span class="token class-name">Round</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCCompilationUnit</span><span class="token punctuation">&gt;</span></span> roots<span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> annotationsPresent<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">&gt;</span></span> topLevelClasses<span class="token punctuation">;</span>
        
        <span class="token comment">/** Create the first round. */</span>
        <span class="token class-name">Round</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCCompilationUnit</span><span class="token punctuation">&gt;</span></span> roots<span class="token punctuation">,</span>
              <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">&gt;</span></span> classSymbols<span class="token punctuation">,</span>
              <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JCCompilationUnit</span><span class="token punctuation">&gt;</span></span> treesToClean<span class="token punctuation">,</span>
              <span class="token class-name">Log<span class="token punctuation">.</span>DeferredDiagnosticHandler</span> deferredDiagnosticHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> treesToClean<span class="token punctuation">,</span> deferredDiagnosticHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>roots <span class="token operator">=</span> roots<span class="token punctuation">;</span>
            genClassFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// The reverse() in the following line is to maintain behavioural</span>
            <span class="token comment">// compatibility with the previous revision of the code. Strictly speaking,</span>
            <span class="token comment">// it should not be necessary, but a javah golden file test fails without it.</span>
             <span class="token comment">// 通过语法树获取所有的类符号</span>
            topLevelClasses <span class="token operator">=</span>
                <span class="token function">getTopLevelClasses</span><span class="token punctuation">(</span>roots<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prependList</span><span class="token punctuation">(</span>classSymbols<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            packageInfoFiles <span class="token operator">=</span> <span class="token function">getPackageInfoFiles</span><span class="token punctuation">(</span>roots<span class="token punctuation">)</span><span class="token punctuation">;</span>

            moduleInfoFiles <span class="token operator">=</span> <span class="token function">getModuleInfoFiles</span><span class="token punctuation">(</span>roots<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token comment">// 获取所有注解</span>
            <span class="token function">findAnnotationsPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/** Find the set of annotations present in the set of top level
         *  classes and package info files to be processed this round. */</span>
        <span class="token keyword">void</span> <span class="token function">findAnnotationsPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ComputeAnnotationSet</span> annotationComputer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComputeAnnotationSet</span><span class="token punctuation">(</span>elementUtils<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Use annotation processing to compute the set of annotations present</span>
            annotationsPresent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ClassSymbol</span> classSym <span class="token operator">:</span> topLevelClasses<span class="token punctuation">)</span>
                 <span class="token comment">// 挨个扫描每个类符号，找出其中的注解，最终是获取了 ClassSymbol.metadata.attributes, 这就是注解，这也就从侧面说明了注解是一种元数据</span>
                annotationComputer<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>classSym<span class="token punctuation">,</span> annotationsPresent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PackageSymbol</span> pkgSym <span class="token operator">:</span> packageInfoFiles<span class="token punctuation">)</span>
                <span class="token comment">// 遍历每一个 package-info.java 文件，解析所有的包注释</span>
                annotationComputer<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>pkgSym<span class="token punctuation">,</span> annotationsPresent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ModuleSymbol</span> mdlSym <span class="token operator">:</span> moduleInfoFiles<span class="token punctuation">)</span>
                annotationComputer<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>mdlSym<span class="token punctuation">,</span> annotationsPresent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/** Run a processing round. */</span>
        <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> lastRound<span class="token punctuation">,</span> <span class="token keyword">boolean</span> errorStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// 获取并运行注解处理器</span>
            <span class="token comment">// annotationsPresent 中包含了所有注解</span>
            <span class="token function">discoverAndRunProcs</span><span class="token punctuation">(</span>annotationsPresent<span class="token punctuation">,</span> topLevelClasses<span class="token punctuation">,</span> packageInfoFiles<span class="token punctuation">,</span> moduleInfoFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">discoverAndRunProcs</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> annotationsPresent<span class="token punctuation">,</span>
                                     <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassSymbol</span><span class="token punctuation">&gt;</span></span> topLevelClasses<span class="token punctuation">,</span>
                                     <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PackageSymbol</span><span class="token punctuation">&gt;</span></span> packageInfoFiles<span class="token punctuation">,</span>
                                     <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModuleSymbol</span><span class="token punctuation">&gt;</span></span> moduleInfoFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 待匹配的注解列表</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> unmatchedAnnotations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>annotationsPresent<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注解处理器的迭代器</span>
        <span class="token class-name">DiscoveredProcessors<span class="token punctuation">.</span>ProcessorStateIterator</span> psi <span class="token operator">=</span> discoveredProcs<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 遍历注解处理器</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>unmatchedAnnotations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> psi<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ProcessorState</span> ps <span class="token operator">=</span> psi<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span>  matchedNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> typeElements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

             <span class="token comment">// 遍历注解列表</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> entry<span class="token operator">:</span> unmatchedAnnotations<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> unmatchedAnnotationName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 判断注解处理器是否支持此注解</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ps<span class="token punctuation">.</span><span class="token function">annotationSupported</span><span class="token punctuation">(</span>unmatchedAnnotationName<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    matchedNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>unmatchedAnnotationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TypeElement</span> te <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>te <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        typeElements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>te<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
             <span class="token punctuation">}</span> 
            
             <span class="token keyword">if</span> <span class="token punctuation">(</span>matchedNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> ps<span class="token punctuation">.</span>contributed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token comment">// 若有匹配的注解，则调用注解处理器去处理注解</span>
                <span class="token keyword">boolean</span> processingResult <span class="token operator">=</span> <span class="token function">callProcessor</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>processor<span class="token punctuation">,</span> typeElements<span class="token punctuation">,</span> renv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ps<span class="token punctuation">.</span>contributed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                ps<span class="token punctuation">.</span><span class="token function">removeSupportedOptions</span><span class="token punctuation">(</span>unmatchedProcessorOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
             <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">callProcessor</span><span class="token punctuation">(</span><span class="token class-name">Processor</span> proc<span class="token punctuation">,</span>
                                         <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> tes<span class="token punctuation">,</span>
                                         <span class="token class-name">RoundEnvironment</span> renv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> proc<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>tes<span class="token punctuation">,</span> renv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br></div></div><h4 id="_4-3-语义分析与字节码生成"><a href="#_4-3-语义分析与字节码生成" class="header-anchor">#</a> 4.3 语义分析与字节码生成</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>                    <span class="token keyword">case</span> BY_FILE<span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Queue</span><span class="token punctuation">&lt;</span><span class="token class-name">Env</span><span class="token punctuation">&lt;</span><span class="token class-name">AttrContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> todo<span class="token punctuation">.</span><span class="token function">groupByFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token class-name">CompileState</span><span class="token punctuation">.</span>ATTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">generate</span><span class="token punctuation">(</span><span class="token function">desugar</span><span class="token punctuation">(</span><span class="token function">flow</span><span class="token punctuation">(</span><span class="token function">attribute</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_5-相应的数据结构"><a href="#_5-相应的数据结构" class="header-anchor">#</a> 5.相应的数据结构</h3> <h2 id="六、mapstruct-源码解析"><a href="#六、mapstruct-源码解析" class="header-anchor">#</a> 六、MapStruct 源码解析</h2> <h3 id="_1-如何-debug"><a href="#_1-如何-debug" class="header-anchor">#</a> 1.如何 Debug</h3> <p>MapStruct 生成实现类的过程是在编译器发生的，那么如何进行编译期的 Debug 呢？可以借助 Maven 实现，如下所示：</p> <p>（1）在使用了 Processor 的项目下，执行 <code>mvnDebug clean compile</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ mvnDebug clean compile
Preparing to execute Maven <span class="token keyword">in</span> debug mode
Listening <span class="token keyword">for</span> transport dt_socket at address: <span class="token number">8000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以看到程序正在监听 8000 端口，并且一直处于阻塞状态，直到另一个进程连接 8000 端口，程序才会往下走</p> <p>(2) 然后在 Idea 中, 创建一个 <code>Remote JVM Debug</code>, 并指定端口为前面的 <code>8000</code></p> <p><img src="/snote/assets/img/image-20210528152918591.6c3afeed.png" alt="image-20210528152918591"></p> <p>然后以 Debug 方式运行，即可进行 AnnotationProcesser 的 Debug</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAbQAAAArCAYAAAAQc31kAAAQT0lEQVR4nO2dWZBc1XnHf+f2dntf1NOjQQquxKUFpAEkO06BBrAUGey4CgkjQvEQHBflhApVcSVvGFUAR6jymidDSB6SPFDYpGSosh0T0BJtFSdGwDBCI2N2aTQzPb3v3bdvHnq6p3ume6b3nuX8qqZquvve892+3ef8z/ed7zstHnzwQR2JRCKRSNY4xtlQZNDXIJFIJBJJxyiDvgCJRCKRSLqBFDSJRCKRrAuMgzIsBHi9XpwOOwaDYVCXseHQNI14Ikk4HEaXq6eSNYwcQ+qzkfv4wATN6/HgsNuZng2SzWQ23I0fBEKARVUJ+P2g64TCcv1UsnaRY8hSNnIfH/J5BhdydDgczAbnyKTlF7Ff6Dpk0hlmg3M4HI5BX45E0hFyDFnKRu/jA/PQjEYDmUx6UOY3NJlMGqNRhmgk9fG4nDjsNoQQAHx+/caqtCPHkMb0qo97XE5sVmul7c+uTXXdRicsK2iKTUG9x4liFehCIIyCxE9CXTPezqzq20cebeq4n7/6cuuNbxDWzGzWKLDe6yD3fhptugCAIWDEPGolfSYBhbXyRkC1WDCbTaDr5PIFsrkc+ir7IFSLBZ/XjdFg6Om1ddPOKruFq4Zu3xfVYsHjdmI2mbrbcJdpKGiKTcH6DReKq6TEhU9yZH+d7NuFSVYvfp+XSCxGoaD11I5iN2DwGbEdcJE6GQfAdsCJXtBR7AaK0UL7bSsKFrMJs9mMyWhEtZgByGRz5AsFcrkc2VyeYrHY0XuwWVW8bjcGQ210X9M0wtEYqXSmo/a7hcthx+N2VR4LIdB1veP3Pyg7ku4gBHjdbhx225LXClpv+3871BW0xWKW/12WzMUEDGA2VO2Rlb2ulbyvZr04SXtYVQuqxU8skSSeSPZsNl+MFkifSWC7z4Xt4PwgqEDmTLwjMQPYOjJc93mbVa153ElIxWG34fO4yWSzBENxcvkCuq5jNpnwul34fV7C0RjxxGAnij5P/QFLCEEy1b2QXr/s9JKiHuDgE48zdP44r7wvWjx3F48e3cnlY68yLlo7dxAoiiCwaVMpslCHTj6z37tpc1PHtRyGXvyEUEUpzOhaiL9qUW0gYtYMf3T3fn59/gy6nOH1FSEEbqcDu9VKJBYnnem+p6HYFdQxBwhKf/OoY05Sb0UpznV3hnhtahqz2YTJZMLjcnbUlslkwudxk0imCEWiQOmeqRYLmWyW6eAcm7wevG4XmWyWfL4zgW4Vs8lEwO9DURrnheXyeSKx+JqwsxLF3Q/x7L4gL75wmimGOfjE49w9tPCl0mfP8+ILp5leA0LTD4QQBPybGoYYc/k8sXhvP7N2qBG0xZ4ZOiBA3WtD6JC7PJhZVLVHttg727HrNlxuD2fe+AW5XLbfl9Y0nczsVjNGowG/z0M6k+1aGNJ2X8kbUxwKwr50IBQWge2Ai2K0ZCv1RqxjmwBasUg6kyWdyXYsaE67rRJWLGMxlwb3z6/fQNd1QpEoqsWCy+Fgro/p1WWRESsM3qFwtKd2dF0nFk8QSyQ6stMuV372fKUvjj78FH/5p0F+9NOJgVzLakAIcDud2G1WhBDLTkIi0fiqXL+sETR1zFERM12DzOkY6j4nQhVYvlIKFQxK1B574gcNXxvZejP7/vh+Tv3y9T5e0WBwOp1881t/glW11n09nUnzn7/8BfE+z566GYZU7AoYBMLauEMJVUERQL43varT7C2raiGdyS57H3RdJ5XJYFMtHdlqhWqRqSc0M8FQ5bVcPt8zOwDBUATVYsbjWlhTq54A9JN3P7jKg7cMxPQSBtHHy2tldpt1/nHjyU4skSSTXZ3OQ42gZS4mS7Nji0Lmv2MUrudJvRHFdp+7ImrGrSayb6fQgv0NkQD82wv/uOS5x574AVNffMb5k2+seP6Cl/Q6HHqAHcEL8yGI3Tx69AF2zn+IM+f+mR+fnpmPed/F7GtX2XHoLgJCcOVnz/MyR3ju8I6aY0vt76ppR9cnOXHsVd6tbv/w0/zdvvPL2l2OeDzOyTff5L77v4lpUTggn89z8s03+y5mZboVhkyciGDcYsJ6oDTQpX4eRQvNZzn6jNi+7QYg+06a/NXeJFVs8nqIxOJobS58GwyGJYvmqsWCruvoul5pPxyJEm6h3TvvvJO77ryz7msXLl7k4sWLy57vsNuIJ5IYDIa661mZbJabNgc69s5WsgOQL+SxqpbKIDqodbSiHuDgvu3MTp6tem7XCn1zN488vfB6tbe38rnLM4g+7nW7mhKzbC5HtMfh4U6oEbRiXCP1RgzFpVC4VpqdFaNajagZhk3YDrpIvRnrq6jVEzOAyYn3Wl5D23FoJyeOHecVISiyuyRaLx3nlRlREb1Hgsd5eRzAz9i+q7x47DhTo0d47vDTPDv5Gs8d+w+KgXt58vt3M3pqQbR85/+F58oCt/shnj16BI69ysvHZmtCjsvZXSkkORea48zpU+w/cLCSPadpRc6cPsVcaK7p+7BaMd9uw1C1hmvabsGQLmUhKtaFe2PcakZYFXLvprp+DTarimoxE4klSKZab1/TNIxV2zE5HXZczoXQYrvtlwVrsag1I2ZAZT2vOtNwMUaDgYDfRzyRJBpPtJWBuJyduXCEQkFDEUqN2DnsNhLJVEeeYSvsPPw0zxwGXZ/l3EvH+fFMtSAtNyYsGkN2P8Szh44wOl4eB5Y/txn62ceddhsGg4F4IonTYW94nK6DyWhkeGgT07Nzq67sBOokhRTjGsV47cyyGNXIX01jvm3+y2cSfRc15f7v1n3+fwHxjT9D/9W/As1lOE6+VpVlNLqTnWKInX/xNHdXHTPjL2fBBTl3Yn6xePwKVw75mD3zPiBgOkiI7QwNA4GdJY/v1HTJfwcYP8u5fY9z6yi8u/jLvKzdlWdz16euc+HCOcbG7gHgwoVzXJ+6vuJ5vUTX9a6EHC231YZaTNvUuscZt5gwbjG1JWi5XL5h9lYZRVHweVzYbSrhSIx8ofnvejqTxapaKmnpqsXCXDhS44W02/5iUWtWzKqJRGMoQlQEpfRx1X5mTocdh91GMBRp29uuZyeZSnPzlpG6x28O+IH+FOyWvarRh5/iwXt3c7K8frbimLBoDKnu56x8brP0q4/HkyniyVIfcjkb7y6iKAIwoCgKW0eGe1Zw3wlN7xSSm0hjGDZhGJ4fBAYgas3QTkF14wynoS5cUZDZBvrUaWbVxx9/hNVqrfw/SLqZFJI4EcE4bES9q9S5GoUcc++kyH2cW3L+nkjJC9qcyTAyv5PE2FwQgIjJxN/edgexRAK/z7vkXIPBsCTMaDGbGR7aRDSeaDrFPp5M4bDb8LpdhCJRZucab0jQTvvVAtaqmJUJRaIUdR1FCOw2a91JiBCCoU1e0pkMc+Fo295atR0oCdbw0CYsZnPNsdlcjunZ7kcZRvw+CF0p9bVFb/Pdn7zOrUcf4JHd71eiI437ZmBFW90cT/rdxyPRWF2vujoMWf7f6bAPvORkMU3v5agXIH0yhjZdFQ6YFzWDf2A7aNXQVv3Z+BUm/Xfx9dGFp0YffojRVj2M+Xa+s79qJjZ6N2NcZWK6d3YvX57g8uXBZWYVChrBUIRgKNy1QmvFrlDK+Chh2m7BfLsN8+02TNsXEih0IUrHAv/09v9x9swpzp45xfGJcY5PjPM3H17le59+wvc+/YRtiQTbEgm2pksCl0pnlnRGq6oyMu8hLEYIgcflxLtMqK6afD5PKBLFYbcxPFSq5VlubaLV9qEkZO2KWZlINIamaei6zkywsehaVbXiPXVqB+DmLSNLxAxK4t7Ie2uXoh5g1w4/s7OzdV9XxASnzwfZse/rDOt6U31zxy27K/+P7D/EmP8ql8fp3nhSRT/7eGw+ulJO5mmU1COEwKbWj5wMkpaUqCxq1gOuGk9N3e8keSLS062IivMhxW6jiAlefsnPk9//Ic8crlrgrTOTW7GdY/Do0cd5Zqw6KaQ0U1OYYWIyyBNVSSEN7a4BuhVerEc5bb9Mo5Cj5XYrYCX+73M8v/NW/uH99xjKZnE0CN1pQvBfgYUJRzgaQysWcTsdFU+k0XvRdb0lDwogkUxRLBbxut1sHvLPtwOfX18aTmun/W5hMBiYCYaWXbsqe2jdsAONPbRcPs+NmWBHdqoZffgpvrNDoE++xo+WScyYOvUa53Y8XkndX2lMmGQnzxw9BCwkf40LgUJ3xpNBIIRgc8DfdDq+oig47bZKuHI1IMbu3d/ybRZGFkRN00mdiqNNtbaQ+we//yU++vjTFY9r1euSezg2R7P3vx693vrK9OWSFyaMAsteGxgXibwO2Usp9Ewp/JX/XSmF2Fws8sPJK3wtNIezjqjlFYVxl4tTQwEuebx8aiut65iMxkqYJRItrWVV72SQzeVaXkNbTGUvRyAWT3S9/W5S7SEVNI1wJNb1wvmVvLBm1tA6+Q5vBFq9P+WdXFaqT6xG0zS+mKoXguo/Qz5Pe7vtlz019R4XuQ/SLYtZK0iBWn0EQ60kmrdOWaAACjcKWO6wYthsBCHQZgvk3kuhzS4d/HOKwrO33Mr909P81Ucf4svVrq/pwOsjW7gjGuHItS9wFgpMuFy84/ZwyePlt4t+bqNYLLad5biYTDa7pHanm+33gk6yHFfis2tTqBYLAb+v5vkbM8G+ZTlKalmukHqt0PbiV1nUOkEIuVv2IFgjUU2gvJ9ja3Uvvxoe5orTWQlBWuYH5Le9Xt4KBHgrUFrY9+Vy7IrFuCMa4anJDxjJZCoC95Fe5H+Mprbr0FYilc50VOfWKxRFoaBphMLRnhfPZrJZbswEsc4Xlqcz2ZbFTI4h9Wmnj8+FI1jMgRbOFasq3AgD/D20QkFDVa2k02tjU9L1hKpae75T/qD51Gbju1/9WiUEadJ1TvprM9RCZjNn/X7O+kvrW45CoSJwj71zib9PJGo8uEseT9eur59bXbVCsVjk+o3mi4A7JZfPt+2RyTGkMe30cV3XuXZjdYQP26WtNbRu4PN6cDgczATlz6f3i+qfZ08kEhvm59nvn57myY8+5M+/8oeE6mTWNcJcLLIrFmNPJMwd0Qh7IhEueTxMuNzzIuchtw7CNGsVOYYsZaP2cSitoQ1M0IQAr9eL02HHYJC/ntwvNE0jnkgSDoflANAGeyIRdsWiFYH7rcNRI3AJ4+ooYdkIyDGkPhu5jw9M0CSS9cCuWKxG4KZUtUbgWvEIJRJJZ0hBk0i6yLZEokbg4kYjl10uLrlLa3A3VmExqkSyXpCCJpH0kC+lUtwai7EnGq5syVWdaFKuhZNIJJ0j9u7dKwVNIukTN+VyjCaT7I3H+WoigVPTGLfb+Y3DwW+cTiat9X8DSyKRrIz00CSSAVJdC7cnEq6phbvk8TLhan5vR4lkoyMFTSJZRVTXwu2JhNnWw1o4iWS9IQVNIlnFyFo4iaR5pKBJJGsMWQsnkdRHCppEssaRtXASSQkpaBLJOkPWwkk2KlLQJJJ1zuJauClV5a9v3zPoy5JIuo4UNIlEIpGsC2R6lEQikUjWBVLQJBKJRLIukIImkUgkknWBFDSJRCKRrAukoEkkEolkXfD/CQqap6T6zKcAAAAASUVORK5CYII=" alt="image-20210528153350536"></p> <p><img src="/snote/assets/img/image-20210528153446410.0f165eb9.png" alt="image-20210528153446410"></p> <h3 id="_2-注解处理的流程"><a href="#_2-注解处理的流程" class="header-anchor">#</a> 2.注解处理的流程</h3> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="449px" preserveAspectRatio="none" version="1.1" viewBox="0 0 391 449" width="391px" zoomAndPan="magnify" style="width:391px;height:449px;"><defs><filter height="300%" id="f18ni5kx94o0es" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FFFFFF" filter="url(#f18ni5kx94o0es)" height="318.1094" width="10" x="86" y="71.9609" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#f18ni5kx94o0es)" height="215.4063" width="10" x="91" y="153.6641" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#f18ni5kx94o0es)" height="145.0547" width="10" x="96" y="197.0156" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#f18ni5kx94o0es)" height="62.7031" width="367.5" x="13" y="260.3672" style="stroke:#000000;stroke-width:2.0;"></rect><line x1="91" x2="91" y1="39.6094" y2="408.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="284.5" x2="284.5" y1="39.6094" y2="408.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><rect fill="#FEFECE" filter="url(#f18ni5kx94o0es)" height="31.6094" width="132" x="23" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="30" y="24.5332">MappingProcessor</text><rect fill="#FEFECE" filter="url(#f18ni5kx94o0es)" height="31.6094" width="132" x="23" y="407.0703" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="30" y="428.6035">MappingProcessor</text><rect fill="#FEFECE" filter="url(#f18ni5kx94o0es)" height="31.6094" width="167" x="199.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="153" x="206.5" y="24.5332">ModelElementProcessor</text><rect fill="#FEFECE" filter="url(#f18ni5kx94o0es)" height="31.6094" width="167" x="199.5" y="407.0703" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="153" x="206.5" y="428.6035">ModelElementProcessor</text><rect fill="#FFFFFF" filter="url(#f18ni5kx94o0es)" height="318.1094" width="10" x="86" y="71.9609" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#f18ni5kx94o0es)" height="215.4063" width="10" x="91" y="153.6641" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#f18ni5kx94o0es)" height="145.0547" width="10" x="96" y="197.0156" style="stroke:#A80036;stroke-width:1.0;"></rect><polygon fill="#A80036" points="74,67.9609,84,71.9609,74,75.9609,78,71.9609" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="3" x2="80" y1="71.9609" y2="71.9609" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="10" y="67.1045">process</text><line x1="96" x2="138" y1="102.3125" y2="102.3125" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="138" x2="138" y1="102.3125" y2="115.3125" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="97" x2="138" y1="115.3125" y2="115.3125" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="107,111.3125,97,115.3125,107,119.3125,103,115.3125" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="103" y="97.4561">getMappers</text><line x1="96" x2="143" y1="140.6641" y2="140.6641" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="143" x2="143" y1="140.6641" y2="153.6641" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="102" x2="143" y1="153.6641" y2="153.6641" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="112,149.6641,102,153.6641,112,157.6641,108,153.6641" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="108" y="135.8076">processMapperElements</text><line x1="101" x2="148" y1="184.0156" y2="184.0156" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="148" x2="148" y1="184.0156" y2="197.0156" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="107" x2="148" y1="197.0156" y2="197.0156" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="117,193.0156,107,197.0156,117,201.0156,113,197.0156" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="113" y="179.1592">processMapperTypeElement</text><line x1="106" x2="148" y1="232.3672" y2="232.3672" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="148" x2="148" y1="232.3672" y2="245.3672" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="107" x2="148" y1="245.3672" y2="245.3672" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="117,241.3672,107,245.3672,117,249.3672,113,245.3672" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="113" y="227.5107">getProcessors()</text><path d="M13,260.3672 L86,260.3672 L86,268.3672 L76,278.3672 L13,278.3672 L13,260.3672 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"></path><rect fill="none" height="62.7031" width="367.5" x="13" y="260.3672" style="stroke:#000000;stroke-width:2.0;"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="28" y="274.8623">loop</text><polygon fill="#A80036" points="273,297.0703,283,301.0703,273,305.0703,277,301.0703" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="106" x2="279" y1="301.0703" y2="301.0703" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="113" y="296.2139">process</text><polygon fill="#A80036" points="117,311.0703,107,315.0703,117,319.0703,113,315.0703" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="111" x2="284" y1="315.0703" y2="315.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="106" x2="148" y1="341.0703" y2="341.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="148" x2="148" y1="341.0703" y2="354.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="101" x2="148" y1="354.0703" y2="354.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="111,350.0703,101,354.0703,111,358.0703,107,354.0703" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="101" x2="143" y1="368.0703" y2="368.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="143" x2="143" y1="368.0703" y2="381.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="96" x2="143" y1="381.0703" y2="381.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="106,377.0703,96,381.0703,106,385.0703,102,381.0703" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="14,386.0703,4,390.0703,14,394.0703,10,390.0703" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="8" x2="90" y1="390.0703" y2="390.0703" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line></g></svg><h4 id="_2-1-注解处理的入口"><a href="#_2-1-注解处理的入口" class="header-anchor">#</a> 2.1 注解处理的入口</h4> <p>对于如下 Mapper，根据 JSR269 规范，在编译期会进行<code>@Mapper</code>注解的处理</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Mapper</span><span class="token punctuation">(</span><span class="token keyword">uses</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">DateMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">RoleConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> unmappedTargetPolicy <span class="token operator">=</span> <span class="token class-name">ReportingPolicy</span><span class="token punctuation">.</span>IGNORE<span class="token punctuation">,</span> unmappedSourcePolicy <span class="token operator">=</span><span class="token class-name">ReportingPolicy</span><span class="token punctuation">.</span>IGNORE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserConverter</span> <span class="token keyword">extends</span> <span class="token class-name">BaseConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">UserConverter</span> INSTANCE <span class="token operator">=</span> <span class="token class-name">Mappers</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在编译时，会通过ServiceLoader来加载注解处理器，其注解处理器是配置在<code>resource/META-INF/services/javax.annotation.processing.Processor</code>文件中的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>ap<span class="token punctuation">.</span></span>MappingProcessor</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因此可以找到编译期<code>@Mapper</code>注解处理的入口：<code>MappingProcessor</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SupportedAnnotationTypes</span><span class="token punctuation">(</span><span class="token string">&quot;org.mapstruct.Mapper&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MappingProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProcessor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> annotations<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RoundEnvironment</span> roundEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">RoundContext</span> roundContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundContext</span><span class="token punctuation">(</span> annotationProcessorContext <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// process any mappers left over from previous rounds</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> deferredMappers <span class="token operator">=</span> <span class="token function">getAndResetDeferredMappers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">processMapperElements</span><span class="token punctuation">(</span> deferredMappers<span class="token punctuation">,</span> roundContext <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// get and process any mappers from this round</span>
        <span class="token comment">// 获取被@Mapper修饰的类元素</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> mappers <span class="token operator">=</span> <span class="token function">getMappers</span><span class="token punctuation">(</span> annotations<span class="token punctuation">,</span> roundEnvironment <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理这些元素</span>
        <span class="token function">processMapperElements</span><span class="token punctuation">(</span> mappers<span class="token punctuation">,</span> roundContext <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ANNOTATIONS_CLAIMED_EXCLUSIVELY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_2-2-使用modelelementprocessor链去处理"><a href="#_2-2-使用modelelementprocessor链去处理" class="header-anchor">#</a> 2.2 使用<code>ModelElementProcessor</code>链去处理</h4> <p>然后会遍历 Mapper 类，并挨个处理</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processMapperElements</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeElement</span><span class="token punctuation">&gt;</span></span> mapperElements<span class="token punctuation">,</span> <span class="token class-name">RoundContext</span> roundContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">TypeElement</span> mapperElement <span class="token operator">:</span> mapperElements <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Element</span><span class="token punctuation">&gt;</span></span> tst <span class="token operator">=</span> mapperElement<span class="token punctuation">.</span><span class="token function">getEnclosedElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ProcessorContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultModelElementProcessorContext</span><span class="token punctuation">(</span>
                        processingEnv<span class="token punctuation">,</span> options<span class="token punctuation">,</span> roundContext<span class="token punctuation">,</span> <span class="token function">getDeclaredTypesNotToBeImported</span><span class="token punctuation">(</span> mapperElement <span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 挨个Mapper类</span>
                <span class="token function">processMapperTypeElement</span><span class="token punctuation">(</span> context<span class="token punctuation">,</span> mapperElement <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>处理主要是借助一个<code>ModelElementProcessor</code>链来处理的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processMapperTypeElement</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> context<span class="token punctuation">,</span> <span class="token class-name">TypeElement</span> mapperTypeElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> model <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">ModelElementProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> processor <span class="token operator">:</span> <span class="token function">getProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 使用model来存储每个processor处理的结果，同时又会将model作为参数传入下一个processor</span>
                model <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span> context<span class="token punctuation">,</span> processor<span class="token punctuation">,</span> mapperTypeElement<span class="token punctuation">,</span> model <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span> <span class="token class-name">AnnotationProcessingException</span> e <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                processingEnv<span class="token punctuation">.</span><span class="token function">getMessager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span>
                        <span class="token class-name">Kind</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>
                        e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        e<span class="token punctuation">.</span><span class="token function">getElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        e<span class="token punctuation">.</span><span class="token function">getAnnotationMirror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        e<span class="token punctuation">.</span><span class="token function">getAnnotationValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModelElementProcessor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO Re-consider which class loader to use in case processors are</span>
        <span class="token comment">// loaded from other modules, too</span>
        <span class="token comment">// 加载实现类</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">)</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModelElementProcessor</span><span class="token punctuation">&gt;</span></span> processorIterator <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
            <span class="token class-name">ModelElementProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token class-name">MappingProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ModelElementProcessor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> processors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span> processorIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            processors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> processorIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 排序</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span> processors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ProcessorComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> processors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><code>ModelElementProcessor</code>链是以 SPI 的形式加载的，内容来自于<code>resource/META-INF/services/org.mapstruct.ap.internal.processor.ModelElementProcessor</code>文件，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>ap<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>processor<span class="token punctuation">.</span></span>CdiComponentProcessor</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>ap<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>processor<span class="token punctuation">.</span></span>Jsr330ComponentProcessor</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>ap<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>processor<span class="token punctuation">.</span></span>MapperCreationProcessor</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>ap<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>processor<span class="token punctuation">.</span></span>MapperRenderingProcessor</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>ap<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>processor<span class="token punctuation">.</span></span>MethodRetrievalProcessor</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>ap<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>processor<span class="token punctuation">.</span></span>SpringComponentProcessor</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>mapstruct<span class="token punctuation">.</span>ap<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>processor<span class="token punctuation">.</span></span>MapperServiceProcessor</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>排序后为如下列表：</p> <p><img src="/snote/assets/img/image-20210531201543029.bff2a5b3.png" alt="image-20210531201543029"></p> <h5 id="_2-1-methodretrievalprocessor"><a href="#_2-1-methodretrievalprocessor" class="header-anchor">#</a> 2.1 MethodRetrievalProcessor</h5> <p>获取 Mapping 方法，包括 Mapper 自身的方法和 <code>@Mapper#uses</code>属性指定的方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceMethod</span><span class="token punctuation">&gt;</span></span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> context<span class="token punctuation">,</span> <span class="token class-name">TypeElement</span> mapperTypeElement<span class="token punctuation">,</span> <span class="token class-name">Void</span> sourceModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token function">retrieveMethods</span><span class="token punctuation">(</span> mapperTypeElement<span class="token punctuation">,</span> mapperTypeElement<span class="token punctuation">,</span> mapperOptions<span class="token punctuation">,</span> prototypeMethods <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * Retrieves the mapping methods declared by the given mapper type.
     *
     * @param usedMapper The type of interest (either the mapper to implement or a used mapper via @uses annotation)
     * @param mapperToImplement the top level type (mapper) that requires implementation
     * @param mapperOptions the mapper config
     * @param prototypeMethods prototype methods defined in mapper config type
     * @return All mapping methods declared by the given type
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceMethod</span><span class="token punctuation">&gt;</span></span> <span class="token function">retrieveMethods</span><span class="token punctuation">(</span><span class="token class-name">TypeElement</span> usedMapper<span class="token punctuation">,</span> <span class="token class-name">TypeElement</span> mapperToImplement<span class="token punctuation">,</span>
                                               <span class="token class-name">MapperOptions</span> mapperOptions<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceMethod</span><span class="token punctuation">&gt;</span></span> prototypeMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceMethod</span><span class="token punctuation">&gt;</span></span> methods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">ExecutableElement</span> executable <span class="token operator">:</span> <span class="token function">getAllEnclosedExecutableElements</span><span class="token punctuation">(</span> elementUtils<span class="token punctuation">,</span> usedMapper <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SourceMethod</span> method <span class="token operator">=</span> <span class="token function">getMethod</span><span class="token punctuation">(</span>
                usedMapper<span class="token punctuation">,</span>
                executable<span class="token punctuation">,</span>
                mapperToImplement<span class="token punctuation">,</span>
                mapperOptions<span class="token punctuation">,</span>
                prototypeMethods <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span> method <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                methods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> method <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//Add all methods of used mappers in order to reference them in the aggregated model</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> usedMapper<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span> mapperToImplement <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">DeclaredType</span> mapper <span class="token operator">:</span> mapperOptions<span class="token punctuation">.</span><span class="token keyword">uses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 处理通过 @Mapper#uses 导入的Mapper</span>
                <span class="token class-name">TypeElement</span> usesMapperElement <span class="token operator">=</span> <span class="token function">asTypeElement</span><span class="token punctuation">(</span> mapper <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>mapperToImplement<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span> usesMapperElement <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    methods<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span> <span class="token function">retrieveMethods</span><span class="token punctuation">(</span>
                        usesMapperElement<span class="token punctuation">,</span>
                        mapperToImplement<span class="token punctuation">,</span>
                        mapperOptions<span class="token punctuation">,</span>
                        prototypeMethods <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    messager<span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span>
                        mapperToImplement<span class="token punctuation">,</span>
                        mapperOptions<span class="token punctuation">.</span><span class="token function">getAnnotationMirror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Message</span><span class="token punctuation">.</span>RETRIEVAL_MAPPER_USES_CYCLE<span class="token punctuation">,</span>
                        mapperToImplement
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> methods<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p><img src="/snote/assets/img/image-20210531212924984.6fb08cf4.png" alt="image-20210531212924984"></p> <h5 id="_2-2-mappercreationprocessor"><a href="#_2-2-mappercreationprocessor" class="header-anchor">#</a> 2.2 MapperCreationProcessor</h5> <p>主要是创建 Mapper 对象，为后续生成 Mapper 实现类做好准备</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Mapper</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> context<span class="token punctuation">,</span> <span class="token class-name">TypeElement</span> mapperTypeElement<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceMethod</span><span class="token punctuation">&gt;</span></span> sourceModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mappingContext <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getMapper</span><span class="token punctuation">(</span> mapperTypeElement<span class="token punctuation">,</span> mapperOptions<span class="token punctuation">,</span> sourceModel <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token class-name">Mapper</span> <span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">TypeElement</span> element<span class="token punctuation">,</span> <span class="token class-name">MapperOptions</span> mapperOptions<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceMethod</span><span class="token punctuation">&gt;</span></span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MappingMethod</span><span class="token punctuation">&gt;</span></span> mappingMethods <span class="token operator">=</span> <span class="token function">getMappingMethods</span><span class="token punctuation">(</span> mapperOptions<span class="token punctuation">,</span> methods <span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappingMethods<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span> mappingContext<span class="token punctuation">.</span><span class="token function">getUsedSupportedMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappingMethods<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span> mappingContext<span class="token punctuation">.</span><span class="token function">getMappingsToGenerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// handle fields</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">&gt;</span></span> fields <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span> mappingContext<span class="token punctuation">.</span><span class="token function">getMapperReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">&gt;</span></span> supportingFieldSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addAllFieldsIn</span><span class="token punctuation">(</span> mappingContext<span class="token punctuation">.</span><span class="token function">getUsedSupportedMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> supportingFieldSet <span class="token punctuation">)</span><span class="token punctuation">;</span>
        fields<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span> supportingFieldSet <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// handle constructorfragments</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SupportingConstructorFragment</span><span class="token punctuation">&gt;</span></span> constructorFragments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addAllFragmentsIn</span><span class="token punctuation">(</span> mappingContext<span class="token punctuation">.</span><span class="token function">getUsedSupportedMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> constructorFragments <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Mapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mapper<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">element</span><span class="token punctuation">(</span> element <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">methods</span><span class="token punctuation">(</span> mappingMethods <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span> fields <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">constructorFragments</span><span class="token punctuation">(</span>  constructorFragments <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span> options <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">versionInformation</span><span class="token punctuation">(</span> versionInformation <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">decorator</span><span class="token punctuation">(</span> <span class="token function">getDecorator</span><span class="token punctuation">(</span> element<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> mapperOptions<span class="token punctuation">.</span><span class="token function">implementationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                mapperOptions<span class="token punctuation">.</span><span class="token function">implementationPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getExtraImports</span><span class="token punctuation">(</span> element<span class="token punctuation">,</span> mapperOptions <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">typeFactory</span><span class="token punctuation">(</span> typeFactory <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">elementUtils</span><span class="token punctuation">(</span> elementUtils <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">extraImports</span><span class="token punctuation">(</span> <span class="token function">getExtraImports</span><span class="token punctuation">(</span> element<span class="token punctuation">,</span> mapperOptions <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">implName</span><span class="token punctuation">(</span> mapperOptions<span class="token punctuation">.</span><span class="token function">implementationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">implPackage</span><span class="token punctuation">(</span> mapperOptions<span class="token punctuation">.</span><span class="token function">implementationPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>mappingContext<span class="token punctuation">.</span><span class="token function">getForgedMethodsUnderCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messager<span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span> element<span class="token punctuation">,</span> <span class="token class-name">Message</span><span class="token punctuation">.</span>GENERAL_NOT_ALL_FORGED_CREATED<span class="token punctuation">,</span>
                mappingContext<span class="token punctuation">.</span><span class="token function">getForgedMethodsUnderCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> mapper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h5 id="_2-3-componentprocessor"><a href="#_2-3-componentprocessor" class="header-anchor">#</a> 2.3 ComponentProcessor</h5> <p>主要给前面创建好的 Mapper 填充相关注解。</p> <p><code>@Mapper</code> 的 <code>componentModel</code>属性可取如下值：</p> <blockquote><ul><li><code>default</code>：映射器不使用组件模型，通常通过<code>Mappers#getMapper(Class)</code>来检索实例</li> <li><code>cdi</code>：生成的映射器是一个应用程序范围的 CDI bean，可以通过它检索 <code>@Inject</code></li> <li><code>spring</code>：生成的映射器是一个单例范围的 Spring bean，可以通过它检索 <code>@Autowired</code></li> <li><code>jsr330</code>：生成的映射器使用{@code @Named}进行注释，并且可以通过<code>@Inject</code>（例如使用 Spring）进行检索</li></ul></blockquote> <p>然后被 CdiComponentProcessor、Jsr330ComponentProcessor、SpringComponentProcessor 处理</p> <h5 id="_2-4-mapperrenderingprocessor"><a href="#_2-4-mapperrenderingprocessor" class="header-anchor">#</a> 2.4 MapperRenderingProcessor</h5> <p>根据前面创建好的 Mapper 来创建 Mapper 实现类的<code>.class</code> 文件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapperRenderingProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">ModelElementProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Mapper</span><span class="token punctuation">,</span> <span class="token class-name">Mapper</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mapper</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> context<span class="token punctuation">,</span> <span class="token class-name">TypeElement</span> mapperTypeElement<span class="token punctuation">,</span> <span class="token class-name">Mapper</span> mapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>context<span class="token punctuation">.</span><span class="token function">isErroneous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">writeToSourceFile</span><span class="token punctuation">(</span> context<span class="token punctuation">.</span><span class="token function">getFiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapper<span class="token punctuation">,</span> mapperTypeElement <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeToSourceFile</span><span class="token punctuation">(</span><span class="token class-name">Filer</span> filer<span class="token punctuation">,</span> <span class="token class-name">Mapper</span> model<span class="token punctuation">,</span> <span class="token class-name">TypeElement</span> originatingElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ModelWriter</span> modelWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">createSourceFile</span><span class="token punctuation">(</span> model<span class="token punctuation">,</span> modelWriter<span class="token punctuation">,</span> filer<span class="token punctuation">,</span> originatingElement <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> model<span class="token punctuation">.</span><span class="token function">getDecorator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">createSourceFile</span><span class="token punctuation">(</span> model<span class="token punctuation">.</span><span class="token function">getDecorator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> modelWriter<span class="token punctuation">,</span> filer<span class="token punctuation">,</span> originatingElement <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createSourceFile</span><span class="token punctuation">(</span><span class="token class-name">GeneratedType</span> model<span class="token punctuation">,</span> <span class="token class-name">ModelWriter</span> modelWriter<span class="token punctuation">,</span> <span class="token class-name">Filer</span> filer<span class="token punctuation">,</span>
                                  <span class="token class-name">TypeElement</span> originatingElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 解析文件名</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> model<span class="token punctuation">.</span><span class="token function">hasPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fileName <span class="token operator">+=</span> model<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        fileName <span class="token operator">+=</span> model<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取 JavaFileObject</span>
        <span class="token class-name">JavaFileObject</span> sourceFile<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            sourceFile <span class="token operator">=</span> filer<span class="token punctuation">.</span><span class="token function">createSourceFile</span><span class="token punctuation">(</span> fileName<span class="token punctuation">,</span> originatingElement <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span> <span class="token class-name">IOException</span> e <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span> e <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	    <span class="token comment">// 写实现类.class文件</span>
        modelWriter<span class="token punctuation">.</span><span class="token function">writeModel</span><span class="token punctuation">(</span> sourceFile<span class="token punctuation">,</span> model <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">9999</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>然后进入 <code>ModelWriter#writeModel</code> 方法，主要是根据前面创建的 sourceFile 打开一个写文件的 writer，然后使用 FreeMarkerWritable 来跟根据定义好的模板来生成实现类.class 文件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//  ModelWriter</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeModel</span><span class="token punctuation">(</span><span class="token class-name">FileObject</span> sourceFile<span class="token punctuation">,</span> <span class="token class-name">Writable</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 打开writer</span>
        <span class="token class-name">BufferedWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndentationCorrectingWriter</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">.</span><span class="token function">openWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        values<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> CONFIGURATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// model 的类型为 FreeMarkerWritable</span>
        model<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ModelWriter<span class="token punctuation">.</span>DefaultModelElementWriterContext</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然后进入 <code>FreeMarkerWritable#write</code> 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">FreeMarkerWritable</span> <span class="token keyword">implements</span> <span class="token class-name">Writable</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Writer</span> writer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">FreeMarkerModelElementWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> writer <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>最终进入 <code>FreeMarkerModelElementWriter#write</code> 方法，这里就是调用 FreeMarker 模板生成实现类内容的代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//  FreeMarkerModelElementWriter</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">FreeMarkerWritable</span> writable<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Writer</span> writer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 模板为 `org/mapstruct/ap/internal/model/GeneratedType.ftl`</span>
        <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span>writable<span class="token punctuation">.</span><span class="token function">getTemplateName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FreeMarkerModelElementWriter<span class="token punctuation">.</span>ExternalParamsTemplateModel</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanModel</span><span class="token punctuation">(</span>writable<span class="token punctuation">,</span> <span class="token class-name">BeansWrapper</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleMapModel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BeansWrapper</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>模板文件为 <code>org/mapstruct/ap/internal/model/GeneratedType.ftl</code>，内容如下：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>&lt;#--

    Copyright MapStruct Authors.

    Licensed under the Apache License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0

--&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#--</span> <span class="token attr-name">@ftlvariable</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.mapstruct.ap.internal.model.GeneratedType<span class="token punctuation">&quot;</span></span> <span class="token attr-name">--</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#if</span> <span class="token attr-name">hasPackageName()</span><span class="token punctuation">&gt;</span></span>
package ${packageName};
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#list</span> <span class="token attr-name">importTypeNames</span> <span class="token attr-name">as</span> <span class="token attr-name">importedType</span><span class="token punctuation">&gt;</span></span>
import ${importedType};
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#list</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#if</span> <span class="token attr-name">!generatedTypeAvailable</span><span class="token punctuation">&gt;</span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span>
@Generated(
    value = &quot;org.mapstruct.ap.MappingProcessor&quot;&lt;#if suppressGeneratorTimestamp == false&gt;,
    date = &quot;${.now?string(&quot;yyyy-MM-dd'T'HH:mm:ssZ&quot;)}&quot;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span>&lt;#if suppressGeneratorVersionComment == false&gt;,
    comments = &quot;version: ${versionInformation.mapStructVersion}, compiler: ${versionInformation.compiler}, environment: Java ${versionInformation.runtimeVersion} (${versionInformation.runtimeVendor})&quot;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span>
)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#if</span> <span class="token attr-name">!generatedTypeAvailable</span><span class="token punctuation">&gt;</span></span>
*/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#list</span> <span class="token attr-name">annotations</span> <span class="token attr-name">as</span> <span class="token attr-name">annotation</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#nt</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>@includeModel</span> <span class="token attr-name">object</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>annotation/</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#list</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#lt</span><span class="token punctuation">&gt;</span></span>${accessibility.keyword} class ${name}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#if</span> <span class="token attr-name">superClassName??</span><span class="token punctuation">&gt;</span></span> extends ${superClassName}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#if</span> <span class="token attr-name">interfaceName??</span><span class="token punctuation">&gt;</span></span> implements ${interfaceName}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span> {

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#list</span> <span class="token attr-name">fields</span> <span class="token attr-name">as</span> <span class="token attr-name">field</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#if</span> <span class="token attr-name">field.used</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#nt</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>@includeModel</span> <span class="token attr-name">object</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>field/</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#list</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#if</span> <span class="token attr-name">constructor??</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#nt</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>@includeModel</span> <span class="token attr-name">object</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>constructor/</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#list</span> <span class="token attr-name">methods</span> <span class="token attr-name">as</span> <span class="token attr-name">method</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#nt</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>@includeModel</span> <span class="token attr-name">object</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>method/</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#list</span><span class="token punctuation">&gt;</span></span>
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h5 id="_2-5-mapperserviceprocessor"><a href="#_2-5-mapperserviceprocessor" class="header-anchor">#</a> 2.5 MapperServiceProcessor</h5> <p>当 Mapper 的 componentMode 为 default，且设置了 mapstruct.alwaysGenerateServicesFile 属性时，会在 <code>META-INF/services</code>目录下生成 Service 文件。</p> <blockquote><ul><li>https://www.jianshu.com/p/4f7b4f4bf689)</li></ul></blockquote></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2021-06-11 22:12:01</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/snote/cs/backend/java/java-basic/09_ye-wu-quan-qiu-hua-duo-shi-qu-de-jie-jue-si-lu.html" class="prev">
            09_业务全球化多时区的解决思路
          </a></span> <span class="next"><a href="/snote/cs/backend/java/java-basic/11_zhu-jie.html">
            11_注解
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#推荐阅读" class="sidebar-link reco-side-推荐阅读" data-v-70334359>推荐阅读</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#一、环境说明" class="sidebar-link reco-side-一、环境说明" data-v-70334359>一、环境说明</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#二、常见的-bean-映射框架" class="sidebar-link reco-side-二、常见的-bean-映射框架" data-v-70334359>二、常见的 Bean 映射框架</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#三、mapstruct-使用入门" class="sidebar-link reco-side-三、mapstruct-使用入门" data-v-70334359>三、MapStruct 使用入门</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_1-引入依赖" class="sidebar-link reco-side-_1-引入依赖" data-v-70334359>1. 引入依赖</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_2-类型转换规则" class="sidebar-link reco-side-_2-类型转换规则" data-v-70334359>2. 类型转换规则</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_3-用法示例" class="sidebar-link reco-side-_3-用法示例" data-v-70334359>3. 用法示例</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#四、jsr-269-入门示例" class="sidebar-link reco-side-四、jsr-269-入门示例" data-v-70334359>四、JSR 269 入门示例</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#五、javac-编译过程详解" class="sidebar-link reco-side-五、javac-编译过程详解" data-v-70334359>五、Javac 编译过程详解</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_1-概述" class="sidebar-link reco-side-_1-概述" data-v-70334359>1.概述</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_2-编译的入口" class="sidebar-link reco-side-_2-编译的入口" data-v-70334359>2.编译的入口</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_3-编译期-debug" class="sidebar-link reco-side-_3-编译期-debug" data-v-70334359>3.编译期 Debug</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_4-编译流程分析" class="sidebar-link reco-side-_4-编译流程分析" data-v-70334359>4.编译流程分析</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_5-相应的数据结构" class="sidebar-link reco-side-_5-相应的数据结构" data-v-70334359>5.相应的数据结构</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#六、mapstruct-源码解析" class="sidebar-link reco-side-六、mapstruct-源码解析" data-v-70334359>六、MapStruct 源码解析</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_1-如何-debug" class="sidebar-link reco-side-_1-如何-debug" data-v-70334359>1.如何 Debug</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/java/java-basic/10_beanying-she-kuang-jia-mapstruct.html#_2-注解处理的流程" class="sidebar-link reco-side-_2-注解处理的流程" data-v-70334359>2.注解处理的流程</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 snote
    </div> <div class="operation" style="right:90px;bottom:40px;display:none;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:none;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:50px;bottom:10px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><canvas id="vuepress-canvas-cursor"></canvas><!----></div></div>
    <script src="/snote/assets/js/app.3cc04e36.js" defer></script><script src="/snote/assets/js/5.22329d81.js" defer></script><script src="/snote/assets/js/1.5e23c49c.js" defer></script><script src="/snote/assets/js/6.f56a3b14.js" defer></script><script src="/snote/assets/js/77.11cc1a2c.js" defer></script>
  </body>
</html>
