<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sentinel源码分析 | snote</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/snote/img/logo.png">
    <meta name="description" content="study note">
    
    <link rel="preload" href="/snote/assets/css/0.styles.733b32e4.css" as="style"><link rel="preload" href="/snote/assets/js/app.3cc04e36.js" as="script"><link rel="preload" href="/snote/assets/js/5.22329d81.js" as="script"><link rel="preload" href="/snote/assets/js/1.5e23c49c.js" as="script"><link rel="preload" href="/snote/assets/js/13.d156e68f.js" as="script"><link rel="preload" href="/snote/assets/js/77.11cc1a2c.js" as="script"><link rel="prefetch" href="/snote/assets/js/10.1e6036a4.js"><link rel="prefetch" href="/snote/assets/js/100.e53901ab.js"><link rel="prefetch" href="/snote/assets/js/101.7ff3bf92.js"><link rel="prefetch" href="/snote/assets/js/102.72df3fb1.js"><link rel="prefetch" href="/snote/assets/js/103.39232b43.js"><link rel="prefetch" href="/snote/assets/js/104.19b1fd3c.js"><link rel="prefetch" href="/snote/assets/js/105.a9e362b5.js"><link rel="prefetch" href="/snote/assets/js/106.77930f24.js"><link rel="prefetch" href="/snote/assets/js/107.ea9f01d0.js"><link rel="prefetch" href="/snote/assets/js/108.7ff74d7c.js"><link rel="prefetch" href="/snote/assets/js/109.e55033b4.js"><link rel="prefetch" href="/snote/assets/js/11.9b2b7f36.js"><link rel="prefetch" href="/snote/assets/js/110.d399212c.js"><link rel="prefetch" href="/snote/assets/js/111.9ca56f5e.js"><link rel="prefetch" href="/snote/assets/js/112.97d8e09c.js"><link rel="prefetch" href="/snote/assets/js/113.b00a35d2.js"><link rel="prefetch" href="/snote/assets/js/114.7071cc16.js"><link rel="prefetch" href="/snote/assets/js/115.71bfbee0.js"><link rel="prefetch" href="/snote/assets/js/116.d3cc8989.js"><link rel="prefetch" href="/snote/assets/js/117.52c30bbd.js"><link rel="prefetch" href="/snote/assets/js/118.d17bd671.js"><link rel="prefetch" href="/snote/assets/js/119.17200614.js"><link rel="prefetch" href="/snote/assets/js/12.8e64e191.js"><link rel="prefetch" href="/snote/assets/js/120.c4c779cd.js"><link rel="prefetch" href="/snote/assets/js/121.6e65fbc1.js"><link rel="prefetch" href="/snote/assets/js/122.304ccf9d.js"><link rel="prefetch" href="/snote/assets/js/123.b744823c.js"><link rel="prefetch" href="/snote/assets/js/124.f5ab81c9.js"><link rel="prefetch" href="/snote/assets/js/125.aaa33725.js"><link rel="prefetch" href="/snote/assets/js/126.10649710.js"><link rel="prefetch" href="/snote/assets/js/127.f35b2900.js"><link rel="prefetch" href="/snote/assets/js/128.833a1e82.js"><link rel="prefetch" href="/snote/assets/js/129.83493639.js"><link rel="prefetch" href="/snote/assets/js/130.3c356544.js"><link rel="prefetch" href="/snote/assets/js/131.77654b97.js"><link rel="prefetch" href="/snote/assets/js/132.3e636caa.js"><link rel="prefetch" href="/snote/assets/js/133.b8a7f38a.js"><link rel="prefetch" href="/snote/assets/js/134.35ccee41.js"><link rel="prefetch" href="/snote/assets/js/135.13f63617.js"><link rel="prefetch" href="/snote/assets/js/136.2cd53605.js"><link rel="prefetch" href="/snote/assets/js/137.8331c390.js"><link rel="prefetch" href="/snote/assets/js/138.0c433171.js"><link rel="prefetch" href="/snote/assets/js/139.a6287a10.js"><link rel="prefetch" href="/snote/assets/js/14.41b00a6a.js"><link rel="prefetch" href="/snote/assets/js/140.53857f35.js"><link rel="prefetch" href="/snote/assets/js/141.173a51f6.js"><link rel="prefetch" href="/snote/assets/js/142.ea2a40cd.js"><link rel="prefetch" href="/snote/assets/js/143.bf22752b.js"><link rel="prefetch" href="/snote/assets/js/144.ee4de6bb.js"><link rel="prefetch" href="/snote/assets/js/145.c3171214.js"><link rel="prefetch" href="/snote/assets/js/146.3784d416.js"><link rel="prefetch" href="/snote/assets/js/147.724d5523.js"><link rel="prefetch" href="/snote/assets/js/148.887b57b8.js"><link rel="prefetch" href="/snote/assets/js/149.365a3713.js"><link rel="prefetch" href="/snote/assets/js/15.d7973cb5.js"><link rel="prefetch" href="/snote/assets/js/150.5a119004.js"><link rel="prefetch" href="/snote/assets/js/151.35989bab.js"><link rel="prefetch" href="/snote/assets/js/152.a53a5bcf.js"><link rel="prefetch" href="/snote/assets/js/153.c49175be.js"><link rel="prefetch" href="/snote/assets/js/154.132d5c92.js"><link rel="prefetch" href="/snote/assets/js/155.4d2859d7.js"><link rel="prefetch" href="/snote/assets/js/156.24fa7e30.js"><link rel="prefetch" href="/snote/assets/js/157.d00b5ab7.js"><link rel="prefetch" href="/snote/assets/js/158.58345bf0.js"><link rel="prefetch" href="/snote/assets/js/159.30fd6c79.js"><link rel="prefetch" href="/snote/assets/js/16.2a0f8a1e.js"><link rel="prefetch" href="/snote/assets/js/160.0415e6c5.js"><link rel="prefetch" href="/snote/assets/js/161.af36ab6d.js"><link rel="prefetch" href="/snote/assets/js/162.3f15c754.js"><link rel="prefetch" href="/snote/assets/js/163.b29fc431.js"><link rel="prefetch" href="/snote/assets/js/164.9bcd2f56.js"><link rel="prefetch" href="/snote/assets/js/165.3b91ca92.js"><link rel="prefetch" href="/snote/assets/js/166.749c6ca6.js"><link rel="prefetch" href="/snote/assets/js/167.d48009c9.js"><link rel="prefetch" href="/snote/assets/js/168.c36d8d5d.js"><link rel="prefetch" href="/snote/assets/js/169.ae085a84.js"><link rel="prefetch" href="/snote/assets/js/17.4ffd4119.js"><link rel="prefetch" href="/snote/assets/js/170.fca3db2e.js"><link rel="prefetch" href="/snote/assets/js/171.7696e010.js"><link rel="prefetch" href="/snote/assets/js/172.1c40e807.js"><link rel="prefetch" href="/snote/assets/js/173.9b50a23b.js"><link rel="prefetch" href="/snote/assets/js/174.58befaba.js"><link rel="prefetch" href="/snote/assets/js/175.e1b9ba0f.js"><link rel="prefetch" href="/snote/assets/js/176.ec0983d0.js"><link rel="prefetch" href="/snote/assets/js/177.36734ab4.js"><link rel="prefetch" href="/snote/assets/js/178.fe90bfd6.js"><link rel="prefetch" href="/snote/assets/js/179.76053104.js"><link rel="prefetch" href="/snote/assets/js/18.f6fa6b40.js"><link rel="prefetch" href="/snote/assets/js/180.b015d622.js"><link rel="prefetch" href="/snote/assets/js/181.9b717ca0.js"><link rel="prefetch" href="/snote/assets/js/182.7f4cf041.js"><link rel="prefetch" href="/snote/assets/js/183.bb178fad.js"><link rel="prefetch" href="/snote/assets/js/184.7bcfa00d.js"><link rel="prefetch" href="/snote/assets/js/185.bca06eaf.js"><link rel="prefetch" href="/snote/assets/js/186.b5a2ae31.js"><link rel="prefetch" href="/snote/assets/js/187.54d67a16.js"><link rel="prefetch" href="/snote/assets/js/188.4c672878.js"><link rel="prefetch" href="/snote/assets/js/189.c4ff0da3.js"><link rel="prefetch" href="/snote/assets/js/19.4e10afcb.js"><link rel="prefetch" href="/snote/assets/js/190.c04cba39.js"><link rel="prefetch" href="/snote/assets/js/191.47277121.js"><link rel="prefetch" href="/snote/assets/js/192.2df35df1.js"><link rel="prefetch" href="/snote/assets/js/193.6522b845.js"><link rel="prefetch" href="/snote/assets/js/194.b0ab5764.js"><link rel="prefetch" href="/snote/assets/js/195.28c85e74.js"><link rel="prefetch" href="/snote/assets/js/196.6b6c7db3.js"><link rel="prefetch" href="/snote/assets/js/197.11fe146e.js"><link rel="prefetch" href="/snote/assets/js/198.d68ebf1f.js"><link rel="prefetch" href="/snote/assets/js/199.b813b835.js"><link rel="prefetch" href="/snote/assets/js/20.3b3c1d36.js"><link rel="prefetch" href="/snote/assets/js/200.b3956510.js"><link rel="prefetch" href="/snote/assets/js/201.9ae9098a.js"><link rel="prefetch" href="/snote/assets/js/202.a2a5abba.js"><link rel="prefetch" href="/snote/assets/js/203.6c78ac54.js"><link rel="prefetch" href="/snote/assets/js/204.07229555.js"><link rel="prefetch" href="/snote/assets/js/205.007d975e.js"><link rel="prefetch" href="/snote/assets/js/206.053c9ad1.js"><link rel="prefetch" href="/snote/assets/js/207.9dc2d2a1.js"><link rel="prefetch" href="/snote/assets/js/208.3ebf2372.js"><link rel="prefetch" href="/snote/assets/js/209.1bef9845.js"><link rel="prefetch" href="/snote/assets/js/21.54f98d7e.js"><link rel="prefetch" href="/snote/assets/js/210.d0a49b1e.js"><link rel="prefetch" href="/snote/assets/js/211.9867a469.js"><link rel="prefetch" href="/snote/assets/js/212.69fd5be2.js"><link rel="prefetch" href="/snote/assets/js/213.8f82a998.js"><link rel="prefetch" href="/snote/assets/js/214.823be3c5.js"><link rel="prefetch" href="/snote/assets/js/215.678426f8.js"><link rel="prefetch" href="/snote/assets/js/216.0564d748.js"><link rel="prefetch" href="/snote/assets/js/217.ea5120a3.js"><link rel="prefetch" href="/snote/assets/js/218.b259e9f5.js"><link rel="prefetch" href="/snote/assets/js/219.7103afc4.js"><link rel="prefetch" href="/snote/assets/js/22.2aac9b21.js"><link rel="prefetch" href="/snote/assets/js/220.294118e9.js"><link rel="prefetch" href="/snote/assets/js/221.fc705f9e.js"><link rel="prefetch" href="/snote/assets/js/222.82415480.js"><link rel="prefetch" href="/snote/assets/js/223.34d2d18a.js"><link rel="prefetch" href="/snote/assets/js/224.0dae4c03.js"><link rel="prefetch" href="/snote/assets/js/225.1200b289.js"><link rel="prefetch" href="/snote/assets/js/226.3f3df43d.js"><link rel="prefetch" href="/snote/assets/js/227.c7ecd98d.js"><link rel="prefetch" href="/snote/assets/js/228.1c820734.js"><link rel="prefetch" href="/snote/assets/js/229.42a94887.js"><link rel="prefetch" href="/snote/assets/js/23.4d176be4.js"><link rel="prefetch" href="/snote/assets/js/230.2fad6960.js"><link rel="prefetch" href="/snote/assets/js/231.ce9d1a71.js"><link rel="prefetch" href="/snote/assets/js/232.c63516ab.js"><link rel="prefetch" href="/snote/assets/js/233.49851721.js"><link rel="prefetch" href="/snote/assets/js/234.e8b507d2.js"><link rel="prefetch" href="/snote/assets/js/235.d33e513e.js"><link rel="prefetch" href="/snote/assets/js/236.87e4e820.js"><link rel="prefetch" href="/snote/assets/js/237.d58c3ffb.js"><link rel="prefetch" href="/snote/assets/js/238.5082bd37.js"><link rel="prefetch" href="/snote/assets/js/239.5802e4fa.js"><link rel="prefetch" href="/snote/assets/js/24.80d247cf.js"><link rel="prefetch" href="/snote/assets/js/240.bd7f4259.js"><link rel="prefetch" href="/snote/assets/js/241.d135df38.js"><link rel="prefetch" href="/snote/assets/js/242.67bd6281.js"><link rel="prefetch" href="/snote/assets/js/243.dda77da4.js"><link rel="prefetch" href="/snote/assets/js/244.5ced0265.js"><link rel="prefetch" href="/snote/assets/js/245.76aa7524.js"><link rel="prefetch" href="/snote/assets/js/246.690093e7.js"><link rel="prefetch" href="/snote/assets/js/247.3127d466.js"><link rel="prefetch" href="/snote/assets/js/248.dbe63ed3.js"><link rel="prefetch" href="/snote/assets/js/249.fe2ef438.js"><link rel="prefetch" href="/snote/assets/js/25.63eaaf87.js"><link rel="prefetch" href="/snote/assets/js/250.1549a447.js"><link rel="prefetch" href="/snote/assets/js/251.db65678e.js"><link rel="prefetch" href="/snote/assets/js/252.e6b08a3c.js"><link rel="prefetch" href="/snote/assets/js/253.c60596c3.js"><link rel="prefetch" href="/snote/assets/js/254.cc49031e.js"><link rel="prefetch" href="/snote/assets/js/255.815e4537.js"><link rel="prefetch" href="/snote/assets/js/256.497750f6.js"><link rel="prefetch" href="/snote/assets/js/257.fd4a510f.js"><link rel="prefetch" href="/snote/assets/js/258.e1d62930.js"><link rel="prefetch" href="/snote/assets/js/259.42dad2e9.js"><link rel="prefetch" href="/snote/assets/js/26.70fb8da2.js"><link rel="prefetch" href="/snote/assets/js/260.a826fe7a.js"><link rel="prefetch" href="/snote/assets/js/261.220b0562.js"><link rel="prefetch" href="/snote/assets/js/262.df8af257.js"><link rel="prefetch" href="/snote/assets/js/263.e8218053.js"><link rel="prefetch" href="/snote/assets/js/264.88e08802.js"><link rel="prefetch" href="/snote/assets/js/265.f936d179.js"><link rel="prefetch" href="/snote/assets/js/266.a05c3940.js"><link rel="prefetch" href="/snote/assets/js/267.a7a75213.js"><link rel="prefetch" href="/snote/assets/js/268.33bfc335.js"><link rel="prefetch" href="/snote/assets/js/269.6e869285.js"><link rel="prefetch" href="/snote/assets/js/27.1f5790a0.js"><link rel="prefetch" href="/snote/assets/js/270.6ffca78a.js"><link rel="prefetch" href="/snote/assets/js/271.ac1fb068.js"><link rel="prefetch" href="/snote/assets/js/272.13e569b2.js"><link rel="prefetch" href="/snote/assets/js/273.2ce712d9.js"><link rel="prefetch" href="/snote/assets/js/274.d66f80d4.js"><link rel="prefetch" href="/snote/assets/js/275.de571766.js"><link rel="prefetch" href="/snote/assets/js/276.f3b29147.js"><link rel="prefetch" href="/snote/assets/js/277.b76178a1.js"><link rel="prefetch" href="/snote/assets/js/278.56362141.js"><link rel="prefetch" href="/snote/assets/js/279.25b22240.js"><link rel="prefetch" href="/snote/assets/js/28.5ef486f6.js"><link rel="prefetch" href="/snote/assets/js/280.0028cb8e.js"><link rel="prefetch" href="/snote/assets/js/281.19110b74.js"><link rel="prefetch" href="/snote/assets/js/282.92106866.js"><link rel="prefetch" href="/snote/assets/js/283.986ffec9.js"><link rel="prefetch" href="/snote/assets/js/284.c24532a5.js"><link rel="prefetch" href="/snote/assets/js/285.f53857b8.js"><link rel="prefetch" href="/snote/assets/js/286.b1f41b19.js"><link rel="prefetch" href="/snote/assets/js/287.b8c0d28b.js"><link rel="prefetch" href="/snote/assets/js/288.77b2860b.js"><link rel="prefetch" href="/snote/assets/js/289.d0a5c87b.js"><link rel="prefetch" href="/snote/assets/js/29.c1aa7b05.js"><link rel="prefetch" href="/snote/assets/js/290.a2b5aa3a.js"><link rel="prefetch" href="/snote/assets/js/291.8d3fa552.js"><link rel="prefetch" href="/snote/assets/js/292.ec03d81e.js"><link rel="prefetch" href="/snote/assets/js/293.98696bcb.js"><link rel="prefetch" href="/snote/assets/js/294.fe6857c9.js"><link rel="prefetch" href="/snote/assets/js/295.618179f3.js"><link rel="prefetch" href="/snote/assets/js/296.9ef57bc6.js"><link rel="prefetch" href="/snote/assets/js/297.f252aac1.js"><link rel="prefetch" href="/snote/assets/js/298.5e1c84a5.js"><link rel="prefetch" href="/snote/assets/js/299.309fb772.js"><link rel="prefetch" href="/snote/assets/js/3.c1ff7317.js"><link rel="prefetch" href="/snote/assets/js/30.4bb90738.js"><link rel="prefetch" href="/snote/assets/js/300.4e4d323e.js"><link rel="prefetch" href="/snote/assets/js/301.3a31e029.js"><link rel="prefetch" href="/snote/assets/js/302.d5214ae9.js"><link rel="prefetch" href="/snote/assets/js/303.df064523.js"><link rel="prefetch" href="/snote/assets/js/304.f9eb1bf7.js"><link rel="prefetch" href="/snote/assets/js/305.4d6612e0.js"><link rel="prefetch" href="/snote/assets/js/306.8acfffc4.js"><link rel="prefetch" href="/snote/assets/js/307.ba54d579.js"><link rel="prefetch" href="/snote/assets/js/308.d4473266.js"><link rel="prefetch" href="/snote/assets/js/309.a76d6b29.js"><link rel="prefetch" href="/snote/assets/js/31.b1ee51e2.js"><link rel="prefetch" href="/snote/assets/js/310.291ca423.js"><link rel="prefetch" href="/snote/assets/js/311.39a60e61.js"><link rel="prefetch" href="/snote/assets/js/312.36aa70af.js"><link rel="prefetch" href="/snote/assets/js/313.68c1ba97.js"><link rel="prefetch" href="/snote/assets/js/314.65cd2f18.js"><link rel="prefetch" href="/snote/assets/js/315.36d2f5b8.js"><link rel="prefetch" href="/snote/assets/js/316.7fc1ad1f.js"><link rel="prefetch" href="/snote/assets/js/317.aef9d07a.js"><link rel="prefetch" href="/snote/assets/js/318.783cd3bc.js"><link rel="prefetch" href="/snote/assets/js/319.e7f7bb74.js"><link rel="prefetch" href="/snote/assets/js/32.415bb67d.js"><link rel="prefetch" href="/snote/assets/js/320.4858112b.js"><link rel="prefetch" href="/snote/assets/js/321.5c2d406d.js"><link rel="prefetch" href="/snote/assets/js/322.0ca7c95d.js"><link rel="prefetch" href="/snote/assets/js/323.2d6fbc1c.js"><link rel="prefetch" href="/snote/assets/js/324.982fef51.js"><link rel="prefetch" href="/snote/assets/js/325.c244b4d2.js"><link rel="prefetch" href="/snote/assets/js/326.dbf8ace0.js"><link rel="prefetch" href="/snote/assets/js/327.8f2c1ebe.js"><link rel="prefetch" href="/snote/assets/js/328.e8eb5fa6.js"><link rel="prefetch" href="/snote/assets/js/329.162c0bd5.js"><link rel="prefetch" href="/snote/assets/js/33.35a98693.js"><link rel="prefetch" href="/snote/assets/js/330.5c6cafc3.js"><link rel="prefetch" href="/snote/assets/js/331.27832ebd.js"><link rel="prefetch" href="/snote/assets/js/332.d924873c.js"><link rel="prefetch" href="/snote/assets/js/333.2a25fce8.js"><link rel="prefetch" href="/snote/assets/js/334.fc1972ba.js"><link rel="prefetch" href="/snote/assets/js/335.35bf5bc7.js"><link rel="prefetch" href="/snote/assets/js/336.14b855aa.js"><link rel="prefetch" href="/snote/assets/js/337.462cd198.js"><link rel="prefetch" href="/snote/assets/js/338.a4ada162.js"><link rel="prefetch" href="/snote/assets/js/339.cdccddf6.js"><link rel="prefetch" href="/snote/assets/js/34.a375d18a.js"><link rel="prefetch" href="/snote/assets/js/340.4ef3435a.js"><link rel="prefetch" href="/snote/assets/js/341.14e6591a.js"><link rel="prefetch" href="/snote/assets/js/342.d944b8a6.js"><link rel="prefetch" href="/snote/assets/js/343.5e6e1814.js"><link rel="prefetch" href="/snote/assets/js/344.60707e61.js"><link rel="prefetch" href="/snote/assets/js/345.25b2d6d9.js"><link rel="prefetch" href="/snote/assets/js/346.fe7a8f22.js"><link rel="prefetch" href="/snote/assets/js/347.8dc03771.js"><link rel="prefetch" href="/snote/assets/js/348.92e83ff5.js"><link rel="prefetch" href="/snote/assets/js/349.2f717ea8.js"><link rel="prefetch" href="/snote/assets/js/35.175c5eb9.js"><link rel="prefetch" href="/snote/assets/js/350.5d843d49.js"><link rel="prefetch" href="/snote/assets/js/351.07f15a6d.js"><link rel="prefetch" href="/snote/assets/js/352.a931cc83.js"><link rel="prefetch" href="/snote/assets/js/353.04a30c0b.js"><link rel="prefetch" href="/snote/assets/js/354.a7adb748.js"><link rel="prefetch" href="/snote/assets/js/355.ed562ee8.js"><link rel="prefetch" href="/snote/assets/js/356.c42cbb30.js"><link rel="prefetch" href="/snote/assets/js/357.30d3bca7.js"><link rel="prefetch" href="/snote/assets/js/358.8e4e9d5d.js"><link rel="prefetch" href="/snote/assets/js/359.b907912b.js"><link rel="prefetch" href="/snote/assets/js/36.a16c85c6.js"><link rel="prefetch" href="/snote/assets/js/360.5901ac19.js"><link rel="prefetch" href="/snote/assets/js/361.480746e5.js"><link rel="prefetch" href="/snote/assets/js/362.ae2e8c50.js"><link rel="prefetch" href="/snote/assets/js/363.f4fd2d93.js"><link rel="prefetch" href="/snote/assets/js/364.71efc99c.js"><link rel="prefetch" href="/snote/assets/js/365.01f1bbac.js"><link rel="prefetch" href="/snote/assets/js/366.ce846e06.js"><link rel="prefetch" href="/snote/assets/js/367.d4be3b41.js"><link rel="prefetch" href="/snote/assets/js/368.5dfde021.js"><link rel="prefetch" href="/snote/assets/js/369.4fc6a3c2.js"><link rel="prefetch" href="/snote/assets/js/37.9518c0e3.js"><link rel="prefetch" href="/snote/assets/js/370.0beee867.js"><link rel="prefetch" href="/snote/assets/js/371.93f76ea7.js"><link rel="prefetch" href="/snote/assets/js/372.3516675d.js"><link rel="prefetch" href="/snote/assets/js/373.77a2d6fe.js"><link rel="prefetch" href="/snote/assets/js/374.4df21af3.js"><link rel="prefetch" href="/snote/assets/js/375.2b0bfaf9.js"><link rel="prefetch" href="/snote/assets/js/376.1ede8405.js"><link rel="prefetch" href="/snote/assets/js/377.6ebc80ca.js"><link rel="prefetch" href="/snote/assets/js/378.10b8ed94.js"><link rel="prefetch" href="/snote/assets/js/379.bf89586c.js"><link rel="prefetch" href="/snote/assets/js/38.87f9adbc.js"><link rel="prefetch" href="/snote/assets/js/380.0858af5c.js"><link rel="prefetch" href="/snote/assets/js/381.f5f831bc.js"><link rel="prefetch" href="/snote/assets/js/382.6f2a95ff.js"><link rel="prefetch" href="/snote/assets/js/383.0f3a65fc.js"><link rel="prefetch" href="/snote/assets/js/384.a5c6d41a.js"><link rel="prefetch" href="/snote/assets/js/385.3a233d1e.js"><link rel="prefetch" href="/snote/assets/js/39.596a81f1.js"><link rel="prefetch" href="/snote/assets/js/4.19456bac.js"><link rel="prefetch" href="/snote/assets/js/40.0bebee27.js"><link rel="prefetch" href="/snote/assets/js/41.119caf45.js"><link rel="prefetch" href="/snote/assets/js/42.07dbe829.js"><link rel="prefetch" href="/snote/assets/js/43.534b6876.js"><link rel="prefetch" href="/snote/assets/js/44.109672d9.js"><link rel="prefetch" href="/snote/assets/js/45.3293f327.js"><link rel="prefetch" href="/snote/assets/js/46.71975505.js"><link rel="prefetch" href="/snote/assets/js/47.403a111f.js"><link rel="prefetch" href="/snote/assets/js/48.31adab5a.js"><link rel="prefetch" href="/snote/assets/js/49.d7cdd50e.js"><link rel="prefetch" href="/snote/assets/js/50.473b8594.js"><link rel="prefetch" href="/snote/assets/js/51.f397ad1e.js"><link rel="prefetch" href="/snote/assets/js/52.d5c73839.js"><link rel="prefetch" href="/snote/assets/js/53.7ff84687.js"><link rel="prefetch" href="/snote/assets/js/54.dfe7baf8.js"><link rel="prefetch" href="/snote/assets/js/55.45ce9dfe.js"><link rel="prefetch" href="/snote/assets/js/56.99f83db0.js"><link rel="prefetch" href="/snote/assets/js/57.041b34e7.js"><link rel="prefetch" href="/snote/assets/js/58.eb1dc55f.js"><link rel="prefetch" href="/snote/assets/js/59.07e58102.js"><link rel="prefetch" href="/snote/assets/js/6.f56a3b14.js"><link rel="prefetch" href="/snote/assets/js/60.401104f8.js"><link rel="prefetch" href="/snote/assets/js/61.1f344f74.js"><link rel="prefetch" href="/snote/assets/js/62.2458973b.js"><link rel="prefetch" href="/snote/assets/js/63.3935dddc.js"><link rel="prefetch" href="/snote/assets/js/64.7ba454e7.js"><link rel="prefetch" href="/snote/assets/js/65.78e00c42.js"><link rel="prefetch" href="/snote/assets/js/66.a5035491.js"><link rel="prefetch" href="/snote/assets/js/67.d4a88243.js"><link rel="prefetch" href="/snote/assets/js/68.e5ea69d1.js"><link rel="prefetch" href="/snote/assets/js/69.0d61549e.js"><link rel="prefetch" href="/snote/assets/js/7.fef180a0.js"><link rel="prefetch" href="/snote/assets/js/70.7ebe43d7.js"><link rel="prefetch" href="/snote/assets/js/71.e9b48c2a.js"><link rel="prefetch" href="/snote/assets/js/72.fea6f5d4.js"><link rel="prefetch" href="/snote/assets/js/73.2eb66693.js"><link rel="prefetch" href="/snote/assets/js/74.bb5a4f82.js"><link rel="prefetch" href="/snote/assets/js/75.f281d576.js"><link rel="prefetch" href="/snote/assets/js/76.8d8d7aee.js"><link rel="prefetch" href="/snote/assets/js/78.65f8cc94.js"><link rel="prefetch" href="/snote/assets/js/79.bcc870ee.js"><link rel="prefetch" href="/snote/assets/js/8.c4d1827a.js"><link rel="prefetch" href="/snote/assets/js/80.7f9e4555.js"><link rel="prefetch" href="/snote/assets/js/81.96ec0bed.js"><link rel="prefetch" href="/snote/assets/js/82.070dd41d.js"><link rel="prefetch" href="/snote/assets/js/83.ebe27694.js"><link rel="prefetch" href="/snote/assets/js/84.75491c26.js"><link rel="prefetch" href="/snote/assets/js/85.714e47e1.js"><link rel="prefetch" href="/snote/assets/js/86.9d78fc9e.js"><link rel="prefetch" href="/snote/assets/js/87.08bb0110.js"><link rel="prefetch" href="/snote/assets/js/88.c6532cef.js"><link rel="prefetch" href="/snote/assets/js/89.92eaf325.js"><link rel="prefetch" href="/snote/assets/js/9.05800a53.js"><link rel="prefetch" href="/snote/assets/js/90.77ebb53b.js"><link rel="prefetch" href="/snote/assets/js/91.6c2753e5.js"><link rel="prefetch" href="/snote/assets/js/92.8ffec3d5.js"><link rel="prefetch" href="/snote/assets/js/93.f2a2ebcd.js"><link rel="prefetch" href="/snote/assets/js/94.ce688d63.js"><link rel="prefetch" href="/snote/assets/js/95.6f20e8a9.js"><link rel="prefetch" href="/snote/assets/js/96.da6970c0.js"><link rel="prefetch" href="/snote/assets/js/97.0ee9c63a.js"><link rel="prefetch" href="/snote/assets/js/98.0cd42ce4.js"><link rel="prefetch" href="/snote/assets/js/99.748348db.js">
    <link rel="stylesheet" href="/snote/assets/css/0.styles.733b32e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>snote</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>study note</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><!---->
            
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/snote/" class="home-link router-link-active"><!----> <span class="site-name">snote</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/snote/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/snote/categories/maven/" class="nav-link"><i class="undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/dev-tools/" class="nav-link"><i class="undefined"></i>
  dev-tools
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/idea/" class="nav-link"><i class="undefined"></i>
  idea
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/java-basic/" class="nav-link"><i class="undefined"></i>
  java-basic
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/java-concurrency/" class="nav-link"><i class="undefined"></i>
  java-concurrency
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/jvm/" class="nav-link"><i class="undefined"></i>
  jvm
</a></li></ul></div></div><div class="nav-item"><a href="/snote/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/snote/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><!----> <!----> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>138</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>6</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6><li class="social-item" data-v-828910c6><i class="iconfont reco-github" style="color:#f47e60;" data-v-828910c6></i></li></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/snote/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/snote/categories/maven/" class="nav-link"><i class="undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/dev-tools/" class="nav-link"><i class="undefined"></i>
  dev-tools
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/idea/" class="nav-link"><i class="undefined"></i>
  idea
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/java-basic/" class="nav-link"><i class="undefined"></i>
  java-basic
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/java-concurrency/" class="nav-link"><i class="undefined"></i>
  java-concurrency
</a></li><li class="dropdown-item"><!----> <a href="/snote/categories/jvm/" class="nav-link"><i class="undefined"></i>
  jvm
</a></li></ul></div></div><div class="nav-item"><a href="/snote/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/snote/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>02 Spring Cloud Alibaba</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/00_spring-cloud-alibabazi-yuan-tie.html" class="sidebar-link">/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/00_spring-cloud-alibabazi-yuan-tie.html</a></li><li><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/01_spring-cloud-alibabagai-shu.html" class="sidebar-link">/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/01_spring-cloud-alibabagai-shu.html</a></li><li><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/02_nacosru-men-shi-li.html" class="sidebar-link">Nacos 入门实例</a></li><li><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelru-men-shi-li.html" class="sidebar-link">Sentinel入门实例</a></li><li><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html" aria-current="page" class="active sidebar-link">Sentinel源码分析</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc></h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><!---->
            
          <!---->
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">Sentinel源码分析</h1> <div data-v-1ff7123e><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="sentinel源码分析"><a href="#sentinel源码分析" class="header-anchor">#</a> Sentinel源码分析</h1> <p>[toc]</p> <p>本文转自：</p> <blockquote><ul><li><a href="https://github.com/all4you/sentinel-tutorial/blob/master/sentinel-principle/sentinel-slot-chain/sentinel-slot-chain.md" target="_blank" rel="noopener noreferrer">Sentinel原理：调用链_all4you/sentinel-tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.javadoop.com/post/sentinel" target="_blank" rel="noopener noreferrer">阿里 Sentinel 源码解析_javadoop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <h2 id="资源合辑"><a href="#资源合辑" class="header-anchor">#</a> 资源合辑</h2> <blockquote><ul><li><a href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener noreferrer">Wiki_Sentinel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/alibaba/Sentinel/blob/master/doc/awesome-sentinel.md" target="_blank" rel="noopener noreferrer">Awesome Sentinel_sentinel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <h2 id="推荐阅读"><a href="#推荐阅读" class="header-anchor">#</a> 推荐阅读</h2> <blockquote><ul><li><a href="https://github.com/all4you/sentinel-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/all4you/sentinel-tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.javadoop.com/post/sentinel" target="_blank" rel="noopener noreferrer">阿里 Sentinel 源码解析_javadoop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <h2 id="一、概览"><a href="#一、概览" class="header-anchor">#</a> 一、概览</h2> <p>在 Sentinel 里面，所有的资源都对应一个资源名称（<code>resourceName</code>），每次资源调用都会创建一个 <code>Entry</code> 对象。Entry 可以通过对主流框架的适配自动创建，也可以通过注解的方式或调用 <code>SphU</code> API 显式创建。Entry 创建的时候，同时也会创建一系列功能插槽（slot chain），这些插槽有不同的职责，例如:</p> <ul><li><code>NodeSelectorSlot</code> 负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级；</li> <li><code>ClusterBuilderSlot</code> 则用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等等，这些信息将用作为多维度限流，降级的依据；</li> <li><code>StatisticSlot</code> 则用于记录、统计不同纬度的 runtime 指标监控信息；</li> <li><code>FlowSlot</code> 则用于根据预设的限流规则以及前面 slot 统计的状态，来进行流量控制；</li> <li><code>AuthoritySlot</code> 则根据配置的黑白名单和调用来源信息，来做黑白名单控制；</li> <li><code>DegradeSlot</code> 则通过统计信息以及预设的规则，来做熔断降级；</li> <li><code>SystemSlot</code> 则通过系统的状态，例如 load1 等，来控制总的入口流量；</li></ul> <p>总体的框架如下:</p> <p><img src="/snote/assets/img/slots.e1406023.gif" alt="img"></p> <h2 id="二、请求响应概览"><a href="#二、请求响应概览" class="header-anchor">#</a> 二、请求响应概览</h2> <h3 id="_1-时序图"><a href="#_1-时序图" class="header-anchor">#</a> 1. 时序图</h3> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1046px" preserveAspectRatio="none" version="1.1" viewBox="0 0 1287 1046" width="1287px" zoomAndPan="magnify" style="width:1287px;height:1046px;"><defs><filter height="300%" id="fmfvlna2b2r4o" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="924.0313" width="10" x="187" y="71.9609" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="740.625" width="10" x="348" y="102.3125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="696.2734" width="10" x="423" y="132.6641" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFBBBB" filter="url(#fmfvlna2b2r4o)" height="608.5703" width="10" x="559" y="206.3672" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="69.3516" width="10" x="564" y="289.0703" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="14" width="10" x="696" y="236.7188" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="14" width="10" x="814.5" y="324.4219" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="405.1641" width="10" x="962" y="395.7734" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFBBBB" filter="url(#fmfvlna2b2r4o)" height="360.8125" width="10" x="1113" y="426.125" style="stroke:#A80036;stroke-width:1.0;"></rect><line x1="191.5" x2="191.5" y1="39.6094" y2="1004.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="353" x2="353" y1="39.6094" y2="1004.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="428" x2="428" y1="39.6094" y2="1004.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="563.5" x2="563.5" y1="39.6094" y2="1004.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="700.5" x2="700.5" y1="39.6094" y2="1004.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="819.5" x2="819.5" y1="39.6094" y2="1004.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="966.5" x2="966.5" y1="39.6094" y2="1004.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><line x1="1118" x2="1118" y1="39.6094" y2="1004.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;"></line><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="169" x="105.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="155" x="112.5" y="24.5332">SentinelResourceAspect</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="169" x="105.5" y="1003.9922" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="155" x="112.5" y="1025.5254">SentinelResourceAspect</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="48" x="327" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="334" y="24.5332">SphU</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="48" x="327" y="1003.9922" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="334" y="1025.5254">SphU</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="38" x="407" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="24" x="414" y="24.5332">Env</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="38" x="407" y="1003.9922" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="24" x="414" y="1025.5254">Env</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="53" x="535.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="542.5" y="24.5332">CtSph</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="53" x="535.5" y="1003.9922" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="542.5" y="1025.5254">CtSph</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="81" x="658.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="665.5" y="24.5332">ContextUtil</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="81" x="658.5" y="1003.9922" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="665.5" y="1025.5254">ContextUtil</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="128" x="753.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="760.5" y="24.5332">SlotChainProvider</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="128" x="753.5" y="1003.9922" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="760.5" y="1025.5254">SlotChainProvider</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="139" x="895.5" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="902.5" y="24.5332">ProcessorSlotChain</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="139" x="895.5" y="1003.9922" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="902.5" y="1025.5254">ProcessorSlotChain</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="102" x="1065" y="3" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="1072" y="24.5332">ProcessorSlot</text><rect fill="#FEFECE" filter="url(#fmfvlna2b2r4o)" height="31.6094" width="102" x="1065" y="1003.9922" style="stroke:#A80036;stroke-width:1.5;"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="1072" y="1025.5254">ProcessorSlot</text><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="924.0313" width="10" x="187" y="71.9609" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="740.625" width="10" x="348" y="102.3125" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="696.2734" width="10" x="423" y="132.6641" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFBBBB" filter="url(#fmfvlna2b2r4o)" height="608.5703" width="10" x="559" y="206.3672" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="69.3516" width="10" x="564" y="289.0703" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="14" width="10" x="696" y="236.7188" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="14" width="10" x="814.5" y="324.4219" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFFFFF" filter="url(#fmfvlna2b2r4o)" height="405.1641" width="10" x="962" y="395.7734" style="stroke:#A80036;stroke-width:1.0;"></rect><rect fill="#FFBBBB" filter="url(#fmfvlna2b2r4o)" height="360.8125" width="10" x="1113" y="426.125" style="stroke:#A80036;stroke-width:1.0;"></rect><polygon fill="#A80036" points="175,67.9609,185,71.9609,175,75.9609,179,71.9609" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="3" x2="181" y1="71.9609" y2="71.9609" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="10" y="67.1045">invokeResourceWithSentinel</text><polygon fill="#A80036" points="336,98.3125,346,102.3125,336,106.3125,340,102.3125" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="197" x2="342" y1="102.3125" y2="102.3125" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="204" y="97.4561">entry</text><polygon fill="#A80036" points="411,128.6641,421,132.6641,411,136.6641,415,132.6641" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="358" x2="417" y1="132.6641" y2="132.6641" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="365" y="127.8076">Env.sph</text><line x1="433" x2="475" y1="163.0156" y2="163.0156" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="475" x2="475" y1="163.0156" y2="176.0156" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="434" x2="475" y1="176.0156" y2="176.0156" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="444,172.0156,434,176.0156,444,180.0156,440,176.0156" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="440" y="158.1592">InitExecutor.doInit()</text><polygon fill="#A80036" points="547,202.3672,557,206.3672,547,210.3672,551,206.3672" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="433" x2="553" y1="206.3672" y2="206.3672" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="440" y="201.5107">entryWithPriority()</text><polygon fill="#A80036" points="684,232.7188,694,236.7188,684,240.7188,688,236.7188" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="569" x2="690" y1="236.7188" y2="236.7188" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="576" y="231.8623">getContext()</text><polygon fill="#A80036" points="580,246.7188,570,250.7188,580,254.7188,576,250.7188" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="574" x2="700" y1="250.7188" y2="250.7188" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="569" x2="616" y1="276.0703" y2="276.0703" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="616" x2="616" y1="276.0703" y2="289.0703" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="575" x2="616" y1="289.0703" y2="289.0703" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="585,285.0703,575,289.0703,585,293.0703,581,289.0703" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="581" y="271.2139">lookProcessChain()</text><polygon fill="#A80036" points="802.5,320.4219,812.5,324.4219,802.5,328.4219,806.5,324.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="574" x2="808.5" y1="324.4219" y2="324.4219" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="581" y="319.5654">newSlotChain()</text><polygon fill="#A80036" points="585,334.4219,575,338.4219,585,342.4219,581,338.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="579" x2="818.5" y1="338.4219" y2="338.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="574" x2="616" y1="357.4219" y2="357.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="616" x2="616" y1="357.4219" y2="370.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="569" x2="616" y1="370.4219" y2="370.4219" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="579,366.4219,569,370.4219,579,374.4219,575,370.4219" style="stroke:#A80036;stroke-width:1.0;"></polygon><polygon fill="#A80036" points="950,391.7734,960,395.7734,950,399.7734,954,395.7734" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="569" x2="956" y1="395.7734" y2="395.7734" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="576" y="390.917">entry()</text><polygon fill="#A80036" points="1101,422.125,1111,426.125,1101,430.125,1105,426.125" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="972" x2="1107" y1="426.125" y2="426.125" style="stroke:#A80036;stroke-width:1.0;"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="979" y="421.2686">next.transformEntry()</text><line x1="1123" x2="1165" y1="456.4766" y2="456.4766" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1165" x2="1165" y1="456.4766" y2="469.4766" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1124" x2="1165" y1="469.4766" y2="469.4766" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1134,465.4766,1124,469.4766,1134,473.4766,1130,469.4766" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="1130" y="451.6201">NodeSelectorSlot.entry()</text><line x1="1123" x2="1165" y1="499.8281" y2="499.8281" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1165" x2="1165" y1="499.8281" y2="512.8281" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1124" x2="1165" y1="512.8281" y2="512.8281" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1134,508.8281,1124,512.8281,1134,516.8281,1130,512.8281" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1130" y="494.9717">ClusterBuilderSlot.entry()</text><line x1="1123" x2="1165" y1="543.1797" y2="543.1797" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1165" x2="1165" y1="543.1797" y2="556.1797" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1124" x2="1165" y1="556.1797" y2="556.1797" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1134,552.1797,1124,556.1797,1134,560.1797,1130,556.1797" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="1130" y="538.3232">LogSlot.entry()</text><line x1="1123" x2="1165" y1="586.5313" y2="586.5313" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1165" x2="1165" y1="586.5313" y2="599.5313" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1124" x2="1165" y1="599.5313" y2="599.5313" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1134,595.5313,1124,599.5313,1134,603.5313,1130,599.5313" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="1130" y="581.6748">StatisticSlot.entry()</text><line x1="1123" x2="1165" y1="629.8828" y2="629.8828" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1165" x2="1165" y1="629.8828" y2="642.8828" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1124" x2="1165" y1="642.8828" y2="642.8828" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1134,638.8828,1124,642.8828,1134,646.8828,1130,642.8828" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1130" y="625.0264">AuthoritySlot.entry()</text><line x1="1123" x2="1165" y1="673.2344" y2="673.2344" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1165" x2="1165" y1="673.2344" y2="686.2344" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1124" x2="1165" y1="686.2344" y2="686.2344" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1134,682.2344,1124,686.2344,1134,690.2344,1130,686.2344" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1130" y="668.3779">SystemSlot.entry()</text><line x1="1123" x2="1165" y1="716.5859" y2="716.5859" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1165" x2="1165" y1="716.5859" y2="729.5859" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1124" x2="1165" y1="729.5859" y2="729.5859" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1134,725.5859,1124,729.5859,1134,733.5859,1130,729.5859" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="1130" y="711.7295">FlowSlot.entry()</text><line x1="1123" x2="1165" y1="759.9375" y2="759.9375" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1165" x2="1165" y1="759.9375" y2="772.9375" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="1124" x2="1165" y1="772.9375" y2="772.9375" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="1134,768.9375,1124,772.9375,1134,776.9375,1130,772.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="1130" y="755.0811">DegradeSlot.entry()</text><polygon fill="#A80036" points="983,782.9375,973,786.9375,983,790.9375,979,786.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="977" x2="1117" y1="786.9375" y2="786.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="580,796.9375,570,800.9375,580,804.9375,576,800.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="574" x2="966" y1="800.9375" y2="800.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="444,810.9375,434,814.9375,444,818.9375,440,814.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="438" x2="563" y1="814.9375" y2="814.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="369,824.9375,359,828.9375,369,832.9375,365,828.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="363" x2="427" y1="828.9375" y2="828.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><polygon fill="#A80036" points="208,838.9375,198,842.9375,208,846.9375,204,842.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="202" x2="352" y1="842.9375" y2="842.9375" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line><line x1="197" x2="239" y1="873.2891" y2="873.2891" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="239" x2="239" y1="873.2891" y2="886.2891" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="198" x2="239" y1="886.2891" y2="886.2891" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="208,882.2891,198,886.2891,208,890.2891,204,886.2891" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="204" y="868.4326">pjp.proceed()</text><line x1="197" x2="239" y1="916.6406" y2="916.6406" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="239" x2="239" y1="916.6406" y2="929.6406" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="198" x2="239" y1="929.6406" y2="929.6406" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="208,925.6406,198,929.6406,208,933.6406,204,929.6406" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="204" y="911.7842">handleBlockException()</text><line x1="197" x2="239" y1="959.9922" y2="959.9922" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="239" x2="239" y1="959.9922" y2="972.9922" style="stroke:#A80036;stroke-width:1.0;"></line><line x1="198" x2="239" y1="972.9922" y2="972.9922" style="stroke:#A80036;stroke-width:1.0;"></line><polygon fill="#A80036" points="208,968.9922,198,972.9922,208,976.9922,204,972.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="204" y="955.1357">handleFallback()</text><polygon fill="#A80036" points="14,982.9922,4,986.9922,14,990.9922,10,986.9922" style="stroke:#A80036;stroke-width:1.0;"></polygon><line x1="8" x2="186" y1="986.9922" y2="986.9922" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;"></line></g></svg><h3 id="_2-核心类图"><a href="#_2-核心类图" class="header-anchor">#</a> 2.核心类图</h3> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1250px" preserveAspectRatio="none" version="1.1" viewBox="0 0 1472 1250" width="1472px" zoomAndPan="magnify" style="width:1472px;height:1250px;"><defs><filter height="300%" id="fq83cxkatoz6r" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="SphResourceTypeSupport" width="177" x="60.5" y="532.5" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="75.5" cy="548.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M76.4531,545.1406 L76.4531,551.7969 L78.1719,551.7969 Q78.7813,551.7969 79.0469,552.0313 Q79.3125,552.2656 79.3125,552.6563 Q79.3125,553.0313 79.0469,553.2656 Q78.7813,553.5 78.1719,553.5 L73.0313,553.5 Q72.4219,553.5 72.1563,553.2656 Q71.8906,553.0313 71.8906,552.6406 Q71.8906,552.2656 72.1563,552.0313 Q72.4219,551.7969 73.0313,551.7969 L74.75,551.7969 L74.75,545.1406 L73.0313,545.1406 Q72.4219,545.1406 72.1563,544.9063 Q71.8906,544.6719 71.8906,544.2813 Q71.8906,543.9063 72.1563,543.6719 Q72.4219,543.4375 73.0313,543.4375 L78.1719,543.4375 Q78.7813,543.4375 79.0469,543.6719 Q79.3125,543.9063 79.3125,544.2813 Q79.3125,544.6719 79.0469,544.9063 Q78.7813,545.1406 78.1719,545.1406 L76.4531,545.1406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="145" x="89.5" y="553.4102">SphResourceTypeSupport</text><line x1="61.5" x2="236.5" y1="564.5" y2="564.5" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="61.5" x2="236.5" y1="572.5" y2="572.5" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="Sph" width="54" x="122" y="682" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="137" cy="698" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M137.9531,694.6406 L137.9531,701.2969 L139.6719,701.2969 Q140.2813,701.2969 140.5469,701.5313 Q140.8125,701.7656 140.8125,702.1563 Q140.8125,702.5313 140.5469,702.7656 Q140.2813,703 139.6719,703 L134.5313,703 Q133.9219,703 133.6563,702.7656 Q133.3906,702.5313 133.3906,702.1406 Q133.3906,701.7656 133.6563,701.5313 Q133.9219,701.2969 134.5313,701.2969 L136.25,701.2969 L136.25,694.6406 L134.5313,694.6406 Q133.9219,694.6406 133.6563,694.4063 Q133.3906,694.1719 133.3906,693.7813 Q133.3906,693.4063 133.6563,693.1719 Q133.9219,692.9375 134.5313,692.9375 L139.6719,692.9375 Q140.2813,692.9375 140.5469,693.1719 Q140.8125,693.4063 140.8125,693.7813 Q140.8125,694.1719 140.5469,694.4063 Q140.2813,694.6406 139.6719,694.6406 L137.9531,694.6406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="22" x="151" y="702.9102">Sph</text><line x1="123" x2="175" y1="714" y2="714" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="123" x2="175" y1="722" y2="722" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="61.8359" id="CtSph" width="286" x="6" y="797" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="127.75" cy="813" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M130.5156,808.875 Q130.6719,808.6563 130.8594,808.5469 Q131.0469,808.4375 131.2656,808.4375 Q131.6406,808.4375 131.875,808.6953 Q132.1094,808.9531 132.1094,809.5625 L132.1094,811.0156 Q132.1094,811.625 131.875,811.8906 Q131.6406,812.1563 131.2656,812.1563 Q130.9219,812.1563 130.7188,811.9531 Q130.5156,811.7656 130.4063,811.25 Q130.3594,810.8906 130.1719,810.7031 Q129.8438,810.3281 129.2344,810.1094 Q128.625,809.8906 128,809.8906 Q127.2344,809.8906 126.6016,810.2188 Q125.9688,810.5469 125.4766,811.2969 Q124.9844,812.0469 124.9844,813.0781 L124.9844,814.1719 Q124.9844,815.4063 125.875,816.2266 Q126.7656,817.0469 128.3594,817.0469 Q129.2969,817.0469 129.9531,816.7969 Q130.3438,816.6406 130.7656,816.2031 Q131.0313,815.9375 131.1797,815.8594 Q131.3281,815.7813 131.5313,815.7813 Q131.8594,815.7813 132.1172,816.0391 Q132.375,816.2969 132.375,816.6406 Q132.375,816.9844 132.0313,817.3906 Q131.5313,817.9688 130.7344,818.2969 Q129.6563,818.75 128.3594,818.75 Q126.8438,818.75 125.6406,818.125 Q124.6563,817.625 123.9688,816.5547 Q123.2813,815.4844 123.2813,814.2031 L123.2813,813.0469 Q123.2813,811.7188 123.8984,810.5703 Q124.5156,809.4219 125.6094,808.8047 Q126.7031,808.1875 127.9375,808.1875 Q128.6719,808.1875 129.3203,808.3516 Q129.9688,808.5156 130.5156,808.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="34" x="148.25" y="817.9102">CtSph</text><line x1="7" x2="291" y1="829" y2="829" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="274" x="12" y="844.4189">Map&lt;ResourceWrapper, ProcessorSlotChain&gt; chainMap;</text><line x1="7" x2="291" y1="850.8359" y2="850.8359" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#EE82EE" filter="url(#fq83cxkatoz6r)" height="89.5078" id="ResourceWrapper" width="132" x="1163" y="511.5" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1178" cy="527.5" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1180.1875,529.2656 L1176.0469,529.2656 L1175.625,530.2969 L1176.0469,530.2969 Q1176.6563,530.2969 1176.9219,530.5313 Q1177.1875,530.7656 1177.1875,531.1563 Q1177.1875,531.5313 1176.9219,531.7656 Q1176.6563,532 1176.0469,532 L1173.75,532 Q1173.1406,532 1172.8828,531.7656 Q1172.625,531.5313 1172.625,531.1406 Q1172.625,530.7656 1172.8984,530.5234 Q1173.1719,530.2813 1173.7969,530.2969 L1176.4688,523.6406 L1175.3594,523.6406 Q1174.75,523.6406 1174.4844,523.4063 Q1174.2188,523.1719 1174.2188,522.7813 Q1174.2188,522.4063 1174.4844,522.1719 Q1174.75,521.9375 1175.3594,521.9375 L1179.0313,521.9375 L1182.4219,530.2969 Q1183.0156,530.2969 1183.2031,530.4375 Q1183.5938,530.7031 1183.5938,531.1563 Q1183.5938,531.5313 1183.3359,531.7656 Q1183.0781,532 1182.4688,532 L1180.1719,532 Q1179.5625,532 1179.2969,531.7656 Q1179.0313,531.5313 1179.0313,531.1406 Q1179.0313,530.7656 1179.2969,530.5313 Q1179.5625,530.2969 1180.1719,530.2969 L1180.5938,530.2969 L1180.1875,529.2656 Z M1179.4688,527.5625 L1178.1094,524.1875 L1176.7344,527.5625 L1179.4688,527.5625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="100" x="1192" y="532.4102">ResourceWrapper</text><line x1="1164" x2="1294" y1="543.5" y2="543.5" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="60" x="1169" y="558.9189">String name;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="104" x="1169" y="572.7549">EntryType entryType;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="85" x="1169" y="586.5908">int resourceType;</text><line x1="1164" x2="1294" y1="593.0078" y2="593.0078" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="61.8359" id="MethodResourceWrapper" width="173" x="1281.5" y="675" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1296.5" cy="691" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1299.2656,686.875 Q1299.4219,686.6563 1299.6094,686.5469 Q1299.7969,686.4375 1300.0156,686.4375 Q1300.3906,686.4375 1300.625,686.6953 Q1300.8594,686.9531 1300.8594,687.5625 L1300.8594,689.0156 Q1300.8594,689.625 1300.625,689.8906 Q1300.3906,690.1563 1300.0156,690.1563 Q1299.6719,690.1563 1299.4688,689.9531 Q1299.2656,689.7656 1299.1563,689.25 Q1299.1094,688.8906 1298.9219,688.7031 Q1298.5938,688.3281 1297.9844,688.1094 Q1297.375,687.8906 1296.75,687.8906 Q1295.9844,687.8906 1295.3516,688.2188 Q1294.7188,688.5469 1294.2266,689.2969 Q1293.7344,690.0469 1293.7344,691.0781 L1293.7344,692.1719 Q1293.7344,693.4063 1294.625,694.2266 Q1295.5156,695.0469 1297.1094,695.0469 Q1298.0469,695.0469 1298.7031,694.7969 Q1299.0938,694.6406 1299.5156,694.2031 Q1299.7813,693.9375 1299.9297,693.8594 Q1300.0781,693.7813 1300.2813,693.7813 Q1300.6094,693.7813 1300.8672,694.0391 Q1301.125,694.2969 1301.125,694.6406 Q1301.125,694.9844 1300.7813,695.3906 Q1300.2813,695.9688 1299.4844,696.2969 Q1298.4063,696.75 1297.1094,696.75 Q1295.5938,696.75 1294.3906,696.125 Q1293.4063,695.625 1292.7188,694.5547 Q1292.0313,693.4844 1292.0313,692.2031 L1292.0313,691.0469 Q1292.0313,689.7188 1292.6484,688.5703 Q1293.2656,687.4219 1294.3594,686.8047 Q1295.4531,686.1875 1296.6875,686.1875 Q1297.4219,686.1875 1298.0703,686.3516 Q1298.7188,686.5156 1299.2656,686.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="141" x="1310.5" y="695.9102">MethodResourceWrapper</text><line x1="1282.5" x2="1453.5" y1="707" y2="707" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="76" x="1287.5" y="722.4189">Method method;</text><line x1="1282.5" x2="1453.5" y1="728.8359" y2="728.8359" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="StringResourceWrapper" width="165" x="1081.5" y="682" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1096.5" cy="698" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1099.2656,693.875 Q1099.4219,693.6563 1099.6094,693.5469 Q1099.7969,693.4375 1100.0156,693.4375 Q1100.3906,693.4375 1100.625,693.6953 Q1100.8594,693.9531 1100.8594,694.5625 L1100.8594,696.0156 Q1100.8594,696.625 1100.625,696.8906 Q1100.3906,697.1563 1100.0156,697.1563 Q1099.6719,697.1563 1099.4688,696.9531 Q1099.2656,696.7656 1099.1563,696.25 Q1099.1094,695.8906 1098.9219,695.7031 Q1098.5938,695.3281 1097.9844,695.1094 Q1097.375,694.8906 1096.75,694.8906 Q1095.9844,694.8906 1095.3516,695.2188 Q1094.7188,695.5469 1094.2266,696.2969 Q1093.7344,697.0469 1093.7344,698.0781 L1093.7344,699.1719 Q1093.7344,700.4063 1094.625,701.2266 Q1095.5156,702.0469 1097.1094,702.0469 Q1098.0469,702.0469 1098.7031,701.7969 Q1099.0938,701.6406 1099.5156,701.2031 Q1099.7813,700.9375 1099.9297,700.8594 Q1100.0781,700.7813 1100.2813,700.7813 Q1100.6094,700.7813 1100.8672,701.0391 Q1101.125,701.2969 1101.125,701.6406 Q1101.125,701.9844 1100.7813,702.3906 Q1100.2813,702.9688 1099.4844,703.2969 Q1098.4063,703.75 1097.1094,703.75 Q1095.5938,703.75 1094.3906,703.125 Q1093.4063,702.625 1092.7188,701.5547 Q1092.0313,700.4844 1092.0313,699.2031 L1092.0313,698.0469 Q1092.0313,696.7188 1092.6484,695.5703 Q1093.2656,694.4219 1094.3594,693.8047 Q1095.4531,693.1875 1096.6875,693.1875 Q1097.4219,693.1875 1098.0703,693.3516 Q1098.7188,693.5156 1099.2656,693.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="133" x="1110.5" y="702.9102">StringResourceWrapper</text><line x1="1082.5" x2="1245.5" y1="714" y2="714" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="1082.5" x2="1245.5" y1="722" y2="722" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="AutoCloseable" width="114" x="800" y="150.5" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="815" cy="166.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M815.9531,163.1406 L815.9531,169.7969 L817.6719,169.7969 Q818.2813,169.7969 818.5469,170.0313 Q818.8125,170.2656 818.8125,170.6563 Q818.8125,171.0313 818.5469,171.2656 Q818.2813,171.5 817.6719,171.5 L812.5313,171.5 Q811.9219,171.5 811.6563,171.2656 Q811.3906,171.0313 811.3906,170.6406 Q811.3906,170.2656 811.6563,170.0313 Q811.9219,169.7969 812.5313,169.7969 L814.25,169.7969 L814.25,163.1406 L812.5313,163.1406 Q811.9219,163.1406 811.6563,162.9063 Q811.3906,162.6719 811.3906,162.2813 Q811.3906,161.9063 811.6563,161.6719 Q811.9219,161.4375 812.5313,161.4375 L817.6719,161.4375 Q818.2813,161.4375 818.5469,161.6719 Q818.8125,161.9063 818.8125,162.2813 Q818.8125,162.6719 818.5469,162.9063 Q818.2813,163.1406 817.6719,163.1406 L815.9531,163.1406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="82" x="829" y="171.4102">AutoCloseable</text><line x1="801" x2="913" y1="182.5" y2="182.5" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="801" x2="913" y1="190.5" y2="190.5" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FF7F50" filter="url(#fq83cxkatoz6r)" height="144.8516" id="Entry" width="193" x="760.5" y="293" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="838.75" cy="309" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M840.9375,310.7656 L836.7969,310.7656 L836.375,311.7969 L836.7969,311.7969 Q837.4063,311.7969 837.6719,312.0313 Q837.9375,312.2656 837.9375,312.6563 Q837.9375,313.0313 837.6719,313.2656 Q837.4063,313.5 836.7969,313.5 L834.5,313.5 Q833.8906,313.5 833.6328,313.2656 Q833.375,313.0313 833.375,312.6406 Q833.375,312.2656 833.6484,312.0234 Q833.9219,311.7813 834.5469,311.7969 L837.2188,305.1406 L836.1094,305.1406 Q835.5,305.1406 835.2344,304.9063 Q834.9688,304.6719 834.9688,304.2813 Q834.9688,303.9063 835.2344,303.6719 Q835.5,303.4375 836.1094,303.4375 L839.7813,303.4375 L843.1719,311.7969 Q843.7656,311.7969 843.9531,311.9375 Q844.3438,312.2031 844.3438,312.6563 Q844.3438,313.0313 844.0859,313.2656 Q843.8281,313.5 843.2188,313.5 L840.9219,313.5 Q840.3125,313.5 840.0469,313.2656 Q839.7813,313.0313 839.7813,312.6406 Q839.7813,312.2656 840.0469,312.0313 Q840.3125,311.7969 840.9219,311.7969 L841.3438,311.7969 L840.9375,310.7656 Z M840.2188,309.0625 L838.8594,305.6875 L837.4844,309.0625 L840.2188,309.0625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="28" x="859.25" y="313.9102">Entry</text><line x1="761.5" x2="952.5" y1="325" y2="325" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="108" x="766.5" y="340.4189">long createTimestamp;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="120" x="766.5" y="354.2549">long completeTimestamp;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="72" x="766.5" y="368.0908">Node curNode;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="82" x="766.5" y="381.9268">Node originNode;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="82" x="766.5" y="395.7627">Throwable error;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="128" x="766.5" y="409.5986">BlockException blockError;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="181" x="766.5" y="423.4346">ResourceWrapper resourceWrapper;</text><line x1="761.5" x2="952.5" y1="429.8516" y2="429.8516" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="117.1797" id="CtEntry" width="276" x="705" y="498" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="819.25" cy="514" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M822.0156,509.875 Q822.1719,509.6563 822.3594,509.5469 Q822.5469,509.4375 822.7656,509.4375 Q823.1406,509.4375 823.375,509.6953 Q823.6094,509.9531 823.6094,510.5625 L823.6094,512.0156 Q823.6094,512.625 823.375,512.8906 Q823.1406,513.1563 822.7656,513.1563 Q822.4219,513.1563 822.2188,512.9531 Q822.0156,512.7656 821.9063,512.25 Q821.8594,511.8906 821.6719,511.7031 Q821.3438,511.3281 820.7344,511.1094 Q820.125,510.8906 819.5,510.8906 Q818.7344,510.8906 818.1016,511.2188 Q817.4688,511.5469 816.9766,512.2969 Q816.4844,513.0469 816.4844,514.0781 L816.4844,515.1719 Q816.4844,516.4063 817.375,517.2266 Q818.2656,518.0469 819.8594,518.0469 Q820.7969,518.0469 821.4531,517.7969 Q821.8438,517.6406 822.2656,517.2031 Q822.5313,516.9375 822.6797,516.8594 Q822.8281,516.7813 823.0313,516.7813 Q823.3594,516.7813 823.6172,517.0391 Q823.875,517.2969 823.875,517.6406 Q823.875,517.9844 823.5313,518.3906 Q823.0313,518.9688 822.2344,519.2969 Q821.1563,519.75 819.8594,519.75 Q818.3438,519.75 817.1406,519.125 Q816.1563,518.625 815.4688,517.5547 Q814.7813,516.4844 814.7813,515.2031 L814.7813,514.0469 Q814.7813,512.7188 815.3984,511.5703 Q816.0156,510.4219 817.1094,509.8047 Q818.2031,509.1875 819.4375,509.1875 Q820.1719,509.1875 820.8203,509.3516 Q821.4688,509.5156 822.0156,509.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="39" x="839.75" y="518.9102">CtEntry</text><line x1="706" x2="980" y1="530" y2="530" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="62" x="711" y="545.4189">Entry parent;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="53" x="711" y="559.2549">Entry child;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="189" x="711" y="573.0908">ProcessorSlot&lt;Object&gt; chain; // for exit</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="79" x="711" y="586.9268">Context context;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="264" x="711" y="600.7627">LinkedList&lt;BiConsumer&lt;Context, Entry&gt;&gt; exitHandlers;</text><line x1="706" x2="980" y1="607.1797" y2="607.1797" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="61.8359" id="AsyncEntry" width="122" x="859" y="675" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="887.95" cy="691" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M890.7156,686.875 Q890.8719,686.6563 891.0594,686.5469 Q891.2469,686.4375 891.4656,686.4375 Q891.8406,686.4375 892.075,686.6953 Q892.3094,686.9531 892.3094,687.5625 L892.3094,689.0156 Q892.3094,689.625 892.075,689.8906 Q891.8406,690.1563 891.4656,690.1563 Q891.1219,690.1563 890.9188,689.9531 Q890.7156,689.7656 890.6063,689.25 Q890.5594,688.8906 890.3719,688.7031 Q890.0438,688.3281 889.4344,688.1094 Q888.825,687.8906 888.2,687.8906 Q887.4344,687.8906 886.8016,688.2188 Q886.1688,688.5469 885.6766,689.2969 Q885.1844,690.0469 885.1844,691.0781 L885.1844,692.1719 Q885.1844,693.4063 886.075,694.2266 Q886.9656,695.0469 888.5594,695.0469 Q889.4969,695.0469 890.1531,694.7969 Q890.5438,694.6406 890.9656,694.2031 Q891.2313,693.9375 891.3797,693.8594 Q891.5281,693.7813 891.7313,693.7813 Q892.0594,693.7813 892.3172,694.0391 Q892.575,694.2969 892.575,694.6406 Q892.575,694.9844 892.2313,695.3906 Q891.7313,695.9688 890.9344,696.2969 Q889.8563,696.75 888.5594,696.75 Q887.0438,696.75 885.8406,696.125 Q884.8563,695.625 884.1688,694.5547 Q883.4813,693.4844 883.4813,692.2031 L883.4813,691.0469 Q883.4813,689.7188 884.0984,688.5703 Q884.7156,687.4219 885.8094,686.8047 Q886.9031,686.1875 888.1375,686.1875 Q888.8719,686.1875 889.5203,686.3516 Q890.1688,686.5156 890.7156,686.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="59" x="905.05" y="695.9102">AsyncEntry</text><line x1="860" x2="980" y1="707" y2="707" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="110" x="865" y="722.4189">Context asyncContext;</text><line x1="860" x2="980" y1="728.8359" y2="728.8359" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="103.3438" id="StatisticNode" width="158" x="1259" y="123" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1297.85" cy="139" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1300.6156,134.875 Q1300.7719,134.6563 1300.9594,134.5469 Q1301.1469,134.4375 1301.3656,134.4375 Q1301.7406,134.4375 1301.975,134.6953 Q1302.2094,134.9531 1302.2094,135.5625 L1302.2094,137.0156 Q1302.2094,137.625 1301.975,137.8906 Q1301.7406,138.1563 1301.3656,138.1563 Q1301.0219,138.1563 1300.8188,137.9531 Q1300.6156,137.7656 1300.5063,137.25 Q1300.4594,136.8906 1300.2719,136.7031 Q1299.9438,136.3281 1299.3344,136.1094 Q1298.725,135.8906 1298.1,135.8906 Q1297.3344,135.8906 1296.7016,136.2188 Q1296.0688,136.5469 1295.5766,137.2969 Q1295.0844,138.0469 1295.0844,139.0781 L1295.0844,140.1719 Q1295.0844,141.4063 1295.975,142.2266 Q1296.8656,143.0469 1298.4594,143.0469 Q1299.3969,143.0469 1300.0531,142.7969 Q1300.4438,142.6406 1300.8656,142.2031 Q1301.1313,141.9375 1301.2797,141.8594 Q1301.4281,141.7813 1301.6313,141.7813 Q1301.9594,141.7813 1302.2172,142.0391 Q1302.475,142.2969 1302.475,142.6406 Q1302.475,142.9844 1302.1313,143.3906 Q1301.6313,143.9688 1300.8344,144.2969 Q1299.7563,144.75 1298.4594,144.75 Q1296.9438,144.75 1295.7406,144.125 Q1294.7563,143.625 1294.0688,142.5547 Q1293.3813,141.4844 1293.3813,140.2031 L1293.3813,139.0469 Q1293.3813,137.7188 1293.9984,136.5703 Q1294.6156,135.4219 1295.7094,134.8047 Q1296.8031,134.1875 1298.0375,134.1875 Q1298.7719,134.1875 1299.4203,134.3516 Q1300.0688,134.5156 1300.6156,134.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="73" x="1317.15" y="143.9102">StatisticNode</text><line x1="1260" x2="1416" y1="155" y2="155" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="146" x="1265" y="170.4189">Metric rollingCounterInSecond;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="140" x="1265" y="184.2549">Metric rollingCounterInMinute;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="131" x="1265" y="198.0908">LongAdder curThreadNum;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="92" x="1265" y="211.9268">long lastFetchTime;</text><line x1="1260" x2="1416" y1="218.3438" y2="218.3438" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="Node" width="62" x="1307" y="8" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1322" cy="24" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1322.9531,20.6406 L1322.9531,27.2969 L1324.6719,27.2969 Q1325.2813,27.2969 1325.5469,27.5313 Q1325.8125,27.7656 1325.8125,28.1563 Q1325.8125,28.5313 1325.5469,28.7656 Q1325.2813,29 1324.6719,29 L1319.5313,29 Q1318.9219,29 1318.6563,28.7656 Q1318.3906,28.5313 1318.3906,28.1406 Q1318.3906,27.7656 1318.6563,27.5313 Q1318.9219,27.2969 1319.5313,27.2969 L1321.25,27.2969 L1321.25,20.6406 L1319.5313,20.6406 Q1318.9219,20.6406 1318.6563,20.4063 Q1318.3906,20.1719 1318.3906,19.7813 Q1318.3906,19.4063 1318.6563,19.1719 Q1318.9219,18.9375 1319.5313,18.9375 L1324.6719,18.9375 Q1325.2813,18.9375 1325.5469,19.1719 Q1325.8125,19.4063 1325.8125,19.7813 Q1325.8125,20.1719 1325.5469,20.4063 Q1325.2813,20.6406 1324.6719,20.6406 L1322.9531,20.6406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="30" x="1336" y="28.9102">Node</text><line x1="1308" x2="1368" y1="40" y2="40" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="1308" x2="1368" y1="48" y2="48" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#40E0D0" filter="url(#fq83cxkatoz6r)" height="89.5078" id="DefaultNode" width="135" x="1161.5" y="320.5" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1191.8" cy="336.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1194.5656,332.375 Q1194.7219,332.1563 1194.9094,332.0469 Q1195.0969,331.9375 1195.3156,331.9375 Q1195.6906,331.9375 1195.925,332.1953 Q1196.1594,332.4531 1196.1594,333.0625 L1196.1594,334.5156 Q1196.1594,335.125 1195.925,335.3906 Q1195.6906,335.6563 1195.3156,335.6563 Q1194.9719,335.6563 1194.7688,335.4531 Q1194.5656,335.2656 1194.4563,334.75 Q1194.4094,334.3906 1194.2219,334.2031 Q1193.8938,333.8281 1193.2844,333.6094 Q1192.675,333.3906 1192.05,333.3906 Q1191.2844,333.3906 1190.6516,333.7188 Q1190.0188,334.0469 1189.5266,334.7969 Q1189.0344,335.5469 1189.0344,336.5781 L1189.0344,337.6719 Q1189.0344,338.9063 1189.925,339.7266 Q1190.8156,340.5469 1192.4094,340.5469 Q1193.3469,340.5469 1194.0031,340.2969 Q1194.3938,340.1406 1194.8156,339.7031 Q1195.0813,339.4375 1195.2297,339.3594 Q1195.3781,339.2813 1195.5813,339.2813 Q1195.9094,339.2813 1196.1672,339.5391 Q1196.425,339.7969 1196.425,340.1406 Q1196.425,340.4844 1196.0813,340.8906 Q1195.5813,341.4688 1194.7844,341.7969 Q1193.7063,342.25 1192.4094,342.25 Q1190.8938,342.25 1189.6906,341.625 Q1188.7063,341.125 1188.0188,340.0547 Q1187.3313,338.9844 1187.3313,337.7031 L1187.3313,336.5469 Q1187.3313,335.2188 1187.9484,334.0703 Q1188.5656,332.9219 1189.6594,332.3047 Q1190.7531,331.6875 1191.9875,331.6875 Q1192.7219,331.6875 1193.3703,331.8516 Q1194.0188,332.0156 1194.5656,332.375 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="69" x="1209.2" y="341.4102">DefaultNode</text><line x1="1162.5" x2="1295.5" y1="352.5" y2="352.5" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="103" x="1167.5" y="367.9189">ResourceWrapper id;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="98" x="1167.5" y="381.7549">Set&lt;Node&gt; childList;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="123" x="1167.5" y="395.5908">ClusterNode clusterNode;</text><line x1="1162.5" x2="1295.5" y1="402.0078" y2="402.0078" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="EntranceNode" width="111" x="1016.5" y="532.5" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1031.5" cy="548.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1034.2656,544.375 Q1034.4219,544.1563 1034.6094,544.0469 Q1034.7969,543.9375 1035.0156,543.9375 Q1035.3906,543.9375 1035.625,544.1953 Q1035.8594,544.4531 1035.8594,545.0625 L1035.8594,546.5156 Q1035.8594,547.125 1035.625,547.3906 Q1035.3906,547.6563 1035.0156,547.6563 Q1034.6719,547.6563 1034.4688,547.4531 Q1034.2656,547.2656 1034.1563,546.75 Q1034.1094,546.3906 1033.9219,546.2031 Q1033.5938,545.8281 1032.9844,545.6094 Q1032.375,545.3906 1031.75,545.3906 Q1030.9844,545.3906 1030.3516,545.7188 Q1029.7188,546.0469 1029.2266,546.7969 Q1028.7344,547.5469 1028.7344,548.5781 L1028.7344,549.6719 Q1028.7344,550.9063 1029.625,551.7266 Q1030.5156,552.5469 1032.1094,552.5469 Q1033.0469,552.5469 1033.7031,552.2969 Q1034.0938,552.1406 1034.5156,551.7031 Q1034.7813,551.4375 1034.9297,551.3594 Q1035.0781,551.2813 1035.2813,551.2813 Q1035.6094,551.2813 1035.8672,551.5391 Q1036.125,551.7969 1036.125,552.1406 Q1036.125,552.4844 1035.7813,552.8906 Q1035.2813,553.4688 1034.4844,553.7969 Q1033.4063,554.25 1032.1094,554.25 Q1030.5938,554.25 1029.3906,553.625 Q1028.4063,553.125 1027.7188,552.0547 Q1027.0313,550.9844 1027.0313,549.7031 L1027.0313,548.5469 Q1027.0313,547.2188 1027.6484,546.0703 Q1028.2656,544.9219 1029.3594,544.3047 Q1030.4531,543.6875 1031.6875,543.6875 Q1032.4219,543.6875 1033.0703,543.8516 Q1033.7188,544.0156 1034.2656,544.375 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="79" x="1045.5" y="553.4102">EntranceNode</text><line x1="1017.5" x2="1126.5" y1="564.5" y2="564.5" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="1017.5" x2="1126.5" y1="572.5" y2="572.5" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="75.6719" id="ClusterNode" width="102" x="1330" y="518.5" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1345" cy="534.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1347.7656,530.375 Q1347.9219,530.1563 1348.1094,530.0469 Q1348.2969,529.9375 1348.5156,529.9375 Q1348.8906,529.9375 1349.125,530.1953 Q1349.3594,530.4531 1349.3594,531.0625 L1349.3594,532.5156 Q1349.3594,533.125 1349.125,533.3906 Q1348.8906,533.6563 1348.5156,533.6563 Q1348.1719,533.6563 1347.9688,533.4531 Q1347.7656,533.2656 1347.6563,532.75 Q1347.6094,532.3906 1347.4219,532.2031 Q1347.0938,531.8281 1346.4844,531.6094 Q1345.875,531.3906 1345.25,531.3906 Q1344.4844,531.3906 1343.8516,531.7188 Q1343.2188,532.0469 1342.7266,532.7969 Q1342.2344,533.5469 1342.2344,534.5781 L1342.2344,535.6719 Q1342.2344,536.9063 1343.125,537.7266 Q1344.0156,538.5469 1345.6094,538.5469 Q1346.5469,538.5469 1347.2031,538.2969 Q1347.5938,538.1406 1348.0156,537.7031 Q1348.2813,537.4375 1348.4297,537.3594 Q1348.5781,537.2813 1348.7813,537.2813 Q1349.1094,537.2813 1349.3672,537.5391 Q1349.625,537.7969 1349.625,538.1406 Q1349.625,538.4844 1349.2813,538.8906 Q1348.7813,539.4688 1347.9844,539.7969 Q1346.9063,540.25 1345.6094,540.25 Q1344.0938,540.25 1342.8906,539.625 Q1341.9063,539.125 1341.2188,538.0547 Q1340.5313,536.9844 1340.5313,535.7031 L1340.5313,534.5469 Q1340.5313,533.2188 1341.1484,532.0703 Q1341.7656,530.9219 1342.8594,530.3047 Q1343.9531,529.6875 1345.1875,529.6875 Q1345.9219,529.6875 1346.5703,529.8516 Q1347.2188,530.0156 1347.7656,530.375 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="70" x="1359" y="539.4102">ClusterNode</text><line x1="1331" x2="1431" y1="550.5" y2="550.5" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="60" x="1336" y="565.9189">String name;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="85" x="1336" y="579.7549">int resourceType;</text><line x1="1331" x2="1431" y1="586.1719" y2="586.1719" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FF69B4" filter="url(#fq83cxkatoz6r)" height="117.1797" id="Context" width="222" x="988" y="116" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1074.25" cy="132" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1077.0156,127.875 Q1077.1719,127.6563 1077.3594,127.5469 Q1077.5469,127.4375 1077.7656,127.4375 Q1078.1406,127.4375 1078.375,127.6953 Q1078.6094,127.9531 1078.6094,128.5625 L1078.6094,130.0156 Q1078.6094,130.625 1078.375,130.8906 Q1078.1406,131.1563 1077.7656,131.1563 Q1077.4219,131.1563 1077.2188,130.9531 Q1077.0156,130.7656 1076.9063,130.25 Q1076.8594,129.8906 1076.6719,129.7031 Q1076.3438,129.3281 1075.7344,129.1094 Q1075.125,128.8906 1074.5,128.8906 Q1073.7344,128.8906 1073.1016,129.2188 Q1072.4688,129.5469 1071.9766,130.2969 Q1071.4844,131.0469 1071.4844,132.0781 L1071.4844,133.1719 Q1071.4844,134.4063 1072.375,135.2266 Q1073.2656,136.0469 1074.8594,136.0469 Q1075.7969,136.0469 1076.4531,135.7969 Q1076.8438,135.6406 1077.2656,135.2031 Q1077.5313,134.9375 1077.6797,134.8594 Q1077.8281,134.7813 1078.0313,134.7813 Q1078.3594,134.7813 1078.6172,135.0391 Q1078.875,135.2969 1078.875,135.6406 Q1078.875,135.9844 1078.5313,136.3906 Q1078.0313,136.9688 1077.2344,137.2969 Q1076.1563,137.75 1074.8594,137.75 Q1073.3438,137.75 1072.1406,137.125 Q1071.1563,136.625 1070.4688,135.5547 Q1069.7813,134.4844 1069.7813,133.2031 L1069.7813,132.0469 Q1069.7813,130.7188 1070.3984,129.5703 Q1071.0156,128.4219 1072.1094,127.8047 Q1073.2031,127.1875 1074.4375,127.1875 Q1075.1719,127.1875 1075.8203,127.3516 Q1076.4688,127.5156 1077.0156,127.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="41" x="1094.75" y="136.9102">Context</text><line x1="989" x2="1209" y1="148" y2="148" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="60" x="994" y="163.4189">String name;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="210" x="994" y="177.2549">DefaultNode entranceNode;// EntranceNode</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="72" x="994" y="191.0908">Entry curEntry;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="60" x="994" y="204.9268">String origin;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="74" x="994" y="218.7627">boolean async;</text><line x1="989" x2="1209" y1="225.1797" y2="225.1797" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FFC0CB" filter="url(#fq83cxkatoz6r)" height="48" id="ProcessorSlot" width="108" x="716" y="682" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="731" cy="698" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M731.9531,694.6406 L731.9531,701.2969 L733.6719,701.2969 Q734.2813,701.2969 734.5469,701.5313 Q734.8125,701.7656 734.8125,702.1563 Q734.8125,702.5313 734.5469,702.7656 Q734.2813,703 733.6719,703 L728.5313,703 Q727.9219,703 727.6563,702.7656 Q727.3906,702.5313 727.3906,702.1406 Q727.3906,701.7656 727.6563,701.5313 Q727.9219,701.2969 728.5313,701.2969 L730.25,701.2969 L730.25,694.6406 L728.5313,694.6406 Q727.9219,694.6406 727.6563,694.4063 Q727.3906,694.1719 727.3906,693.7813 Q727.3906,693.4063 727.6563,693.1719 Q727.9219,692.9375 728.5313,692.9375 L733.6719,692.9375 Q734.2813,692.9375 734.5469,693.1719 Q734.8125,693.4063 734.8125,693.7813 Q734.8125,694.1719 734.5469,694.4063 Q734.2813,694.6406 733.6719,694.6406 L731.9531,694.6406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="76" x="745" y="702.9102">ProcessorSlot</text><line x1="717" x2="823" y1="714" y2="714" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="717" x2="823" y1="722" y2="722" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="61.8359" id="AbstractLinkedProcessorSlot" width="251" x="644.5" y="797" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="686.5" cy="813" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M688.6875,814.7656 L684.5469,814.7656 L684.125,815.7969 L684.5469,815.7969 Q685.1563,815.7969 685.4219,816.0313 Q685.6875,816.2656 685.6875,816.6563 Q685.6875,817.0313 685.4219,817.2656 Q685.1563,817.5 684.5469,817.5 L682.25,817.5 Q681.6406,817.5 681.3828,817.2656 Q681.125,817.0313 681.125,816.6406 Q681.125,816.2656 681.3984,816.0234 Q681.6719,815.7813 682.2969,815.7969 L684.9688,809.1406 L683.8594,809.1406 Q683.25,809.1406 682.9844,808.9063 Q682.7188,808.6719 682.7188,808.2813 Q682.7188,807.9063 682.9844,807.6719 Q683.25,807.4375 683.8594,807.4375 L687.5313,807.4375 L690.9219,815.7969 Q691.5156,815.7969 691.7031,815.9375 Q692.0938,816.2031 692.0938,816.6563 Q692.0938,817.0313 691.8359,817.2656 Q691.5781,817.5 690.9688,817.5 L688.6719,817.5 Q688.0625,817.5 687.7969,817.2656 Q687.5313,817.0313 687.5313,816.6406 Q687.5313,816.2656 687.7969,816.0313 Q688.0625,815.7969 688.6719,815.7969 L689.0938,815.7969 L688.6875,814.7656 Z M687.9688,813.0625 L686.6094,809.6875 L685.2344,813.0625 L687.9688,813.0625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="159" x="706.5" y="817.9102">AbstractLinkedProcessorSlot</text><line x1="645.5" x2="894.5" y1="829" y2="829" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="239" x="650.5" y="844.4189">AbstractLinkedProcessorSlot&lt;?&gt; next; //单向链表</text><line x1="645.5" x2="894.5" y1="850.8359" y2="850.8359" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FFC0CB" filter="url(#fq83cxkatoz6r)" height="48" id="ProcessorSlotChain" width="141" x="78.5" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="93.5" cy="942" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M95.6875,943.7656 L91.5469,943.7656 L91.125,944.7969 L91.5469,944.7969 Q92.1563,944.7969 92.4219,945.0313 Q92.6875,945.2656 92.6875,945.6563 Q92.6875,946.0313 92.4219,946.2656 Q92.1563,946.5 91.5469,946.5 L89.25,946.5 Q88.6406,946.5 88.3828,946.2656 Q88.125,946.0313 88.125,945.6406 Q88.125,945.2656 88.3984,945.0234 Q88.6719,944.7813 89.2969,944.7969 L91.9688,938.1406 L90.8594,938.1406 Q90.25,938.1406 89.9844,937.9063 Q89.7188,937.6719 89.7188,937.2813 Q89.7188,936.9063 89.9844,936.6719 Q90.25,936.4375 90.8594,936.4375 L94.5313,936.4375 L97.9219,944.7969 Q98.5156,944.7969 98.7031,944.9375 Q99.0938,945.2031 99.0938,945.6563 Q99.0938,946.0313 98.8359,946.2656 Q98.5781,946.5 97.9688,946.5 L95.6719,946.5 Q95.0625,946.5 94.7969,946.2656 Q94.5313,946.0313 94.5313,945.6406 Q94.5313,945.2656 94.7969,945.0313 Q95.0625,944.7969 95.6719,944.7969 L96.0938,944.7969 L95.6875,943.7656 Z M94.9688,942.0625 L93.6094,938.6875 L92.2344,942.0625 L94.9688,942.0625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="109" x="107.5" y="946.9102">ProcessorSlotChain</text><line x1="79.5" x2="218.5" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="79.5" x2="218.5" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="89.5078" id="DefaultProcessorSlotChain" width="196" x="51" y="1041" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="72.3" cy="1057" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M75.0656,1052.875 Q75.2219,1052.6563 75.4094,1052.5469 Q75.5969,1052.4375 75.8156,1052.4375 Q76.1906,1052.4375 76.425,1052.6953 Q76.6594,1052.9531 76.6594,1053.5625 L76.6594,1055.0156 Q76.6594,1055.625 76.425,1055.8906 Q76.1906,1056.1563 75.8156,1056.1563 Q75.4719,1056.1563 75.2688,1055.9531 Q75.0656,1055.7656 74.9563,1055.25 Q74.9094,1054.8906 74.7219,1054.7031 Q74.3938,1054.3281 73.7844,1054.1094 Q73.175,1053.8906 72.55,1053.8906 Q71.7844,1053.8906 71.1516,1054.2188 Q70.5188,1054.5469 70.0266,1055.2969 Q69.5344,1056.0469 69.5344,1057.0781 L69.5344,1058.1719 Q69.5344,1059.4063 70.425,1060.2266 Q71.3156,1061.0469 72.9094,1061.0469 Q73.8469,1061.0469 74.5031,1060.7969 Q74.8938,1060.6406 75.3156,1060.2031 Q75.5813,1059.9375 75.7297,1059.8594 Q75.8781,1059.7813 76.0813,1059.7813 Q76.4094,1059.7813 76.6672,1060.0391 Q76.925,1060.2969 76.925,1060.6406 Q76.925,1060.9844 76.5813,1061.3906 Q76.0813,1061.9688 75.2844,1062.2969 Q74.2063,1062.75 72.9094,1062.75 Q71.3938,1062.75 70.1906,1062.125 Q69.2063,1061.625 68.5188,1060.5547 Q67.8313,1059.4844 67.8313,1058.2031 L67.8313,1057.0469 Q67.8313,1055.7188 68.4484,1054.5703 Q69.0656,1053.4219 70.1594,1052.8047 Q71.2531,1052.1875 72.4875,1052.1875 Q73.2219,1052.1875 73.8703,1052.3516 Q74.5188,1052.5156 75.0656,1052.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="150" x="87.7" y="1061.9102">DefaultProcessorSlotChain</text><line x1="52" x2="246" y1="1073" y2="1073" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="108" x="57" y="1088.4189">// 头尾指针，头插尾插</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="184" x="57" y="1102.2549">AbstractLinkedProcessorSlot&lt;?&gt; first;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="183" x="57" y="1116.0908">AbstractLinkedProcessorSlot&lt;?&gt; end;</text><line x1="52" x2="246" y1="1122.5078" y2="1122.5078" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="NodeSelectorSlot" width="128" x="1166" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1181" cy="942" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1183.7656,937.875 Q1183.9219,937.6563 1184.1094,937.5469 Q1184.2969,937.4375 1184.5156,937.4375 Q1184.8906,937.4375 1185.125,937.6953 Q1185.3594,937.9531 1185.3594,938.5625 L1185.3594,940.0156 Q1185.3594,940.625 1185.125,940.8906 Q1184.8906,941.1563 1184.5156,941.1563 Q1184.1719,941.1563 1183.9688,940.9531 Q1183.7656,940.7656 1183.6563,940.25 Q1183.6094,939.8906 1183.4219,939.7031 Q1183.0938,939.3281 1182.4844,939.1094 Q1181.875,938.8906 1181.25,938.8906 Q1180.4844,938.8906 1179.8516,939.2188 Q1179.2188,939.5469 1178.7266,940.2969 Q1178.2344,941.0469 1178.2344,942.0781 L1178.2344,943.1719 Q1178.2344,944.4063 1179.125,945.2266 Q1180.0156,946.0469 1181.6094,946.0469 Q1182.5469,946.0469 1183.2031,945.7969 Q1183.5938,945.6406 1184.0156,945.2031 Q1184.2813,944.9375 1184.4297,944.8594 Q1184.5781,944.7813 1184.7813,944.7813 Q1185.1094,944.7813 1185.3672,945.0391 Q1185.625,945.2969 1185.625,945.6406 Q1185.625,945.9844 1185.2813,946.3906 Q1184.7813,946.9688 1183.9844,947.2969 Q1182.9063,947.75 1181.6094,947.75 Q1180.0938,947.75 1178.8906,947.125 Q1177.9063,946.625 1177.2188,945.5547 Q1176.5313,944.4844 1176.5313,943.2031 L1176.5313,942.0469 Q1176.5313,940.7188 1177.1484,939.5703 Q1177.7656,938.4219 1178.8594,937.8047 Q1179.9531,937.1875 1181.1875,937.1875 Q1181.9219,937.1875 1182.5703,937.3516 Q1183.2188,937.5156 1183.7656,937.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="96" x="1195" y="946.9102">NodeSelectorSlot</text><line x1="1167" x2="1293" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="1167" x2="1293" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="ClusterBuilderSlot" width="132" x="1329" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1344" cy="942" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1346.7656,937.875 Q1346.9219,937.6563 1347.1094,937.5469 Q1347.2969,937.4375 1347.5156,937.4375 Q1347.8906,937.4375 1348.125,937.6953 Q1348.3594,937.9531 1348.3594,938.5625 L1348.3594,940.0156 Q1348.3594,940.625 1348.125,940.8906 Q1347.8906,941.1563 1347.5156,941.1563 Q1347.1719,941.1563 1346.9688,940.9531 Q1346.7656,940.7656 1346.6563,940.25 Q1346.6094,939.8906 1346.4219,939.7031 Q1346.0938,939.3281 1345.4844,939.1094 Q1344.875,938.8906 1344.25,938.8906 Q1343.4844,938.8906 1342.8516,939.2188 Q1342.2188,939.5469 1341.7266,940.2969 Q1341.2344,941.0469 1341.2344,942.0781 L1341.2344,943.1719 Q1341.2344,944.4063 1342.125,945.2266 Q1343.0156,946.0469 1344.6094,946.0469 Q1345.5469,946.0469 1346.2031,945.7969 Q1346.5938,945.6406 1347.0156,945.2031 Q1347.2813,944.9375 1347.4297,944.8594 Q1347.5781,944.7813 1347.7813,944.7813 Q1348.1094,944.7813 1348.3672,945.0391 Q1348.625,945.2969 1348.625,945.6406 Q1348.625,945.9844 1348.2813,946.3906 Q1347.7813,946.9688 1346.9844,947.2969 Q1345.9063,947.75 1344.6094,947.75 Q1343.0938,947.75 1341.8906,947.125 Q1340.9063,946.625 1340.2188,945.5547 Q1339.5313,944.4844 1339.5313,943.2031 L1339.5313,942.0469 Q1339.5313,940.7188 1340.1484,939.5703 Q1340.7656,938.4219 1341.8594,937.8047 Q1342.9531,937.1875 1344.1875,937.1875 Q1344.9219,937.1875 1345.5703,937.3516 Q1346.2188,937.5156 1346.7656,937.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="100" x="1358" y="946.9102">ClusterBuilderSlot</text><line x1="1330" x2="1460" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="1330" x2="1460" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="LogSlot" width="74" x="348" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="363" cy="942" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M365.7656,937.875 Q365.9219,937.6563 366.1094,937.5469 Q366.2969,937.4375 366.5156,937.4375 Q366.8906,937.4375 367.125,937.6953 Q367.3594,937.9531 367.3594,938.5625 L367.3594,940.0156 Q367.3594,940.625 367.125,940.8906 Q366.8906,941.1563 366.5156,941.1563 Q366.1719,941.1563 365.9688,940.9531 Q365.7656,940.7656 365.6563,940.25 Q365.6094,939.8906 365.4219,939.7031 Q365.0938,939.3281 364.4844,939.1094 Q363.875,938.8906 363.25,938.8906 Q362.4844,938.8906 361.8516,939.2188 Q361.2188,939.5469 360.7266,940.2969 Q360.2344,941.0469 360.2344,942.0781 L360.2344,943.1719 Q360.2344,944.4063 361.125,945.2266 Q362.0156,946.0469 363.6094,946.0469 Q364.5469,946.0469 365.2031,945.7969 Q365.5938,945.6406 366.0156,945.2031 Q366.2813,944.9375 366.4297,944.8594 Q366.5781,944.7813 366.7813,944.7813 Q367.1094,944.7813 367.3672,945.0391 Q367.625,945.2969 367.625,945.6406 Q367.625,945.9844 367.2813,946.3906 Q366.7813,946.9688 365.9844,947.2969 Q364.9063,947.75 363.6094,947.75 Q362.0938,947.75 360.8906,947.125 Q359.9063,946.625 359.2188,945.5547 Q358.5313,944.4844 358.5313,943.2031 L358.5313,942.0469 Q358.5313,940.7188 359.1484,939.5703 Q359.7656,938.4219 360.8594,937.8047 Q361.9531,937.1875 363.1875,937.1875 Q363.9219,937.1875 364.5703,937.3516 Q365.2188,937.5156 365.7656,937.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="42" x="377" y="946.9102">LogSlot</text><line x1="349" x2="421" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="349" x2="421" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="StatisticSlot" width="96" x="457" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="472" cy="942" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M474.7656,937.875 Q474.9219,937.6563 475.1094,937.5469 Q475.2969,937.4375 475.5156,937.4375 Q475.8906,937.4375 476.125,937.6953 Q476.3594,937.9531 476.3594,938.5625 L476.3594,940.0156 Q476.3594,940.625 476.125,940.8906 Q475.8906,941.1563 475.5156,941.1563 Q475.1719,941.1563 474.9688,940.9531 Q474.7656,940.7656 474.6563,940.25 Q474.6094,939.8906 474.4219,939.7031 Q474.0938,939.3281 473.4844,939.1094 Q472.875,938.8906 472.25,938.8906 Q471.4844,938.8906 470.8516,939.2188 Q470.2188,939.5469 469.7266,940.2969 Q469.2344,941.0469 469.2344,942.0781 L469.2344,943.1719 Q469.2344,944.4063 470.125,945.2266 Q471.0156,946.0469 472.6094,946.0469 Q473.5469,946.0469 474.2031,945.7969 Q474.5938,945.6406 475.0156,945.2031 Q475.2813,944.9375 475.4297,944.8594 Q475.5781,944.7813 475.7813,944.7813 Q476.1094,944.7813 476.3672,945.0391 Q476.625,945.2969 476.625,945.6406 Q476.625,945.9844 476.2813,946.3906 Q475.7813,946.9688 474.9844,947.2969 Q473.9063,947.75 472.6094,947.75 Q471.0938,947.75 469.8906,947.125 Q468.9063,946.625 468.2188,945.5547 Q467.5313,944.4844 467.5313,943.2031 L467.5313,942.0469 Q467.5313,940.7188 468.1484,939.5703 Q468.7656,938.4219 469.8594,937.8047 Q470.9531,937.1875 472.1875,937.1875 Q472.9219,937.1875 473.5703,937.3516 Q474.2188,937.5156 474.7656,937.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="64" x="486" y="946.9102">StatisticSlot</text><line x1="458" x2="552" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="458" x2="552" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="AuthoritySlot" width="99" x="588.5" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="603.5" cy="942" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M606.2656,937.875 Q606.4219,937.6563 606.6094,937.5469 Q606.7969,937.4375 607.0156,937.4375 Q607.3906,937.4375 607.625,937.6953 Q607.8594,937.9531 607.8594,938.5625 L607.8594,940.0156 Q607.8594,940.625 607.625,940.8906 Q607.3906,941.1563 607.0156,941.1563 Q606.6719,941.1563 606.4688,940.9531 Q606.2656,940.7656 606.1563,940.25 Q606.1094,939.8906 605.9219,939.7031 Q605.5938,939.3281 604.9844,939.1094 Q604.375,938.8906 603.75,938.8906 Q602.9844,938.8906 602.3516,939.2188 Q601.7188,939.5469 601.2266,940.2969 Q600.7344,941.0469 600.7344,942.0781 L600.7344,943.1719 Q600.7344,944.4063 601.625,945.2266 Q602.5156,946.0469 604.1094,946.0469 Q605.0469,946.0469 605.7031,945.7969 Q606.0938,945.6406 606.5156,945.2031 Q606.7813,944.9375 606.9297,944.8594 Q607.0781,944.7813 607.2813,944.7813 Q607.6094,944.7813 607.8672,945.0391 Q608.125,945.2969 608.125,945.6406 Q608.125,945.9844 607.7813,946.3906 Q607.2813,946.9688 606.4844,947.2969 Q605.4063,947.75 604.1094,947.75 Q602.5938,947.75 601.3906,947.125 Q600.4063,946.625 599.7188,945.5547 Q599.0313,944.4844 599.0313,943.2031 L599.0313,942.0469 Q599.0313,940.7188 599.6484,939.5703 Q600.2656,938.4219 601.3594,937.8047 Q602.4531,937.1875 603.6875,937.1875 Q604.4219,937.1875 605.0703,937.3516 Q605.7188,937.5156 606.2656,937.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="67" x="617.5" y="946.9102">AuthoritySlot</text><line x1="589.5" x2="686.5" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="589.5" x2="686.5" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="SystemSlot" width="94" x="723" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="738" cy="942" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M740.7656,937.875 Q740.9219,937.6563 741.1094,937.5469 Q741.2969,937.4375 741.5156,937.4375 Q741.8906,937.4375 742.125,937.6953 Q742.3594,937.9531 742.3594,938.5625 L742.3594,940.0156 Q742.3594,940.625 742.125,940.8906 Q741.8906,941.1563 741.5156,941.1563 Q741.1719,941.1563 740.9688,940.9531 Q740.7656,940.7656 740.6563,940.25 Q740.6094,939.8906 740.4219,939.7031 Q740.0938,939.3281 739.4844,939.1094 Q738.875,938.8906 738.25,938.8906 Q737.4844,938.8906 736.8516,939.2188 Q736.2188,939.5469 735.7266,940.2969 Q735.2344,941.0469 735.2344,942.0781 L735.2344,943.1719 Q735.2344,944.4063 736.125,945.2266 Q737.0156,946.0469 738.6094,946.0469 Q739.5469,946.0469 740.2031,945.7969 Q740.5938,945.6406 741.0156,945.2031 Q741.2813,944.9375 741.4297,944.8594 Q741.5781,944.7813 741.7813,944.7813 Q742.1094,944.7813 742.3672,945.0391 Q742.625,945.2969 742.625,945.6406 Q742.625,945.9844 742.2813,946.3906 Q741.7813,946.9688 740.9844,947.2969 Q739.9063,947.75 738.6094,947.75 Q737.0938,947.75 735.8906,947.125 Q734.9063,946.625 734.2188,945.5547 Q733.5313,944.4844 733.5313,943.2031 L733.5313,942.0469 Q733.5313,940.7188 734.1484,939.5703 Q734.7656,938.4219 735.8594,937.8047 Q736.9531,937.1875 738.1875,937.1875 Q738.9219,937.1875 739.5703,937.3516 Q740.2188,937.5156 740.7656,937.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="62" x="752" y="946.9102">SystemSlot</text><line x1="724" x2="816" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="724" x2="816" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FFC0CB" filter="url(#fq83cxkatoz6r)" height="61.8359" id="FlowSlot" width="142" x="852" y="919" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="895.35" cy="935" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M898.1156,930.875 Q898.2719,930.6563 898.4594,930.5469 Q898.6469,930.4375 898.8656,930.4375 Q899.2406,930.4375 899.475,930.6953 Q899.7094,930.9531 899.7094,931.5625 L899.7094,933.0156 Q899.7094,933.625 899.475,933.8906 Q899.2406,934.1563 898.8656,934.1563 Q898.5219,934.1563 898.3188,933.9531 Q898.1156,933.7656 898.0063,933.25 Q897.9594,932.8906 897.7719,932.7031 Q897.4438,932.3281 896.8344,932.1094 Q896.225,931.8906 895.6,931.8906 Q894.8344,931.8906 894.2016,932.2188 Q893.5688,932.5469 893.0766,933.2969 Q892.5844,934.0469 892.5844,935.0781 L892.5844,936.1719 Q892.5844,937.4063 893.475,938.2266 Q894.3656,939.0469 895.9594,939.0469 Q896.8969,939.0469 897.5531,938.7969 Q897.9438,938.6406 898.3656,938.2031 Q898.6313,937.9375 898.7797,937.8594 Q898.9281,937.7813 899.1313,937.7813 Q899.4594,937.7813 899.7172,938.0391 Q899.975,938.2969 899.975,938.6406 Q899.975,938.9844 899.6313,939.3906 Q899.1313,939.9688 898.3344,940.2969 Q897.2563,940.75 895.9594,940.75 Q894.4438,940.75 893.2406,940.125 Q892.2563,939.625 891.5688,938.5547 Q890.8813,937.4844 890.8813,936.2031 L890.8813,935.0469 Q890.8813,933.7188 891.4984,932.5703 Q892.1156,931.4219 893.2094,930.8047 Q894.3031,930.1875 895.5375,930.1875 Q896.2719,930.1875 896.9203,930.3516 Q897.5688,930.5156 898.1156,930.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="47" x="915.65" y="939.9102">FlowSlot</text><line x1="853" x2="993" y1="951" y2="951" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="130" x="858" y="966.4189">FlowRuleChecker checker;</text><line x1="853" x2="993" y1="972.8359" y2="972.8359" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="DegradeSlot" width="101" x="1029.5" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="1044.5" cy="942" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M1047.2656,937.875 Q1047.4219,937.6563 1047.6094,937.5469 Q1047.7969,937.4375 1048.0156,937.4375 Q1048.3906,937.4375 1048.625,937.6953 Q1048.8594,937.9531 1048.8594,938.5625 L1048.8594,940.0156 Q1048.8594,940.625 1048.625,940.8906 Q1048.3906,941.1563 1048.0156,941.1563 Q1047.6719,941.1563 1047.4688,940.9531 Q1047.2656,940.7656 1047.1563,940.25 Q1047.1094,939.8906 1046.9219,939.7031 Q1046.5938,939.3281 1045.9844,939.1094 Q1045.375,938.8906 1044.75,938.8906 Q1043.9844,938.8906 1043.3516,939.2188 Q1042.7188,939.5469 1042.2266,940.2969 Q1041.7344,941.0469 1041.7344,942.0781 L1041.7344,943.1719 Q1041.7344,944.4063 1042.625,945.2266 Q1043.5156,946.0469 1045.1094,946.0469 Q1046.0469,946.0469 1046.7031,945.7969 Q1047.0938,945.6406 1047.5156,945.2031 Q1047.7813,944.9375 1047.9297,944.8594 Q1048.0781,944.7813 1048.2813,944.7813 Q1048.6094,944.7813 1048.8672,945.0391 Q1049.125,945.2969 1049.125,945.6406 Q1049.125,945.9844 1048.7813,946.3906 Q1048.2813,946.9688 1047.4844,947.2969 Q1046.4063,947.75 1045.1094,947.75 Q1043.5938,947.75 1042.3906,947.125 Q1041.4063,946.625 1040.7188,945.5547 Q1040.0313,944.4844 1040.0313,943.2031 L1040.0313,942.0469 Q1040.0313,940.7188 1040.6484,939.5703 Q1041.2656,938.4219 1042.3594,937.8047 Q1043.4531,937.1875 1044.6875,937.1875 Q1045.4219,937.1875 1046.0703,937.3516 Q1046.7188,937.5156 1047.2656,937.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="69" x="1058.5" y="946.9102">DegradeSlot</text><line x1="1030.5" x2="1129.5" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="1030.5" x2="1129.5" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#DDA0DD" filter="url(#fq83cxkatoz6r)" height="48" id="Rule" width="58" x="255" y="926" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="270" cy="942" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M270.9531,938.6406 L270.9531,945.2969 L272.6719,945.2969 Q273.2813,945.2969 273.5469,945.5313 Q273.8125,945.7656 273.8125,946.1563 Q273.8125,946.5313 273.5469,946.7656 Q273.2813,947 272.6719,947 L267.5313,947 Q266.9219,947 266.6563,946.7656 Q266.3906,946.5313 266.3906,946.1406 Q266.3906,945.7656 266.6563,945.5313 Q266.9219,945.2969 267.5313,945.2969 L269.25,945.2969 L269.25,938.6406 L267.5313,938.6406 Q266.9219,938.6406 266.6563,938.4063 Q266.3906,938.1719 266.3906,937.7813 Q266.3906,937.4063 266.6563,937.1719 Q266.9219,936.9375 267.5313,936.9375 L272.6719,936.9375 Q273.2813,936.9375 273.5469,937.1719 Q273.8125,937.4063 273.8125,937.7813 Q273.8125,938.1719 273.5469,938.4063 Q273.2813,938.6406 272.6719,938.6406 L270.9531,938.6406 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="26" x="284" y="946.9102">Rule</text><line x1="256" x2="312" y1="958" y2="958" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="256" x2="312" y1="966" y2="966" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="AbstractRule" width="103" x="292.5" y="1062" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="307.5" cy="1078" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M309.6875,1079.7656 L305.5469,1079.7656 L305.125,1080.7969 L305.5469,1080.7969 Q306.1563,1080.7969 306.4219,1081.0313 Q306.6875,1081.2656 306.6875,1081.6563 Q306.6875,1082.0313 306.4219,1082.2656 Q306.1563,1082.5 305.5469,1082.5 L303.25,1082.5 Q302.6406,1082.5 302.3828,1082.2656 Q302.125,1082.0313 302.125,1081.6406 Q302.125,1081.2656 302.3984,1081.0234 Q302.6719,1080.7813 303.2969,1080.7969 L305.9688,1074.1406 L304.8594,1074.1406 Q304.25,1074.1406 303.9844,1073.9063 Q303.7188,1073.6719 303.7188,1073.2813 Q303.7188,1072.9063 303.9844,1072.6719 Q304.25,1072.4375 304.8594,1072.4375 L308.5313,1072.4375 L311.9219,1080.7969 Q312.5156,1080.7969 312.7031,1080.9375 Q313.0938,1081.2031 313.0938,1081.6563 Q313.0938,1082.0313 312.8359,1082.2656 Q312.5781,1082.5 311.9688,1082.5 L309.6719,1082.5 Q309.0625,1082.5 308.7969,1082.2656 Q308.5313,1082.0313 308.5313,1081.6406 Q308.5313,1081.2656 308.7969,1081.0313 Q309.0625,1080.7969 309.6719,1080.7969 L310.0938,1080.7969 L309.6875,1079.7656 Z M308.9688,1078.0625 L307.6094,1074.6875 L306.2344,1078.0625 L308.9688,1078.0625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="71" x="321.5" y="1082.9102">AbstractRule</text><line x1="293.5" x2="394.5" y1="1094" y2="1094" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="293.5" x2="394.5" y1="1102" y2="1102" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#DDA0DD" filter="url(#fq83cxkatoz6r)" height="48" id="FlowRule" width="84" x="575" y="1191" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="590" cy="1207" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M592.7656,1202.875 Q592.9219,1202.6563 593.1094,1202.5469 Q593.2969,1202.4375 593.5156,1202.4375 Q593.8906,1202.4375 594.125,1202.6953 Q594.3594,1202.9531 594.3594,1203.5625 L594.3594,1205.0156 Q594.3594,1205.625 594.125,1205.8906 Q593.8906,1206.1563 593.5156,1206.1563 Q593.1719,1206.1563 592.9688,1205.9531 Q592.7656,1205.7656 592.6563,1205.25 Q592.6094,1204.8906 592.4219,1204.7031 Q592.0938,1204.3281 591.4844,1204.1094 Q590.875,1203.8906 590.25,1203.8906 Q589.4844,1203.8906 588.8516,1204.2188 Q588.2188,1204.5469 587.7266,1205.2969 Q587.2344,1206.0469 587.2344,1207.0781 L587.2344,1208.1719 Q587.2344,1209.4063 588.125,1210.2266 Q589.0156,1211.0469 590.6094,1211.0469 Q591.5469,1211.0469 592.2031,1210.7969 Q592.5938,1210.6406 593.0156,1210.2031 Q593.2813,1209.9375 593.4297,1209.8594 Q593.5781,1209.7813 593.7813,1209.7813 Q594.1094,1209.7813 594.3672,1210.0391 Q594.625,1210.2969 594.625,1210.6406 Q594.625,1210.9844 594.2813,1211.3906 Q593.7813,1211.9688 592.9844,1212.2969 Q591.9063,1212.75 590.6094,1212.75 Q589.0938,1212.75 587.8906,1212.125 Q586.9063,1211.625 586.2188,1210.5547 Q585.5313,1209.4844 585.5313,1208.2031 L585.5313,1207.0469 Q585.5313,1205.7188 586.1484,1204.5703 Q586.7656,1203.4219 587.8594,1202.8047 Q588.9531,1202.1875 590.1875,1202.1875 Q590.9219,1202.1875 591.5703,1202.3516 Q592.2188,1202.5156 592.7656,1202.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="52" x="604" y="1211.9102">FlowRule</text><line x1="576" x2="658" y1="1223" y2="1223" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="576" x2="658" y1="1231" y2="1231" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="DegradeRule" width="106" x="151" y="1191" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="166" cy="1207" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M168.7656,1202.875 Q168.9219,1202.6563 169.1094,1202.5469 Q169.2969,1202.4375 169.5156,1202.4375 Q169.8906,1202.4375 170.125,1202.6953 Q170.3594,1202.9531 170.3594,1203.5625 L170.3594,1205.0156 Q170.3594,1205.625 170.125,1205.8906 Q169.8906,1206.1563 169.5156,1206.1563 Q169.1719,1206.1563 168.9688,1205.9531 Q168.7656,1205.7656 168.6563,1205.25 Q168.6094,1204.8906 168.4219,1204.7031 Q168.0938,1204.3281 167.4844,1204.1094 Q166.875,1203.8906 166.25,1203.8906 Q165.4844,1203.8906 164.8516,1204.2188 Q164.2188,1204.5469 163.7266,1205.2969 Q163.2344,1206.0469 163.2344,1207.0781 L163.2344,1208.1719 Q163.2344,1209.4063 164.125,1210.2266 Q165.0156,1211.0469 166.6094,1211.0469 Q167.5469,1211.0469 168.2031,1210.7969 Q168.5938,1210.6406 169.0156,1210.2031 Q169.2813,1209.9375 169.4297,1209.8594 Q169.5781,1209.7813 169.7813,1209.7813 Q170.1094,1209.7813 170.3672,1210.0391 Q170.625,1210.2969 170.625,1210.6406 Q170.625,1210.9844 170.2813,1211.3906 Q169.7813,1211.9688 168.9844,1212.2969 Q167.9063,1212.75 166.6094,1212.75 Q165.0938,1212.75 163.8906,1212.125 Q162.9063,1211.625 162.2188,1210.5547 Q161.5313,1209.4844 161.5313,1208.2031 L161.5313,1207.0469 Q161.5313,1205.7188 162.1484,1204.5703 Q162.7656,1203.4219 163.8594,1202.8047 Q164.9531,1202.1875 166.1875,1202.1875 Q166.9219,1202.1875 167.5703,1202.3516 Q168.2188,1202.5156 168.7656,1202.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="74" x="180" y="1211.9102">DegradeRule</text><line x1="152" x2="256" y1="1223" y2="1223" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="152" x2="256" y1="1231" y2="1231" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="AuthorityRule" width="104" x="292" y="1191" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="307" cy="1207" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M309.7656,1202.875 Q309.9219,1202.6563 310.1094,1202.5469 Q310.2969,1202.4375 310.5156,1202.4375 Q310.8906,1202.4375 311.125,1202.6953 Q311.3594,1202.9531 311.3594,1203.5625 L311.3594,1205.0156 Q311.3594,1205.625 311.125,1205.8906 Q310.8906,1206.1563 310.5156,1206.1563 Q310.1719,1206.1563 309.9688,1205.9531 Q309.7656,1205.7656 309.6563,1205.25 Q309.6094,1204.8906 309.4219,1204.7031 Q309.0938,1204.3281 308.4844,1204.1094 Q307.875,1203.8906 307.25,1203.8906 Q306.4844,1203.8906 305.8516,1204.2188 Q305.2188,1204.5469 304.7266,1205.2969 Q304.2344,1206.0469 304.2344,1207.0781 L304.2344,1208.1719 Q304.2344,1209.4063 305.125,1210.2266 Q306.0156,1211.0469 307.6094,1211.0469 Q308.5469,1211.0469 309.2031,1210.7969 Q309.5938,1210.6406 310.0156,1210.2031 Q310.2813,1209.9375 310.4297,1209.8594 Q310.5781,1209.7813 310.7813,1209.7813 Q311.1094,1209.7813 311.3672,1210.0391 Q311.625,1210.2969 311.625,1210.6406 Q311.625,1210.9844 311.2813,1211.3906 Q310.7813,1211.9688 309.9844,1212.2969 Q308.9063,1212.75 307.6094,1212.75 Q306.0938,1212.75 304.8906,1212.125 Q303.9063,1211.625 303.2188,1210.5547 Q302.5313,1209.4844 302.5313,1208.2031 L302.5313,1207.0469 Q302.5313,1205.7188 303.1484,1204.5703 Q303.7656,1203.4219 304.8594,1202.8047 Q305.9531,1202.1875 307.1875,1202.1875 Q307.9219,1202.1875 308.5703,1202.3516 Q309.2188,1202.5156 309.7656,1202.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="72" x="321" y="1211.9102">AuthorityRule</text><line x1="293" x2="395" y1="1223" y2="1223" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="293" x2="395" y1="1231" y2="1231" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="SystemRule" width="99" x="431.5" y="1191" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="446.5" cy="1207" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M449.2656,1202.875 Q449.4219,1202.6563 449.6094,1202.5469 Q449.7969,1202.4375 450.0156,1202.4375 Q450.3906,1202.4375 450.625,1202.6953 Q450.8594,1202.9531 450.8594,1203.5625 L450.8594,1205.0156 Q450.8594,1205.625 450.625,1205.8906 Q450.3906,1206.1563 450.0156,1206.1563 Q449.6719,1206.1563 449.4688,1205.9531 Q449.2656,1205.7656 449.1563,1205.25 Q449.1094,1204.8906 448.9219,1204.7031 Q448.5938,1204.3281 447.9844,1204.1094 Q447.375,1203.8906 446.75,1203.8906 Q445.9844,1203.8906 445.3516,1204.2188 Q444.7188,1204.5469 444.2266,1205.2969 Q443.7344,1206.0469 443.7344,1207.0781 L443.7344,1208.1719 Q443.7344,1209.4063 444.625,1210.2266 Q445.5156,1211.0469 447.1094,1211.0469 Q448.0469,1211.0469 448.7031,1210.7969 Q449.0938,1210.6406 449.5156,1210.2031 Q449.7813,1209.9375 449.9297,1209.8594 Q450.0781,1209.7813 450.2813,1209.7813 Q450.6094,1209.7813 450.8672,1210.0391 Q451.125,1210.2969 451.125,1210.6406 Q451.125,1210.9844 450.7813,1211.3906 Q450.2813,1211.9688 449.4844,1212.2969 Q448.4063,1212.75 447.1094,1212.75 Q445.5938,1212.75 444.3906,1212.125 Q443.4063,1211.625 442.7188,1210.5547 Q442.0313,1209.4844 442.0313,1208.2031 L442.0313,1207.0469 Q442.0313,1205.7188 442.6484,1204.5703 Q443.2656,1203.4219 444.3594,1202.8047 Q445.4531,1202.1875 446.6875,1202.1875 Q447.4219,1202.1875 448.0703,1202.3516 Q448.7188,1202.5156 449.2656,1202.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="67" x="460.5" y="1211.9102">SystemRule</text><line x1="432.5" x2="529.5" y1="1223" y2="1223" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="432.5" x2="529.5" y1="1231" y2="1231" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#DDA0DD" filter="url(#fq83cxkatoz6r)" height="61.8359" id="FlowRuleManager" width="303" x="483.5" y="1055" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="580.75" cy="1071" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M583.5156,1066.875 Q583.6719,1066.6563 583.8594,1066.5469 Q584.0469,1066.4375 584.2656,1066.4375 Q584.6406,1066.4375 584.875,1066.6953 Q585.1094,1066.9531 585.1094,1067.5625 L585.1094,1069.0156 Q585.1094,1069.625 584.875,1069.8906 Q584.6406,1070.1563 584.2656,1070.1563 Q583.9219,1070.1563 583.7188,1069.9531 Q583.5156,1069.7656 583.4063,1069.25 Q583.3594,1068.8906 583.1719,1068.7031 Q582.8438,1068.3281 582.2344,1068.1094 Q581.625,1067.8906 581,1067.8906 Q580.2344,1067.8906 579.6016,1068.2188 Q578.9688,1068.5469 578.4766,1069.2969 Q577.9844,1070.0469 577.9844,1071.0781 L577.9844,1072.1719 Q577.9844,1073.4063 578.875,1074.2266 Q579.7656,1075.0469 581.3594,1075.0469 Q582.2969,1075.0469 582.9531,1074.7969 Q583.3438,1074.6406 583.7656,1074.2031 Q584.0313,1073.9375 584.1797,1073.8594 Q584.3281,1073.7813 584.5313,1073.7813 Q584.8594,1073.7813 585.1172,1074.0391 Q585.375,1074.2969 585.375,1074.6406 Q585.375,1074.9844 585.0313,1075.3906 Q584.5313,1075.9688 583.7344,1076.2969 Q582.6563,1076.75 581.3594,1076.75 Q579.8438,1076.75 578.6406,1076.125 Q577.6563,1075.625 576.9688,1074.5547 Q576.2813,1073.4844 576.2813,1072.2031 L576.2813,1071.0469 Q576.2813,1069.7188 576.8984,1068.5703 Q577.5156,1067.4219 578.6094,1066.8047 Q579.7031,1066.1875 580.9375,1066.1875 Q581.6719,1066.1875 582.3203,1066.3516 Q582.9688,1066.5156 583.5156,1066.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="100" x="601.25" y="1075.9102">FlowRuleManager</text><line x1="484.5" x2="785.5" y1="1087" y2="1087" style="stroke:#A80036;stroke-width:1.5;"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="291" x="489.5" y="1102.4189">AtomicReference&lt;Map&lt;String, List&lt;FlowRule&gt;&gt;&gt; flowRules;</text><line x1="484.5" x2="785.5" y1="1108.8359" y2="1108.8359" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fq83cxkatoz6r)" height="48" id="FlowRuleChecker" width="130" x="858" y="1062" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="873" cy="1078" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M875.7656,1073.875 Q875.9219,1073.6563 876.1094,1073.5469 Q876.2969,1073.4375 876.5156,1073.4375 Q876.8906,1073.4375 877.125,1073.6953 Q877.3594,1073.9531 877.3594,1074.5625 L877.3594,1076.0156 Q877.3594,1076.625 877.125,1076.8906 Q876.8906,1077.1563 876.5156,1077.1563 Q876.1719,1077.1563 875.9688,1076.9531 Q875.7656,1076.7656 875.6563,1076.25 Q875.6094,1075.8906 875.4219,1075.7031 Q875.0938,1075.3281 874.4844,1075.1094 Q873.875,1074.8906 873.25,1074.8906 Q872.4844,1074.8906 871.8516,1075.2188 Q871.2188,1075.5469 870.7266,1076.2969 Q870.2344,1077.0469 870.2344,1078.0781 L870.2344,1079.1719 Q870.2344,1080.4063 871.125,1081.2266 Q872.0156,1082.0469 873.6094,1082.0469 Q874.5469,1082.0469 875.2031,1081.7969 Q875.5938,1081.6406 876.0156,1081.2031 Q876.2813,1080.9375 876.4297,1080.8594 Q876.5781,1080.7813 876.7813,1080.7813 Q877.1094,1080.7813 877.3672,1081.0391 Q877.625,1081.2969 877.625,1081.6406 Q877.625,1081.9844 877.2813,1082.3906 Q876.7813,1082.9688 875.9844,1083.2969 Q874.9063,1083.75 873.6094,1083.75 Q872.0938,1083.75 870.8906,1083.125 Q869.9063,1082.625 869.2188,1081.5547 Q868.5313,1080.4844 868.5313,1079.2031 L868.5313,1078.0469 Q868.5313,1076.7188 869.1484,1075.5703 Q869.7656,1074.4219 870.8594,1073.8047 Q871.9531,1073.1875 873.1875,1073.1875 Q873.9219,1073.1875 874.5703,1073.3516 Q875.2188,1073.5156 875.7656,1073.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="98" x="887" y="1082.9102">FlowRuleChecker</text><line x1="859" x2="987" y1="1094" y2="1094" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="859" x2="987" y1="1102" y2="1102" style="stroke:#A80036;stroke-width:1.5;"></line><path d="M149,600.87 C149,627.282 149,659.994 149,681.628 " fill="none" id="SphResourceTypeSupport&lt;-Sph" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="142,600.547,149,580.547,156,600.547,142,600.547" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M149,750.324 C149,765.679 149,782.618 149,796.661 " fill="none" id="Sph&lt;-CtSph" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="142,750.137,149,730.137,156,750.137,142,750.137" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1284.44,616.331 C1303.33,636.373 1323.66,657.948 1339.54,674.798 " fill="none" id="ResourceWrapper&lt;-MethodResourceWrapper" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="1279.33,621.111,1270.7,601.755,1289.52,611.509,1279.33,621.111" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1201.3,620.361 C1191.7,642.137 1181.54,665.207 1174.24,681.753 " fill="none" id="ResourceWrapper&lt;-StringResourceWrapper" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="1195.03,617.234,1209.5,601.755,1207.84,622.879,1195.03,617.234" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M857,218.87 C857,240.704 857,267.754 857,292.592 " fill="none" id="AutoCloseable&lt;-Entry" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="850,218.68,857,198.68,864,218.68,850,218.68" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M850.189,458.449 C849.192,471.905 848.19,485.43 847.264,497.931 " fill="none" id="Entry&lt;-CtEntry" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="843.229,457.651,851.687,438.222,857.191,458.685,843.229,457.651" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M882.557,633.275 C890.264,648.038 897.914,662.693 904.271,674.87 " fill="none" id="CtEntry&lt;-AsyncEntry" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="876.262,636.342,873.211,615.373,888.672,629.863,876.262,636.342" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1338,76.37 C1338,91.07 1338,107.63 1338,122.85 " fill="none" id="Node&lt;-StatisticNode" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="1331,76.2,1338,56.2,1345,76.2,1331,76.2" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1298.65,243.728 C1283.9,269.299 1267.55,297.657 1254.4,320.466 " fill="none" id="StatisticNode&lt;-DefaultNode" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="1292.73,239.977,1308.79,226.15,1304.86,246.971,1292.73,239.977" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1179.39,426.219 C1149.45,462.27 1112.98,506.169 1091.17,532.422 " fill="none" id="DefaultNode&lt;-EntranceNode" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="1174.03,421.724,1192.19,410.812,1184.8,430.669,1174.03,421.724" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1346,246.229 C1355.12,326.804 1369.68,455.426 1376.8,518.365 " fill="none" id="StatisticNode&lt;-ClusterNode" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="1339.05,247.014,1343.75,226.35,1352.96,245.44,1339.05,247.014" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1229,424.131 C1229,452.214 1229,485.45 1229,511.466 " fill="none" id="DefaultNode&lt;-ResourceWrapper" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="1229,410.812,1225,416.812,1229,422.812,1233,416.812,1229,410.812" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1272.92,421.11 C1298.05,452.356 1328.91,490.728 1351.21,518.459 " fill="none" id="DefaultNode&lt;-ClusterNode" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="1264.64,410.812,1265.2838,417.9943,1272.1612,420.1624,1271.5174,412.9801,1264.64,410.812" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1014.77,241.282 C993.476,257.914 970.502,275.856 948.851,292.765 " fill="none" id="Context&lt;-Entry" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="1025.08,233.23,1017.8892,233.7703,1015.6222,240.6158,1022.813,240.0755,1025.08,233.23" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M1146.08,243.951 C1163.59,269.407 1182.98,297.599 1198.61,320.315 " fill="none" id="Context&lt;-DefaultNode" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="1138.71,233.23,1138.8135,240.4404,1145.509,243.118,1145.4055,235.9077,1138.71,233.23" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M770,750.324 C770,765.679 770,782.618 770,796.661 " fill="none" id="ProcessorSlot&lt;-AbstractLinkedProcessorSlot" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="763,750.137,770,730.137,777,750.137,763,750.137" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M624.448,847.117 C516.555,862.104 366.403,886.245 237,919 C229.02,921.02 220.726,923.426 212.562,925.984 " fill="none" id="AbstractLinkedProcessorSlot&lt;-ProcessorSlotChain" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="623.662,840.16,644.427,844.38,625.562,854.03,623.662,840.16" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M149,994.208 C149,1009.144 149,1025.894 149,1040.901 " fill="none" id="ProcessorSlotChain&lt;-DefaultProcessorSlotChain" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="142,994.035,149,974.035,156,994.035,142,994.035" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M915.218,859.398 C985.966,875.265 1071.98,896.128 1148,919 C1154.97,921.096 1162.21,923.461 1169.37,925.92 " fill="none" id="AbstractLinkedProcessorSlot&lt;-NodeSelectorSlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="913.694,866.23,895.689,855.057,916.731,852.563,913.694,866.23" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M915.649,846.068 C1025.39,860.65 1179.01,884.745 1311,919 C1318.64,920.984 1326.58,923.368 1334.38,925.914 " fill="none" id="AbstractLinkedProcessorSlot&lt;-ClusterBuilderSlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="914.605,852.991,895.683,843.456,916.422,839.11,914.605,852.991" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M624.719,860.427 C565.992,875.198 498.225,894.912 439,919 C433.437,921.263 427.723,923.971 422.192,926.822 " fill="none" id="AbstractLinkedProcessorSlot&lt;-LogSlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="623.169,853.6,644.263,855.608,626.521,867.192,623.169,853.6" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M684.841,867.472 C649.6,883.403 608.323,902.078 571,919 C565.268,921.599 559.258,924.327 553.296,927.034 " fill="none" id="AbstractLinkedProcessorSlot&lt;-StatisticSlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="682.09,861.033,703.198,859.174,687.857,873.79,682.09,861.033" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M721.803,872.816 C702.013,890.806 679.916,910.895 663.383,925.925 " fill="none" id="AbstractLinkedProcessorSlot&lt;-AuthoritySlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="717.183,867.555,736.691,859.281,726.601,877.914,717.183,867.555" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M770,879.544 C770,895.677 770,912.746 770,925.925 " fill="none" id="AbstractLinkedProcessorSlot&lt;-SystemSlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="763,879.281,770,859.281,777,879.281,763,879.281" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M824.357,871.633 C844.295,887.27 866.428,904.63 884.669,918.937 " fill="none" id="AbstractLinkedProcessorSlot&lt;-FlowSlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="820.025,877.132,808.608,859.281,828.665,866.116,820.025,877.132" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M872.646,865.977 C915.597,881.8 965.917,900.796 1011,919 C1016.94,921.396 1023.13,923.975 1029.26,926.577 " fill="none" id="AbstractLinkedProcessorSlot&lt;-DegradeSlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="870.155,872.519,853.79,859.059,874.977,859.376,870.155,872.519" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M808.492,627.226 C798.729,646.952 788.775,667.064 781.436,681.892 " fill="none" id="CtEntry&lt;-ProcessorSlot" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#FFFFFF" points="814.358,615.373,808.1115,618.9759,809.0347,626.1277,815.2813,622.5248,814.358,615.373" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M302.609,992.561 C312.821,1015.366 325.1,1042.79 333.619,1061.817 " fill="none" id="Rule&lt;-AbstractRule" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"></path><polygon fill="none" points="296.099,995.15,294.314,974.035,308.877,989.428,296.099,995.15" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M412.041,1118.653 C463.077,1142.3947 531.34,1174.1507 574.751,1194.3459 " fill="none" id="AbstractRule&lt;-FlowRule" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="408.936,1124.929,393.755,1110.146,414.841,1112.235,408.936,1124.929" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M303.248,1123.968 C279.426,1145.5783 250.092,1172.1878 229.515,1190.8539 " fill="none" id="AbstractRule&lt;-DegradeRule" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="298.805,1118.547,318.322,1110.294,308.212,1128.916,298.805,1118.547" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M344,1130.298 C344,1150.5983 344,1173.974 344,1190.8539 " fill="none" id="AbstractRule&lt;-AuthorityRule" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="337,1130.294,344,1110.294,351,1130.294,337,1130.294" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M383.878,1123.968 C407.191,1145.5783 435.896,1172.1878 456.031,1190.8539 " fill="none" id="AbstractRule&lt;-SystemRule" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="379.036,1129.024,369.128,1110.294,388.554,1118.757,379.036,1129.024" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M149,872.285 C149,890.41 149,910.746 149,925.925 " fill="none" id="CtSph&lt;-ProcessorSlotChain" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#FFFFFF" points="149,859.281,145,865.281,149,871.281,153,865.281,149,859.281" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M858.367,981.072 C812.671,1002.334 751.468,1030.81 704.683,1052.578 " fill="none" id="FlowSlot-&gt;FlowRuleManager" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="699.915,1054.797,709.7624,1054.6278,704.4485,1052.6881,706.3882,1047.3742,699.915,1054.797" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M923,981.072 C923,1003.646 923,1034.353 923,1056.53 " fill="none" id="FlowSlot-&gt;FlowRuleChecker" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#A80036" points="923,1061.69,927,1052.69,923,1056.69,919,1052.69,923,1061.69" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M628.873,1130.229 C625.993,1150.5508 622.674,1173.9677 620.279,1190.8677 " fill="none" id="FlowRuleManager&lt;-FlowRule" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="#FFFFFF" points="630.734,1117.097,625.9316,1122.4763,629.0501,1128.9783,633.8524,1123.5989,630.734,1117.097" style="stroke:#A80036;stroke-width:1.0;"></polygon></g></svg><h3 id="_3-sentinel用法示例"><a href="#_3-sentinel用法示例" class="header-anchor">#</a> 3.Sentinel用法示例</h3> <p>官方文档中，它的最简单的使用是下面这样的，这里用了 try-with-resource 的写法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Your business logic here.</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Handle rejected request.</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>当然，Sentinel也支持通过注解的方式来定义资源，可参见上一篇：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/rateLimit&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RateLimitController</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 按资源名称限流，需要指定限流处理逻辑
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/byResource&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;byResource&quot;</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;handleException&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">byResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;按资源名称限流&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 按URL限流，有默认的限流处理逻辑
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/byUrl&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;byUrl&quot;</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;handleException&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">byUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;按url限流&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> exception<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_3-请求响应流程"><a href="#_3-请求响应流程" class="header-anchor">#</a> 3.请求响应流程</h3> <h4 id="_3-1-通过切面处理注解"><a href="#_3-1-通过切面处理注解" class="header-anchor">#</a> 3.1 通过切面处理注解</h4> <p>对于 <code>@SentinelResource</code>注解的处理是通过切面<code>SentinelResourceAspect</code>来完成的，在此切面中，对注解的处理逻辑与上述 try-with-resource 的写法一致：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelResourceAspect</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSentinelAspectSupport</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(com.alibaba.csp.sentinel.annotation.SentinelResource)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sentinelResourceAnnotationPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;sentinelResourceAnnotationPointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invokeResourceWithSentinel</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">Method</span> originMethod <span class="token operator">=</span> <span class="token function">resolveMethod</span><span class="token punctuation">(</span>pjp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1.获取注解，并解析出相关属性</span>
        <span class="token class-name">SentinelResource</span> annotation <span class="token operator">=</span> originMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">SentinelResource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Should not go through here.</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Wrong state for SentinelResource annotation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> resourceName <span class="token operator">=</span> <span class="token function">getResourceName</span><span class="token punctuation">(</span>annotation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EntryType</span> entryType <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">entryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> resourceType <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">resourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.调用 entry 方法，进入拦截器链中进行各个规则的检查</span>
            entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">,</span> resourceType<span class="token punctuation">,</span> entryType<span class="token punctuation">,</span> pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3.执行被保护的业务逻辑</span>
            <span class="token keyword">return</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.若规则检查没有通过，则尝试执行配置的 blockHandler 方法</span>
            <span class="token keyword">return</span> <span class="token function">handleBlockException</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> annotation<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptionsToIgnore <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">exceptionsToIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// The ignore list will be checked first.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionsToIgnore<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">exceptionBelongsTo</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> exceptionsToIgnore<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exceptionBelongsTo</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> annotation<span class="token punctuation">.</span><span class="token function">exceptionsToTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">traceException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 5.若服务出现异常，则尝试执行配置的 fallback 方法</span>
                <span class="token keyword">return</span> <span class="token function">handleFallback</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> annotation<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// No fallback function can handle the exception, so throw it out.</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                entry<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h4 id="_3-2-获取-context-和过滤器链"><a href="#_3-2-获取-context-和过滤器链" class="header-anchor">#</a> 3.2 获取 Context 和过滤器链</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
    <span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">entryWithPriority</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.获取Context</span>
        <span class="token comment">// 1.1 从ThreadLocal中获取Context</span>
        <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">NullContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// The {@link NullContext} indicates that the amount of context has exceeded the threshold,</span>
            <span class="token comment">// so here init the entry only. No rule checking will be done.</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 1.2 使用默认的Context</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Using default context.</span>
            context <span class="token operator">=</span> <span class="token class-name">InternalContextUtil</span><span class="token punctuation">.</span><span class="token function">internalEnter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>CONTEXT_DEFAULT_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Global switch is close, no rule checking will do.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>ON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2.加载过滤器链</span>
        <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> chain <span class="token operator">=</span> <span class="token function">lookProcessChain</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Means amount of resources (slot chain) exceeds {@link Constants.MAX_SLOT_CHAIN_SIZE},
         * so no rule checking will be done.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Entry</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.执行过滤器链</span>
            chain<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// This should not happen, unless there are errors existing in Sentinel internal.</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Sentinel unexpected exception&quot;</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h5 id="_3-2-1-获取context"><a href="#_3-2-1-获取context" class="header-anchor">#</a> 3.2.1 获取Context</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 从当前线程中获取Context的工具类
 *
 * &lt;p&gt;
 *  每一个SphU#entry() or SphO#entry() 都应该出一个Context中，如果没有显示调用 ContextUtil#enter() ，则会使用默认的
 *  Context
 * &lt;/p&gt;
 *
 * @author jialiang.linjl
 * @author leyou(lihao)
 * @author Eric Zhao
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextUtil</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Store the context in ThreadLocal for easy access.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Context</span><span class="token punctuation">&gt;</span></span> contextHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Holds all {@link EntranceNode}. Each {@link EntranceNode} is associated with a distinct context name.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> contextNameNodeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> LOCK <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Context</span> NULL_CONTEXT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment">// Cache the entrance node for default context.</span>
        <span class="token function">initDefaultContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initDefaultContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> defaultContextName <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>CONTEXT_DEFAULT_NAME<span class="token punctuation">;</span>
        <span class="token class-name">EntranceNode</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>defaultContextName<span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span>IN<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Constants</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        contextNameNodeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>defaultContextName<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">enter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>CONTEXT_DEFAULT_NAME<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ContextNameDefineException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;The &quot;</span> <span class="token operator">+</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>CONTEXT_DEFAULT_NAME <span class="token operator">+</span> <span class="token string">&quot; can't be permit to defined!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">trueEnter</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">trueEnter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Context</span> context <span class="token operator">=</span> contextHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> localCacheNameMap <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">;</span>
            <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> localCacheNameMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localCacheNameMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>MAX_CONTEXT_NAME_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> NULL_CONTEXT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    LOCK<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        node <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>MAX_CONTEXT_NAME_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">setNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> NULL_CONTEXT<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span>IN<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">// Add entrance node.</span>
                                <span class="token class-name">Constants</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                contextNameNodeMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        LOCK<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p>因此，当没有在程序中显示调用<code>Context#enter()</code> 方法，则会 <code>1.1 处</code> 获取的Context就为空，会进入到 <code>1.2处</code> ，使用默认的Context，其实就是将一个默认的 <code>EntranceNode</code> 的节点加入到Context中，并将Context放入 ThreadLocal</p> <h5 id="_3-2-2-加载过滤器链"><a href="#_3-2-2-加载过滤器链" class="header-anchor">#</a> 3.2.2 加载过滤器链</h5> <p>（1）通过SPI的方式加载过滤器链</p> <p>通过注解 <code>@SentinelResource</code>或者其他方式定义的资源，会被包装成一个 <code>ResourceWrapper</code>，对于每一个 ResourceWrapper 都会创建一个对应的过滤器链，并缓存起来。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">lookProcessChain</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ProcessorSlotChain</span> chain <span class="token operator">=</span> chainMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>LOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                chain <span class="token operator">=</span> chainMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Entry size limit.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>chainMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>MAX_SLOT_CHAIN_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 创建过滤器链</span>
                    chain <span class="token operator">=</span> <span class="token class-name">SlotChainProvider</span><span class="token punctuation">.</span><span class="token function">newSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceWrapper</span><span class="token punctuation">,</span> <span class="token class-name">ProcessorSlotChain</span><span class="token punctuation">&gt;</span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceWrapper</span><span class="token punctuation">,</span> <span class="token class-name">ProcessorSlotChain</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                        chainMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>chainMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    chainMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>创建过滤器链时，会先通过SPI的方式，加载一个过滤器链的构建器，然后通过这个构建器来创建过滤器链</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SlotChainProvider</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">SlotChainBuilder</span> slotChainBuilder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * The load and pick process is not thread-safe, but it's okay since the method should be only invoked
     * via {@code lookProcessChain} in {@link com.alibaba.csp.sentinel.CtSph} under lock.
     *
     * @return new created slot chain
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token function">newSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>slotChainBuilder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> slotChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Resolve the slot chain builder SPI.</span>
        slotChainBuilder <span class="token operator">=</span> <span class="token class-name">SpiLoader</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">SlotChainBuilder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadFirstInstanceOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>slotChainBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Should not go through here.</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[SlotChainProvider] Wrong state when resolving slot chain builder, using default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            slotChainBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSlotChainBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[SlotChainProvider] Global slot chain builder resolved: {}&quot;</span><span class="token punctuation">,</span>
                slotChainBuilder<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> slotChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">SlotChainProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>构建器的实现类见<code>src/main/reosurces/META-INF/services</code>这个文件夹下的<code>com.alibaba.csp.sentinel.slotchain.SlotChainBuilder</code>文件：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code># <span class="token class-name">Default</span> slot chain builder
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span></span>DefaultSlotChainBuilder</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>也就是说构建器实现类为：DefaultSlotChainBuilder</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>isDefault <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSlotChainBuilder</span> <span class="token keyword">implements</span> <span class="token class-name">SlotChainBuilder</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ProcessorSlotChain</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultProcessorSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessorSlot</span><span class="token punctuation">&gt;</span></span> sortedSlotList <span class="token operator">=</span> <span class="token class-name">SpiLoader</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">ProcessorSlot</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInstanceListSorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessorSlot</span> slot <span class="token operator">:</span> sortedSlotList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>slot <span class="token keyword">instanceof</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;The ProcessorSlot(&quot;</span> <span class="token operator">+</span> slot<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) is not an instance of AbstractLinkedProcessorSlot, can't be added into ProcessorSlotChain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            chain<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> chain<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>构建过滤器链时，依旧是通过SPI的方式来获取一组过滤器（也即 ProcessorSlot 处理器槽，等效于过滤器），然后按顺序添加到过滤器链中，这一组过滤器的实现类见<code>src/main/reosurces/META-INF/services</code>这个文件夹下的<code>com.alibaba.csp.sentinel.slotchain.ProcessorSlot</code>文件：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code># <span class="token class-name">Sentinel</span> <span class="token keyword">default</span> <span class="token class-name">ProcessorSlots</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>nodeselector<span class="token punctuation">.</span></span>NodeSelectorSlot</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>clusterbuilder<span class="token punctuation">.</span></span>ClusterBuilderSlot</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>logger<span class="token punctuation">.</span></span>LogSlot</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>statistic<span class="token punctuation">.</span></span>StatisticSlot</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span>AuthoritySlot</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>system<span class="token punctuation">.</span></span>SystemSlot</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow<span class="token punctuation">.</span></span>FlowSlot</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>degrade<span class="token punctuation">.</span></span>DegradeSlot</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>也就是说，过滤器链是由如上过滤器从前往后组成。</p> <p>（2）过滤器链其实是一个单向链表，并添加有头尾指针</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultProcessorSlotChain</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token punctuation">{</span>
     <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> first<span class="token punctuation">;</span>
     <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> end <span class="token operator">=</span> first<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_3-3-执行过滤器链"><a href="#_3-3-执行过滤器链" class="header-anchor">#</a> 3.3 执行过滤器链</h4> <p>加载好当前资源对应的过滤器链之后，就会执行过滤器链：从头结点开始依次执行过滤器中节点。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultProcessorSlotChain</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> first<span class="token punctuation">;</span>
    <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> end<span class="token punctuation">;</span>
    
        <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行头节点</span>
        first<span class="token punctuation">.</span><span class="token function">transformEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> t<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>执行到相应过滤器节点中时，可通过 <code>AbstractLinkedProcessorSlot#fireEntry()</code>来触发下一个过滤器的执行：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fireEntry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">transformEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这样就会从前往后触发每个过滤器的执行，每个过滤器都有相应的职责：</p> <blockquote><ul><li><code>NodeSelectorSlot</code> 负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级；</li> <li><code>ClusterBuilderSlot</code> 则用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等等，这些信息将用作为多维度限流，降级的依据；</li> <li><code>StatistcSlot</code> 则用于记录，统计不同纬度的 runtime 信息；</li> <li><code>FlowSlot</code> 则用于根据预设的限流规则，以及前面 slot 统计的状态，来进行限流；</li> <li><code>AuthorizationSlot</code> 则根据黑白名单，来做黑白名单控制；</li> <li><code>DegradeSlot</code> 则通过统计信息，以及预设的规则，来做熔断降级；</li> <li><code>SystemSlot</code> 则通过系统的状态，例如 load1 等，来控制总的入口流量；</li></ul></blockquote> <p>其中部分过滤器会进行资源相应的规则校验，若某个规则校验不通过，则会抛出 BlockException，从而进入到切面中去执行注解中定义的blockHandler方法来进行相应的容错处理。</p> <p>BlockException 的类图如下：</p> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="283px" preserveAspectRatio="none" version="1.1" viewBox="0 0 836 283" width="836px" zoomAndPan="magnify" style="width:836px;height:283px;"><defs><filter height="300%" id="fx4msu2kba60i" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><rect fill="#FEFECE" filter="url(#fx4msu2kba60i)" height="48" id="BlockException" width="117" x="327" y="116" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="342" cy="132" fill="#A9DCDF" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M344.1875,133.7656 L340.0469,133.7656 L339.625,134.7969 L340.0469,134.7969 Q340.6563,134.7969 340.9219,135.0313 Q341.1875,135.2656 341.1875,135.6563 Q341.1875,136.0313 340.9219,136.2656 Q340.6563,136.5 340.0469,136.5 L337.75,136.5 Q337.1406,136.5 336.8828,136.2656 Q336.625,136.0313 336.625,135.6406 Q336.625,135.2656 336.8984,135.0234 Q337.1719,134.7813 337.7969,134.7969 L340.4688,128.1406 L339.3594,128.1406 Q338.75,128.1406 338.4844,127.9063 Q338.2188,127.6719 338.2188,127.2813 Q338.2188,126.9063 338.4844,126.6719 Q338.75,126.4375 339.3594,126.4375 L343.0313,126.4375 L346.4219,134.7969 Q347.0156,134.7969 347.2031,134.9375 Q347.5938,135.2031 347.5938,135.6563 Q347.5938,136.0313 347.3359,136.2656 Q347.0781,136.5 346.4688,136.5 L344.1719,136.5 Q343.5625,136.5 343.2969,136.2656 Q343.0313,136.0313 343.0313,135.6406 Q343.0313,135.2656 343.2969,135.0313 Q343.5625,134.7969 344.1719,134.7969 L344.5938,134.7969 L344.1875,133.7656 Z M343.4688,132.0625 L342.1094,128.6875 L340.7344,132.0625 L343.4688,132.0625 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="85" x="356" y="136.9102">BlockException</text><line x1="328" x2="443" y1="148" y2="148" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="328" x2="443" y1="156" y2="156" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fx4msu2kba60i)" height="48" id="Exception" width="85" x="343" y="8" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="358" cy="24" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M360.7656,19.875 Q360.9219,19.6563 361.1094,19.5469 Q361.2969,19.4375 361.5156,19.4375 Q361.8906,19.4375 362.125,19.6953 Q362.3594,19.9531 362.3594,20.5625 L362.3594,22.0156 Q362.3594,22.625 362.125,22.8906 Q361.8906,23.1563 361.5156,23.1563 Q361.1719,23.1563 360.9688,22.9531 Q360.7656,22.7656 360.6563,22.25 Q360.6094,21.8906 360.4219,21.7031 Q360.0938,21.3281 359.4844,21.1094 Q358.875,20.8906 358.25,20.8906 Q357.4844,20.8906 356.8516,21.2188 Q356.2188,21.5469 355.7266,22.2969 Q355.2344,23.0469 355.2344,24.0781 L355.2344,25.1719 Q355.2344,26.4063 356.125,27.2266 Q357.0156,28.0469 358.6094,28.0469 Q359.5469,28.0469 360.2031,27.7969 Q360.5938,27.6406 361.0156,27.2031 Q361.2813,26.9375 361.4297,26.8594 Q361.5781,26.7813 361.7813,26.7813 Q362.1094,26.7813 362.3672,27.0391 Q362.625,27.2969 362.625,27.6406 Q362.625,27.9844 362.2813,28.3906 Q361.7813,28.9688 360.9844,29.2969 Q359.9063,29.75 358.6094,29.75 Q357.0938,29.75 355.8906,29.125 Q354.9063,28.625 354.2188,27.5547 Q353.5313,26.4844 353.5313,25.2031 L353.5313,24.0469 Q353.5313,22.7188 354.1484,21.5703 Q354.7656,20.4219 355.8594,19.8047 Q356.9531,19.1875 358.1875,19.1875 Q358.9219,19.1875 359.5703,19.3516 Q360.2188,19.5156 360.7656,19.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="53" x="372" y="28.9102">Exception</text><line x1="344" x2="427" y1="40" y2="40" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="344" x2="427" y1="48" y2="48" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fx4msu2kba60i)" height="48" id="FlowException" width="111" x="6" y="224" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="21" cy="240" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M23.7656,235.875 Q23.9219,235.6563 24.1094,235.5469 Q24.2969,235.4375 24.5156,235.4375 Q24.8906,235.4375 25.125,235.6953 Q25.3594,235.9531 25.3594,236.5625 L25.3594,238.0156 Q25.3594,238.625 25.125,238.8906 Q24.8906,239.1563 24.5156,239.1563 Q24.1719,239.1563 23.9688,238.9531 Q23.7656,238.7656 23.6563,238.25 Q23.6094,237.8906 23.4219,237.7031 Q23.0938,237.3281 22.4844,237.1094 Q21.875,236.8906 21.25,236.8906 Q20.4844,236.8906 19.8516,237.2188 Q19.2188,237.5469 18.7266,238.2969 Q18.2344,239.0469 18.2344,240.0781 L18.2344,241.1719 Q18.2344,242.4063 19.125,243.2266 Q20.0156,244.0469 21.6094,244.0469 Q22.5469,244.0469 23.2031,243.7969 Q23.5938,243.6406 24.0156,243.2031 Q24.2813,242.9375 24.4297,242.8594 Q24.5781,242.7813 24.7813,242.7813 Q25.1094,242.7813 25.3672,243.0391 Q25.625,243.2969 25.625,243.6406 Q25.625,243.9844 25.2813,244.3906 Q24.7813,244.9688 23.9844,245.2969 Q22.9063,245.75 21.6094,245.75 Q20.0938,245.75 18.8906,245.125 Q17.9063,244.625 17.2188,243.5547 Q16.5313,242.4844 16.5313,241.2031 L16.5313,240.0469 Q16.5313,238.7188 17.1484,237.5703 Q17.7656,236.4219 18.8594,235.8047 Q19.9531,235.1875 21.1875,235.1875 Q21.9219,235.1875 22.5703,235.3516 Q23.2188,235.5156 23.7656,235.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="79" x="35" y="244.9102">FlowException</text><line x1="7" x2="116" y1="256" y2="256" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="7" x2="116" y1="264" y2="264" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fx4msu2kba60i)" height="48" id="DegradeException" width="133" x="152" y="224" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="167" cy="240" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M169.7656,235.875 Q169.9219,235.6563 170.1094,235.5469 Q170.2969,235.4375 170.5156,235.4375 Q170.8906,235.4375 171.125,235.6953 Q171.3594,235.9531 171.3594,236.5625 L171.3594,238.0156 Q171.3594,238.625 171.125,238.8906 Q170.8906,239.1563 170.5156,239.1563 Q170.1719,239.1563 169.9688,238.9531 Q169.7656,238.7656 169.6563,238.25 Q169.6094,237.8906 169.4219,237.7031 Q169.0938,237.3281 168.4844,237.1094 Q167.875,236.8906 167.25,236.8906 Q166.4844,236.8906 165.8516,237.2188 Q165.2188,237.5469 164.7266,238.2969 Q164.2344,239.0469 164.2344,240.0781 L164.2344,241.1719 Q164.2344,242.4063 165.125,243.2266 Q166.0156,244.0469 167.6094,244.0469 Q168.5469,244.0469 169.2031,243.7969 Q169.5938,243.6406 170.0156,243.2031 Q170.2813,242.9375 170.4297,242.8594 Q170.5781,242.7813 170.7813,242.7813 Q171.1094,242.7813 171.3672,243.0391 Q171.625,243.2969 171.625,243.6406 Q171.625,243.9844 171.2813,244.3906 Q170.7813,244.9688 169.9844,245.2969 Q168.9063,245.75 167.6094,245.75 Q166.0938,245.75 164.8906,245.125 Q163.9063,244.625 163.2188,243.5547 Q162.5313,242.4844 162.5313,241.2031 L162.5313,240.0469 Q162.5313,238.7188 163.1484,237.5703 Q163.7656,236.4219 164.8594,235.8047 Q165.9531,235.1875 167.1875,235.1875 Q167.9219,235.1875 168.5703,235.3516 Q169.2188,235.5156 169.7656,235.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="101" x="181" y="244.9102">DegradeException</text><line x1="153" x2="284" y1="256" y2="256" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="153" x2="284" y1="264" y2="264" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fx4msu2kba60i)" height="48" id="AuthorityException" width="131" x="320" y="224" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="335" cy="240" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M337.7656,235.875 Q337.9219,235.6563 338.1094,235.5469 Q338.2969,235.4375 338.5156,235.4375 Q338.8906,235.4375 339.125,235.6953 Q339.3594,235.9531 339.3594,236.5625 L339.3594,238.0156 Q339.3594,238.625 339.125,238.8906 Q338.8906,239.1563 338.5156,239.1563 Q338.1719,239.1563 337.9688,238.9531 Q337.7656,238.7656 337.6563,238.25 Q337.6094,237.8906 337.4219,237.7031 Q337.0938,237.3281 336.4844,237.1094 Q335.875,236.8906 335.25,236.8906 Q334.4844,236.8906 333.8516,237.2188 Q333.2188,237.5469 332.7266,238.2969 Q332.2344,239.0469 332.2344,240.0781 L332.2344,241.1719 Q332.2344,242.4063 333.125,243.2266 Q334.0156,244.0469 335.6094,244.0469 Q336.5469,244.0469 337.2031,243.7969 Q337.5938,243.6406 338.0156,243.2031 Q338.2813,242.9375 338.4297,242.8594 Q338.5781,242.7813 338.7813,242.7813 Q339.1094,242.7813 339.3672,243.0391 Q339.625,243.2969 339.625,243.6406 Q339.625,243.9844 339.2813,244.3906 Q338.7813,244.9688 337.9844,245.2969 Q336.9063,245.75 335.6094,245.75 Q334.0938,245.75 332.8906,245.125 Q331.9063,244.625 331.2188,243.5547 Q330.5313,242.4844 330.5313,241.2031 L330.5313,240.0469 Q330.5313,238.7188 331.1484,237.5703 Q331.7656,236.4219 332.8594,235.8047 Q333.9531,235.1875 335.1875,235.1875 Q335.9219,235.1875 336.5703,235.3516 Q337.2188,235.5156 337.7656,235.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="99" x="349" y="244.9102">AuthorityException</text><line x1="321" x2="450" y1="256" y2="256" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="321" x2="450" y1="264" y2="264" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fx4msu2kba60i)" height="48" id="SystemBlockException" width="156" x="486.5" y="224" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="501.5" cy="240" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M504.2656,235.875 Q504.4219,235.6563 504.6094,235.5469 Q504.7969,235.4375 505.0156,235.4375 Q505.3906,235.4375 505.625,235.6953 Q505.8594,235.9531 505.8594,236.5625 L505.8594,238.0156 Q505.8594,238.625 505.625,238.8906 Q505.3906,239.1563 505.0156,239.1563 Q504.6719,239.1563 504.4688,238.9531 Q504.2656,238.7656 504.1563,238.25 Q504.1094,237.8906 503.9219,237.7031 Q503.5938,237.3281 502.9844,237.1094 Q502.375,236.8906 501.75,236.8906 Q500.9844,236.8906 500.3516,237.2188 Q499.7188,237.5469 499.2266,238.2969 Q498.7344,239.0469 498.7344,240.0781 L498.7344,241.1719 Q498.7344,242.4063 499.625,243.2266 Q500.5156,244.0469 502.1094,244.0469 Q503.0469,244.0469 503.7031,243.7969 Q504.0938,243.6406 504.5156,243.2031 Q504.7813,242.9375 504.9297,242.8594 Q505.0781,242.7813 505.2813,242.7813 Q505.6094,242.7813 505.8672,243.0391 Q506.125,243.2969 506.125,243.6406 Q506.125,243.9844 505.7813,244.3906 Q505.2813,244.9688 504.4844,245.2969 Q503.4063,245.75 502.1094,245.75 Q500.5938,245.75 499.3906,245.125 Q498.4063,244.625 497.7188,243.5547 Q497.0313,242.4844 497.0313,241.2031 L497.0313,240.0469 Q497.0313,238.7188 497.6484,237.5703 Q498.2656,236.4219 499.3594,235.8047 Q500.4531,235.1875 501.6875,235.1875 Q502.4219,235.1875 503.0703,235.3516 Q503.7188,235.5156 504.2656,235.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="124" x="515.5" y="244.9102">SystemBlockException</text><line x1="487.5" x2="641.5" y1="256" y2="256" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="487.5" x2="641.5" y1="264" y2="264" style="stroke:#A80036;stroke-width:1.5;"></line><rect fill="#FEFECE" filter="url(#fx4msu2kba60i)" height="48" id="ParamFlowException" width="148" x="677.5" y="224" style="stroke:#A80036;stroke-width:1.5;"></rect><ellipse cx="692.5" cy="240" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"></ellipse><path d="M695.2656,235.875 Q695.4219,235.6563 695.6094,235.5469 Q695.7969,235.4375 696.0156,235.4375 Q696.3906,235.4375 696.625,235.6953 Q696.8594,235.9531 696.8594,236.5625 L696.8594,238.0156 Q696.8594,238.625 696.625,238.8906 Q696.3906,239.1563 696.0156,239.1563 Q695.6719,239.1563 695.4688,238.9531 Q695.2656,238.7656 695.1563,238.25 Q695.1094,237.8906 694.9219,237.7031 Q694.5938,237.3281 693.9844,237.1094 Q693.375,236.8906 692.75,236.8906 Q691.9844,236.8906 691.3516,237.2188 Q690.7188,237.5469 690.2266,238.2969 Q689.7344,239.0469 689.7344,240.0781 L689.7344,241.1719 Q689.7344,242.4063 690.625,243.2266 Q691.5156,244.0469 693.1094,244.0469 Q694.0469,244.0469 694.7031,243.7969 Q695.0938,243.6406 695.5156,243.2031 Q695.7813,242.9375 695.9297,242.8594 Q696.0781,242.7813 696.2813,242.7813 Q696.6094,242.7813 696.8672,243.0391 Q697.125,243.2969 697.125,243.6406 Q697.125,243.9844 696.7813,244.3906 Q696.2813,244.9688 695.4844,245.2969 Q694.4063,245.75 693.1094,245.75 Q691.5938,245.75 690.3906,245.125 Q689.4063,244.625 688.7188,243.5547 Q688.0313,242.4844 688.0313,241.2031 L688.0313,240.0469 Q688.0313,238.7188 688.6484,237.5703 Q689.2656,236.4219 690.3594,235.8047 Q691.4531,235.1875 692.6875,235.1875 Q693.4219,235.1875 694.0703,235.3516 Q694.7188,235.5156 695.2656,235.875 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="116" x="706.5" y="244.9102">ParamFlowException</text><line x1="678.5" x2="824.5" y1="256" y2="256" style="stroke:#A80036;stroke-width:1.5;"></line><line x1="678.5" x2="824.5" y1="264" y2="264" style="stroke:#A80036;stroke-width:1.5;"></line><path d="M385.5,76.024 C385.5,89.579 385.5,104.038 385.5,115.678 " fill="none" id="Exception&lt;-BlockException" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="378.5,76,385.5,56,392.5,76,378.5,76" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M307.733,166.442 C248.913,185.6859 169.567,211.6447 117.032,228.8321 " fill="none" id="BlockException&lt;-FlowException" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="305.641,159.762,326.826,160.196,309.994,173.0677,305.641,159.762" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M332.226,174.8147 C307.022,190.8126 277.57,209.5064 254.954,223.8617 " fill="none" id="BlockException&lt;-DegradeException" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="328.626,168.808,349.263,164,336.129,180.6283,328.626,168.808" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M385.5,184.0236 C385.5,197.5792 385.5,212.0381 385.5,223.6784 " fill="none" id="BlockException&lt;-AuthorityException" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="378.5,184.0005,385.5,164,392.5,184.0004,378.5,184.0005" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M441.82,174.3518 C469.007,190.451 500.951,209.3677 525.427,223.8617 " fill="none" id="BlockException&lt;-SystemBlockException" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="437.983,180.2144,424.34,164,445.116,168.168,437.983,180.2144" style="stroke:#A80036;stroke-width:1.0;"></polygon><path d="M463.874,163.699 C527.062,181.9988 615.311,207.5573 677.347,225.5239 " fill="none" id="BlockException&lt;-ParamFlowException" style="stroke:#A80036;stroke-width:1.0;"></path><polygon fill="none" points="461.567,170.318,444.304,158.031,465.462,156.871,461.567,170.318" style="stroke:#A80036;stroke-width:1.0;"></polygon></g></svg><p>Sentinel 的功能主要就是通过这一个一个的过滤器来实现的，下面我们将针对这些过滤器来进行分析:</p> <blockquote><p>转自：</p></blockquote> <h2 id="三、nodeselectorslot"><a href="#三、nodeselectorslot" class="header-anchor">#</a> 三、NodeSelectorSlot</h2> <p><code>NodeSelectorSlot</code> 是用来构造调用链的，具体的是将资源的调用路径，封装成一个一个的节点，再组成一个树状的结构来形成一个完整的调用链， <code>NodeSelectorSlot</code>是所有Slot中最关键也是最复杂的一个Slot，这里涉及到以下几个核心的概念：</p> <ul><li>Resource</li></ul> <p>资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它服务，甚至可以是一段代码。</p> <p>只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。</p> <p>简单来说，资源就是 Sentinel 用来保护系统的一个媒介。源码中用来包装资源的类是： <code>com.alibaba.csp.sentinel.slotchain.ResourceWrapper</code>，他有两个子类： <code>StringResourceWrapper</code> 和 <code>MethodResourceWrapper</code>，通过名字就知道可以将一段字符串或一个方法包装为一个资源。</p> <p>打个比方，我有一个服务A，请求非常多，经常会被陡增的流量冲垮，为了防止这种情况，简单的做法，我们可以定义一个 Sentinel 的资源，通过该资源来对请求进行调整，使得允许通过的请求不会把服务A搞崩溃。</p> <p><img src="/snote/assets/img/33e692531834afb1dacf14fa6250271f.3c32efd0.jpg" alt="img"></p> <p>每个资源的状态也是不同的，这取决于资源后端的服务，有的资源可能比较稳定，有的资源可能不太稳定。那么在整个调用链中，Sentinel 需要对不稳定资源进行控制。当调用链路中某个资源出现不稳定，例如，表现为 timeout，或者异常比例升高的时候，则对这个资源的调用进行限制，并让请求快速失败，避免影响到其它的资源，最终导致雪崩的后果。</p> <ul><li>Context</li></ul> <p>上下文是一个用来保存调用链当前状态的元数据的类，每次进入一个资源时，就会创建一个上下文。**并且相同的资源名只会创建一个上下文。**一个Context中包含了三个核心的对象：</p> <p>1）当前调用链的根节点：EntranceNode</p> <p>2）当前的入口：Entry</p> <p>3）当前入口所关联的节点：Node</p> <p>上下文中只会保存一个当前正在处理的入口Entry，另外还会保存调用链的根节点。<strong>需要注意的是，每次进入一个新的资源时，都会创建一个新的上下文。</strong></p> <ul><li>Entry</li></ul> <p>每次调用 <code>SphU#entry()</code> 都会生成一个Entry入口，该入口中会保存了以下数据：入口的创建时间，当前入口所关联的节点，当前入口所关联的调用源对应的节点。Entry是一个抽象类，他只有一个实现类，在CtSph中的一个静态类：CtEntry</p> <ul><li>Node</li></ul> <p>节点是用来保存某个资源的各种实时统计信息的，他是一个接口，通过访问节点，就可以获取到对应资源的实时状态，以此为依据进行限流和降级操作。</p> <p>可能看到这里，大家还是比较懵，这么多类到底有什么用，接下来就让我们更进一步，挖掘一下这些类的作用，在这之前，我先给大家展示一下他们之间的关系，如下图所示：</p> <p><img src="/snote/assets/img/fe55a91fa2573afe4d4b936e4b2d2b12.4b11ba45.jpg" alt="img"></p> <p>这里把几种Node的作用先大概介绍下：</p> <table><thead><tr><th style="text-align:left;">节点</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;">StatisticNode</td> <td style="text-align:left;">执行具体的资源统计操作</td></tr> <tr><td style="text-align:left;">DefaultNode</td> <td style="text-align:left;">该节点持有指定上下文中指定资源的统计信息，当在同一个上下文中多次调用entry方法时，该节点可能下会创建有一系列的子节点。 另外每个DefaultNode中会关联一个ClusterNode</td></tr> <tr><td style="text-align:left;">ClusterNode</td> <td style="text-align:left;">该节点中保存了资源的总体的运行时统计信息，包括rt，线程数，qps等等，相同的资源会全局共享同一个ClusterNode，不管他属于哪个上下文</td></tr> <tr><td style="text-align:left;">EntranceNode</td> <td style="text-align:left;">该节点表示一棵调用链树的入口节点，通过他可以获取调用链树中所有的子节点</td></tr></tbody></table> <h3 id="_1-context的创建与销毁"><a href="#_1-context的创建与销毁" class="header-anchor">#</a> 1.Context的创建与销毁</h3> <p>首先我们要清楚的一点就是，每次执行entry()方法，试图冲破一个资源时，都会生成一个上下文。这个上下文中会保存着调用链的根节点和当前的入口。</p> <p>Context是通过ContextUtil创建的，具体的方法是trueEntry，代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">trueEnter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先从ThreadLocal中获取</span>
    <span class="token class-name">Context</span> context <span class="token operator">=</span> contextHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果ThreadLocal中获取不到Context</span>
        <span class="token comment">// 则根据name从map中获取根节点，只要是相同的资源名，就能直接从map中获取到node</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> localCacheNameMap <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">;</span>
        <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> localCacheNameMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 省略部分代码</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                LOCK<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                node <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 省略部分代码</span>
                    <span class="token comment">// 创建一个新的入口节点</span>
                    node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span>IN<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Constants</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 省略部分代码</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                LOCK<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 创建一个新的Context，并设置Context的根节点，即设置EntranceNode</span>
        context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将该Context保存到ThreadLocal中去</span>
        contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>上面的代码中我省略了部分代码，只保留了核心的部分。从源码中还是可以比较清晰的看出生成Context的过程：</p> <ul><li>1.先从ThreadLocal中获取，如果能获取到直接返回，如果获取不到则继续第2步</li> <li>2.从一个static的map中根据上下文的名称获取，如果能获取到则直接返回，否则继续第3步</li> <li>3.加锁后进行一次double check，如果还是没能从map中获取到，则创建一个EntranceNode，并把该EntranceNode添加到一个全局的ROOT节点中去，然后将该节点添加到map中去(这部分代码在上述代码中省略了)</li> <li>4.根据EntranceNode创建一个上下文，并将该上下文保存到ThreadLocal中去，下一个请求可以直接获取</li></ul> <p>那保存在ThreadLocal中的上下文什么时候会清除呢？从代码中可以看到具体的清除工作在ContextUtil的exit方法中，当执行该方法时，会将保存在ThreadLocal中的context对象清除，具体的代码非常简单，这里就不贴代码了。</p> <p>那ContextUtil.exit方法什么时候会被调用呢？有两种情况：一是主动调用ContextUtil.exit的时候，二是当一个入口Entry要退出，执行该Entry的trueExit方法的时候，此时会触发ContextUtil.exit的方法。但是有一个前提，就是当前Entry的父Entry为null时，此时说明该Entry已经是最顶层的根节点了，可以清除context。</p> <h3 id="_2-调用链树"><a href="#_2-调用链树" class="header-anchor">#</a> 2.调用链树</h3> <p>当在一个上下文中多次调用了 SphU#entry() 方法时，就会创建一棵调用链树。具体的代码在entry方法中创建CtEntry对象时：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token class-name">CtEntry</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> chain<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chain <span class="token operator">=</span> chain<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>

        <span class="token comment">// 设置上下文入口</span>
        <span class="token function">setUpEntryFor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setUpEntryFor</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The entry should not be associated to NullContext.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">NullContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取「上下文」中上一次的入口</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 然后将当前入口设置为上一次入口的子节点</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CtEntry</span><span class="token punctuation">)</span> parent<span class="token punctuation">)</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置「上下文」的当前入口为该类本身</span>
        context<span class="token punctuation">.</span><span class="token function">setCurEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这里可能看代码没有那么直观，可以用一些图形来描述一下这个过程。</p> <h4 id="_2-1-构造树干"><a href="#_2-1-构造树干" class="header-anchor">#</a> 2.1 构造树干</h4> <h5 id="_2-1-1-创建context"><a href="#_2-1-1-创建context" class="header-anchor">#</a> 2.1.1 创建context</h5> <p>context的创建在上面已经分析过了，初始化的时候，context中的curEntry属性是没有值的，如下图所示：</p> <p><img src="/snote/assets/img/9ef9f58e693217e75cbc213637e76ca9.07bbb13f.jpg" alt="img"></p> <h5 id="_2-1-2-创建entry"><a href="#_2-1-2-创建entry" class="header-anchor">#</a> 2.1.2 创建Entry</h5> <p>每创建一个新的Entry对象时，都会重新设置context的curEntry，并将context原来的curEntry设置为该新Entry对象的父节点，如下图所示：</p> <p><img src="/snote/assets/img/e2133660e798ed159169baf0387b8705.1473de36.jpg" alt="img"></p> <h5 id="_2-1-3-退出entry"><a href="#_2-1-3-退出entry" class="header-anchor">#</a> 2.1.3 退出Entry</h5> <p>某个Entry退出时，将会重新设置context的curEntry，当该Entry是最顶层的一个入口时，将会把ThreadLocal中保存的context也清除掉，如下图所示：</p> <p><img src="/snote/assets/img/9dc4366529b1207f66088a10164e4cfe.6cee485e.jpg" alt="img"></p> <h4 id="_2-2-构造叶子节点"><a href="#_2-2-构造叶子节点" class="header-anchor">#</a> 2.2 构造叶子节点</h4> <p>上面的过程是构造了一棵调用链的树，但是这棵树只有树干，没有叶子，那叶子节点是在什么时候创建的呢？DefaultNode就是叶子节点，在叶子节点中保存着目标资源在当前状态下的统计信息。通过分析，我们知道了叶子节点是在NodeSelectorSlot的entry方法中创建的。具体的代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据「上下文」的名称获取DefaultNode</span>
        <span class="token comment">// 多线程环境下，每个线程都会创建一个context，</span>
        <span class="token comment">// 只要资源名相同，则context的名称也相同，那么获取到的节点就相同  </span>
        <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 如果当前「上下文」中没有该节点，则创建一个DefaultNode节点</span>
                    node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> cacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cacheMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    map <span class="token operator">=</span> cacheMap<span class="token punctuation">;</span>
                    <span class="token comment">// Build invocation tree</span>
                    <span class="token comment">// 将当前node作为「上下文」的最后一个节点的子节点添加进去</span>
                    <span class="token comment">// 如果context的curEntry.parent.curNode为null，则添加到entranceNode中去</span>
                    <span class="token comment">// 否则添加到context的curEntry.parent.curNode中去</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultNode</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将该节点设置为「上下文」中的当前节点</span>
        <span class="token comment">// 实际是将当前节点赋值给context中curEntry的curNode</span>
        <span class="token comment">// 在Context的getLastNode中会用到在此处设置的curNode</span>
        context<span class="token punctuation">.</span><span class="token function">setCurNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>上面的代码可以分解成下面这些步骤：<br>
1）获取当前上下文对应的DefaultNode，如果没有的话会为当前的调用新生成一个DefaultNode节点，它的作用是对资源进行各种统计度量以便进行流控；<br>
2）将新创建的DefaultNode节点，添加到context中，作为「entranceNode」或者「curEntry.parent.curNode」的子节点；<br>
3）将DefaultNode节点，添加到context中，作为「curEntry」的curNode。</p> <p>上面的第2步，不是每次都会执行。我们先看第3步，把当前DefaultNode设置为context的curNode，实际上是把当前节点赋值给context中curEntry的curNode，用图形表示就是这样：</p> <p><img src="/snote/assets/img/ffb8083eaf506e944df1627e7cf89513.87369c38.jpg" alt="img"></p> <p>多次创建不同的Entry，并且执行NodeSelectorSlot的entry方法后，就会变成这样一棵调用链树：</p> <p><img src="/snote/assets/img/f5bc9b4f583d63dc4de5e8bae41e8c20.7e58f04a.jpg" alt="img"></p> <p><strong>PS：这里图中的node0，node1，node2可能是相同的node，因为在同一个context中从map中获取的node是同一个，这里只是为了表述的更清楚所以用了不同的节点名。</strong></p> <h4 id="_2-3-保存子节点"><a href="#_2-3-保存子节点" class="header-anchor">#</a> 2.3 保存子节点</h4> <p>上面已经分析了叶子节点的构造过程，叶子节点是保存在各个Entry的curNode属性中的。</p> <p>我们知道context中只保存了入口节点和当前Entry，那子节点是什么时候保存的呢，其实子节点就是上面代码中的第2步中保存的。</p> <p>下面我们来分析上面的第2步的情况：</p> <p>第一次调用NodeSelectorSlot的entry方法时，map中肯定是没有DefaultNode的，那就会进入第2步中，创建一个node，创建完成后会把该节点加入到context的lastNode的子节点中去。我们先看一下context的getLastNode方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Node</span> <span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果curEntry不存在时，返回entranceNode</span>
        <span class="token comment">// 否则返回curEntry的lastNode，</span>
        <span class="token comment">// 需要注意的是curEntry的lastNode是获取的parent的curNode，</span>
        <span class="token comment">// 如果每次进入的资源不同，就会每次都创建一个CtEntry，则parent为null，</span>
        <span class="token comment">// 所以curEntry.getLastNode()也为null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curEntry <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> curEntry<span class="token punctuation">.</span><span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> curEntry<span class="token punctuation">.</span><span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> entranceNode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>代码中我们可以知道，lastNode的值可能是context中的entranceNode也可能是curEntry.parent.curNode，但是他们都是「DefaultNode」类型的节点，DefaultNode的所有子节点是保存在一个HashSet中的。</p> <p>第一次调用getLastNode方法时，context中curEntry是null，因为curEntry是在第3步中才赋值的。所以，lastNode最初的值就是context的entranceNode。那么将node添加到entranceNode的子节点中去之后就变成了下面这样：</p> <p><img src="/snote/assets/img/575b27cd8167138f56ae82808dac7990.efecfd8b.jpg" alt="img"></p> <p>紧接着再进入一次，资源名不同，会再次生成一个新的Entry，上面的图形就变成下图这样：</p> <p><img src="/snote/assets/img/4c44f2bd0b2cc5223868f75e28d9891a.57a2198c.jpg" alt="img"></p> <p>此时再次调用context的getLastNode方法，因为此时curEntry的parent不再是null了，所以获取到的lastNode是curEntry.parent.curNode，在上图中可以很方便的看出，这个节点就是<strong>node0</strong>。那么把当前节点node1添加到lastNode的子节点中去，上面的图形就变成下图这样：</p> <p><img src="/snote/assets/img/15c11c3468a211b6083ea4e6b922c045.62b863f2.jpg" alt="img"></p> <p>然后将当前node设置给context的curNode，上面的图形就变成下图这样：</p> <p><img src="/snote/assets/img/f0a315c92ded8e731a2456bf85174223.ff0a928c.jpg" alt="img"></p> <p>假如再创建一个Entry，然后再进入一次不同的资源名，上面的图就变成下面这样：</p> <p><img src="/snote/assets/img/e4618bbb7803774c8d1f8622908ef6d5.ab19fe2a.jpg" alt="img"></p> <p>至此NodeSelectorSlot的基本功能已经大致分析清楚了。</p> <p><strong>PS：以上的分析是基于每次执行SphU.entry(name)时，资源名都是不一样的前提下。如果资源名都一样的话，那么生成的node都相同，则只会再第一次把node加入到entranceNode的子节点中去，其他的时候，只会创建一个新的Entry，然后替换context中的curEntry的值。</strong></p> <h2 id="四、clusterbuilderslot"><a href="#四、clusterbuilderslot" class="header-anchor">#</a> 四、ClusterBuilderSlot</h2> <p>NodeSelectorSlot的entry方法执行完之后，会调用fireEntry方法，此时会触发ClusterBuilderSlot的entry方法。</p> <p>ClusterBuilderSlot的entry方法比较简单，具体代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Create the cluster node.</span>
                clusterNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">.</span><span class="token function">getResourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将clusterNode保存到全局的map中去</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceWrapper</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>clusterNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>clusterNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

                clusterNodeMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将clusterNode塞到DefaultNode中去</span>
    node<span class="token punctuation">.</span><span class="token function">setClusterNode</span><span class="token punctuation">(</span>clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 省略部分代码</span>

    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>ClusterBuilderSlot的职责比较简单，主要做了两件事：</p> <p>一、为每个资源创建一个clusterNode，然后把clusterNode塞到DefaultNode中去</p> <p>二、将clusterNode保持到全局的map中去，用资源作为map的key</p> <p><strong>PS：一个资源只有一个ClusterNode，但是可以有多个DefaultNode</strong></p> <h2 id="五、statisticslot"><a href="#五、statisticslot" class="header-anchor">#</a> 五、StatisticSlot</h2> <p>StatisticSlot负责来统计资源的实时状态，具体的代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 触发下一个Slot的entry方法</span>
        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果能通过SlotChain中后面的Slot的entry方法，说明没有被限流或降级</span>
        <span class="token comment">// 统计信息</span>
        node<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 省略部分代码</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Add block count.</span>
        node<span class="token punctuation">.</span><span class="token function">increaseBlockedQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 省略部分代码</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Should not happen</span>
        node<span class="token punctuation">.</span><span class="token function">increaseExceptionQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 省略部分代码</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultNode</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getCurNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> rt <span class="token operator">=</span> <span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rt <span class="token operator">&gt;</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>TIME_DROP_VALVE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rt <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>TIME_DROP_VALVE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        node<span class="token punctuation">.</span><span class="token function">rt</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 省略部分代码</span>
        node<span class="token punctuation">.</span><span class="token function">decreaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 省略部分代码</span>
    <span class="token punctuation">}</span>
    <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>代码分成了两部分，第一部分是entry方法，该方法首先会触发后续slot的entry方法，即SystemSlot、FlowSlot、DegradeSlot等的规则，如果规则不通过，就会抛出BlockException，则会在node中统计被block的数量。反之会在node中统计通过的请求数和线程数等信息。第二部分是在exit方法中，当退出该Entry入口时，会统计rt的时间，并减少线程数。</p> <p>这些统计的实时数据会被后续的校验规则所使用，具体的统计方式是通过 <code>滑动窗口</code> 来实现的。后面我会详细分析滑动窗口的原理。</p> <h2 id="六、systemslot"><a href="#六、systemslot" class="header-anchor">#</a> 六、SystemSlot</h2> <p>SystemSlot就是根据总的请求统计信息，来做流控，主要是防止系统被搞垮，具体的代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">checkSystem</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkSystem</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略部分代码</span>
    <span class="token comment">// total qps</span>
    <span class="token keyword">double</span> currentQps <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">successQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentQps <span class="token operator">&gt;</span> qps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;qps&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// total thread</span>
    <span class="token keyword">int</span> currentThread <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">curThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentThread <span class="token operator">&gt;</span> maxThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">double</span> rt <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">avgRt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rt <span class="token operator">&gt;</span> maxRt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;rt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 完全按照RT,BBR算法来</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>highestSystemLoadIsSet <span class="token operator">&amp;&amp;</span> <span class="token function">getCurrentSystemAvgLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> highestSystemLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentThread <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
            currentThread <span class="token operator">&gt;</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">maxSuccessQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">minRt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;load&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>其中的Constants.ENTRY_NODE是一个全局的ClusterNode，该节点的值是在StatisticsSlot中进行统计的。</p> <h2 id="七、authorityslot"><a href="#七、authorityslot" class="header-anchor">#</a> 七、AuthoritySlot</h2> <p>AuthoritySlot做的事也比较简单，主要是根据黑白名单进行过滤，只要有一条规则校验不通过，就抛出异常。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">AuthorityRuleManager</span><span class="token punctuation">.</span><span class="token function">checkAuthority</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkAuthority</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>authorityRules <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 根据资源名称获取相应的规则</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> authorityRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AuthorityRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只要有一条规则校验不通过，就抛出AuthorityException</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rule<span class="token punctuation">.</span><span class="token function">passCheck</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthorityException</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="八、flowslot"><a href="#八、flowslot" class="header-anchor">#</a> 八、FlowSlot</h2> <p>FlowSlot主要是根据前面统计好的信息，与设置的限流规则进行匹配校验，如果规则校验不通过则进行限流，具体的代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">checkFlow</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> flowRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rule<span class="token punctuation">.</span><span class="token function">passCheck</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FlowException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="九、degradeslot"><a href="#九、degradeslot" class="header-anchor">#</a> 九、DegradeSlot</h2> <p>DegradeSlot主要是根据前面统计好的信息，与设置的降级规则进行匹配校验，如果规则校验不通过则进行降级，具体的代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">checkDegrade</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkDegrade</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> degradeRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DegradeRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rule<span class="token punctuation">.</span><span class="token function">passCheck</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DegradeException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>sentinel的限流降级等功能，主要是通过一个SlotChain实现的。在链式插槽中，有7个核心的Slot，这些Slot各司其职，可以分为以下几种类型：</p> <p>一、进行资源调用路径构造的NodeSelectorSlot和ClusterBuilderSlot</p> <p>二、进行资源的实时状态统计的StatisticsSlot</p> <p>三、进行系统保护，限流，降级等规则校验的SystemSlot、AuthoritySlot、FlowSlot、DegradeSlot</p> <p>后面几个Slot依赖于前面几个Slot统计的结果。至此，每种Slot的功能已经基本分析清楚了。</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2021-06-11 22:12:01</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelru-men-shi-li.html" class="prev">
            Sentinel入门实例
          </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#资源合辑" class="sidebar-link reco-side-资源合辑" data-v-70334359>资源合辑</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#推荐阅读" class="sidebar-link reco-side-推荐阅读" data-v-70334359>推荐阅读</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#一、概览" class="sidebar-link reco-side-一、概览" data-v-70334359>一、概览</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#二、请求响应概览" class="sidebar-link reco-side-二、请求响应概览" data-v-70334359>二、请求响应概览</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#_1-时序图" class="sidebar-link reco-side-_1-时序图" data-v-70334359>1. 时序图</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#_2-核心类图" class="sidebar-link reco-side-_2-核心类图" data-v-70334359>2.核心类图</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#_3-sentinel用法示例" class="sidebar-link reco-side-_3-sentinel用法示例" data-v-70334359>3.Sentinel用法示例</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#_3-请求响应流程" class="sidebar-link reco-side-_3-请求响应流程" data-v-70334359>3.请求响应流程</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#三、nodeselectorslot" class="sidebar-link reco-side-三、nodeselectorslot" data-v-70334359>三、NodeSelectorSlot</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#_1-context的创建与销毁" class="sidebar-link reco-side-_1-context的创建与销毁" data-v-70334359>1.Context的创建与销毁</a></li><li class="level-3" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#_2-调用链树" class="sidebar-link reco-side-_2-调用链树" data-v-70334359>2.调用链树</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#四、clusterbuilderslot" class="sidebar-link reco-side-四、clusterbuilderslot" data-v-70334359>四、ClusterBuilderSlot</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#五、statisticslot" class="sidebar-link reco-side-五、statisticslot" data-v-70334359>五、StatisticSlot</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#六、systemslot" class="sidebar-link reco-side-六、systemslot" data-v-70334359>六、SystemSlot</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#七、authorityslot" class="sidebar-link reco-side-七、authorityslot" data-v-70334359>七、AuthoritySlot</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#八、flowslot" class="sidebar-link reco-side-八、flowslot" data-v-70334359>八、FlowSlot</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#九、degradeslot" class="sidebar-link reco-side-九、degradeslot" data-v-70334359>九、DegradeSlot</a></li><li class="level-2" data-v-70334359><a href="/snote/cs/backend/spring/spring-cloud/02_spring-cloud-alibaba/03_sentinelyuan-ma-fen-xi.html#总结" class="sidebar-link reco-side-总结" data-v-70334359>总结</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 snote
    </div> <div class="operation" style="right:90px;bottom:40px;display:none;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:none;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:50px;bottom:10px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><canvas id="vuepress-canvas-cursor"></canvas><!----></div></div>
    <script src="/snote/assets/js/app.3cc04e36.js" defer></script><script src="/snote/assets/js/5.22329d81.js" defer></script><script src="/snote/assets/js/1.5e23c49c.js" defer></script><script src="/snote/assets/js/13.d156e68f.js" defer></script><script src="/snote/assets/js/77.11cc1a2c.js" defer></script>
  </body>
</html>
